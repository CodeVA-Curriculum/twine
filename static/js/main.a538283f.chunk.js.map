{"version":3,"sources":["store/stories/index.ts","components/tooltip/tooltip.tsx","components/control/icon-button.tsx","store/prefs/index.ts","store/story-formats/index.ts","components/container/button-bar/button-bar.tsx","components/container/button-bar/button-bar-separator.tsx","components/container/card/card-content.tsx","dialogs/index.ts","store/undoable-stories/index.ts","components/container/dialog-card/background-dialog-card.tsx","components/container/dialog-card/dialog-card.tsx","components/container/dialog-card/dialog-editor.tsx","util/geometry.ts","electron/shared/index.ts","store/stories/defaults.ts","util/is-electron.ts","components/error/error-message.tsx","components/error/global-error-boundary.tsx","components/error/safari-warning-card.tsx","components/control/checkbox-button.tsx","store/persistence/persistable-changes.ts","components/control/text-select.tsx","util/story-format/editor-extensions.ts","util/story-format/namespace.ts","util/app-info.ts","util/publish.ts","util/tag.ts","components/image/icon/empty.tsx","components/image/icon/loading.tsx","components/image/icon/file-twee.tsx","components/image/icon/twine.tsx","components/control/card-button.tsx","components/control/menu-button.tsx","components/control/prompt-button.tsx","store/use-publishing.ts","util/parse-links.ts","store/prefs/defaults.ts","util/unused-name.ts","components/control/text-input.tsx","codemirror/prefix-trigger.ts","components/control/code-area/code-area.tsx","util/i18n.ts","store/persistence/electron-ipc/prefs/load.ts","store/persistence/electron-ipc/save-json.ts","store/persistence/electron-ipc/prefs/save-middleware.ts","store/persistence/electron-ipc/stories/load.ts","store/persistence/electron-ipc/stories/save-middleware.ts","store/persistence/electron-ipc/stories/save-story.ts","store/persistence/electron-ipc/story-formats/load.ts","store/persistence/electron-ipc/story-formats/save-middleware.ts","store/persistence/local-storage/prefs/load.ts","store/persistence/local-storage/prefs/save-middleware.ts","store/persistence/local-storage/prefs/save.ts","store/persistence/local-storage/stories/save-middleware.ts","store/persistence/local-storage/stories/load.ts","store/persistence/local-storage/comma-list.ts","store/persistence/local-storage/stories/save.ts","store/persistence/local-storage/story-formats/load.ts","store/persistence/local-storage/story-formats/save.ts","store/persistence/local-storage/story-formats/save-middleware.ts","store/persistence/use-persistence.ts","store/persistence/electron-ipc/use-electron-ipc-persistence.ts","store/persistence/local-storage/use-local-storage-persistence.ts","dialogs/context/action-creators.ts","dialogs/context/reducer.ts","dialogs/context/dialogs-context.tsx","components/tag/add-tag-button.tsx","components/tag/tag-button.tsx","components/control/icon-link.tsx","components/codemirror/indent-buttons.tsx","components/codemirror/undo-redo-buttons.tsx","components/container/card/card.tsx","store/stories/getters.ts","util/story-format/fetch-properties.ts","store/story-formats/defaults.ts","store/use-store-error-reporter.ts","util/codemirror-options.ts","util/color.ts","components/container/dialog-card/dialog-stack-expander.tsx","components/container/dialog-card/dialog-stack.tsx","dialogs/passage-edit/passage-text.tsx","store/use-codemirror-passage-hints.ts","store/use-format-codemirror-mode.ts","dialogs/passage-edit/passage-toolbar.tsx","dialogs/passage-edit/story-format-toolbar.tsx","store/use-format-codemirror-toolbar.ts","dialogs/passage-edit/tag-toolbar.tsx","dialogs/passage-edit/passage-edit-contents.tsx","dialogs/passage-edit/passage-edit-stack.tsx","util/regexp.ts","components/tag/tag-stripe.tsx","dialogs/context/dialogs.tsx","util/import.ts","util/passage-is-empty.ts","components/container/button-card.tsx","components/passage/rename-passage-button.tsx","routes/story-edit/toolbar/passage/test-passage-button.tsx","store/use-story-launch.ts","store/prefs/use-computed-theme.ts","components/tag/tag-editor.tsx","store/use-stories-repair.tsx","util/twee.ts","components/meter/meter.tsx","store/format-loader.tsx","store/prefs/action-creators.ts","store/prefs/getters.ts","electron/shared/story-filename.ts","store/story-formats/action-creators.ts","store/story-formats/getters.ts","dialogs/app-donation.tsx","dialogs/passage-tags.tsx","dialogs/story-javascript.tsx","dialogs/story-search.tsx","dialogs/story-stylesheet.tsx","dialogs/story-tags.tsx","store/stories/action-creators/create-newly-linked-passages.ts","store/stories/action-creators/create-story.ts","store/stories/action-creators/create-untitled-passage.ts","store/stories/action-creators/delete-passage.ts","store/stories/action-creators/delete-story.ts","store/stories/action-creators/duplicate-story.ts","store/stories/action-creators/delete-orphaned-passages.ts","store/stories/action-creators/update-passage.ts","store/stories/action-creators/find-replace.ts","store/stories/action-creators/highlight-passages.ts","store/stories/action-creators/import-stories.ts","store/stories/action-creators/move-passages.ts","store/stories/action-creators/rename-passage-tag.ts","store/stories/action-creators/rename-story-tag.ts","store/stories/action-creators/select-passage.ts","store/stories/action-creators/select-story.ts","store/stories/action-creators/tag-color.ts","store/stories/action-creators/tag-passage.ts","store/stories/action-creators/update-story.ts","store/stories/reducer/create-passage.ts","store/stories/reducer/delete-passage.ts","store/stories/reducer/repair/repair-passage.ts","store/stories/reducer/repair/repair-story.ts","store/stories/reducer/update-passage.ts","store/stories/reducer/index.ts","store/stories/reducer/create-passages.ts","store/stories/reducer/create-story.ts","store/stories/reducer/delete-passages.ts","store/stories/reducer/delete-story.ts","store/stories/reducer/init.ts","store/stories/reducer/repair/repair-state.ts","store/stories/reducer/update-passages.ts","store/stories/reducer/update-story.ts","store/stories/stories-context.tsx","components/control/file-input.tsx","dialogs/story-import/file-chooser.tsx","dialogs/story-import/story-chooser.tsx","dialogs/story-import/story-import.tsx","store/undoable-stories/reverse-action.ts","store/undoable-stories/reverse-thunk.ts","store/undoable-stories/reducer.ts","store/undoable-stories/undoable-stories-context.tsx","components/story-format/story-format-select.tsx","dialogs/story-details/story-stats.tsx","dialogs/story-details/story-details.tsx","components/control/font-select.tsx","util/locales.ts","dialogs/app-prefs.tsx","store/prefs/prefs-context.tsx","store/prefs/reducer.ts","store/story-formats/story-formats-context.tsx","store/story-formats/reducer.ts","dialogs/about-twine/about-twine.tsx","components/loading-curtain/loading-curtain.tsx","store/locale-switcher.tsx","components/click-away-listener/click-away-listener.tsx","components/container/card-group.tsx","components/document-title/document-title.tsx","components/container/main-content.tsx","components/badge/badge.tsx","components/container/card/selectable-card.tsx","components/story-format/story-format-card/story-format-card-details.tsx","components/story-format/story-format-card/story-format-card.tsx","components/route-toolbar/back-button.tsx","components/route-toolbar/route-toolbar.tsx","util/save-file.ts","route-actions/build-actions.tsx","route-actions/app-actions.tsx","routes/story-format-list/toolbar/formats/add-story-format-button.tsx","routes/story-format-list/toolbar/formats/default-story-format-button.tsx","routes/story-format-list/toolbar/formats/proofing-story-format-button.tsx","routes/story-format-list/toolbar/formats/remove-story-format-button.tsx","routes/story-format-list/toolbar/formats/story-format-extensions-button.tsx","routes/story-format-list/toolbar/formats/format-actions.tsx","routes/story-format-list/toolbar/view-actions.tsx","routes/story-format-list/toolbar/story-format-list-toolbar.tsx","routes/story-format-list/story-format-list-route.tsx","components/marquee-selection/marquee-selection.tsx","components/passage/passage-connections/broken-connection.tsx","util/svg.ts","components/passage/passage-connections/passage-connection.tsx","components/passage/passage-connections/self-connection.tsx","components/passage/passage-connections/passage-connection-group.tsx","components/passage/passage-connections/link-markers.tsx","components/passage/passage-connections/start-connection.tsx","store/use-format-reference-parser.ts","components/passage/passage-connections/passage-connections.tsx","components/passage/passage-card.tsx","components/passage/passage-card-group.tsx","components/passage/passage-map/passage-map.tsx","routes/story-edit/marqueeable-passage-map.tsx","routes/story-edit/toolbar/passage/create-passage-button.tsx","routes/story-edit/toolbar/passage/delete-passages-button.tsx","routes/story-edit/toolbar/passage/edit-passages-buttons.tsx","routes/story-edit/toolbar/passage/go-to-passage-button.tsx","routes/story-edit/toolbar/passage/select-all-passages-button.tsx","routes/story-edit/toolbar/passage/start-at-passage-button.tsx","routes/story-edit/toolbar/passage/passage-actions.tsx","components/story/rename-story-button.tsx","routes/story-edit/toolbar/story/details-button.tsx","routes/story-edit/toolbar/story/find-replace-button.tsx","routes/story-edit/toolbar/story/javascript-button.tsx","routes/story-edit/toolbar/story/passage-tags-button.tsx","routes/story-edit/toolbar/story/stylesheet-button.tsx","routes/story-edit/toolbar/story/story-actions.tsx","routes/story-edit/toolbar/undo-redo-buttons.tsx","routes/story-edit/toolbar/story-edit-toolbar.tsx","routes/story-edit/use-zoom-transition.ts","routes/story-edit/zoom-buttons.tsx","components/fuzzy-finder/fuzzy-finder-result.tsx","components/fuzzy-finder/fuzzy-finder.tsx","routes/story-edit/passage-fuzzy-finder.tsx","routes/story-edit/story-edit-route.tsx","routes/story-edit/use-view-center.ts","routes/story-edit/use-passage-change-handlers.ts","routes/story-edit/use-zoom-shortcuts.ts","routes/story-edit/use-initial-passage-creation.ts","components/storage-quota/storage-quota.tsx","routes/story-list/toolbar/library/archive-button.tsx","routes/story-list/toolbar/library/import-story-button.tsx","routes/story-list/toolbar/library/story-tags-button.tsx","routes/story-list/toolbar/library/library-actions.tsx","routes/story-list/toolbar/story/create-story-button.tsx","components/control/confirm-button.tsx","routes/story-list/toolbar/story/delete-story-button.tsx","routes/story-list/toolbar/story/duplicate-story-button.tsx","routes/story-list/toolbar/story/edit-story-button.tsx","routes/story-list/toolbar/story/tag-story-button.tsx","routes/story-list/toolbar/story/story-actions.tsx","routes/story-list/toolbar/view/sort-by-button.tsx","routes/story-list/toolbar/view/tag-filter-button.tsx","routes/story-list/toolbar/view/view-actions.tsx","routes/story-list/toolbar/story-list-toolbar.tsx","util/hue-string.ts","components/story/story-preview.tsx","components/story/story-card.tsx","routes/story-list/story-cards.tsx","routes/story-list/story-list-route.tsx","store/prefs/use-donation-check.ts","util/replace-dom.ts","routes/story-play/story-play-route.tsx","routes/story-proof/story-proof-route.tsx","routes/story-test/story-test-route.tsx","components/welcome/welcome-card.tsx","routes/welcome/content.tsx","routes/welcome/welcome-route.tsx","routes/index.tsx","store/state-loader.tsx","store/theme-setter.tsx","app.tsx","index.tsx"],"names":["Tooltip","props","anchor","label","position","React","tooltipEl","setTooltipEl","arrowEl","setArrowEl","visible","setVisible","appearTimeout","setAppearTimeout","usePopper","modifiers","name","options","element","placement","strategy","styles","attributes","handleOnEnter","window","setTimeout","handleOnLeave","clearTimeout","addEventListener","removeEventListener","CSSTransition","classNames","in","mountOnEnter","timeout","unmountOnExit","className","ref","role","style","popper","arrow","IconButton","disabled","icon","iconOnly","iconPosition","onClick","preventDefault","selectable","selected","tooltipPosition","variant","button","setButton","undefined","e","ButtonBar","orientation","children","ButtonBarSeparator","CardContent","BackgroundDialogCard","headerLabel","onClose","onRaise","useErrorBoundary","didCatch","ErrorBoundary","error","t","useTranslation","console","floating","DialogCard","collapsed","fixedSize","highlighted","maximizable","maximized","onChangeCollapsed","onChangeHighlighted","onChangeMaximized","calcdClassName","onKeyDown","event","key","DialogEditor","lineAngle","p1","p2","Math","atan2","top","left","PI","lineDistance","hypot","rectCenter","rect","width","height","rectFromPoints","rectsIntersect","r1","r2","rectIntersectionWithLine","segmentStart","segmentEnd","result","NaN","segseg","boundingRect","rects","length","Error","right","bottom","i","rectRight","rectBottom","passageDefaults","i18n","tags","text","storyDefaults","ifid","lastUpdate","Date","passages","script","snapToGrid","startPassage","storyFormat","storyFormatVersion","stylesheet","tagColors","zoom","isElectronRenderer","navigator","userAgent","indexOf","ErrorMessage","GlobalErrorBoundary","href","rel","target","stack","SafariWarningCard","browser","UAParser","getBrowser","version","parseInt","replace","Number","isFinite","safariNavigator","standalone","canAddToHomeScreen","CheckboxButton","checkedIcon","onChange","uncheckedIcon","value","otherProps","calculatedIcon","trivialPassageProps","trivialStoryProps","trivialStoryFormatProps","isPersistablePassageChange","Object","keys","some","includes","isPersistableStoryChange","isPersistableStoryFormatChange","TextSelect","map","option","formatEditorExtensions","format","twineVersion","loadState","properties","editorExtensions","twine","extensions","filter","semverSpec","satisfies","warn","info","namespaceForFormat","toLowerCase","getAppInfo","process","archiveFilename","timestamp","toLocaleString","publishArchive","stories","appInfo","reduce","output","story","publishStory","startOptional","publishPassage","passage","localId","escape","toString","join","startLocalId","formatOptions","startId","find","p","id","passageData","forEach","index","tagData","tag","publishStoryWithFormat","formatSource","isValidTagName","test","IconEmpty","viewBox","stroke","strokeWidth","fill","strokeLinecap","strokeLinejoin","IconLoading","IconFileTwee","xmlns","d","cx","cy","r","IconTwine","xmlnsXlink","offset","stopColor","stopOpacity","xlinkHref","x1","y1","x2","y2","gradientUnits","gradientTransform","transform","CardButton","ariaLabel","onChangeOpen","focusSelector","open","other","buttonEl","setButtonEl","cardEl","setCardEl","focusTrapOptions","clickOutsideDeactivates","onDeactivate","MenuButton","items","menuEl","setMenuEl","setOpen","closer","document","item","separator","checked","PromptButton","cancelIcon","cancelLabel","onSubmit","prompt","submitIcon","submitLabel","submitVariant","validate","mounted","validation","setValidation","a","current","valid","updateValidation","message","buttonType","usePublishing","prefs","usePrefsContext","useStoryFormatsContext","storyFormatsDispatch","dispatch","formats","useStoriesContext","proofStory","storyId","storyWithId","formatWithNameAndVersion","proofingFormat","loadFormatProperties","formatProperties","source","publishOptions","publishStoryData","internalLinks","link","nonEmptyLinks","removeSetters","noSetter","getField","removeEnclosingBrackets","substr","fields","split","extractLink","tagContent","parseLinks","internalOnly","uniq","match","extractLinkTags","defaults","appTheme","codeEditorFontFamily","codeEditorFontScale","dialogWidth","disabledStoryFormatEditorExtensions","donateShown","editorCursorBlinks","firstRunTime","getTime","lastUpdateSeen","lastUpdateCheckTime","locale","userLanguage","language","browserLanguage","systemLanguage","passageEditorFontFamily","passageEditorFontScale","storyFormatListFilter","storyListSort","storyListTagFilter","storyTagColors","welcomeSeen","unusedName","existing","suffix","TextInput","type","onInput","placeholder","attachments","prefixTriggerOption","cm","prefixes","callback","checkTrigger","state","completionActive","curWord","findWordAt","getDoc","getCursor","ch","prevWordRange","prevWord","getRange","head","push","on","off","editor","inited","CodeMirror","defineOption","CodeArea","fontFamily","fontScale","fontSize","classnames","labelHidden","i18next","createInstance","use","HttpBackend","initReactI18next","init","debug","backend","loadPath","fallbackLng","interpolation","escapeValue","load","twineElectron","prefKeys","ipcRenderer","invoke","saveJson","filename","data","send","saveMiddleware","action","Array","isArray","file","importStories","htmlSource","mtime","lastState","saveStory","fetchStoryFormatProperties","url","storyWithName","oldStory","newStory","once","passageUpdates","passageId","storyFormats","uuid","userAdded","serialized","localStorage","getItem","serializedPref","JSON","parse","previouslySerialized","removeItem","ids","setItem","stringify","save","serializedStories","serializedStory","serializedPassages","serializedPassage","trim","values","addUnique","list","RegExp","contains","remove","substring","doUpdateTransaction","updater","transaction","passageIds","storyIds","savePassage","deletePassageById","passageWithName","deleteStory","passageWithId","serializedFormat","loadError","usePersistence","electronIpcPersistence","localStoragePersistence","addPassageEditors","editorLimit","currentState","passageEditStackIndex","findIndex","component","PassageEditStack","updatedPassageIds","clampedPassageIds","removePassageEditors","reducer","exists","editedState","stateDialog","isEqual","dialog","DialogsContext","dialogs","displayName","useDialogsContext","DialogsContextProvider","useThunkReducer","Provider","AddTagButton","assignedTags","existingTags","onAdd","creatingTag","setCreatingTag","newColor","setNewColor","newName","setNewName","validationMessage","canAdd","tagName","colors","color","TagButton","checkable","onChangeColor","onRemove","IconLink","IndentButtons","execCommand","command","focus","UndoRedoButtons","watch","canRedo","setCanRedo","canUndo","setCanUndo","history","historySize","redo","undo","Card","passageName","passageConnections","connectionParser","parser","passageMap","Map","draggable","broken","Set","connections","self","fixed","targetName","add","targetPassage","get","has","set","passagesMatchingFuzzySearch","search","count","fuse","Fuse","ignoreLocation","weight","limit","passagesMatchingSearch","flags","matcher","includePassageNames","matchCase","useRegexes","createRegExp","storyPassageTags","from","sort","storyStats","links","brokenLinks","characters","words","storyTags","s","requestQueue","Promise","resolve","jsonpRequester","jsonp","reject","then","resolveQueue","err","builtins","useStoreErrorReporter","useSuspense","ready","reportError","messageKey","alert","codeMirrorOptionsFromPrefs","extraKeys","Insert","cursorBlinkRate","DialogStackExpander","dialogLength","expanded","onChangeExpanded","wasTouched","setWasTouched","listener","onMouseEnter","onTouchEnd","headerHeight","DialogStack","childKeys","containerRef","setExpanded","childrenInRenderOrder","reverse","childKeysInRenderOrder","lastChildKeysInRenderOrder","foregroundIsRising","visibleLength","min","stackHasOverflow","overflowHeaderHeight","onMouseLeave","TransitionGroup","child","cardIsOverflowed","expandedTop","focusHandlers","onBlur","onFocus","rising","PassageText","onEditorChange","storyFormatExtensionsDisabled","localText","setLocalText","autocompletePassageNames","showHint","completeSingle","character","hint","doc","replaceRange","close","wordRange","word","comps","to","useCodeMirrorPassageHints","mode","formatName","formatVersion","modeName","setModeName","extensionsDisabled","formatEditorExtensionsDisabled","codeMirror","defineMode","useFormatCodeMirrorMode","onChangeText","onChangeTimeout","handleLocalChange","handleMount","refresh","lineWrapping","prefixTrigger","readOnly","editorDidMount","onBeforeChange","PassageToolbar","useUndoableStoriesContext","handleSetSize","updatePassage","addPassageTag","setTagColor","onRename","dontUpdateOthers","StoryFormatToolbar","onExecCommand","useComputedTheme","toolbarFactory","loaded","setLoaded","toolbarFunc","setToolbarFunc","namespace","commands","commandName","namespacedCommand","toolbar","environment","subitem","useFormatCodeMirrorToolbar","toolbarItems","setToolbarItems","tryToSetToolbar","getComputedStyle","foregroundColor","src","alt","TagToolbar","updateStory","handleChangeTagColor","removePassageTag","PassageEditContents","storyFormatExtensionsEnabled","setStoryFormatExtensionsEnabled","editorCrashed","setEditorCrashed","cmEditor","setCmEditor","resetError","reset","handlePassageTextChange","selections","listSelections","setSelections","InnerPassageEditStack","onChangeProps","managementProps","passageNames","handleClose","shiftKey","existingPassageIds","escapeRegExp","escapeRegExpReplace","TagStripe","title","DialogTransition","Dialogs","useScrollbarSize","hasUnmaximized","containerStyle","paddingLeft","marginBottom","marginRight","maximizedStyle","selectors","float","stringValue","parseFloat","query","el","selector","querySelectorAll","parseDimensions","raw","bits","html","lastUpdateOverride","nodes","createElement","innerHTML","storyEl","importedStory","startPassagePid","getAttribute","startPassageId","textContent","passageEl","size","domToObject","passageIsEmpty","ButtonCard","DisabledRenamePassageButton","EnabledRenamePassageButton","RenamePassageButton","TestPassageButton","testStory","useStoryLaunch","playStory","matchMedia","mediaQuery","matches","systemTheme","setSystemTheme","TagEditor","allTags","onChangeName","useStoriesRepair","useCallback","safeFormat","allFormats","defaultFormat","linebreakRegExp","escapeForTweeHeader","escapeForTweeText","passageToTwee","escapedName","repeat","metadata","escapedText","passageFromTwee","headerLine","lines","headerBits","exec","rawName","rawTags","rawMetadata","unescapeForTweeHeader","unescapeForTweeText","storyFromTwee","isScript","isStylesheet","titlePassageIndex","splice","dataPassageIndex","dataPassage","start","every","floor","storyToTwee","storyTitle","storyData","sortBy","scriptPassageName","stylesheetPassageName","Meter","domId","percent","FormatLoader","block","seenFormats","setSeenFormats","newFormats","newFormat","oldFormat","loadAllFormatProperties","loadingFormat","f","loadPercent","setPref","storyFileName","extension","createFromProperties","deleteFormat","deselectAllFormats","getFormats","deselectFormat","loadFormatThunk","hydrate","hydrateResult","Function","call","toLoad","allSettled","selectFormat","exclusive","getState","filteredFormats","semverLt","formatImageUrl","image","isAbsoluteUrl","formatWithId","newestFormatNamed","gt","sortFormats","b","AppDonationDialog","PassageTagsDialog","handleChangeColor","renamePassageTag","handleChangeTagName","StoryJavaScriptDialog","autofocus","ignoreTab","Tab","StorySearchDialog","setFlags","setReplace","setFind","debouncedFind","setDebouncedFind","closingRef","updateDebouncedFind","debounce","leading","trailing","toggleFlag","highlightPassagesMatchingSearch","replaceInStory","StoryStylesheetDialog","StoryTagsDialog","storiesDispatch","prefsDispatch","renameStoryTag","createNewlyLinkedPassages","newText","oldText","oldLinks","toCreate","l","passageDefs","passageGap","newPassagesWidth","needsMoving","createStory","createUntitledPassage","centerX","centerY","defs","bounds","max","round","deletePassages","duplicateStory","deleteOrphanedPassages","newLinks","orphan","orphanPassage","oldName","updatedStory","oldNameEscaped","newNameEscaped","simpleLinkRegexp","compoundLinkRegexp","reverseLinkRegexp","relinkedPassage","replaceText","searchFor","replaceWith","replacer","replaceInPassage","matchIds","oldHighlighted","newHighlighted","toImport","existingStories","importStory","otherStory","existingStory","movePassages","xChange","yChange","deselectPassage","selectAllPassages","selectPassage","selectPassagesInRect","ignoreIds","deselectStory","deselectAllStories","selectStory","createPassage","passageProps","storyExists","created","newState","newPassage","deletePassage","foundStory","deleted","logRepair","propName","repairedValue","detail","repairStory","allStories","storyDefs","repairs","newId","newIfid","entries","defKey","repairFormat","anyPassageRepaired","repairedPassages","repairedPassage","parentStory","pos","posKey","dim","dimKey","otherPassage","repairPassage","updated","createPassages","storyProps","toUpperCase","repairState","updatePassages","StoriesContext","StoriesContextProvider","storiesPersistence","persistedReducer","FileInput","onError","changeEvent","files","reader","FileReader","loadEvent","readAsText","FileChooser","accept","StoryChooser","onImport","selectedStories","setSelectedStories","willReplaceExisting","handleChange","StoryImportDialog","repairStories","setFile","setStories","handleImport","reverseAction","prop","passageResult","reverseThunk","thunk","actions","actionOrThunk","newChange","description","storiesState","newChanges","changes","slice","currentChange","change","UndoableStoriesContext","UndoableStoriesContextProvider","dispatchAndRecordStoryAction","redoLabel","undoLabel","StoryFormatSelect","selectedFormat","loadingFormats","loadingCount","dateFormatter","Intl","DateTimeFormat","dateStyle","timeStyle","StoryDetailsDialogStats","stats","date","StoryDetailsDialog","families","scales","FontSelect","familyLabel","onChangeFamily","onChangeScale","scaleLabel","customScaleVisible","setCustomScaleVisible","customFamilyVisible","setCustomFamilyVisible","customFamily","setCustomFamily","customScale","setCustomScale","scale","locales","code","closestAppLocale","roughCode","roughMatch","AppPrefsDialog","PrefsContext","PrefsContextProvider","prefKey","defaultBuiltins","StoryFormatsContext","StoryFormatsContextProvider","builtinFormats","keep","builtinFormat","AboutTwineDialog","dangerouslySetInnerHTML","__html","credits","c","localizations","LoadingCurtain","LocaleSwitcher","changeLanguage","ClickAwayListener","ignoreSelector","onClickAway","closest","CardGroup","gridTemplateColumns","columnWidth","columns","maxWidth","DocumentTitle","querySelector","Helmet","MainContent","grabbable","padded","dragScrollStart","dragMouseStart","container","moveListener","scrollLeft","clientX","scrollTop","clientY","stopGrab","releasePointerCapture","pointerId","cursor","upListener","downListener","setPointerCapture","ignoreContext","Badge","SelectableCard","onDoubleClick","onSelect","ctrlKey","tabIndex","StoryFormatCardDetails","errorMessage","author","license","StoryFormatCard","editorExtensionsDisabled","proofing","BackButton","useHistory","location","pathname","goBack","RouteToolbar","helpUrl","pinnedControls","tabs","selectedTabClassName","tabName","tabContent","saveHtml","Blob","saveAs","BuildActions","playError","setPlayError","proofError","setProofError","publishError","setPublishError","testError","setTestError","resetErrors","saveTwee","AppActions","isValidUrl","URL","AddStoryFormatButton","newFormatUrl","setNewFormatUrl","storyFormatName","DefaultStoryFormatButton","ProofingStoryFormatButton","RemoveStoryFormatButton","isDefault","isProofing","StoryFormatExtensionsButton","FormatActions","selectedFormats","ViewActions","setFilter","StoryFormatListToolbar","StoryFormatListRoute","formatsDispatch","visibleFormats","disabledFormat","handleSelect","MarqueeSelection","ignoreEventsOnSelector","onSelectRect","onTemporarySelectRect","additive","setAdditive","dragging","setDragging","setStart","setCurrent","currentContainerRect","currentContainer","relativePointerPos","pointerType","getBoundingClientRect","lineOffset","sqrt","BrokenConnection","markerEnd","arc","end","radius","largeArc","sweep","rotation","PassageConnection","path","offsetStart","offsetEnd","startPoint","endPoint","distance","SelfConnection","PassageConnectionGroup","connection","LinkMarkers","refX","refY","markerWidth","markerHeight","orient","StartConnection","markerStart","emptyFunc","emptySet","noOffset","PassageConnections","referenceParser","setEditorExtensions","references","parsePassageText","useFormatReferenceParser","draggableLinks","fixedLinks","draggableReferences","fixedReferences","PassageCard","onDeselect","onDrag","onDragStart","onDragStop","onEdit","empty","excerpt","deviceType","handleMouseDown","handleEdit","nodeRef","onMouseDown","onStart","onStop","PassageCardGroup","sortedPassages","dragReducer","dragX","x","dragY","y","startX","startY","PassageMap","visibleZoom","compactCards","setCompactCards","passageBounds","setProperty","handleDragStart","body","classList","handleDrag","handleDragStop","MarqueeablePassageMap","temporaryRect","setTemporaryRect","temporaryAdditive","setTemporaryAdditive","innerPassages","handleTemporarySelectRect","handleSelectRect","CreatePassageButton","getCenter","handleClick","DeletePassagesButton","useHotkeys","EditPassagesButton","GoToPassageButton","onOpenFuzzyFinder","SelectAllPassagesButton","StartAtPassageButton","PassageActions","selectedPassages","soloSelectedPassage","handleRename","DisabledRenameStoryButton","EnabledRenameStoryButton","RenameStoryButton","DetailsButton","FindReplaceButton","JavaScriptButton","PassageTagsButton","StylesheetButton","StoryActions","StoryEditToolbar","useZoomTransition","scrollTarget","transition","step","requestAnimationFrame","lastTimestamp","elapsed","setter","time","quadOut","transitionStep","newLeft","scrollNormalizedCenter","scrollCenter","newTop","clientWidth","clientHeight","ZoomButtons","handleZoomChange","FuzzyFinderResult","heading","elementIsFocused","activeElement","FuzzyFinder","noResultsText","onChangeSearch","onSelectResult","results","selectedResult","setSelectedResult","inputRef","enableOnTags","PassageFuzzyFinder","onOpen","setCenter","setSearch","debouncedSearch","setDebouncedSearch","updateDebouncedSearch","InnerStoryEditRoute","useParams","fuzzyFinderOpen","setFuzzyFinderOpen","mainContent","elementRef","scroll","scrollTo","useViewCenter","undoableStoriesDispatch","dialogsDispatch","handleDeselectPassage","handleDragPassages","abs","handleEditPassage","handleSelectPassage","logicalRect","usePassageChangeHandlers","keydown","keyup","useZoomShortcuts","setInited","center","useInitialPassageCreation","StoryEditRoute","StorageQuota","lastWatch","setLastWatch","working","setWorking","percentFree","setPercentFree","hide","storage","estimate","quota","usage","toFixed","run","ArchiveButton","ImportStoryButton","StoryTagsButton","LibraryActions","CreateStoryButton","ConfirmButton","confirmIcon","confirmLabel","confirmVariant","onConfirm","DeleteStoryButton","storyName","setStoryName","DuplicateStoryButton","EditStoryButton","TagStoryButton","tagColor","selectedStory","SortByButton","TagFilterButton","StoryListToolbar","hueString","charCodeAt","StoryPreview","hues","minX","POSITIVE_INFINITY","minY","maxX","NEGATIVE_INFINITY","maxY","svg","circle","bgRadius","StoryCard","onChangeTagColor","onRemoveTag","StoryCards","onSelectStory","handleRemoveTag","InnerStoryListRoute","shouldShowDonationPrompt","now","useDonationCheck","visibleStories","filteredStories","StoryListRoute","replaceDom","SVG","Store","StoryFormat","amdDefine","app","jQuery","write","StoryPlayRoute","StoryProofRoute","StoryTestRoute","WelcomeCard","nextLabel","onNext","onSkip","showSkip","content","WelcomeRoute","containerEl","shown","setShown","allCards","visibleCards","lastCard","documentElement","offsetTop","duration","finish","showNext","card","Routes","exact","render","StateLoader","initing","setIniting","prefsRepaired","setPrefsRepaired","formatsRepaired","setFormatsRepaired","storiesRepaired","setStoriesRepaired","prefsState","formatsState","ThemeSetter","computedTheme","dataset","App","fallback","ReactDOM","getElementById"],"mappings":"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","file":"static/js/main.a538283f.chunk.js","sourcesContent":["export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './stories-context';\nexport * from './stories.types';\nexport * from './zoom';\n","import * as React from 'react';\nimport {CSSTransition} from 'react-transition-group';\nimport {usePopper} from 'react-popper';\nimport {Placement} from '@popperjs/core';\nimport './tooltip.css';\n\nexport interface TooltipProps {\n\tanchor: HTMLElement | null;\n\tlabel: string;\n\tposition?: Placement;\n}\n\n// This component is intentionally limited in functionality. It should *only* be\n// used to duplicate content that is only perceivable by screen readers or other\n// assistive technology, e.g. through an `aria-label` attribute. The one use\n// case right now in the app are icon-only buttons.\n//\n// Content in these components is *not* accessible to screen readers and should\n// not be. That content should be placed in an `aria-label` attribute instead.\n\nexport const Tooltip: React.FC<TooltipProps> = props => {\n\tconst {anchor, label, position = 'top'} = props;\n\tconst [tooltipEl, setTooltipEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [arrowEl, setArrowEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [visible, setVisible] = React.useState(false);\n\tconst [appearTimeout, setAppearTimeout] = React.useState<number>();\n\tconst {styles, attributes} = usePopper(anchor, tooltipEl, {\n\t\tmodifiers: [{name: 'arrow', options: {element: arrowEl}}, {name: 'flip'}],\n\t\tplacement: position,\n\t\tstrategy: 'fixed'\n\t});\n\n\tReact.useEffect(() => {\n\t\tconst handleOnEnter = () =>\n\t\t\tsetAppearTimeout(window.setTimeout(() => setVisible(true), 500));\n\t\tconst handleOnLeave = () => {\n\t\t\tif (appearTimeout) {\n\t\t\t\twindow.clearTimeout(appearTimeout);\n\t\t\t}\n\n\t\t\tsetVisible(false);\n\t\t};\n\n\t\tif (anchor) {\n\t\t\tanchor.addEventListener('pointerenter', handleOnEnter);\n\t\t\tanchor.addEventListener('pointerleave', handleOnLeave);\n\t\t\treturn () => {\n\t\t\t\tanchor.removeEventListener('pointerenter', handleOnEnter);\n\t\t\t\tanchor.removeEventListener('pointerleave', handleOnLeave);\n\t\t\t};\n\t\t}\n\t}, [anchor, appearTimeout]);\n\n\treturn (\n\t\t<CSSTransition\n\t\t\tclassNames=\"fade-in-out\"\n\t\t\tin={visible}\n\t\t\tmountOnEnter\n\t\t\ttimeout={200}\n\t\t\tunmountOnExit\n\t\t>\n\t\t\t<div\n\t\t\t\taria-hidden\n\t\t\t\tclassName=\"tooltip\"\n\t\t\t\tref={setTooltipEl}\n\t\t\t\trole=\"tooltip\"\n\t\t\t\tstyle={styles.popper}\n\t\t\t\t{...attributes.popper}\n\t\t\t>\n\t\t\t\t<div className=\"tooltip-arrow\" ref={setArrowEl} style={styles.arrow} />\n\t\t\t\t<div className=\"tooltip-label\">{label}</div>\n\t\t\t</div>\n\t\t</CSSTransition>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './icon-button-link.css';\nimport {Tooltip, TooltipProps} from '../tooltip';\n\nexport interface IconButtonProps {\n\tbuttonType?: 'button' | 'submit';\n\tdisabled?: boolean;\n\ticon: React.ReactNode;\n\ticonOnly?: boolean;\n\ticonPosition?: 'start' | 'end';\n\tlabel: string;\n\tonClick?: (e: React.MouseEvent) => void;\n\tpreventDefault?: boolean;\n\tselectable?: boolean;\n\tselected?: boolean;\n\ttooltipPosition?: TooltipProps['position'];\n\tvariant?: 'create' | 'danger' | 'primary' | 'secondary';\n}\n\nexport const IconButton = React.forwardRef<HTMLButtonElement, IconButtonProps>(\n\t(props, ref) => {\n\t\tconst {\n\t\t\tdisabled,\n\t\t\ticon,\n\t\t\ticonOnly,\n\t\t\ticonPosition = 'start',\n\t\t\tonClick,\n\t\t\tpreventDefault,\n\t\t\tselectable = false,\n\t\t\tselected = false,\n\t\t\ttooltipPosition,\n\t\t\tvariant = 'secondary'\n\t\t} = props;\n\t\tconst className = classNames(\n\t\t\t'icon-button',\n\t\t\t`icon-position-${iconPosition}`,\n\t\t\t{selected: selected},\n\t\t\t`variant-${variant}`,\n\t\t\t{'icon-only': iconOnly}\n\t\t);\n\t\tconst [button, setButton] = React.useState<HTMLButtonElement | null>(null);\n\t\tReact.useImperativeHandle(ref, () => button as HTMLButtonElement);\n\t\tconst handleOnClick = (e: React.MouseEvent) => {\n\t\t\tonClick && onClick(e);\n\n\t\t\tif (preventDefault) {\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t};\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<button\n\t\t\t\t\taria-label={iconOnly ? props.label : undefined}\n\t\t\t\t\taria-pressed={selectable ? selected : undefined}\n\t\t\t\t\tdisabled={disabled}\n\t\t\t\t\tclassName={className}\n\t\t\t\t\tonClick={handleOnClick}\n\t\t\t\t\tref={setButton}\n\t\t\t\t>\n\t\t\t\t\t<span className=\"icon\">{icon}</span>\n\t\t\t\t\t{!iconOnly && props.label}\n\t\t\t\t</button>\n\t\t\t\t{iconOnly && (\n\t\t\t\t\t<Tooltip\n\t\t\t\t\t\tanchor={button}\n\t\t\t\t\t\tlabel={props.label}\n\t\t\t\t\t\tposition={tooltipPosition}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n);\n","export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './prefs-context';\nexport * from './prefs.types';\n","export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './story-formats-context';\nexport * from './story-formats.types';\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './button-bar.css';\n\nexport interface ButtonBarProps {\n\torientation?: 'horizontal' | 'vertical';\n}\n\nexport const ButtonBar: React.FC<ButtonBarProps> = props => (\n\t<div\n\t\tclassName={classNames(\n\t\t\t'button-bar',\n\t\t\t`orientation-${props.orientation ?? 'horizontal'}`\n\t\t)}\n\t>\n\t\t{props.children}\n\t</div>\n);\n","import * as React from 'react';\nimport './button-bar-separator.css';\n\nexport const ButtonBarSeparator: React.FC = () => (\n\t<div className=\"button-bar-separator\" />\n);\n","import * as React from 'react';\nimport './card-content.css';\n\nexport const CardContent: React.FC = ({children}) => (\n\t<div className=\"card-content\">{children}</div>\n);\n","export * from './about-twine';\nexport * from './app-donation';\nexport * from './app-prefs';\nexport * from './context';\nexport * from './context/dialogs';\nexport * from './dialogs.types';\nexport * from './passage-edit';\nexport * from './passage-tags';\nexport * from './story-import';\nexport * from './story-javascript';\nexport * from './story-details';\nexport * from './story-search';\nexport * from './story-stylesheet';\nexport * from './story-tags';\n","export * from './undoable-stories-context';\nexport * from './undoable-stories.types';\n","import {IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport useErrorBoundary from 'use-error-boundary';\nimport {IconButton} from '../../control/icon-button';\nimport {ErrorMessage} from '../../error';\nimport {Card} from '../card';\nimport './dialog-card.css';\n\nexport interface BackgroundDialogCardProps {\n\theaderLabel: string;\n\tonClose: (event?: React.MouseEvent) => void;\n\tonRaise: () => void;\n}\n\nexport const BackgroundDialogCard: React.FC<\n\tBackgroundDialogCardProps\n> = props => {\n\tconst {children, headerLabel, onClose, onRaise} = props;\n\tconst {didCatch, ErrorBoundary, error} = useErrorBoundary();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\t}, [error]);\n\n\treturn (\n\t\t<div aria-label={headerLabel} className=\"dialog-card background\">\n\t\t\t<Card floating>\n\t\t\t\t<h2>\n\t\t\t\t\t<div className=\"dialog-card-header\">\n\t\t\t\t\t\t<IconButton icon={null} label={headerLabel} onClick={onRaise} />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"dialog-card-header-controls\">\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\t\ticonOnly\n\t\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\ttooltipPosition=\"bottom\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</h2>\n\t\t\t\t{didCatch ? (\n\t\t\t\t\t<ErrorMessage>\n\t\t\t\t\t\t{t('components.dialogCard.contentsCrashed')}\n\t\t\t\t\t</ErrorMessage>\n\t\t\t\t) : (\n\t\t\t\t\t<ErrorBoundary>{children}</ErrorBoundary>\n\t\t\t\t)}\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {useTranslation} from 'react-i18next';\nimport {\n\tIconArrowsDiagonal,\n\tIconArrowsDiagonalMinimize,\n\tIconChevronDown,\n\tIconChevronUp,\n\tIconX\n} from '@tabler/icons';\nimport {Card} from '../card';\nimport {IconButton} from '../../control/icon-button';\nimport './dialog-card.css';\nimport useErrorBoundary from 'use-error-boundary';\nimport {ErrorMessage} from '../../error';\n\nexport interface DialogCardProps {\n\tclassName?: string;\n\tcollapsed: boolean;\n\tfixedSize?: boolean;\n\theaderLabel: string;\n\thighlighted?: boolean;\n\tmaximizable?: boolean;\n\tmaximized?: boolean;\n\tonChangeCollapsed: (value: boolean) => void;\n\tonChangeHighlighted: (value: boolean) => void;\n\tonChangeMaximized: (value: boolean) => void;\n\tonClose: (event?: React.KeyboardEvent | React.MouseEvent) => void;\n}\n\nexport const DialogCard: React.FC<DialogCardProps> = props => {\n\tconst {\n\t\tchildren,\n\t\tclassName,\n\t\tcollapsed,\n\t\tfixedSize,\n\t\theaderLabel,\n\t\thighlighted,\n\t\tmaximizable,\n\t\tmaximized,\n\t\tonChangeCollapsed,\n\t\tonChangeHighlighted,\n\t\tonChangeMaximized,\n\t\tonClose\n\t} = props;\n\tconst {didCatch, ErrorBoundary, error} = useErrorBoundary();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\t}, [error]);\n\n\tReact.useEffect(() => {\n\t\tif (highlighted) {\n\t\t\tconst timeout = window.setTimeout(() => onChangeHighlighted(false), 400);\n\n\t\t\treturn () => window.clearTimeout(timeout);\n\t\t}\n\t}, [highlighted, onChangeHighlighted]);\n\n\tconst calcdClassName = classNames('dialog-card', className, {\n\t\tcollapsed,\n\t\thighlighted,\n\t\t'fixed-size': fixedSize,\n\t\tmaximized\n\t});\n\n\tfunction handleKeyDown(event: React.KeyboardEvent) {\n\t\tif (event.key === 'Escape') {\n\t\t\tonClose(event);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div\n\t\t\taria-label={headerLabel}\n\t\t\trole=\"dialog\"\n\t\t\tclassName={calcdClassName}\n\t\t\tonKeyDown={handleKeyDown}\n\t\t>\n\t\t\t<Card floating>\n\t\t\t\t<h2>\n\t\t\t\t\t<div className=\"dialog-card-header\">\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={collapsed ? <IconChevronUp /> : <IconChevronDown />}\n\t\t\t\t\t\t\tlabel={headerLabel}\n\t\t\t\t\t\t\tonClick={() => onChangeCollapsed(!collapsed)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"dialog-card-header-controls\">\n\t\t\t\t\t\t{maximizable && (\n\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\ticon={\n\t\t\t\t\t\t\t\t\tmaximized ? (\n\t\t\t\t\t\t\t\t\t\t<IconArrowsDiagonalMinimize />\n\t\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t\t<IconArrowsDiagonal />\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ticonOnly\n\t\t\t\t\t\t\t\tlabel={\n\t\t\t\t\t\t\t\t\tmaximized ? t('common.unmaximize') : t('common.maximize')\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tonClick={() => onChangeMaximized(!maximized)}\n\t\t\t\t\t\t\t\ttooltipPosition=\"bottom\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\t\ticonOnly\n\t\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\ttooltipPosition=\"bottom\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</h2>\n\t\t\t\t{didCatch ? (\n\t\t\t\t\t<ErrorMessage>\n\t\t\t\t\t\t{t('components.dialogCard.contentsCrashed')}\n\t\t\t\t\t</ErrorMessage>\n\t\t\t\t) : (\n\t\t\t\t\t<ErrorBoundary>{!collapsed && children}</ErrorBoundary>\n\t\t\t\t)}\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport './dialog-editor.css';\n\nexport const DialogEditor: React.FC = props => (\n\t<div className=\"dialog-editor\">{props.children}</div>\n);\n","import segseg, {SegSegVector} from 'segseg';\n\nexport interface Point {\n\ttop: number;\n\tleft: number;\n}\n\nexport interface Rect extends Point {\n\theight: number;\n\twidth: number;\n}\n\n/**\n * Returns the angle between two points in degrees.\n * @see https://gist.github.com/conorbuck/2606166\n */\nexport function lineAngle(p1: Point, p2: Point) {\n\treturn (Math.atan2(p2.top - p1.top, p2.left - p1.left) * 180) / Math.PI;\n}\n\n/**\n * Returns the length of the line segment between two points.\n */\nexport function lineDistance(p1: Point, p2: Point) {\n\treturn Math.hypot(p1.left - p2.left, p1.top - p2.top);\n}\n\n/**\n * Returns the center of a rectangle.\n */\nexport function rectCenter(rect: Rect): Point {\n\treturn {left: rect.left + rect.width / 2, top: rect.top + rect.height / 2};\n}\n\n/**\n * Creates a rectangle from two points, regardless of their relative position.\n */\n\nexport function rectFromPoints(p1: Point, p2: Point): Rect {\n\tconst rect: Rect = {height: 0, left: 0, top: 0, width: 0};\n\n\tif (p1.left < p2.left) {\n\t\trect.left = p1.left;\n\t\trect.width = p2.left - p1.left;\n\t} else {\n\t\trect.left = p2.left;\n\t\trect.width = p1.left - p2.left;\n\t}\n\n\tif (p1.top < p2.top) {\n\t\trect.top = p1.top;\n\t\trect.height = p2.top - p1.top;\n\t} else {\n\t\trect.top = p2.top;\n\t\trect.height = p1.top - p2.top;\n\t}\n\n\treturn rect;\n}\n\n/**\n * Returns whether two rectangles intersect.\n * @see http://stackoverflow.com/questions/2752349/fast-rectangle-to-rectangle-intersection\n */\nexport function rectsIntersect(r1: Rect, r2: Rect) {\n\treturn !(\n\t\tr2.left > r1.left + r1.width ||\n\t\tr2.left + r2.width < r1.left ||\n\t\tr2.top > r1.top + r1.height ||\n\t\tr2.top + r2.height < r1.top\n\t);\n}\n\n/**\n * Returns the intersection point between a rectangle and a line segment. If\n * none exists, this returns null.\n */\nexport function rectIntersectionWithLine(\n\trect: Rect,\n\tsegmentStart: Point,\n\tsegmentEnd: Point\n): Point | null {\n\tlet result: SegSegVector = [NaN, NaN];\n\n\t// Left side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top],\n\t\t\t[rect.left, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Right side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left + rect.width, rect.top],\n\t\t\t[rect.left + rect.width, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Top side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top],\n\t\t\t[rect.left + rect.width, rect.top],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Bottom side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top + rect.height],\n\t\t\t[rect.left + rect.width, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\treturn null;\n}\n\n/**\n * Returns a rectangle enclosing a set of rectangles.\n */\nexport function boundingRect(rects: Rect[]) {\n\tif (rects.length === 0) {\n\t\tthrow new Error(\"Can't calculate bounding rect for 0 rects\");\n\t}\n\n\tlet left = rects[0].left;\n\tlet right = rects[0].left + rects[0].width;\n\tlet top = rects[0].top;\n\tlet bottom = rects[0].top + rects[0].height;\n\n\tfor (let i = 1; i < rects.length; i++) {\n\t\tconst rectRight = rects[i].left + rects[i].width;\n\t\tconst rectBottom = rects[i].top + rects[i].height;\n\n\t\tif (rects[i].left < left) {\n\t\t\tleft = rects[i].left;\n\t\t}\n\n\t\tif (rects[i].top < top) {\n\t\t\ttop = rects[i].top;\n\t\t}\n\n\t\tif (rectRight > right) {\n\t\t\tright = rectRight;\n\t\t}\n\n\t\tif (rectBottom > bottom) {\n\t\t\tbottom = rectBottom;\n\t\t}\n\t}\n\n\treturn {left, top, height: bottom - top, width: right - left};\n}\n","export * from './electron-shared.types';\nexport * from './story-filename';\n","import {i18n} from '../../util/i18n';\nimport {Passage, Story} from './stories.types';\n\nexport const passageDefaults = (): Omit<Passage, 'id' | 'story'> => ({\n\theight: 100,\n\thighlighted: false,\n\tleft: 0,\n\tname: i18n.t('store.passageDefaults.name'),\n\tselected: false,\n\ttags: [],\n\ttext: '',\n\ttop: 0,\n\twidth: 100\n});\n\nexport const storyDefaults = (): Omit<Story, 'id'> => ({\n\tifid: '',\n\tlastUpdate: new Date(),\n\tpassages: [],\n\tname: i18n.t('store.storyDefaults.name'),\n\tscript: '',\n\tselected: false,\n\tsnapToGrid: true,\n\tstartPassage: '',\n\tstoryFormat: '',\n\tstoryFormatVersion: '',\n\tstylesheet: '',\n\ttags: [],\n\ttagColors: {},\n\tzoom: 1\n});\n","/**\n * Is this code currently in an Electron renderer process? Returns false if\n * either this is running in the Electron main process, or Electron is not\n * involved at all.\n * @see https://github.com/electron/electron/issues/2288#issuecomment-337858978\n */\nexport const isElectronRenderer = () =>\n\twindow.navigator.userAgent.indexOf('Electron') !== -1;\n\n/**\n * Is this code currently running in an Electron main process? Returns false if\n * either this is running in an Electron renderer process, or Electron is not\n * involved at all.\n * @see https://github.com/electron/electron/issues/2288#issuecomment-611231970\n */\n\nexport const isElectronMain = () => process.versions.hasOwnProperty('electron');\n","import {IconAlertOctagon} from '@tabler/icons';\nimport * as React from 'react';\nimport './error-message.css';\n\nexport const ErrorMessage: React.FC = ({children}) => (\n\t<div className=\"error-message\">\n\t\t<IconAlertOctagon />\n\t\t<div className=\"message\">{children}</div>\n\t</div>\n);\n","import * as React from 'react';\nimport useErrorBoundary from 'use-error-boundary';\nimport {ErrorMessage} from './error-message';\nimport './global-error-boundary.css';\n\nexport const GlobalErrorBoundary: React.FC = ({children}) => {\n\tconst {ErrorBoundary, didCatch, error} = useErrorBoundary();\n\n\t// Non-localized because our localization might be broken.\n\n\treturn didCatch ? (\n\t\t<div className=\"global-error-boundary\">\n\t\t\t<div>\n\t\t\t\t<ErrorMessage>\n\t\t\t\t\t<p>Something went wrong and Twine can't continue.</p>\n\t\t\t\t\t<p>Please try restarting Twine or reloading the page.</p>\n\t\t\t\t\t<p>\n\t\t\t\t\t\tIf you see this message repeatedly, please{' '}\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref=\"https://twinery.org/2bugs\"\n\t\t\t\t\t\t\trel=\"noreferrer\"\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\treport a bug\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t.\n\t\t\t\t\t</p>\n\t\t\t\t</ErrorMessage>\n\t\t\t\t<p>Details:</p>\n\t\t\t\t<pre>{error.stack}</pre>\n\t\t\t</div>\n\t\t</div>\n\t) : (\n\t\t<ErrorBoundary>{children}</ErrorBoundary>\n\t);\n};","import {IconInfoCircle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport UAParser from 'ua-parser-js';\nimport {ButtonBar} from '../container/button-bar';\nimport {Card} from '../container/card';\nimport {IconLink} from '../control/icon-link';\nimport {ErrorMessage} from '../error';\nimport './safari-warning-card.css';\n\nexport interface SafariNavigator extends Navigator {\n\tstandalone?: boolean;\n}\n\nexport const SafariWarningCard: React.FC = props => {\n\tconst {t} = useTranslation();\n\tconst browser = new UAParser().getBrowser();\n\n\tif (browser.name !== 'Safari') {\n\t\treturn null;\n\t}\n\n\tif (browser.version) {\n\t\tconst version = parseInt(browser.version.replace(/\\..*/, ''));\n\n\t\tif (Number.isFinite(version) && version < 13) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tconst safariNavigator = window.navigator as SafariNavigator;\n\n\tif (safariNavigator.standalone) {\n\t\t// We are in \"standalone\" or full-screen mode. This is supposed to have\n\t\t// its own localStorage which is not subject to the seven-day limit.\n\t\t// https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html\n\t\treturn null;\n\t}\n\n\tconst canAddToHomeScreen = safariNavigator.standalone !== undefined;\n\n\treturn (\n\t\t<div className=\"safari-warning-card\">\n\t\t\t<Card>\n\t\t\t\t<ErrorMessage>\n\t\t\t\t\t<p>{t('components.safariWarningCard.message')}</p>\n\t\t\t\t\t{canAddToHomeScreen && (\n\t\t\t\t\t\t<p>{t('components.safariWarningCard.addToHomeScreen')}</p>\n\t\t\t\t\t)}\n\t\t\t\t\t<p>{t('components.safariWarningCard.archiveAndUseAnotherBrowser')}</p>\n\t\t\t\t</ErrorMessage>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://twinery.org/2ioslocalstorage\"\n\t\t\t\t\t\ticon={<IconInfoCircle />}\n\t\t\t\t\t\tlabel={t('components.safariWarningCard.learnMore')}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t\t{canAddToHomeScreen && (\n\t\t\t\t\t\t<IconLink\n\t\t\t\t\t\t\thref=\"https://twinery.org/2ioshomescreen\"\n\t\t\t\t\t\t\ticon={<IconInfoCircle />}\n\t\t\t\t\t\t\tlabel={t('components.safariWarningCard.howToAddToHomeScreen')}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</ButtonBar>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {IconSquare, IconSquareCheck} from '@tabler/icons';\nimport {IconButton, IconButtonProps} from './icon-button';\n\nexport interface CheckboxButtonProps\n\textends Omit<IconButtonProps, 'icon' | 'onClick'> {\n\tcheckedIcon?: React.ReactNode;\n\ticon?: React.ReactNode;\n\tonChange: (value: boolean) => void;\n\tuncheckedIcon?: React.ReactNode;\n\tvalue: boolean;\n}\n\nexport const CheckboxButton: React.FC<CheckboxButtonProps> = props => {\n\tconst {\n\t\tcheckedIcon,\n\t\ticon,\n\t\tonChange,\n\t\tuncheckedIcon,\n\t\tvalue,\n\t\t...otherProps\n\t} = props;\n\tconst calculatedIcon = value\n\t\t? checkedIcon ?? <IconSquareCheck />\n\t\t: uncheckedIcon ?? <IconSquare />;\n\n\treturn (\n\t\t<span\n\t\t\taria-disabled={otherProps.disabled}\n\t\t\tclassName=\"checkbox-button\"\n\t\t\trole=\"checkbox\"\n\t\t\taria-checked={value}\n\t\t>\n\t\t\t<IconButton\n\t\t\t\ticon={icon ?? calculatedIcon}\n\t\t\t\tonClick={() => onChange(!value)}\n\t\t\t\t{...otherProps}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import {Passage, Story} from '../stories';\nimport {StoryFormat} from '../story-formats';\n\nconst trivialPassageProps: (keyof Passage)[] = ['highlighted', 'selected'];\nconst trivialStoryProps: (keyof Story)[] = ['lastUpdate', 'selected'];\n\n// Loosely typing this because of the different load states possible in the type.\nconst trivialStoryFormatProps: string[] = [\n\t'loadError',\n\t'loadState',\n\t'properties',\n\t'selected'\n];\n\n/**\n * Is a passage change persistable? e.g. is it nontrivial?\n */\nexport function isPersistablePassageChange(props: Partial<Passage>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialPassageProps.includes(key as keyof Passage)\n\t);\n}\n\n/**\n * Is a story change persistable? e.g. is it nontrivial?\n */\nexport function isPersistableStoryChange(props: Partial<Story>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialStoryProps.includes(key as keyof Story)\n\t);\n}\n\n/**\n * Is a story format persistable? e.g. is it nontrivial?\n */\nexport function isPersistableStoryFormatChange(props: Partial<StoryFormat>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialStoryFormatProps.includes(key as keyof StoryFormat)\n\t);\n}","import * as React from 'react';\nimport classNames from 'classnames';\nimport './text-select.css';\n\nexport interface SelectOption {\n\tdisabled?: boolean;\n\tlabel: string;\n\tvalue: string;\n}\n\nexport interface TextSelectProps {\n\tchildren: React.ReactNode;\n\tonChange?: React.ChangeEventHandler<HTMLSelectElement>;\n\toptions: SelectOption[];\n\torientation?: 'horizontal' | 'vertical';\n\tvalue: string;\n}\n\nexport const TextSelect: React.FC<TextSelectProps> = props => {\n\tconst {children, onChange, options, orientation, value} = props;\n\tconst className = classNames(\n\t\t'text-select',\n\t\t`orientation-${orientation ?? 'horizontal'}`\n\t);\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"text-select-label\">{children}</span>\n\t\t\t\t<span className=\"text-select-control\">\n\t\t\t\t\t<select onChange={onChange} value={value}>\n\t\t\t\t\t\t{options.map(option => (\n\t\t\t\t\t\t\t<option\n\t\t\t\t\t\t\t\tdisabled={option.disabled}\n\t\t\t\t\t\t\t\tkey={option.value}\n\t\t\t\t\t\t\t\tvalue={option.value}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{option.label}\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</select>\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import {StoryFormat} from '../../store/story-formats';\nimport {satisfies} from 'semver';\n\n/**\n * Returns editor extensions in a format that fit the Twine version specified.\n * If none are available, then this returns undefined.\n */\nexport function formatEditorExtensions(\n\tformat: StoryFormat,\n\ttwineVersion: string\n) {\n\tif (format.loadState !== 'loaded') {\n\t\treturn;\n\t}\n\n\tif (!format.properties.editorExtensions?.twine) {\n\t\treturn;\n\t}\n\n\tconst extensions = Object.keys(\n\t\tformat.properties.editorExtensions.twine\n\t).filter(semverSpec => satisfies(twineVersion, semverSpec));\n\n\tif (extensions.length === 0) {\n\t\tconsole.info(\n\t\t\t`${format.name} ${format.version} has editor extensions, but none that ${twineVersion} satisfies`\n\t\t);\n\t\treturn;\n\t}\n\n\tif (extensions.length > 1) {\n\t\tconsole.warn(\n\t\t\t`More than one set of editor extensions for ${format.name} ${format.version} is satisfied by ${twineVersion}. Using the first.`\n\t\t);\n\t}\n\n\treturn format.properties.editorExtensions.twine[extensions[0]];\n}\n","import {StoryFormat} from '../../store/story-formats';\n\n/**\n * Returns a namespace prefix for a story format that is compatible with\n * CodeMirror names (modes and commands).\n */\nexport function namespaceForFormat(format: StoryFormat) {\n\treturn format.name.toLowerCase().replace(/\\s/g, '-') + '-' + format.version;\n}\n","export interface AppInfo {\n\tname: string;\n\tversion: string;\n}\n\n/**\n * Retrieves information about the Twine app itself based on buildtime\n * environment\n */\nexport function getAppInfo(): AppInfo {\n\treturn {\n\t\tname: process.env.REACT_APP_NAME as string,\n\t\tversion: process.env.REACT_APP_VERSION as string\n\t};\n}\n","import escape from 'lodash/escape';\nimport {Passage, Story} from '../store/stories';\nimport {AppInfo} from './app-info';\nimport {i18n} from './i18n';\n\nexport interface PublishOptions {\n\t/**\n\t * Options that will be passed as-is to the format in the `options` attribute\n\t * of the published `<tw-storydata>` tag.\n\t */\n\tformatOptions?: string;\n\n\t/**\n\t * ID of the passage to start the story at. This overrides what is set at the\n\t * story level.\n\t */\n\tstartId?: string;\n\n\t/**\n\t * If true, publishing will proceed even if the story has no starting passage\n\t * set and one wasn't set manually.\n\t */\n\tstartOptional?: boolean;\n}\n\n/**\n * Returns a filename for an archive file.\n */\nexport function archiveFilename() {\n\tconst timestamp = new Date().toLocaleString().replace(/[/:\\\\]/g, '.');\n\n\treturn i18n.t('store.archiveFilename', {timestamp});\n}\n\n/**\n * Publishes an archive of stories, e.g. all stories in one file with no story\n * format binding.\n */\nexport function publishArchive(stories: Story[], appInfo: AppInfo) {\n\treturn stories.reduce((output, story) => {\n\t\t// Force publishing even if there is no start point set.\n\n\t\treturn (\n\t\t\toutput + publishStory(story, appInfo, {startOptional: true}) + '\\n\\n'\n\t\t);\n\t}, '');\n}\n\n/**\n * Publishes a passage to an HTML fragment. This takes a id argument because\n * passages are numbered sequentially in published stories, not with a UUID.\n */\nexport function publishPassage(passage: Passage, localId: number) {\n\treturn (\n\t\t`<tw-passagedata pid=\"${escape(localId.toString())}\" ` +\n\t\t`name=\"${escape(passage.name)}\" ` +\n\t\t`tags=\"${escape(passage.tags.join(' '))}\" ` +\n\t\t`position=\"${passage.left},${passage.top}\" ` +\n\t\t`size=\"${passage.width},${passage.height}\">` +\n\t\t`${escape(passage.text)}</tw-passagedata>`\n\t);\n}\n\n/**\n * Does a \"naked\" publish of a story -- creating an HTML representation of it,\n * but without any story format binding.\n */\nexport function publishStory(\n\tstory: Story,\n\tappInfo: AppInfo,\n\t{formatOptions, startId, startOptional}: PublishOptions = {}\n) {\n\tstartId = startId ?? story.startPassage;\n\n\t// Verify that the start passage exists.\n\n\tif (!startOptional) {\n\t\tif (!startId) {\n\t\t\tthrow new Error(\n\t\t\t\t'There is no starting point set for this story and none was set manually.'\n\t\t\t);\n\t\t}\n\n\t\tif (!story.passages.find(p => p.id === startId)) {\n\t\t\tthrow new Error(\n\t\t\t\t'The passage set as starting point for this story does not exist.'\n\t\t\t);\n\t\t}\n\t}\n\n\t// The id of the start passage as it is published (*not* a UUID).\n\n\tlet startLocalId;\n\tlet passageData = '';\n\n\tstory.passages.forEach((p, index) => {\n\t\tpassageData += publishPassage(p, index + 1);\n\n\t\tif (p.id === startId) {\n\t\t\tstartLocalId = index + 1;\n\t\t}\n\t});\n\n\tconst tagData = Object.keys(story.tagColors).reduce(\n\t\t(result, tag) =>\n\t\t\tresult +\n\t\t\t`<tw-tag name=\"${escape(tag)}\" color=\"${escape(\n\t\t\t\tstory.tagColors[tag]\n\t\t\t)}\"></tw-tag>`,\n\t\t''\n\t);\n\n\treturn (\n\t\t`<tw-storydata name=\"${escape(story.name)}\" ` +\n\t\t`startnode=\"${startLocalId || ''}\" ` +\n\t\t`creator=\"${escape(appInfo.name)}\" ` +\n\t\t`creator-version=\"${escape(appInfo.version)}\" ` +\n\t\t`format=\"${escape(story.storyFormat)}\" ` +\n\t\t`format-version=\"${escape(story.storyFormatVersion)}\" ` +\n\t\t`ifid=\"${escape(story.ifid)}\" ` +\n\t\t`options=\"${escape(formatOptions)}\" ` +\n\t\t`tags=\"${escape(story.tags.join(' '))}\" ` +\n\t\t`zoom=\"${escape(story.zoom.toString())}\" hidden>` +\n\t\t`<style role=\"stylesheet\" id=\"twine-user-stylesheet\" ` +\n\t\t`type=\"text/twine-css\">` +\n\t\tstory.stylesheet +\n\t\t`</style>` +\n\t\t`<script role=\"script\" id=\"twine-user-script\" ` +\n\t\t`type=\"text/twine-javascript\">` +\n\t\tstory.script +\n\t\t`</script>` +\n\t\ttagData +\n\t\tpassageData +\n\t\t`</tw-storydata>`\n\t);\n}\n\n/**\n * Publishes a story and binds it to the source of a story format.\n */\nexport function publishStoryWithFormat(\n\tstory: Story,\n\tformatSource: string,\n\tappInfo: AppInfo,\n\t{formatOptions, startId}: PublishOptions = {}\n) {\n\tif (!formatSource) {\n\t\tthrow new Error('Story format source cannot be empty.');\n\t}\n\n\tlet output = formatSource;\n\n\t// We use function replacements to protect the data from accidental\n\t// interactions with the special string replacement patterns.\n\n\toutput = output.replace(/{{STORY_NAME}}/g, () => escape(story.name));\n\toutput = output.replace(/{{STORY_DATA}}/g, () =>\n\t\tpublishStory(story, appInfo, {formatOptions, startId})\n\t);\n\n\treturn output;\n}\n","export function isValidTagName(value: string) {\n\treturn value.length > 0 && !/\\s/.test(value);\n}\n","import * as React from 'react';\n\nexport const IconEmpty: React.FC = () => (\n\t<svg\n\t\tviewBox=\"0 0 24 24\"\n\t\twidth=\"24\"\n\t\theight=\"24\"\n\t\tstroke=\"currentColor\"\n\t\tstrokeWidth=\"2\"\n\t\tfill=\"none\"\n\t\tstrokeLinecap=\"round\"\n\t\tstrokeLinejoin=\"round\"\n\t></svg>\n);\n","import * as React from 'react';\nimport {IconCircle} from '@tabler/icons';\nimport './loading.css';\n\nexport const IconLoading: React.FC = () => {\n\treturn (\n\t\t<span className=\"icon-loading\">\n\t\t\t<IconCircle />\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\n\n// export const IconTwee: React.FC = () => (\n// \t<svg\n// \t\tviewBox=\"0 0 24 24\"\n// \t\twidth=\"24\"\n// \t\theight=\"24\"\n// \t\tstroke=\"currentColor\"\n// \t\tstrokeWidth=\"2\"\n// \t\tfill=\"none\"\n// \t\tstrokeLinecap=\"round\"\n// \t\tstrokeLinejoin=\"round\"\n// \t>\n// \t\t<circle cx=\"8\" cy=\"8\" r=\"1\" fill=\"currentColor\" />\n// \t\t<circle cx=\"16\" cy=\"8\" r=\"1\" fill=\"currentColor\" />\n// \t\t<circle cx=\"8\" cy=\"16\" r=\"1\" fill=\"currentColor\" />\n// \t\t<circle cx=\"16\" cy=\"16\" r=\"1\" fill=\"currentColor\" />\n// \t</svg>\n// );\n\nexport const IconFileTwee: React.FC = () => (\n\t<svg\n\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\tviewBox=\"0 0 24 24\"\n\t\tstrokeWidth=\"2\"\n\t\tstroke=\"currentColor\"\n\t\tfill=\"none\"\n\t\tstrokeLinecap=\"round\"\n\t\tstrokeLinejoin=\"round\"\n\t>\n\t\t<path d=\"M14 3v4a1 1 0 0 0 1 1h4\" />\n\t\t<path d=\"M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z\" />\n\t\t<circle cx=\"10\" cy=\"12\" r=\"0.5\" />\n\t\t<circle cx=\"14\" cy=\"12\" r=\"0.5\" />\n\t\t<circle cx=\"10\" cy=\"16\" r=\"0.5\" />\n\t\t<circle cx=\"14\" cy=\"16\" r=\"0.5\" />\n\t</svg>\n);\n","import * as React from 'react';\n\nexport const IconTwine: React.FC = () => (\n\t<svg\n\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\txmlnsXlink=\"http://www.w3.org/1999/xlink\"\n\t\tviewBox=\"0 0 1200 1200\"\n\t\twidth=\"1200\"\n\t\theight=\"1200\"\n\t>\n\t\t<defs>\n\t\t\t<linearGradient id=\"b\">\n\t\t\t\t<stop offset=\"0\" stopColor=\"#127aee\" />\n\t\t\t\t<stop offset=\"1\" stopColor=\"#117aef\" stopOpacity=\".251\" />\n\t\t\t</linearGradient>\n\t\t\t<linearGradient id=\"a\">\n\t\t\t\t<stop offset=\"0\" stopColor=\"#10f05e\" stopOpacity=\".251\" />\n\t\t\t\t<stop offset=\"1\" stopColor=\"#10f05e\" />\n\t\t\t</linearGradient>\n\t\t\t<linearGradient\n\t\t\t\txlinkHref=\"#a\"\n\t\t\t\tid=\"d\"\n\t\t\t\tx1=\"52\"\n\t\t\t\ty1=\"604.362\"\n\t\t\t\tx2=\"972\"\n\t\t\t\ty2=\"604.362\"\n\t\t\t\tgradientUnits=\"userSpaceOnUse\"\n\t\t\t/>\n\t\t\t<linearGradient\n\t\t\t\txlinkHref=\"#b\"\n\t\t\t\tid=\"c\"\n\t\t\t\tx1=\"256\"\n\t\t\t\ty1=\"0\"\n\t\t\t\tx2=\"231.987\"\n\t\t\t\ty2=\"725.548\"\n\t\t\t\tgradientUnits=\"userSpaceOnUse\"\n\t\t\t\tgradientTransform=\"translate(0 28.362)\"\n\t\t\t/>\n\t\t</defs>\n\t\t<path\n\t\t\tfill=\"url(#c)\"\n\t\t\td=\"M64 28.362h384v1024H64z\"\n\t\t\ttransform=\"translate(88 59.638)\"\n\t\t/>\n\t\t<path\n\t\t\td=\"M64 860.362c0-704 896-704 896-704v384s-512 0-512 320v192H64z\"\n\t\t\tfill=\"url(#d)\"\n\t\t\ttransform=\"translate(88 59.638)\"\n\t\t/>\n\t</svg>\n);\n","import * as React from 'react';\nimport {usePopper} from 'react-popper';\nimport {CSSTransition} from 'react-transition-group';\nimport {Card} from '../container/card';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './card-button.css';\nimport FocusTrap from 'focus-trap-react';\n\nexport interface CardButtonProps extends IconButtonProps {\n\t/**\n\t * ARIA label for the card that opens.\n\t */\n\tariaLabel: string;\n\t/**\n\t * CSS selector for the element inside the card that should be focused when it\n\t * is opened. Otherwise, the first text input or button in source order will\n\t * be focused.\n\t */\n\tfocusSelector?: string;\n\t/**\n\t * Callback for when the open status of the card should change.\n\t */\n\tonChangeOpen: (value: boolean) => void;\n\t/**\n\t * Is the card currently open?\n\t */\n\topen?: boolean;\n}\n\nexport const CardButton: React.FC<CardButtonProps> = props => {\n\tconst {ariaLabel, children, focusSelector, onChangeOpen, open, ...other} =\n\t\tprops;\n\tconst [buttonEl, setButtonEl] = React.useState<HTMLButtonElement | null>(\n\t\tnull\n\t);\n\tconst [cardEl, setCardEl] = React.useState<HTMLDivElement | null>(null);\n\tconst {styles, attributes} = usePopper(buttonEl, cardEl, {strategy: 'fixed'});\n\n\treturn (\n\t\t<span className=\"card-button\">\n\t\t\t<IconButton\n\t\t\t\tonClick={() => onChangeOpen(!open)}\n\t\t\t\t{...other}\n\t\t\t\tref={setButtonEl}\n\t\t\t/>\n\t\t\t<CSSTransition\n\t\t\t\tclassNames=\"fade-out\"\n\t\t\t\tin={open}\n\t\t\t\tmountOnEnter\n\t\t\t\ttimeout={200}\n\t\t\t\tunmountOnExit\n\t\t\t>\n\t\t\t\t<FocusTrap\n\t\t\t\t\tfocusTrapOptions={{\n\t\t\t\t\t\tclickOutsideDeactivates: true,\n\t\t\t\t\t\tonDeactivate: () => onChangeOpen(false)\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\taria-label={ariaLabel}\n\t\t\t\t\t\tclassName=\"card-button-card\"\n\t\t\t\t\t\tref={setCardEl}\n\t\t\t\t\t\trole=\"dialog\"\n\t\t\t\t\t\tstyle={styles.popper}\n\t\t\t\t\t\t{...attributes.popper}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Card floating>{children}</Card>\n\t\t\t\t\t</div>\n\t\t\t\t</FocusTrap>\n\t\t\t</CSSTransition>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {usePopper} from 'react-popper';\nimport {CSSTransition} from 'react-transition-group';\nimport {ButtonBar, ButtonBarSeparator} from '../container/button-bar';\nimport {ButtonCard} from '../container/button-card';\nimport {IconEmpty} from '../image/icon';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './menu-button.css';\nimport {CheckboxButton} from './checkbox-button';\nimport {IconCheck} from '@tabler/icons';\n\nexport interface UncheckableLabeledMenuItem {\n\tdisabled?: boolean;\n\tlabel: string;\n\tonClick: () => void;\n\tseparator?: undefined;\n\tvariant?: IconButtonProps['variant'];\n}\n\nexport interface CheckableLabeledMenuItem extends UncheckableLabeledMenuItem {\n\tcheckable: true;\n\tchecked: boolean;\n}\n\nexport type LabeledMenuItem =\n\t| UncheckableLabeledMenuItem\n\t| CheckableLabeledMenuItem;\n\nexport interface MenuSeparator {\n\tseparator: true;\n}\n\nexport interface MenuButtonProps extends Omit<IconButtonProps, 'onClick'> {\n\titems: (LabeledMenuItem | MenuSeparator)[];\n}\n\nexport const MenuButton: React.FC<MenuButtonProps> = props => {\n\tconst {items, ...other} = props;\n\tconst [buttonEl, setButtonEl] = React.useState<HTMLButtonElement | null>(\n\t\tnull\n\t);\n\tconst [menuEl, setMenuEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [open, setOpen] = React.useState(false);\n\tconst {styles, attributes} = usePopper(buttonEl, menuEl, {strategy: 'fixed'});\n\n\tReact.useEffect(() => {\n\t\tconst closer = () => setOpen(false);\n\n\t\tif (open) {\n\t\t\tdocument.addEventListener('click', closer);\n\t\t}\n\n\t\treturn () => document.removeEventListener('click', closer);\n\t}, [menuEl, open, setOpen]);\n\n\treturn (\n\t\t<span className=\"menu-button\">\n\t\t\t<IconButton\n\t\t\t\t{...other}\n\t\t\t\tonClick={() => setOpen(open => !open)}\n\t\t\t\tref={setButtonEl}\n\t\t\t/>\n\t\t\t<CSSTransition\n\t\t\t\tclassNames=\"fade-out\"\n\t\t\t\tin={open}\n\t\t\t\tmountOnEnter\n\t\t\t\ttimeout={200}\n\t\t\t\tunmountOnExit\n\t\t\t>\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"menu-button-menu\"\n\t\t\t\t\tref={setMenuEl}\n\t\t\t\t\tstyle={styles.popper}\n\t\t\t\t\t{...attributes.popper}\n\t\t\t\t>\n\t\t\t\t\t<ButtonCard floating>\n\t\t\t\t\t\t<ButtonBar orientation=\"vertical\">\n\t\t\t\t\t\t\t{items.map((item, index) => {\n\t\t\t\t\t\t\t\tif (item.separator) {\n\t\t\t\t\t\t\t\t\treturn <ButtonBarSeparator key={index} />;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn 'checkable' in item ? (\n\t\t\t\t\t\t\t\t\t<CheckboxButton\n\t\t\t\t\t\t\t\t\t\tcheckedIcon={<IconCheck />}\n\t\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\t\tonChange={item.onClick}\n\t\t\t\t\t\t\t\t\t\tuncheckedIcon={<IconEmpty />}\n\t\t\t\t\t\t\t\t\t\tvalue={item.checked}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\t\ticon={<IconEmpty />}\n\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\t\tonClick={item.onClick}\n\t\t\t\t\t\t\t\t\t\tvariant={item.variant}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t</ButtonBar>\n\t\t\t\t\t</ButtonCard>\n\t\t\t\t</div>\n\t\t\t</CSSTransition>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconCheck, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton, CardButtonProps} from './card-button';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport {TextInput} from './text-input';\n\nexport interface PromptValidationResponse {\n\tmessage?: string;\n\tvalid: boolean;\n}\n\nexport type PromptButtonValidator = (\n\tvalue: string\n) => PromptValidationResponse | Promise<PromptValidationResponse>;\n\nexport interface PromptButtonProps\n\textends Omit<CardButtonProps, 'ariaLabel' | 'onChangeOpen' | 'open'> {\n\tcancelIcon?: React.ReactNode;\n\tcancelLabel?: string;\n\tonChange: React.ChangeEventHandler<HTMLInputElement>;\n\tonSubmit: (value: string) => void;\n\tprompt: string;\n\tsubmitIcon?: React.ReactNode;\n\tsubmitLabel?: string;\n\tsubmitVariant?: IconButtonProps['variant'];\n\tvalidate?: PromptButtonValidator;\n\tvalue: string;\n}\n\nexport const PromptButton: React.FC<PromptButtonProps> = props => {\n\tconst {\n\t\tcancelIcon,\n\t\tcancelLabel,\n\t\tonChange,\n\t\tonSubmit,\n\t\tprompt,\n\t\tsubmitIcon,\n\t\tsubmitLabel,\n\t\tsubmitVariant,\n\t\tvalidate,\n\t\tvalue,\n\t\t...other\n\t} = props;\n\tconst mounted = React.useRef(true);\n\tconst [open, setOpen] = React.useState(false);\n\tconst [validation, setValidation] =\n\t\tReact.useState<PromptValidationResponse>();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tasync function updateValidation() {\n\t\t\tif (validate) {\n\t\t\t\tconst validation = await validate(value);\n\n\t\t\t\tif (mounted.current) {\n\t\t\t\t\tsetValidation(validation);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (mounted.current) {\n\t\t\t\t\tsetValidation({valid: true});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tupdateValidation();\n\t}, [validate, value]);\n\n\tReact.useEffect(() => {\n\t\treturn () => {\n\t\t\tmounted.current = false;\n\t\t};\n\t}, []);\n\n\tfunction handleCancel(event: React.MouseEvent) {\n\t\tevent.preventDefault();\n\t\tsetOpen(false);\n\t}\n\n\tfunction handleSubmit(event: React.FormEvent) {\n\t\tevent.preventDefault();\n\n\t\t// It's possible to submit with the Enter key and bypass us disabling the\n\t\t// submit button, so we need to catch that here.\n\n\t\tif (validation?.valid) {\n\t\t\tonSubmit(value);\n\t\t\tsetOpen(false);\n\t\t}\n\t}\n\n\treturn (\n\t\t<span className=\"prompt-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={prompt}\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t\t{...other}\n\t\t\t>\n\t\t\t\t<form onSubmit={handleSubmit}>\n\t\t\t\t\t<CardContent>\n\t\t\t\t\t\t<TextInput onChange={onChange} orientation=\"vertical\" value={value}>\n\t\t\t\t\t\t\t{prompt}\n\t\t\t\t\t\t</TextInput>\n\t\t\t\t\t\t{validation?.message && <p>{validation.message}</p>}\n\t\t\t\t\t</CardContent>\n\t\t\t\t\t<ButtonBar>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\tbuttonType=\"submit\"\n\t\t\t\t\t\t\tdisabled={!validation?.valid}\n\t\t\t\t\t\t\ticon={submitIcon ?? <IconCheck />}\n\t\t\t\t\t\t\tlabel={submitLabel ?? t('common.ok')}\n\t\t\t\t\t\t\tvariant={submitVariant ?? 'primary'}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\tbuttonType=\"button\"\n\t\t\t\t\t\t\ticon={cancelIcon ?? <IconX />}\n\t\t\t\t\t\t\tlabel={cancelLabel ?? t('common.cancel')}\n\t\t\t\t\t\t\tonClick={handleCancel}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</ButtonBar>\n\t\t\t\t</form>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {\n\tpublishArchive,\n\tpublishStory,\n\tpublishStoryWithFormat,\n\tPublishOptions\n} from '../util/publish';\nimport {usePrefsContext} from './prefs';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {storyWithId, useStoriesContext} from './stories';\nimport {getAppInfo} from '../util/app-info';\n\nexport interface UsePublishingProps {\n\tproofStory: (storyId: string) => Promise<string>;\n\tpublishArchive: (storyIds?: string[]) => Promise<string>;\n\tpublishStory: (\n\t\tstoryId: string,\n\t\tpublishOptions?: PublishOptions\n\t) => Promise<string>;\n\tpublishStoryData: (storyId: string) => string;\n}\n\n/**\n * A React hook to publish stories from context. You probably want to use\n * `useStoryLaunch` instead--this is for doing the actual binding of the story\n * and story format.\n */\nexport function usePublishing(): UsePublishingProps {\n\t// As little logic as possible should live here--instead it should be in\n\t// util/publish.ts.\n\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch: storyFormatsDispatch, formats} = useStoryFormatsContext();\n\tconst {stories} = useStoriesContext();\n\n\treturn {\n\t\tpublishArchive: React.useCallback(\n\t\t\tasync () => publishArchive(stories, getAppInfo()),\n\t\t\t[stories]\n\t\t),\n\t\tproofStory: React.useCallback(\n\t\t\tasync storyId => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\t\t\t\tconst format = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tprefs.proofingFormat.name,\n\t\t\t\t\tprefs.proofingFormat.version\n\t\t\t\t);\n\t\t\t\tconst formatProperties = await loadFormatProperties(format)(\n\t\t\t\t\tstoryFormatsDispatch\n\t\t\t\t);\n\n\t\t\t\tif (!formatProperties) {\n\t\t\t\t\tthrow new Error(`Couldn't load story format properties`);\n\t\t\t\t}\n\n\t\t\t\treturn publishStoryWithFormat(\n\t\t\t\t\tstory,\n\t\t\t\t\tformatProperties.source,\n\t\t\t\t\tgetAppInfo()\n\t\t\t\t);\n\t\t\t},\n\t\t\t[\n\t\t\t\tformats,\n\t\t\t\tprefs.proofingFormat.name,\n\t\t\t\tprefs.proofingFormat.version,\n\t\t\t\tstories,\n\t\t\t\tstoryFormatsDispatch\n\t\t\t]\n\t\t),\n\t\tpublishStory: React.useCallback(\n\t\t\tasync (storyId, publishOptions) => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\t\t\t\tconst format = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tstory.storyFormat,\n\t\t\t\t\tstory.storyFormatVersion\n\t\t\t\t);\n\t\t\t\tconst formatProperties = await loadFormatProperties(format)(\n\t\t\t\t\tstoryFormatsDispatch\n\t\t\t\t);\n\n\t\t\t\tif (!formatProperties) {\n\t\t\t\t\tthrow new Error(`Couldn't load story format properties`);\n\t\t\t\t}\n\n\t\t\t\treturn publishStoryWithFormat(\n\t\t\t\t\tstory,\n\t\t\t\t\tformatProperties.source,\n\t\t\t\t\tgetAppInfo(),\n\t\t\t\t\tpublishOptions\n\t\t\t\t);\n\t\t\t},\n\t\t\t[formats, stories, storyFormatsDispatch]\n\t\t),\n\t\tpublishStoryData: React.useCallback(\n\t\t\t(storyId: string) => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\n\t\t\t\treturn publishStory(story, getAppInfo(), {startOptional: true});\n\t\t\t},\n\t\t\t[stories]\n\t\t)\n\t};\n}\n","/*\nParses passage text for links. Optionally, it returns internal links only --\ne.g. those pointing to other passages in a story, not to an external web site.\n*/\n\nimport uniq from 'lodash/uniq';\n\n// The top level regular expression to catch links -- i.e. [[link]].\nconst extractLinkTags = (text: string) => text.match(/\\[\\[.*?\\]\\]/g) || [];\n\n// Links _not_ starting with a protocol, e.g. abcd://.\nconst internalLinks = (link: string) => !/^\\w+:\\/\\/\\/?\\w/i.test(link);\n\n// Links with some text in them.\nconst nonEmptyLinks = (link: string) => link !== '';\n\n// Setter is the second [] block if exists.\nconst removeSetters = (link: string) => {\n\tconst noSetter = getField(link, '][', 0);\n\n\treturn noSetter ?? link;\n};\n\nconst removeEnclosingBrackets = (link: string) =>\n\tlink.substr(2, link.length - 4);\n\n/**\n * Split the link by the separator and return the field in the given index.\n * Negative indices start from the end of the array.\n */\nconst getField = (link: string, separator: string, index: number) => {\n\tconst fields = link.split(separator);\n\n\tif (fields.length === 1) {\n\t\t/* Separator not present. */\n\t\treturn undefined;\n\t}\n\n\treturn index < 0 ? fields[fields.length + index] : fields[index];\n};\n\n// Arrow links:\n// [[display text->link]] format\n// [[link<-display text]] format\n// Interpret the rightmost '->' and the leftmost '<-' as the divider.\n\nconst extractLink = (tagContent: string) => {\n\treturn (\n\t\tgetField(tagContent, '->', -1) ||\n\t\tgetField(tagContent, '<-', 0) ||\n\t\t//  TiddlyWiki links:\n\t\t//  [[display text|link]] format\n\n\t\tgetField(tagContent, '|', -1) ||\n\t\t// [[link]] format\n\t\ttagContent\n\t);\n};\n\n/**\n * Returns a list of unique links in passage source code.\n */\nexport function parseLinks(text: string, internalOnly?: boolean) {\n\t// Link matching regexps ignore setter components, should they exist.\n\n\tlet result = uniq(\n\t\textractLinkTags(text)\n\t\t\t.map(removeEnclosingBrackets)\n\t\t\t.map(removeSetters)\n\t\t\t.map(extractLink)\n\t\t\t.filter(nonEmptyLinks)\n\t);\n\n\tif (internalOnly) {\n\t\tresult = result.filter(internalLinks);\n\t}\n\n\treturn result;\n}\n","import {PrefsState} from './prefs.types';\n\nexport const defaults = (): PrefsState => ({\n\tappTheme: 'system',\n\tcodeEditorFontFamily: 'var(--font-monospaced)',\n\tcodeEditorFontScale: 1,\n\tdialogWidth: 600,\n\tdisabledStoryFormatEditorExtensions: [],\n\tdonateShown: false,\n\teditorCursorBlinks: true,\n\tfirstRunTime: new Date().getTime(),\n\tlastUpdateSeen: '',\n\tlastUpdateCheckTime: new Date().getTime(),\n\tlocale:\n\t\t(window.navigator as any).userLanguage ||\n\t\twindow.navigator.language ||\n\t\t(window.navigator as any).browserLanguage ||\n\t\t(window.navigator as any).systemLanguage ||\n\t\t'en-us',\n\tpassageEditorFontFamily: 'var(--font-system)',\n\tpassageEditorFontScale: 1,\n\tproofingFormat: {\n\t\tname: 'Paperthin',\n\t\tversion: '1.0.0'\n\t},\n\tstoryFormat: {\n\t\tname: 'Harlowe',\n\t\tversion: '3.3.5'\n\t},\n\tstoryFormatListFilter: 'current',\n\tstoryListSort: 'name',\n\tstoryListTagFilter: [],\n\tstoryTagColors: {},\n\twelcomeSeen: false\n});\n","/**\n * Returns an unique name among an array of existing, making it unique if need\n * be by adding a number at the end.\n */\nexport function unusedName(name: string, existing: string[]): string {\n\tif (existing.includes(name)) {\n\t\tlet suffix = 1;\n\n\t\twhile (existing.includes(`${name} ${suffix}`)) {\n\t\t\tsuffix++;\n\t\t}\n\n\t\treturn `${name} ${suffix}`;\n\t}\n\n\treturn name;\n}\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport './text-input.css';\n\nexport interface TextInputProps {\n\tchildren: React.ReactNode;\n\tonChange?: (event: React.ChangeEvent<HTMLInputElement>) => void;\n\tonInput?: (event: React.FormEvent<HTMLInputElement>) => void;\n\torientation?: 'horizontal' | 'vertical';\n\tplaceholder?: string;\n\ttype?: 'search' | 'text';\n\tvalue: string;\n}\n\nexport const TextInput = React.forwardRef<HTMLInputElement, TextInputProps>(\n\t(props, ref) => {\n\t\tconst className = classNames(\n\t\t\t'text-input',\n\t\t\t`orientation-${props.orientation}`,\n\t\t\t`type-${props.type}`\n\t\t);\n\n\t\treturn (\n\t\t\t<span className={className}>\n\t\t\t\t<label>\n\t\t\t\t\t<span className=\"text-input-label\">{props.children}</span>\n\t\t\t\t\t<input\n\t\t\t\t\t\tonChange={props.onChange}\n\t\t\t\t\t\tonInput={props.onInput}\n\t\t\t\t\t\tplaceholder={props.placeholder}\n\t\t\t\t\t\tref={ref}\n\t\t\t\t\t\ttype={props.type ?? 'text'}\n\t\t\t\t\t\tvalue={props.value}\n\t\t\t\t\t/>\n\t\t\t\t</label>\n\t\t\t</span>\n\t\t);\n\t}\n);\n","// This automatically triggers a function when typing a word that is prefixed by\n// certain text. We use this to automatically pop open the autocomplete when the\n// user is probably typing a passage name.\n\nimport CodeMirror from 'codemirror';\nimport {Editor} from 'codemirror';\n\nlet attachments: Editor[] = [];\n\nexport interface CMPrefixTriggerOptions {\n\t/**\n\t * Called when the user types a prefix in.\n\t */\n\tcallback?: (editor: Editor) => void;\n\t/**\n\t * An array of strings that will trigger the callback, case-sensitive.\n\t */\n\tprefixes?: string[];\n}\n\nexport function prefixTriggerOption(\n\tcm: Editor,\n\toptions: CMPrefixTriggerOptions\n) {\n\tconst {prefixes, callback} = options;\n\n\tfunction checkTrigger(cm: Editor) {\n\t\tif (cm.state.completionActive || !prefixes || !callback) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Back up two words from the cursor.\n\n\t\tconst curWord = cm.findWordAt(cm.getDoc().getCursor());\n\n\t\tcurWord.anchor.ch--;\n\n\t\tconst prevWordRange = cm.findWordAt(curWord.anchor);\n\t\tconst prevWord = cm.getRange(prevWordRange.anchor, prevWordRange.head);\n\n\t\t// Do we have a match? Only trigger this once.\n\n\t\tfor (const prefix of prefixes) {\n\t\t\tif (prevWord === prefix) {\n\t\t\t\tcallback(cm);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (callback && prefixes && !attachments.includes(cm)) {\n\t\tattachments.push(cm);\n\t\tcm.on('inputRead', checkTrigger);\n\t} else if (attachments.includes(cm)) {\n\t\tcm.off('inputRead', checkTrigger);\n\t\tattachments = attachments.filter(editor => editor !== cm);\n\t}\n}\n\nlet inited = false;\n\nexport function initPrefixTriggerGlobally() {\n\tif (!inited) {\n\t\tCodeMirror.defineOption('prefixTrigger', [], prefixTriggerOption);\n\t\tinited = true;\n\t}\n}\n","import * as React from 'react';\nimport {\n\tControlled as CodeMirror,\n\tIControlledCodeMirror\n} from 'react-codemirror2';\nimport 'codemirror/addon/display/placeholder';\nimport 'codemirror/addon/hint/show-hint';\nimport 'codemirror/addon/hint/show-hint.css';\nimport 'codemirror/lib/codemirror.css';\nimport 'codemirror/mode/css/css';\nimport 'codemirror/mode/javascript/javascript';\nimport './code-area.css';\nimport './codemirror-theme.css';\nimport classnames from 'classnames';\nimport {initPrefixTriggerGlobally} from '../../../codemirror/prefix-trigger';\n\n// Not ideal by far to do this init here, outside of a component, but we have to\n// set up CodeMirror before the first render. Otherwise, CodeMirror doesn't pick\n// up on options properly.\n\ninitPrefixTriggerGlobally();\n\nexport interface CodeAreaProps extends IControlledCodeMirror {\n\tfontFamily?: string;\n\tfontScale?: number;\n\tlabel: string;\n\tlabelHidden?: boolean;\n\tvalue: string;\n}\n\nexport const CodeArea: React.FC<CodeAreaProps> = props => {\n\tconst {fontFamily, fontScale, label, ...otherProps} = props;\n\tconst style: React.CSSProperties = {};\n\n\tif (fontFamily) {\n\t\tstyle.fontFamily = fontFamily.includes(' ')\n\t\t\t? `\"${fontFamily}\"`\n\t\t\t: fontFamily;\n\t}\n\n\tif (fontScale) {\n\t\tstyle.fontSize = `${fontScale * 100}%`;\n\t}\n\n\treturn (\n\t\t<div className=\"code-area\" style={style}>\n\t\t\t<label>\n\t\t\t\t<span\n\t\t\t\t\tclassName={classnames('label', {\n\t\t\t\t\t\t'screen-reader-only': props.labelHidden\n\t\t\t\t\t})}\n\t\t\t\t>\n\t\t\t\t\t{label}\n\t\t\t\t</span>\n\t\t\t\t<CodeMirror {...otherProps} />\n\t\t\t</label>\n\t\t</div>\n\t);\n};\n","import i18next from 'i18next';\nimport HttpBackend from 'i18next-http-backend';\nimport {initReactI18next} from 'react-i18next';\n\nexport const i18n = i18next.createInstance();\n\ni18n\n\t.use(HttpBackend)\n\t.use(initReactI18next)\n\t.init({\n\t\tdebug: process.env.NODE_ENV === 'development',\n\t\tbackend: {\n\t\t\tloadPath: `${process.env.PUBLIC_URL}/locales/{{lng}}.json`\n\t\t},\n\t\tfallbackLng: 'en-us',\n\t\tinterpolation: {\n\t\t\tescapeValue: false\n\t\t},\n\t\tload: 'currentOnly'\n\t});\n","import {PrefsState} from '../../../prefs';\nimport {TwineElectronWindow} from '../../../../electron/shared';\nimport {defaults} from '../../../prefs/defaults';\n\nexport async function load(): Promise<Partial<PrefsState>> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\tconst result: Partial<PrefsState> = {};\n\tconst prefKeys = Object.keys(defaults());\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst prefs = await twineElectron?.ipcRenderer.invoke('load-prefs');\n\n\tif (prefs && typeof prefs === 'object') {\n\t\tfor (const key in prefs) {\n\t\t\tif (prefKeys.includes(key)) {\n\t\t\t\t(result as any)[key] = prefs[key];\n\t\t\t}\n\t\t}\n\t}\n\n\treturn result;\n}\n","import {TwineElectronWindow} from '../../../electron/shared';\n\nexport function saveJson(filename: string, data: any) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\ttwineElectron.ipcRenderer.send('save-json', filename, data);\n}\n","import {PrefsAction, PrefsState} from '../../../prefs';\nimport {saveJson} from '../save-json';\n\n/**\n * A middleware function to save changes to disk. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(state: PrefsState, action: PrefsAction) {\n\tif (action.type === 'repair' || action.type === 'update') {\n\t\tsaveJson('prefs.json', state);\n\t}\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {Story} from '../../../stories/stories.types';\nimport {importStories} from '../../../../util/import';\n\nexport async function load(): Promise<Story[]> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst stories = await twineElectron?.ipcRenderer.invoke('load-stories');\n\n\tif (stories && Array.isArray(stories)) {\n\t\treturn stories.reduce((result, file) => {\n\t\t\tconst story = importStories(file.htmlSource, file.mtime);\n\n\t\t\tif (story[0]) {\n\t\t\t\treturn [...result, story[0]];\n\t\t\t}\n\n\t\t\tconsole.warn('Could not hydrate story: ', file.htmlSource);\n\t\t\treturn result;\n\t\t}, [] as Story[]);\n\t} else {\n\t\tconsole.warn('No stories to hydrate in Electron bridge');\n\t}\n\n\treturn [];\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {\n\tStoriesAction,\n\tStoriesState,\n\tstoryWithId,\n\tstoryWithName\n} from '../../../stories';\nimport {StoryFormatsState} from '../../../story-formats';\nimport {\n\tisPersistablePassageChange,\n\tisPersistableStoryChange\n} from '../../persistable-changes';\nimport {saveStory} from './save-story';\n\n// When a story is deleted, we need to be able to look up information about it\n// from the last state.\n\nlet lastState: StoriesState;\n\n/**\n * A middleware function to save changes to disk. This should be called *after*\n * the main reducer runs.\n *\n * This has an extra argument: functions to archive and publish a story. This is\n * because the Electron app saves stories in published format.\n */\nexport function saveMiddleware(\n\tstate: StoriesState,\n\taction: StoriesAction,\n\tformats: StoryFormatsState\n) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\tcase 'repair':\n\t\t\t// We take no action here on a repair action. This is to prevent messing up a\n\t\t\t// story's last modified date. If the user then edits the story, we'll save\n\t\t\t// their change and the repair then.\n\t\t\tbreak;\n\n\t\tcase 'createStory':\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t}\n\n\t\t\tsaveStory(storyWithName(state, action.props.name), formats);\n\t\t\tbreak;\n\n\t\tcase 'deleteStory': {\n\t\t\t// We have to look up the story in our saved last state to know what file\n\t\t\t// to delete.\n\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'delete-story',\n\t\t\t\tstoryWithId(lastState, action.storyId)\n\t\t\t);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updateStory':\n\t\t\tif (isPersistableStoryChange(action.props)) {\n\t\t\t\tif (action.props.name) {\n\t\t\t\t\t// The story has been renamed, and we need to process it\n\t\t\t\t\t// specially. We rename the story file, then save it to catch\n\t\t\t\t\t// any other changes.\n\n\t\t\t\t\tconst oldStory = storyWithId(lastState, action.storyId);\n\t\t\t\t\tconst newStory = storyWithId(state, action.storyId);\n\n\t\t\t\t\t// It's crucial that we only respond to this event once. Otherwise,\n\t\t\t\t\t// multiple renames in one session will cause mayhem.\n\n\t\t\t\t\ttwineElectron.ipcRenderer.once('story-renamed', () =>\n\t\t\t\t\t\tsaveStory(newStory, formats)\n\t\t\t\t\t);\n\t\t\t\t\ttwineElectron.ipcRenderer.send('rename-story', oldStory, newStory);\n\t\t\t\t} else {\n\t\t\t\t\t// An ordinary update.\n\n\t\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'createPassage':\n\t\tcase 'createPassages':\n\t\tcase 'deletePassage':\n\t\tcase 'deletePassages':\n\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\tbreak;\n\n\t\tcase 'updatePassage':\n\t\t\t// Skip updates that wouldn't be saved.\n\t\t\tif (isPersistablePassageChange(action.props)) {\n\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'updatePassages':\n\t\t\t// Skip updates that wouldn't be saved.\n\t\t\tif (\n\t\t\t\tObject.keys(action.passageUpdates).some(passageId =>\n\t\t\t\t\tisPersistablePassageChange(action.passageUpdates[passageId])\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tconsole.warn(\n\t\t\t\t`Story action ${\n\t\t\t\t\t(action as any).type\n\t\t\t\t} has no Electron persistence handler`\n\t\t\t);\n\t}\n\n\tlastState = [...state];\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {Story} from '../../../stories';\nimport {publishStory, publishStoryWithFormat} from '../../../../util/publish';\nimport {\n\tformatWithNameAndVersion,\n\tStoryFormatsState\n} from '../../../story-formats';\nimport {getAppInfo} from '../../../../util/app-info';\nimport {fetchStoryFormatProperties} from '../../../../util/story-format/fetch-properties';\n\n/**\n * Sends an IPC message to save a story to disk, ideally in published form.\n */\nexport async function saveStory(story: Story, formats: StoryFormatsState) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\ttry {\n\t\tconst format = formatWithNameAndVersion(\n\t\t\tformats,\n\t\t\tstory.storyFormat,\n\t\t\tstory.storyFormatVersion\n\t\t);\n\n\t\tif (format.loadState === 'loaded') {\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'save-story-html',\n\t\t\t\tstory,\n\t\t\t\tpublishStoryWithFormat(story, format.properties.source, getAppInfo(), {\n\t\t\t\t\tstartOptional: true\n\t\t\t\t})\n\t\t\t);\n\t\t} else {\n\t\t\tconst {source} = await fetchStoryFormatProperties(format.url);\n\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'save-story-html',\n\t\t\t\tstory,\n\t\t\t\tpublishStoryWithFormat(story, source, getAppInfo(), {\n\t\t\t\t\tstartOptional: true\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t`Could not save full story (${error.message}). Trying to save story data only.`\n\t\t);\n\t\ttwineElectron.ipcRenderer.send(\n\t\t\t'save-story-html',\n\t\t\tstory,\n\t\t\tpublishStory(story, getAppInfo(), {startOptional: true})\n\t\t);\n\t}\n}\n","import uuid from 'tiny-uuid';\nimport {TwineElectronWindow} from '../../../../electron/shared';\nimport {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport async function load(): Promise<StoryFormatsState> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst storyFormats = await twineElectron?.ipcRenderer.invoke(\n\t\t'load-story-formats'\n\t);\n\n\tif (!storyFormats || !Array.isArray(storyFormats)) {\n\t\treturn [];\n\t}\n\n\treturn storyFormats.map(data => ({\n\t\tid: uuid(),\n\t\tloadState: 'unloaded',\n\t\tname: data.name,\n\t\tselected: false,\n\t\tversion: data.version,\n\t\turl: data.url,\n\t\tuserAdded: data.userAdded\n\t}));\n}\n","import {StoryFormatsAction, StoryFormatsState} from '../../../story-formats';\nimport {isPersistableStoryFormatChange} from '../../persistable-changes';\nimport {saveJson} from '../save-json';\n\n/**\n * A middleware function to save changes to disk. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(\n\tstate: StoryFormatsState,\n\taction: StoryFormatsAction\n) {\n\tconst shouldSave =\n\t\taction.type === 'create' ||\n\t\taction.type === 'delete' ||\n\t\taction.type === 'repair' ||\n\t\t(action.type === 'update' && isPersistableStoryFormatChange(action.props));\n\n\tif (shouldSave) {\n\t\tsaveJson(\n\t\t\t'story-formats.json',\n\t\t\tstate.map(format => ({\n\t\t\t\tid: format.id,\n\t\t\t\tname: format.name,\n\t\t\t\tselected: undefined,\n\t\t\t\tversion: format.version,\n\t\t\t\turl: format.url,\n\t\t\t\tuserAdded: format.userAdded\n\t\t\t}))\n\t\t);\n\t}\n}\n","import {PrefsState} from '../../../prefs';\n\nexport async function load(): Promise<Partial<PrefsState>> {\n\tconst serialized = window.localStorage.getItem('twine-prefs');\n\tconst result: Partial<PrefsState> = {};\n\n\tif (!serialized) {\n\t\treturn {};\n\t}\n\n\tserialized.split(',').forEach(id => {\n\t\ttry {\n\t\t\tconst serializedPref = window.localStorage.getItem(`twine-prefs-${id}`);\n\n\t\t\tif (!serializedPref) {\n\t\t\t\tconsole.warn(`No preference stored at twine-prefs-${id}`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst item = JSON.parse(serializedPref);\n\n\t\t\t(result as any)[item.name] = item.value;\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Preference ${id} had corrupt serialized value, skipping`,\n\t\t\t\twindow.localStorage.getItem(`twine-prefs-${id}`),\n\t\t\t\te\n\t\t\t);\n\t\t}\n\t});\n\n\treturn result;\n}\n","import {PrefsAction, PrefsState} from '../../../prefs';\nimport {save} from './save';\n\nexport function saveMiddleware(state: PrefsState, action: PrefsAction) {\n\tif (action.type === 'repair' || action.type === 'update') {\n\t\tsave(state);\n\t}\n}\n","import uuid from 'tiny-uuid';\nimport {PrefsState} from '../../../prefs';\n\nexport function save(state: PrefsState) {\n\t// Delete existing prefs in local storage, since we aren't bothering to\n\t// preserve IDs.\n\n\tconst previouslySerialized = window.localStorage.getItem('twine-prefs');\n\n\tif (previouslySerialized) {\n\t\tpreviouslySerialized.split(',').forEach(id => {\n\t\t\twindow.localStorage.removeItem(`twine-prefs-${id}`);\n\t\t});\n\t}\n\n\t/* Save new ones. */\n\n\tlet ids: string[] = [];\n\n\tfor (const name in state) {\n\t\tconst id = uuid();\n\n\t\tids.push(id);\n\t\twindow.localStorage.setItem(\n\t\t\t`twine-prefs-${id}`,\n\t\t\tJSON.stringify({\n\t\t\t\tid,\n\t\t\t\tname,\n\t\t\t\tvalue: state[name as keyof PrefsState]\n\t\t\t})\n\t\t);\n\t}\n\n\twindow.localStorage.setItem('twine-prefs', ids.join(','));\n}\n","import {\n\tpassageWithId,\n\tpassageWithName,\n\tStoriesAction,\n\tStoriesState,\n\tstoryWithId,\n\tstoryWithName\n} from '../../../stories';\nimport {isPersistablePassageChange} from '../../persistable-changes';\nimport {\n\tdeletePassageById,\n\tdeleteStory,\n\tdoUpdateTransaction,\n\tsavePassage,\n\tsaveStory\n} from './save';\n\nlet lastState: StoriesState;\n\n/**\n * A middleware function to save changes to local storage. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(state: StoriesState, action: StoriesAction) {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\tcase 'repair':\n\t\t\t// We take no action here on a repair action. This is to prevent messing up a\n\t\t\t// story's last modified date. If the user then edits the story, we'll save\n\t\t\t// their change and the repair then.\n\t\t\tbreak;\n\n\t\tcase 'createPassage': {\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t}\n\n\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\tconst passage = passageWithName(state, story.id, action.props.name);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tsavePassage(transaction, passage);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'createPassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\taction.props.forEach(props => {\n\t\t\t\t\tif (!props.name) {\n\t\t\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t\t\t}\n\n\t\t\t\t\tsavePassage(\n\t\t\t\t\t\ttransaction,\n\t\t\t\t\t\tpassageWithName(state, story.id, props.name)\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'createStory':\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Story was created but with no name specified');\n\t\t\t}\n\n\t\t\tconst story = storyWithName(state, action.props.name);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tstory.passages.forEach(passage => savePassage(transaction, passage));\n\t\t\t});\n\t\t\tbreak;\n\n\t\tcase 'deletePassage': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\t// We can't dig up the passage in question right now, because\n\t\t\t// previousStories is only a shallow copy, and it's gone there at\n\t\t\t// this point in time.\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tdeletePassageById(transaction, action.passageId);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deletePassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\t// See above comment about passages.\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\taction.passageIds.forEach(passageId =>\n\t\t\t\t\tdeletePassageById(transaction, passageId)\n\t\t\t\t);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deleteStory': {\n\t\t\t// The story will be gone from state by the time we're called, so we\n\t\t\t// need a cached copy.\n\n\t\t\tconst story = storyWithId(lastState, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\t// We have to delete all passages, then the story itself.\n\n\t\t\t\tstory.passages.forEach(passage =>\n\t\t\t\t\tdeletePassageById(transaction, passage.id)\n\t\t\t\t);\n\n\t\t\t\tdeleteStory(transaction, story);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updatePassage':\n\t\t\tif (isPersistablePassageChange(action.props)) {\n\t\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\t\tconst passage = passageWithId(state, action.storyId, action.passageId);\n\n\t\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\t\tsaveStory(transaction, story);\n\t\t\t\t\tsavePassage(transaction, passage);\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'updatePassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tObject.keys(action.passageUpdates)\n\t\t\t\t\t.filter(passageId =>\n\t\t\t\t\t\tisPersistablePassageChange(action.passageUpdates[passageId])\n\t\t\t\t\t)\n\t\t\t\t\t.forEach(passageId =>\n\t\t\t\t\t\tsavePassage(\n\t\t\t\t\t\t\ttransaction,\n\t\t\t\t\t\t\tpassageWithId(state, action.storyId, passageId)\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updateStory': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tstory.passages.forEach(passage => savePassage(transaction, passage));\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tdefault:\n\t\t\tconsole.warn(\n\t\t\t\t`Story action ${\n\t\t\t\t\t(action as any).type\n\t\t\t\t} has no local storage persistence handler`\n\t\t\t);\n\t}\n\n\tlastState = state;\n}\n","import {passageDefaults, storyDefaults} from '../../../stories/defaults';\nimport {Passage, Story} from '../../../stories/stories.types';\n\n/**\n * Parses initial state from local storage.\n */\nexport async function load(): Promise<Story[]> {\n\tconst stories: Record<string, Story> = {};\n\tconst serializedStories = window.localStorage.getItem('twine-stories');\n\n\tif (!serializedStories) {\n\t\treturn [];\n\t}\n\n\t// First, deserialize stories. We index them by ID so that we can quickly add\n\t// passages to them as they are deserialized.\n\n\tserializedStories.split(',').forEach(id => {\n\t\tconst serializedStory = window.localStorage.getItem(`twine-stories-${id}`);\n\n\t\tif (!serializedStory) {\n\t\t\tconsole.warn(\n\t\t\t\t`Story list contained ID ${id}, but twine-stories-${id} does not exist, skipping`\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst story: Story = JSON.parse(serializedStory);\n\n\t\t\tif (!story.id) {\n\t\t\t\tconsole.warn('Story in local storage had no ID, skipping', story);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tstories[story.id] = {\n\t\t\t\t...storyDefaults(),\n\t\t\t\t...story,\n\n\t\t\t\t// Coerce lastUpdate to a date.\n\t\t\t\tlastUpdate: story.lastUpdate\n\t\t\t\t\t? new Date(Date.parse(story.lastUpdate as unknown as string))\n\t\t\t\t\t: new Date(),\n\n\t\t\t\t// Force the passages property to be an empty array -- we'll populate it\n\t\t\t\t// when we load passages below.\n\t\t\t\tpassages: []\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Could not parse story as JSON, skipping: ${serializedStory}`\n\t\t\t);\n\t\t}\n\t});\n\n\t// Then create passages, adding them to their parent story.\n\n\tconst serializedPassages = window.localStorage.getItem('twine-passages');\n\n\tif (serializedPassages) {\n\t\tserializedPassages.split(',').forEach(id => {\n\t\t\tconst serializedPassage = window.localStorage.getItem(\n\t\t\t\t`twine-passages-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedPassage) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Passage list contained ID ${id}, but twine-passages-${id} does not exist, skipping`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst passage: Passage = JSON.parse(serializedPassage);\n\n\t\t\t\tif (!passage || !passage.story) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Passage ${id} did not have parent story ID, skipping`,\n\t\t\t\t\t\tpassage\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!stories[passage.story]) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Passage ${id} is orphaned (looking for story ID ${passage.story}), skipping`\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstories[passage.story].passages.push({\n\t\t\t\t\t...passageDefaults,\n\t\t\t\t\t...passage,\n\n\t\t\t\t\t// Remove empty tags.\n\t\t\t\t\ttags: passage.tags ? passage.tags.filter(t => t.trim() !== '') : []\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Could not parse passage as JSON, skipping: ${serializedPassage}`\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\t}\n\n\t// Flatten the stories object.\n\treturn Object.values(stories);\n}\n","// Lightweight functions for dealing with comma-delimited strings (e.g. that don't\n// deal with all the intracacies of dealing with the actual CSV format, e.g.\n// quotation marks).\n\n/**\n * Returns whether a list contains a value.\n */\nexport function contains(list: string, value: string) {\n\treturn new RegExp('\\\\b' + value + '\\\\b').test(list);\n}\n\n/**\n * Adds a value to a list if it's not already present.\n */\nexport function addUnique(list: string, value: string) {\n\tif (list === '') {\n\t\treturn value;\n\t}\n\n\tif (contains(list, value)) {\n\t\treturn list;\n\t}\n\n\treturn list + ',' + value;\n}\n\n/**\n * Removes a value from a list.\n */\nexport function remove(list: string, value: string) {\n\tlist = list.replace(new RegExp(',?' + value), '');\n\n\t// We end up with a leading comma if we just removed the first value.\n\n\tif (list[0] === ',') {\n\t\treturn list.substring(1);\n\t}\n\n\treturn list;\n}\n","// Functions for moving stories into local storage. This module in particular\n// needs to remain well-optimized, as it has a direct effect on load time. As a\n// result, saving requires that you start and end a transaction manually. This\n// minimizes the number of writes to local storage.\n\nimport {Passage, Story} from '../../../stories/stories.types';\nimport {addUnique, remove} from '../comma-list';\n\nexport interface StorageTransaction {\n\tpassageIds: string;\n\tstoryIds: string;\n}\n\nexport type StorageUpdater = (transaction: StorageTransaction) => void;\n\n/**\n * A wrapper for a series of save/delete operations. This takes a function as\n * argument that will receive an object keeping track of the transaction. This\n * function should then make save and delete calls as necessary, passing the\n * provided transaction object as their first argument.\n */\nexport function doUpdateTransaction(updater: StorageUpdater) {\n\tconst transaction = {\n\t\tpassageIds: window.localStorage.getItem('twine-passages') ?? '',\n\t\tstoryIds: window.localStorage.getItem('twine-stories') ?? ''\n\t};\n\n\tupdater(transaction);\n\n\twindow.localStorage.setItem('twine-stories', transaction.storyIds);\n\twindow.localStorage.setItem('twine-passages', transaction.passageIds);\n}\n\n/**\n * Saves a story to local storage. This does *not* affect any child passages.\n **/\nexport function saveStory(transaction: StorageTransaction, story: Story) {\n\tif (!story.id) {\n\t\tthrow new Error('Story has no ID');\n\t}\n\n\ttransaction.storyIds = addUnique(transaction.storyIds, story.id);\n\n\t// We have to remove the passages property before serializing the story,\n\t// as those are serialized under separate keys.\n\n\twindow.localStorage.setItem(\n\t\t`twine-stories-${story.id}`,\n\t\tJSON.stringify({...story, passages: undefined})\n\t);\n}\n\n/**\n * Deletes a story from local storage. This does *not* affect any child\n * passages. You *must* delete child passages manually.\n */\nexport function deleteStory(transaction: StorageTransaction, story: Story) {\n\tif (!story.id) {\n\t\tthrow new Error('Story has no ID');\n\t}\n\n\ttransaction.storyIds = remove(transaction.storyIds, story.id);\n\twindow.localStorage.removeItem(`twine-stories-${story.id}`);\n}\n\n/**\n * Saves a passage to local storage.\n */\nexport function savePassage(transaction: StorageTransaction, passage: Passage) {\n\tif (!passage.id) {\n\t\tthrow new Error('Passage has no ID');\n\t}\n\n\ttransaction.passageIds = addUnique(transaction.passageIds, passage.id);\n\twindow.localStorage.setItem(\n\t\t`twine-passages-${passage.id}`,\n\t\tJSON.stringify(passage)\n\t);\n}\n\n/**\n * Deletes a passage from local storage.\n */\nexport function deletePassage(\n\ttransaction: StorageTransaction,\n\tpassage: Passage\n) {\n\tif (!passage.id) {\n\t\tthrow new Error('Passage has no ID');\n\t}\n\n\tdeletePassageById(transaction, passage.id);\n}\n\n/**\n * Deletes a passage from local storage by ID only.\n */\nexport function deletePassageById(\n\ttransaction: StorageTransaction,\n\tpassageId: string\n) {\n\ttransaction.passageIds = remove(transaction.passageIds, passageId);\n\twindow.localStorage.removeItem(`twine-passages-${passageId}`);\n}\n","import {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport async function load(): Promise<StoryFormatsState> {\n\tconst result: StoryFormatsState = [];\n\tconst serialized = window.localStorage.getItem('twine-storyformats');\n\n\tif (!serialized) {\n\t\treturn [];\n\t}\n\n\tserialized.split(',').forEach(id => {\n\t\ttry {\n\t\t\tconst serializedFormat = window.localStorage.getItem(\n\t\t\t\t`twine-storyformats-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedFormat) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`No story format stored at twine-storyformats-${id}, skipping`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresult.push({...JSON.parse(serializedFormat), loadState: 'unloaded'});\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Story format ${id} had corrupt serialized value, skipping`,\n\t\t\t\twindow.localStorage.getItem(`twine-storyformats-${id}`)\n\t\t\t);\n\t\t}\n\t});\n\n\treturn result;\n}\n","import uuid from 'tiny-uuid';\nimport {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport function save(state: StoryFormatsState) {\n\t// Delete existing formats in local storage, since we aren't bothering to\n\t// preserve ids.\n\n\tconst previouslySerialized = window.localStorage.getItem(\n\t\t'twine-storyformats'\n\t);\n\n\tif (previouslySerialized) {\n\t\tpreviouslySerialized.split(',').forEach(id => {\n\t\t\twindow.localStorage.removeItem(`twine-storyformats-${id}`);\n\t\t});\n\t}\n\n\t// Save new ones.\n\n\tlet ids: string[] = [];\n\n\tstate.forEach(format => {\n\t\tconst id = uuid();\n\n\t\t// We have to remove the `properties` property if it exists, as that is\n\t\t// dynamically added when loading.\n\n\t\tids.push(id);\n\t\twindow.localStorage.setItem(\n\t\t\t`twine-storyformats-${id}`,\n\t\t\tJSON.stringify({\n\t\t\t\t...format,\n\t\t\t\tloadError: undefined,\n\t\t\t\tloadState: undefined,\n\t\t\t\tproperties: undefined,\n\t\t\t\tselected: undefined\n\t\t\t})\n\t\t);\n\t});\n\n\twindow.localStorage.setItem('twine-storyformats', ids.join(','));\n}\n","import {StoryFormatsAction, StoryFormatsState} from '../../../story-formats';\nimport {isPersistableStoryFormatChange} from '../../persistable-changes';\nimport {save} from './save';\n\n/**\n * A middleware function to save changes to local storage. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(\n\tstate: StoryFormatsState,\n\taction: StoryFormatsAction\n) {\n\tswitch (action.type) {\n\t\tcase 'create':\n\t\tcase 'delete':\n\t\tcase 'repair':\n\t\t\tsave(state);\n\t\t\tbreak;\n\n\t\tcase 'update':\n\t\t\t// Is this a significant update?\n\t\t\tif (isPersistableStoryFormatChange(action.props)) {\n\t\t\t\tsave(state);\n\t\t\t}\n\t\t\tbreak;\n\t}\n}\n","import * as React from 'react';\nimport {useElectronIpcPersistence} from './electron-ipc/use-electron-ipc-persistence';\nimport {useLocalStoragePersistence} from './local-storage/use-local-storage-persistence';\nimport {isElectronRenderer} from '../../util/is-electron';\nimport {StoriesAction, StoriesState} from '../stories';\nimport {StoryFormatsAction, StoryFormatsState} from '../story-formats';\nimport {PrefsAction, PrefsState} from '../prefs';\n\nexport interface PersistenceHooks {\n\tprefs: {\n\t\tload: () => Promise<Partial<PrefsState>>;\n\t\tsaveMiddleware: (state: PrefsState, action: PrefsAction) => void;\n\t};\n\tstories: {\n\t\tload: () => Promise<StoriesState>;\n\t\tsaveMiddleware: (\n\t\t\tstate: StoriesState,\n\t\t\taction: StoriesAction,\n\t\t\tformats: StoryFormatsState\n\t\t) => void;\n\t};\n\tstoryFormats: {\n\t\tload: () => Promise<StoryFormatsState>;\n\t\tsaveMiddleware: (\n\t\t\tstate: StoryFormatsState,\n\t\t\taction: StoryFormatsAction\n\t\t) => void;\n\t};\n}\n\nexport function usePersistence(): PersistenceHooks {\n\tconst electronIpcPersistence = useElectronIpcPersistence();\n\tconst localStoragePersistence = useLocalStoragePersistence();\n\n\treturn React.useMemo(\n\t\t() =>\n\t\t\tisElectronRenderer() ? electronIpcPersistence : localStoragePersistence,\n\t\t[electronIpcPersistence, localStoragePersistence]\n\t);\n}\n","import * as React from 'react';\nimport * as prefs from './prefs';\nimport * as stories from './stories';\nimport * as storyFormats from './story-formats';\n\nexport function useElectronIpcPersistence() {\n\treturn React.useMemo(\n\t\t() => ({\n\t\t\tprefs: {\n\t\t\t\tload: prefs.load,\n\t\t\t\tsaveMiddleware: prefs.saveMiddleware\n\t\t\t},\n\t\t\tstories: {\n\t\t\t\tload: stories.load,\n\t\t\t\tsaveMiddleware: stories.saveMiddleware\n\t\t\t},\n\t\t\tstoryFormats: {\n\t\t\t\tload: storyFormats.load,\n\t\t\t\tsaveMiddleware: storyFormats.saveMiddleware\n\t\t\t}\n\t\t}),\n\t\t[]\n\t);\n}\n","import * as React from 'react';\nimport * as prefs from './prefs';\nimport * as stories from './stories';\nimport * as storyFormats from './story-formats';\n\nexport function useLocalStoragePersistence() {\n\treturn React.useMemo(\n\t\t() => ({\n\t\t\tprefs: {\n\t\t\t\tload: prefs.load,\n\t\t\t\tsaveMiddleware: prefs.saveMiddleware\n\t\t\t},\n\t\t\tstories: {\n\t\t\t\tload: stories.load,\n\t\t\t\tsaveMiddleware: stories.saveMiddleware\n\t\t\t},\n\t\t\tstoryFormats: {\n\t\t\t\tload: storyFormats.load,\n\t\t\t\tsaveMiddleware: storyFormats.saveMiddleware\n\t\t\t}\n\t\t}),\n\t\t[]\n\t);\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\nimport {PassageEditStack} from '../passage-edit';\n\n/**\n * Adds a passage editor dialog, either creating a new stack for it or adding it\n * to the top of an existing one.\n */\nexport function addPassageEditors(\n\tstoryId: string,\n\tpassageIds: string[],\n\teditorLimit = 6\n): Thunk<DialogsState, DialogsAction> {\n\treturn (dispatch, state) => {\n\t\tconst currentState = state();\n\t\tconst passageEditStackIndex = currentState.findIndex(\n\t\t\t({component}) => component === PassageEditStack\n\t\t);\n\n\t\tif (passageEditStackIndex !== -1) {\n\t\t\t// Put the passage IDs at the start, ensuring there are no duplicates.\n\n\t\t\tconst existing: string[] =\n\t\t\t\tcurrentState[passageEditStackIndex].props?.passageIds ?? [];\n\t\t\tconst updatedPassageIds = [\n\t\t\t\t...passageIds,\n\t\t\t\t...existing.filter(id => !passageIds.includes(id))\n\t\t\t];\n\n\t\t\t// Clamp the array length to the editor limit.\n\n\t\t\tif (updatedPassageIds.length > editorLimit) {\n\t\t\t\tupdatedPassageIds.length = editorLimit;\n\t\t\t}\n\n\t\t\tdispatch({\n\t\t\t\ttype: 'setDialogProps',\n\t\t\t\tindex: passageEditStackIndex,\n\t\t\t\tprops: {\n\t\t\t\t\t...currentState[passageEditStackIndex].props,\n\t\t\t\t\tpassageIds: updatedPassageIds\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\t// Add a new stack, clamping length.\n\t\t\tconst clampedPassageIds = [...passageIds];\n\n\t\t\tif (clampedPassageIds.length > editorLimit) {\n\t\t\t\tclampedPassageIds.length = editorLimit;\n\t\t\t}\n\n\t\t\tdispatch({\n\t\t\t\ttype: 'addDialog',\n\t\t\t\tcomponent: PassageEditStack,\n\t\t\t\tprops: {\n\t\t\t\t\tstoryId,\n\t\t\t\t\tpassageIds: clampedPassageIds\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n}\n\nexport function removePassageEditors(\n\tpassageIds: string[]\n): Thunk<DialogsState, DialogsAction> {\n\treturn (dispatch, state) => {\n\t\tconst currentState = state();\n\t\tconst passageEditStackIndex = currentState.findIndex(\n\t\t\t({component}) => component === PassageEditStack\n\t\t);\n\n\t\tif (passageEditStackIndex === -1) {\n\t\t\tconsole.warn(\n\t\t\t\t'Asked to remove a passage editor, but there is no editor stack'\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tconst updatedPassageIds = currentState[\n\t\t\tpassageEditStackIndex\n\t\t].props!.passageIds.filter((id: string) => !passageIds.includes(id));\n\n\t\tif (updatedPassageIds.length === 0) {\n\t\t\t// There are no passages left, so close the stack.\n\t\t\tdispatch({type: 'removeDialog', index: passageEditStackIndex});\n\t\t} else {\n\t\t\tdispatch({\n\t\t\t\ttype: 'setDialogProps',\n\t\t\t\tindex: passageEditStackIndex,\n\t\t\t\tprops: {\n\t\t\t\t\t...currentState[passageEditStackIndex].props,\n\t\t\t\t\tpassageIds: updatedPassageIds\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n}\n","import * as React from 'react';\nimport isEqual from 'lodash/isEqual';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\n\nexport const reducer: React.Reducer<DialogsState, DialogsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'addDialog':\n\t\t\t// If the dialog has been previously added, expand and/or highlight it.\n\t\t\t// Otherwise, add it to the end.\n\n\t\t\tlet exists = false;\n\t\t\tconst editedState = state.map(stateDialog => {\n\t\t\t\tif (\n\t\t\t\t\tisEqual(stateDialog, {\n\t\t\t\t\t\t// Ignore collapsed, highlighted, and maximized properties for comparison.\n\t\t\t\t\t\tcollapsed: stateDialog.collapsed,\n\t\t\t\t\t\tcomponent: action.component,\n\t\t\t\t\t\thighlighted: stateDialog.highlighted,\n\t\t\t\t\t\tmaximized: stateDialog.maximized,\n\t\t\t\t\t\tprops: action.props\n\t\t\t\t\t})\n\t\t\t\t) {\n\t\t\t\t\texists = true;\n\t\t\t\t\treturn {...stateDialog, collapsed: false, highlighted: true};\n\t\t\t\t}\n\n\t\t\t\treturn stateDialog;\n\t\t\t});\n\n\t\t\tif (exists) {\n\t\t\t\treturn editedState;\n\t\t\t}\n\n\t\t\treturn [\n\t\t\t\t...state,\n\t\t\t\t{\n\t\t\t\t\tcollapsed: false,\n\t\t\t\t\tcomponent: action.component,\n\t\t\t\t\thighlighted: false,\n\t\t\t\t\tmaximized: false,\n\t\t\t\t\tprops: action.props\n\t\t\t\t}\n\t\t\t];\n\n\t\tcase 'removeDialog':\n\t\t\treturn state.filter((dialog, index) => index !== action.index);\n\n\t\tcase 'setDialogCollapsed':\n\t\t\treturn state.map((dialog, index) =>\n\t\t\t\tindex === action.index\n\t\t\t\t\t? {...dialog, collapsed: action.collapsed}\n\t\t\t\t\t: dialog\n\t\t\t);\n\n\t\tcase 'setDialogHighlighted':\n\t\t\treturn state.map((dialog, index) =>\n\t\t\t\tindex === action.index\n\t\t\t\t\t? {...dialog, highlighted: action.highlighted}\n\t\t\t\t\t: dialog\n\t\t\t);\n\n\t\tcase 'setDialogMaximized':\n\t\t\treturn state.map((dialog, index) => ({\n\t\t\t\t...dialog,\n\t\t\t\tmaximized: index === action.index ? action.maximized : false\n\t\t\t}));\n\n\t\tcase 'setDialogProps':\n\t\t\treturn state.map((dialog, index) => ({\n\t\t\t\t...dialog,\n\t\t\t\tprops: index === action.index ? action.props : dialog.props\n\t\t\t}));\n\t}\n};\n","import * as React from 'react';\nimport useThunkReducer, {Thunk} from 'react-hook-thunk-reducer';\nimport {reducer} from './reducer';\nimport {Dialogs} from './dialogs';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\n\nexport interface DialogsContextProps {\n\tdispatch: React.Dispatch<DialogsAction | Thunk<DialogsState, DialogsAction>>;\n\tdialogs: DialogsState;\n}\n\nexport const DialogsContext = React.createContext<DialogsContextProps>({\n\tdispatch: () => {},\n\tdialogs: []\n});\n\nDialogsContext.displayName = 'Dialogs';\n\nexport const useDialogsContext = () => React.useContext(DialogsContext);\n\nexport const DialogsContextProvider: React.FC = props => {\n\tconst [dialogs, dispatch] = useThunkReducer(reducer, []);\n\n\treturn (\n\t\t<DialogsContext.Provider value={{dispatch, dialogs}}>\n\t\t\t{props.children}\n\t\t\t<Dialogs />\n\t\t</DialogsContext.Provider>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {colors, Color} from '../../util/color';\nimport {IconPlus, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton} from '../control/card-button';\nimport {IconButton} from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport {TextSelect} from '../control/text-select';\nimport {isValidTagName} from '../../util/tag';\nimport './add-tag-button.css';\n\nexport interface AddTagButtonProps {\n\t/**\n\t * Tags that have been assigned to this object.\n\t */\n\tassignedTags: string[];\n\t/**\n\t * Is the button disabled?\n\t */\n\tdisabled?: boolean;\n\t/**\n\t * Other tags that have been assigned to this type of object.\n\t */\n\texistingTags: string[];\n\t/**\n\t * Icon for the button.\n\t */\n\ticon?: React.ReactNode;\n\t/**\n\t * Label for the button.\n\t */\n\tlabel?: string;\n\t/**\n\t * Called when the user chooses to add a tag. If they are adding a\n\t * pre-existing tag, it will only send a name.\n\t */\n\tonAdd: (name: string, color?: Color) => void;\n}\n\nexport const AddTagButton: React.FC<AddTagButtonProps> = props => {\n\tconst {assignedTags, disabled, existingTags, icon, label, onAdd} = props;\n\tconst [creatingTag, setCreatingTag] = React.useState(true);\n\tconst [newColor, setNewColor] = React.useState<Color>('none');\n\tconst [newName, setNewName] = React.useState('');\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\tlet validationMessage: string | undefined = undefined;\n\tlet canAdd = isValidTagName(newName);\n\n\tif (!canAdd && newName !== '') {\n\t\tvalidationMessage = t('components.addTagButton.invalidName');\n\t}\n\n\tif (canAdd && creatingTag) {\n\t\tcanAdd = !existingTags.includes(newName);\n\n\t\tif (!canAdd) {\n\t\t\tvalidationMessage = t('components.addTagButton.alreadyAdded');\n\t\t}\n\t}\n\n\tfunction handleAdd() {\n\t\tif (creatingTag) {\n\t\t\tonAdd(newName, newColor);\n\t\t} else {\n\t\t\tonAdd(newName);\n\t\t}\n\n\t\tsetOpen(false);\n\t}\n\n\tfunction handleSelectChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst tagName = event.target.value;\n\n\t\tsetNewName(tagName);\n\t\tsetCreatingTag(tagName === '');\n\t}\n\n\treturn (\n\t\t<span className=\"add-tag-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={t('components.addTagButton.addLabel')}\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon={icon ?? <IconPlus />}\n\t\t\t\tlabel={label ?? t('common.tag')}\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<TextSelect\n\t\t\t\t\t\tonChange={handleSelectChange}\n\t\t\t\t\t\toptions={[\n\t\t\t\t\t\t\t{label: t('components.addTagButton.newTag'), value: ''},\n\t\t\t\t\t\t\t...existingTags.map(tag => ({\n\t\t\t\t\t\t\t\tdisabled: assignedTags.includes(tag),\n\t\t\t\t\t\t\t\tlabel: tag,\n\t\t\t\t\t\t\t\tvalue: tag\n\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t]}\n\t\t\t\t\t\tvalue={creatingTag ? '' : newName}\n\t\t\t\t\t>\n\t\t\t\t\t\t{t('components.addTagButton.addLabel')}\n\t\t\t\t\t</TextSelect>\n\t\t\t\t\t{creatingTag && (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<TextInput\n\t\t\t\t\t\t\t\tonChange={e => setNewName(e.target.value.replace(/\\s/g, '-'))}\n\t\t\t\t\t\t\t\tvalue={newName}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{t('components.addTagButton.tagNameLabel')}\n\t\t\t\t\t\t\t</TextInput>\n\t\t\t\t\t\t\t<TextSelect\n\t\t\t\t\t\t\t\tonChange={e => setNewColor(e.target.value)}\n\t\t\t\t\t\t\t\toptions={colors.map(color => ({\n\t\t\t\t\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\t\t\t\t\tvalue: color\n\t\t\t\t\t\t\t\t}))}\n\t\t\t\t\t\t\t\tvalue={newColor}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{t('components.addTagButton.tagColorLabel')}\n\t\t\t\t\t\t\t</TextSelect>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)}\n\t\t\t\t\t{creatingTag && !!validationMessage && <p>{validationMessage}</p>}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={!canAdd}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={t('common.add')}\n\t\t\t\t\t\tonClick={handleAdd}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.cancel')}\n\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {useTranslation} from 'react-i18next';\nimport {IconChevronDown} from '@tabler/icons';\nimport {MenuButton} from '../control/menu-button';\nimport {colors, Color} from '../../util/color';\nimport './tag-button.css';\n\nexport interface TagButtonProps {\n\tcolor?: Color;\n\tdisabled?: boolean;\n\tname: string;\n\tonChangeColor: (color: Color) => void;\n\tonRemove: () => void;\n}\n\nexport const TagButton: React.FC<TagButtonProps> = props => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<span className={classNames('tag-button', `color-${props.color}`)}>\n\t\t\t<MenuButton\n\t\t\t\tdisabled={props.disabled}\n\t\t\t\ticon={<IconChevronDown />}\n\t\t\t\ticonPosition=\"end\"\n\t\t\t\titems={[\n\t\t\t\t\t...colors.map(color => ({\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: color === 'none' ? !props.color : color === props.color,\n\t\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\t\tonClick: () => props.onChangeColor(color)\n\t\t\t\t\t})),\n\t\t\t\t\t{\n\t\t\t\t\t\tseparator: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('common.remove'),\n\t\t\t\t\t\tonClick: props.onRemove\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tlabel={props.name}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './icon-button-link.css';\n\nexport interface IconLinkProps {\n\thref: string;\n\ticon: React.ReactNode;\n\tlabel: string;\n\tvariant?: 'create' | 'danger' | 'primary' | 'secondary';\n\ttarget?: string;\n}\n\nexport const IconLink: React.FC<IconLinkProps> = props => {\n\tconst {href, icon, label, target, variant} = props;\n\tconst className = classNames('icon-link', `variant-${variant}`);\n\n\treturn (\n\t\t<a href={href} className={className} target={target ?? '_blank'}>\n\t\t\t<span className=\"icon\">{icon}</span>\n\t\t\t{label}\n\t\t</a>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconIndentDecrease, IconIndentIncrease} from '@tabler/icons';\nimport {IconButton} from '../control/icon-button';\n\nexport interface IndentButtonsProps {\n\t/**\n\t * CodeMirror instance to interact with.\n\t */\n\teditor?: CodeMirror.Editor;\n}\n\nexport const IndentButtons: React.FC<IndentButtonsProps> = props => {\n\tconst {editor} = props;\n\tconst {t} = useTranslation();\n\n\tfunction execCommand(command: string) {\n\t\teditor?.execCommand(command);\n\t\teditor?.focus();\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!editor}\n\t\t\t\ticon={<IconIndentIncrease />}\n\t\t\t\tlabel={t('components.indentButtons.indent')}\n\t\t\t\tonClick={() => execCommand('indentMore')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!editor}\n\t\t\t\ticon={<IconIndentDecrease />}\n\t\t\t\tlabel={t('components.indentButtons.unindent')}\n\t\t\t\tonClick={() => execCommand('indentLess')}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowBack, IconArrowForward} from '@tabler/icons';\nimport {IconButton} from '../control/icon-button';\n\nexport interface UndoRedoButtonsProps {\n\t/**\n\t * Disables both buttons no matter the state of the editor.\n\t */\n\tdisabled?: boolean;\n\t/**\n\t * CodeMirror instance to interact with.\n\t */\n\teditor?: CodeMirror.Editor;\n\t/**\n\t * A change in this prop triggers a render (probably, put the editor value\n\t * here). This is necessary because the editor instance itself is mutable, so\n\t * we need some way of knowing when to re-check whether undo/redo is availble.\n\t */\n\twatch: string;\n}\n\nexport const UndoRedoButtons: React.FC<UndoRedoButtonsProps> = props => {\n\tconst {disabled, editor, watch} = props;\n\tconst {t} = useTranslation();\n\tconst [canRedo, setCanRedo] = React.useState(false);\n\tconst [canUndo, setCanUndo] = React.useState(false);\n\n\tReact.useEffect(() => {\n\t\tif (editor) {\n\t\t\tconst history = editor.historySize();\n\n\t\t\tsetCanRedo(history.redo > 0);\n\t\t\tsetCanUndo(history.undo > 0);\n\t\t} else {\n\t\t\tsetCanRedo(false);\n\t\t\tsetCanUndo(false);\n\t\t}\n\t}, [editor, watch]);\n\n\tfunction execCommand(command: string) {\n\t\teditor?.execCommand(command);\n\t\teditor?.focus();\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={disabled || !canUndo}\n\t\t\t\ticon={<IconArrowBack />}\n\t\t\t\tlabel={t('common.undo')}\n\t\t\t\tonClick={() => execCommand('undo')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={disabled || !canRedo}\n\t\t\t\ticon={<IconArrowForward />}\n\t\t\t\tlabel={t('common.redo')}\n\t\t\t\tonClick={() => execCommand('redo')}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './card.css';\n\nexport interface CardProps {\n\tfloating?: boolean;\n\thighlighted?: boolean;\n}\n\nexport const Card: React.FC<CardProps> = props => {\n\tconst {children, floating, highlighted} = props;\n\n\tconst className = classNames('card', {\n\t\tfloating,\n\t\thighlighted\n\t});\n\n\treturn <div className={className}>{children}</div>;\n};\n","import Fuse from 'fuse.js';\nimport uniq from 'lodash/uniq';\nimport {Passage, StorySearchFlags, Story} from './stories.types';\nimport {createRegExp} from '../../util/regexp';\nimport {parseLinks} from '../../util/parse-links';\n\nexport function passageWithId(\n\tstories: Story[],\n\tstoryId: string,\n\tpassageId: string\n) {\n\tconst story = storyWithId(stories, storyId);\n\tconst result = story.passages.find(p => p.id === passageId);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no passage with ID \"${passageId}\" in a story with ID \"${storyId}\".`\n\t);\n}\n\nexport function passageWithName(\n\tstories: Story[],\n\tstoryId: string,\n\tpassageName: string\n) {\n\tconst story = storyWithId(stories, storyId);\n\tconst result = story.passages.find(p => p.name === passageName);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no passage with name \"${passageName}\" in a story with ID \"${storyId}\".`\n\t);\n}\n\n/**\n * Returns connections between passages in a structure optimized for rendering.\n * Connections are divided between draggable and fixed, depending on whether\n * either of their passages are selected (and could be dragged by the user).\n */\nexport function passageConnections(\n\tpassages: Passage[],\n\tconnectionParser?: (text: string) => string[]\n) {\n\tconst parser = connectionParser ?? ((text: string) => parseLinks(text, true));\n\tconst passageMap = new Map(passages.map(p => [p.name, p]));\n\tconst result = {\n\t\tdraggable: {\n\t\t\tbroken: new Set<Passage>(),\n\t\t\tconnections: new Map<Passage, Set<Passage>>(),\n\t\t\tself: new Set<Passage>()\n\t\t},\n\t\tfixed: {\n\t\t\tbroken: new Set<Passage>(),\n\t\t\tconnections: new Map<Passage, Set<Passage>>(),\n\t\t\tself: new Set<Passage>()\n\t\t}\n\t};\n\n\tpassages.forEach(passage =>\n\t\tparser(passage.text).forEach(targetName => {\n\t\t\tif (targetName === passage.name) {\n\t\t\t\t(passage.selected ? result.draggable : result.fixed).self.add(passage);\n\t\t\t} else {\n\t\t\t\tconst targetPassage = passageMap.get(targetName);\n\n\t\t\t\tif (targetPassage) {\n\t\t\t\t\tconst target =\n\t\t\t\t\t\tpassage.selected || targetPassage.selected\n\t\t\t\t\t\t\t? result.draggable\n\t\t\t\t\t\t\t: result.fixed;\n\n\t\t\t\t\tif (target.connections.has(passage)) {\n\t\t\t\t\t\ttarget.connections.get(passage)!.add(targetPassage);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttarget.connections.set(passage, new Set([targetPassage]));\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t(passage.selected ? result.draggable : result.fixed).broken.add(\n\t\t\t\t\t\tpassage\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t);\n\n\treturn result;\n}\n\n/**\n * Returns a set of passages matching a fuzzy search crtieria.\n */\nexport function passagesMatchingFuzzySearch(\n\tpassages: Passage[],\n\tsearch: string,\n\tcount = 5\n) {\n\tif (search.trim() === '') {\n\t\treturn [];\n\t}\n\n\tconst fuse = new Fuse(passages, {\n\t\tignoreLocation: true,\n\t\tkeys: [\n\t\t\t{name: 'name', weight: 0.6},\n\t\t\t{name: 'text', weight: 0.4}\n\t\t]\n\t});\n\n\treturn fuse.search(search, {limit: count}).map(({item}) => item);\n}\n\n/**\n * Returns all passages matching a search criteria. Use\n * `highlightPassageMatches()` to highlight exactly what matched.\n */\nexport function passagesMatchingSearch(\n\tpassages: Passage[],\n\tsearch: string,\n\tflags: StorySearchFlags\n): Passage[] {\n\tif (search === '') {\n\t\treturn [];\n\t}\n\n\tconst {includePassageNames, matchCase, useRegexes} = flags;\n\tlet matcher: RegExp;\n\n\ttry {\n\t\tmatcher = createRegExp(search, {matchCase, useRegexes});\n\t} catch (error) {\n\t\t// The regexp was malformed. Take no action.\n\t\treturn [];\n\t}\n\n\treturn passages.reduce((result, passage) => {\n\t\tif (\n\t\t\tmatcher.test(passage.text) ||\n\t\t\t(includePassageNames && matcher.test(passage.name))\n\t\t) {\n\t\t\treturn [...result, passage];\n\t\t}\n\n\t\treturn result;\n\t}, [] as Passage[]);\n}\n\nexport function storyPassageTags(story: Story) {\n\treturn Array.from(\n\t\tstory.passages.reduce((result, passage) => {\n\t\t\tpassage.tags && passage.tags.forEach(tag => result.add(tag));\n\t\t\treturn result;\n\t\t}, new Set<string>())\n\t).sort();\n}\n\nexport function storyStats(story: Story) {\n\tconst links = story.passages.reduce<string[]>(\n\t\t(links, passage) => [\n\t\t\t...links,\n\t\t\t...parseLinks(passage.text).filter(link => links.indexOf(link) === -1)\n\t\t],\n\t\t[]\n\t);\n\n\tconst brokenLinks = uniq(links).filter(\n\t\tlink => !story.passages.some(passage => passage.name === link)\n\t);\n\n\treturn {\n\t\tbrokenLinks,\n\t\tlinks,\n\t\tcharacters: story.passages.reduce(\n\t\t\t(count, passage) => count + passage.text.length,\n\t\t\t0\n\t\t),\n\t\tpassages: story.passages.length,\n\t\twords: story.passages.reduce(\n\t\t\t(count, passage) => count + passage.text.split(/\\s+/).length,\n\t\t\t0\n\t\t)\n\t};\n}\n\nexport function storyTags(stories: Story[]) {\n\treturn Array.from(\n\t\tstories.reduce((result, story) => {\n\t\t\tstory.tags && story.tags.forEach(tag => result.add(tag));\n\t\t\treturn result;\n\t\t}, new Set<string>())\n\t).sort();\n}\n\nexport function storyWithId(stories: Story[], storyId: string) {\n\tconst result = stories.find(s => s.id === storyId);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story with ID \"${storyId}\".`);\n}\n\nexport function storyWithName(stories: Story[], name: string) {\n\tconst result = stories.find(s => s.name === name);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story with name \"${name}\".`);\n}\n","// Manages requesting a story format via URL. There are two aspects that add\n// complexity:\n//\n// - The difference between web and Electron contexts. In a web context, the app is\n//   able to make JSON requests freely. In Electron contexts, however, it is\n//   restricted to HTTP/HTTPS only. To allow users to add story formats via\n//   file:/// URL, the main process will make JSONP requests on behalf of a web\n//   process.\n//\n//   This is only needed for requests outside the app bundle (e.g. loading a locale\n//   or an external story format).\n//\n// - Throttling requests. Because all story formats load via the same global\n//   callback, we can only load one at a time safely--otherwise they will compete\n//   for the same callback.\n\nimport jsonp from 'jsonp';\nimport {TwineElectronWindow} from '../../electron/shared';\nimport {StoryFormatProperties} from '../../store/story-formats';\nimport {isElectronRenderer} from '../is-electron';\n\nlet requestQueue = Promise.resolve();\n\n/**\n * Fetches a story format's properties via JSONP. If multiple requests are made\n * at once, they will be queued by this function.\n */\nexport async function fetchStoryFormatProperties(\n\turl: string,\n\ttimeout = 2000\n): Promise<StoryFormatProperties> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\tconst jsonpRequester =\n\t\tisElectronRenderer() && twineElectron?.jsonp ? twineElectron.jsonp : jsonp;\n\n\treturn new Promise(\n\t\t(resolve, reject) =>\n\t\t\t(requestQueue = requestQueue.then(\n\t\t\t\t() =>\n\t\t\t\t\tnew Promise(resolveQueue => {\n\t\t\t\t\t\tjsonpRequester(url, {timeout, name: 'storyFormat'}, (err, data) => {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\treject(err);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresolve(data);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolveQueue();\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t))\n\t);\n}\n","export const builtins = () => [\n\t{\n\t\tname: 'Chapbook',\n\t\turl: 'story-formats/chapbook-1.2.3/format.js',\n\t\tversion: '1.2.3'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-1.2.4/format.js',\n\t\tversion: '1.2.4'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-2.1.0/format.js',\n\t\tversion: '2.1.0'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-3.3.5/format.js',\n\t\tversion: '3.3.5'\n\t},\n\t{\n\t\tname: 'Paperthin',\n\t\turl: 'story-formats/paperthin-1.0.0/format.js',\n\t\tversion: '1.0.0'\n\t},\n\t{\n\t\tname: 'Snowman',\n\t\turl: 'story-formats/snowman-1.4.0/format.js',\n\t\tversion: '1.4.0'\n\t},\n\t{\n\t\tname: 'Snowman',\n\t\turl: 'story-formats/snowman-2.0.2/format.js',\n\t\tversion: '2.0.2',\n\t\tuserAdded: false\n\t},\n\t{\n\t\tname: 'SugarCube',\n\t\turl: 'story-formats/sugarcube-1.0.35/format.js',\n\t\tversion: '1.0.35'\n\t},\n\t{\n\t\tname: 'SugarCube',\n\t\turl: 'story-formats/sugarcube-2.36.1/format.js',\n\t\tversion: '2.36.1'\n\t}\n];\n","import {useTranslation} from 'react-i18next';\nimport {isElectronRenderer} from '../util/is-electron';\n\nexport function useStoreErrorReporter() {\n\t// We can't use suspense here because we're too high in the component tree--we\n\t// need to report errors as soon as possible, and if prefs fail, we might not\n\t// have i18n initialized.\n\n\tconst {t, ready} = useTranslation('', {useSuspense: false});\n\n\treturn {\n\t\treportError(error: Error, messageKey: string) {\n\t\t\tconsole.error('Twine store error', error);\n\n\t\t\tif (ready) {\n\t\t\t\twindow.alert(\n\t\t\t\t\tt(messageKey, {error: error.message}) +\n\t\t\t\t\t\t' ' +\n\t\t\t\t\t\tt(\n\t\t\t\t\t\t\t`store.errors.${\n\t\t\t\t\t\t\t\tisElectronRenderer() ? 'electron' : 'web'\n\t\t\t\t\t\t\t}Remediation`\n\t\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\twindow.alert(\n\t\t\t\t\t`An error occurred while saving (${error.message}). Reloading or restarting the application may help.`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t};\n}\n","import {EditorConfiguration} from 'codemirror';\nimport {PrefsState} from '../store/prefs';\n\n/**\n * Returns baseline CodeMirror options based on user preferences.\n */\nexport function codeMirrorOptionsFromPrefs(\n\tprefs: PrefsState\n): EditorConfiguration {\n\t// Disable overstrike mode.\n\n\tlet result: EditorConfiguration = {\n\t\textraKeys: {\n\t\t\tInsert() {}\n\t\t}\n\t};\n\n\tif (!prefs.editorCursorBlinks) {\n\t\tresult.cursorBlinkRate = 0;\n\t}\n\n\treturn result;\n}\n","// See https://stackoverflow.com/a/64174790\n\nexport const colors = [\n\t'none',\n\t'red',\n\t'orange',\n\t'yellow',\n\t'green',\n\t'blue',\n\t'purple'\n];\n\nexport type Color = typeof colors[number];\n","import * as React from 'react';\nimport './dialog-stack-expander.css';\n\nexport interface DialogStackExpanderProps {\n\tdialogLength: number;\n\texpanded: boolean;\n\tonChangeExpanded: (value: boolean) => void;\n}\n\nexport const DialogStackExpander: React.FC<\n\tDialogStackExpanderProps\n> = props => {\n\tconst {dialogLength, expanded, onChangeExpanded} = props;\n\tconst [wasTouched, setWasTouched] = React.useState(false);\n\n\t// This listener is global and listens for touches anywhere when the stack is\n\t// expanded. Because it listens only on `touchstart`, it will never respond to\n\t// mouse-initiated events.\n\n\tReact.useEffect(() => {\n\t\tfunction listener() {\n\t\t\tif (expanded) {\n\t\t\t\tonChangeExpanded(false);\n\t\t\t\tsetWasTouched(false);\n\t\t\t}\n\t\t}\n\n\t\twindow.addEventListener('touchstart', listener);\n\t\treturn () => window.removeEventListener('touchstart', listener);\n\t}, [expanded, onChangeExpanded]);\n\n\t// If the stack is expanded and was opened via touch, we don't need to render\n\t// anything. The global listener will handle collapsing the stack.\n\n\tif (expanded && wasTouched) {\n\t\treturn null;\n\t}\n\n\t// The stack is either not expanded, or a mouse was used to open the stack. In\n\t// this case, we render a div to catch events:\n\t// - mouseover to catch either expand or collapsing based on hover behavior.\n\t//   The style property sets the area we listen to for these events (the\n\t//   overflow area when the stack is collapsed, everything but the overflow\n\t//   area when it's expanded).\n\t// - touchend to handle expanding a collapsed stack via touch. We prevent\n\t//   default on this event to prevent mouse emulation events from firing.\n\n\treturn (\n\t\t<div\n\t\t\taria-hidden\n\t\t\tclassName=\"dialog-stack-expander\"\n\t\t\tonMouseEnter={() => onChangeExpanded(!expanded)}\n\t\t\tonTouchEnd={event => {\n\t\t\t\tonChangeExpanded(true);\n\t\t\t\tsetWasTouched(true);\n\t\t\t\tevent.preventDefault();\n\t\t\t}}\n\t\t\tstyle={{\n\t\t\t\tbottom: expanded ? 0 : 'auto',\n\t\t\t\theight: expanded ? 'auto' : 'var(--control-height)',\n\t\t\t\ttop: expanded ? `calc(var(--control-height) * ${dialogLength})` : 0\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import classnames from 'classnames';\nimport * as React from 'react';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {DialogStackExpander} from './dialog-stack-expander';\nimport './dialog-stack.css';\n\nexport interface DialogStackProps {\n\t/**\n\t * Children must be <DialogCard>s or <BackgroundDialogCard>s. Order in the\n\t * array is topmost to bottom as displayed. We do this to make it easy to\n\t * clamp the number of children; truncating the end means the furthest back\n\t * are removed.\n\t */\n\tchildren: React.ReactNode[];\n\t/**\n\t * Keys to apply to the children to prevent spurious transitions.\n\t */\n\tchildKeys: string[];\n}\n\n/**\n * Maximum number of expanded dialogs. More than this will cause the last\n * remaining slot to be used as overflow.\n */\nconst maxExpandedDialogs = 3;\n\n// Saves some parenthesis counting in the styles below.\nconst headerHeight = 'var(--control-height)';\n\nexport const DialogStack: React.FC<DialogStackProps> = ({\n\tchildren,\n\tchildKeys\n}) => {\n\tconst containerRef = React.useRef<HTMLDivElement>(null);\n\tconst [expanded, setExpanded] = React.useState(false);\n\n\t// We need to reverse the order of children for rendering so that tab order is\n\t// correct. Meaning--the further in the background a dialog is, the earlier it\n\t// needs to be rendered. This has a side effect of also not needing us to\n\t// calculate z indices, since absolutely-positioned elements later in the DOM\n\t// appear above earlier ones.\n\t//\n\t// These are separately memoized because children may change while childKeys\n\t// remains the same.\n\n\tconst childrenInRenderOrder = React.useMemo(\n\t\t() => [...children].reverse(),\n\t\t[children]\n\t);\n\tconst childKeysInRenderOrder = React.useMemo(\n\t\t() => [...childKeys].reverse(),\n\t\t[childKeys]\n\t);\n\n\t// Remember the last change in childKeys.\n\n\tconst lastChildKeysInRenderOrder = React.useRef<string[]>();\n\n\tReact.useEffect(() => {\n\t\tlastChildKeysInRenderOrder.current = childKeysInRenderOrder;\n\t}, [childKeysInRenderOrder]);\n\n\t// The foreground dialog should have a rising animation applied to it if:\n\t// - The number of dialogs has not changed, but\n\t// - The foreground dialog key has changed\n\t//\n\t// In other words, if the dialogs have been reordered in-place.\n\tconst foregroundIsRising = React.useMemo(\n\t\t() =>\n\t\t\tchildKeysInRenderOrder.length ===\n\t\t\t\tlastChildKeysInRenderOrder.current?.length &&\n\t\t\tchildKeysInRenderOrder[childKeysInRenderOrder.length - 1] !==\n\t\t\t\tlastChildKeysInRenderOrder.current?.[childKeysInRenderOrder.length - 1],\n\t\t[childKeysInRenderOrder]\n\t);\n\n\t// How many dialog card headers will be fully visible.\n\tconst visibleLength = Math.min(children.length, maxExpandedDialogs);\n\n\t// Do we have overflowed dialogs?\n\tconst stackHasOverflow = children.length > visibleLength;\n\n\t// The height of a single dialog card header in the overflow area, where\n\t// headers are not completely visible.\n\tconst overflowHeaderHeight = `${headerHeight} / ${\n\t\tchildren.length + 1 - maxExpandedDialogs\n\t}`;\n\n\t// The height of each dialog. This is calculated so all dialogs stay within the\n\t// container height.\n\tconst height = `calc(100% - (${headerHeight} * ${visibleLength - 1}))`;\n\n\t// TransitionGroup and CSSTransition should match usage in <Dialogs>.\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"dialog-stack\"\n\t\t\tonMouseLeave={() => setExpanded(false)}\n\t\t\tonClick={() => setExpanded(false)}\n\t\t\tref={containerRef}\n\t\t>\n\t\t\t{stackHasOverflow && (\n\t\t\t\t<DialogStackExpander\n\t\t\t\t\tdialogLength={children.length}\n\t\t\t\t\texpanded={expanded}\n\t\t\t\t\tonChangeExpanded={setExpanded}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{childrenInRenderOrder.map((child, index) => {\n\t\t\t\t\t// This is the unexpanded top position of the dialog card. If the card\n\t\t\t\t\t// is not overflowed, then it's moved down to an even multiple of\n\t\t\t\t\t// headerHeight. If the card is overflowed, then it is moved down\n\t\t\t\t\t// based on overflowHeaderHeight instead, which evenly divides the\n\t\t\t\t\t// overflow area by the number of cards in it.\n\n\t\t\t\t\t// An example of a simple stack (length 3):\n\t\t\t\t\t// 0    index 0\n\t\t\t\t\t// 40px index 1\n\t\t\t\t\t// 80px index 2\n\n\t\t\t\t\t// An example of an overflowed stack (length 6):\n\t\t\t\t\t// 0    index 0\n\t\t\t\t\t// 10px index 1\n\t\t\t\t\t// 20px index 2\n\t\t\t\t\t// 30px index 3\n\t\t\t\t\t// -- overflow before this --\n\t\t\t\t\t// 40px index 4\n\t\t\t\t\t// 80px index 5\n\n\t\t\t\t\tconst cardIsOverflowed =\n\t\t\t\t\t\tstackHasOverflow && index <= children.length - maxExpandedDialogs;\n\t\t\t\t\tconst top = cardIsOverflowed\n\t\t\t\t\t\t? `calc(${overflowHeaderHeight} * ${index})`\n\t\t\t\t\t\t: `calc(${headerHeight} * ${\n\t\t\t\t\t\t\t\tstackHasOverflow\n\t\t\t\t\t\t\t\t\t? index - (children.length - maxExpandedDialogs)\n\t\t\t\t\t\t\t\t\t: index\n\t\t\t\t\t\t  })`;\n\n\t\t\t\t\t// When the stack is expanded, all cards get equal height.\n\n\t\t\t\t\tconst expandedTop = `calc(${headerHeight} * ${index})`;\n\n\t\t\t\t\t// If an overflowed card gains focus, we need to expand it.\n\n\t\t\t\t\tconst focusHandlers = cardIsOverflowed && {\n\t\t\t\t\t\tonBlur: () => setExpanded(false),\n\t\t\t\t\t\tonFocus: () => setExpanded(true)\n\t\t\t\t\t};\n\n\t\t\t\t\t// We need two container divs because CSSTransition will apply a\n\t\t\t\t\t// transform property to the outer container (via the pop-* classes),\n\t\t\t\t\t// but we also want to use transform to position the dialogs so that\n\t\t\t\t\t// we can smoothly animate their motion.\n\t\t\t\t\t//\n\t\t\t\t\t// We assign the `rising` CSS class to make it appear as if a dialog\n\t\t\t\t\t// that has moved to the front is popping into place. The check with\n\t\t\t\t\t// children's length is to ensure it doesn't get added if a dialog is\n\t\t\t\t\t// new to the stack.\n\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<CSSTransition\n\t\t\t\t\t\t\tclassNames=\"pop\"\n\t\t\t\t\t\t\ttimeout={200}\n\t\t\t\t\t\t\tkey={childKeysInRenderOrder[index]}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclassName={classnames('dialog-height-setter', {\n\t\t\t\t\t\t\t\t\trising:\n\t\t\t\t\t\t\t\t\t\tforegroundIsRising &&\n\t\t\t\t\t\t\t\t\t\tindex === childrenInRenderOrder.length - 1\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\tstyle={{height}}\n\t\t\t\t\t\t\t\t{...focusHandlers}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\t\tclassName=\"dialog-transform-setter\"\n\t\t\t\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\t\t\t\ttransform: `translateY(${expanded ? expandedTop : top})`\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{child}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</TransitionGroup>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogEditor} from '../../components/container/dialog-card';\nimport {CodeArea} from '../../components/control/code-area';\nimport {usePrefsContext} from '../../store/prefs';\nimport {Passage, Story} from '../../store/stories';\nimport {StoryFormat} from '../../store/story-formats';\nimport {useCodeMirrorPassageHints} from '../../store/use-codemirror-passage-hints';\nimport {useFormatCodeMirrorMode} from '../../store/use-format-codemirror-mode';\nimport {codeMirrorOptionsFromPrefs} from '../../util/codemirror-options';\n\nexport interface PassageTextProps {\n\tdisabled?: boolean;\n\tonChange: (value: string) => void;\n\tonEditorChange: (value: CodeMirror.Editor) => void;\n\tpassage: Passage;\n\tstory: Story;\n\tstoryFormat: StoryFormat;\n\tstoryFormatExtensionsDisabled?: boolean;\n}\n\nexport const PassageText: React.FC<PassageTextProps> = props => {\n\tconst {\n\t\tdisabled,\n\t\tonChange,\n\t\tonEditorChange,\n\t\tpassage,\n\t\tstory,\n\t\tstoryFormat,\n\t\tstoryFormatExtensionsDisabled\n\t} = props;\n\tconst [localText, setLocalText] = React.useState(passage.text);\n\tconst {prefs} = usePrefsContext();\n\tconst autocompletePassageNames = useCodeMirrorPassageHints(story);\n\tconst mode =\n\t\tuseFormatCodeMirrorMode(storyFormat.name, storyFormat.version) ?? 'text';\n\tconst {t} = useTranslation();\n\n\t// These are refs so that changing them doesn't trigger a rerender, and more\n\t// importantly, no React effects fire.\n\n\tconst onChangeText = React.useRef<string>();\n\tconst onChangeTimeout = React.useRef<number>();\n\n\t// Effects to handle debouncing updates upward. The idea here is that the\n\t// component maintains a local state so that the CodeMirror instance always is\n\t// up-to-date with what the user has typed, but the global context may not be.\n\t// This is because updating global context causes re-rendering in the story\n\t// map, which can be time-intensive.\n\n\tReact.useEffect(() => {\n\t\t// A change to passage text has occurred externally, e.g. through a find and\n\t\t// replace. We ignore this if a change is pending so that users don't see\n\t\t// things they've typed in disappear or be replaced.\n\n\t\tif (!onChangeTimeout.current && localText !== passage.text) {\n\t\t\tsetLocalText(passage.text);\n\t\t}\n\t}, [localText, passage.text]);\n\n\tconst handleLocalChange = React.useCallback(\n\t\t(\n\t\t\teditor: CodeMirror.Editor,\n\t\t\tdata: CodeMirror.EditorChange,\n\t\t\ttext: string\n\t\t) => {\n\t\t\t// A local change has been made, e.g. the user has typed or pasted into\n\t\t\t// the field. It's safe to immediately trigger a CodeMirror editor update.\n\n\t\t\tonEditorChange(editor);\n\n\t\t\t// Set local state because the CodeMirror instance is controlled, and\n\t\t\t// updates there should be immediate.\n\n\t\t\tsetLocalText(text);\n\n\t\t\t// If there was a pending update, cancel it.\n\n\t\t\tif (onChangeTimeout.current) {\n\t\t\t\twindow.clearTimeout(onChangeTimeout.current);\n\t\t\t}\n\n\t\t\t// Save the text value in case we need to reset the timeout in the next\n\t\t\t// effect.\n\n\t\t\tonChangeText.current = text;\n\n\t\t\t// Queue a call to onChange.\n\n\t\t\tonChangeTimeout.current = window.setTimeout(() => {\n\t\t\t\t// Important to reset this ref so that we don't try to cancel fired\n\t\t\t\t// timeouts above.\n\n\t\t\t\tonChangeTimeout.current = undefined;\n\n\t\t\t\t// Finally call the onChange prop.\n\n\t\t\t\tonChange(onChangeText.current!);\n\t\t\t}, 1000);\n\t\t},\n\t\t[onChange, onEditorChange]\n\t);\n\n\t// If the onChange prop changes while an onChange call is pending, reset the\n\t// timeout and point it to the correct callback.\n\n\tReact.useEffect(() => {\n\t\tif (onChangeTimeout.current) {\n\t\t\twindow.clearTimeout(onChangeTimeout.current);\n\t\t\tonChangeTimeout.current = window.setTimeout(() => {\n\t\t\t\t// This body must be the same as in the timeout in the previous effect.\n\n\t\t\t\tonChangeTimeout.current = undefined;\n\t\t\t\tonChange(onChangeText.current!);\n\t\t\t}, 1000);\n\t\t}\n\t}, [onChange]);\n\n\tconst handleMount = React.useCallback(\n\t\t(editor: CodeMirror.Editor) => {\n\t\t\tonEditorChange(editor);\n\n\t\t\t// The potential combination of loading a mode and the dialog entrance\n\t\t\t// animation seems to mess up CodeMirror's cursor rendering. The delay below\n\t\t\t// is intended to run after the animation completes.\n\n\t\t\twindow.setTimeout(() => {\n\t\t\t\teditor.focus();\n\t\t\t\teditor.refresh();\n\t\t\t}, 400);\n\t\t},\n\t\t[onEditorChange]\n\t);\n\n\tconst options = React.useMemo(\n\t\t() => ({\n\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\tmode: storyFormatExtensionsDisabled ? 'text' : mode,\n\t\t\tlineWrapping: true,\n\t\t\tplaceholder: t('dialogs.passageEdit.passageTextPlaceholder'),\n\t\t\tprefixTrigger: {\n\t\t\t\tcallback: autocompletePassageNames,\n\t\t\t\tprefixes: ['[[', '->']\n\t\t\t},\n\t\t\t// This value prevents the area from being focused.\n\t\t\treadOnly: disabled ? 'nocursor' : false\n\t\t}),\n\t\t[\n\t\t\tautocompletePassageNames,\n\t\t\tdisabled,\n\t\t\tmode,\n\t\t\tprefs,\n\t\t\tstoryFormatExtensionsDisabled,\n\t\t\tt\n\t\t]\n\t);\n\n\treturn (\n\t\t<DialogEditor>\n\t\t\t<CodeArea\n\t\t\t\teditorDidMount={handleMount}\n\t\t\t\tfontFamily={prefs.passageEditorFontFamily}\n\t\t\t\tfontScale={prefs.passageEditorFontScale}\n\t\t\t\tlabel={t('dialogs.passageEdit.passageTextEditorLabel')}\n\t\t\t\tlabelHidden\n\t\t\t\tonBeforeChange={handleLocalChange}\n\t\t\t\tonChange={onEditorChange}\n\t\t\t\toptions={options}\n\t\t\t\tvalue={localText}\n\t\t\t/>\n\t\t</DialogEditor>\n\t);\n};","import CodeMirror, {Editor, Handle} from 'codemirror';\nimport * as React from 'react';\nimport {Story} from './stories';\n\ntype HintExtraKeyHandler = (editor: Editor, hint: Handle) => void;\n\nexport function useCodeMirrorPassageHints(story: Story) {\n\treturn React.useCallback(\n\t\t(editor: Editor) => {\n\t\t\teditor.showHint({\n\t\t\t\tcompleteSingle: false,\n\t\t\t\textraKeys:\n\t\t\t\t\t// Any of the characters below are an indication the user is finished\n\t\t\t\t\t// typing a passage name in a link and the hint should close. We need\n\t\t\t\t\t// to 'type' this character for the user since our handler consumes\n\t\t\t\t\t// the event.\n\t\t\t\t\t[']', '-', '|'].reduce<Record<string, HintExtraKeyHandler>>(\n\t\t\t\t\t\t(result, character) => {\n\t\t\t\t\t\t\tresult[character] = (editor, hint) => {\n\t\t\t\t\t\t\t\tconst doc = editor.getDoc();\n\n\t\t\t\t\t\t\t\tdoc.replaceRange(character, doc.getCursor());\n\t\t\t\t\t\t\t\thint.close();\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{}\n\t\t\t\t\t),\n\t\t\t\thint() {\n\t\t\t\t\tconst wordRange = editor.findWordAt(editor.getCursor());\n\t\t\t\t\tconst word = editor\n\t\t\t\t\t\t.getRange(wordRange.anchor, wordRange.head)\n\t\t\t\t\t\t.toLowerCase();\n\n\t\t\t\t\tconst comps = {\n\t\t\t\t\t\tlist: story.passages.reduce<string[]>((result, passage) => {\n\t\t\t\t\t\t\tif (passage.name.toLowerCase().includes(word)) {\n\t\t\t\t\t\t\t\treturn [...result, passage.name];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}, []),\n\t\t\t\t\t\tfrom: wordRange.anchor,\n\t\t\t\t\t\tto: wordRange.head\n\t\t\t\t\t};\n\n\t\t\t\t\tCodeMirror.on(comps, 'pick', () => {\n\t\t\t\t\t\tconst doc = editor.getDoc();\n\n\t\t\t\t\t\tdoc.replaceRange(']] ', doc.getCursor());\n\t\t\t\t\t});\n\n\t\t\t\t\treturn comps;\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t[story.passages]\n\t);\n}\n","import {version as twineVersion} from '../../package.json';\nimport CodeMirror from 'codemirror';\nimport * as React from 'react';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {formatEditorExtensions, namespaceForFormat} from '../util/story-format';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\n\n/**\n * Sets up a CodeMirror mode for a format, if the format has defined one via\n * properties.codeMirror.mode. Once one is fully set up, this returns the name\n * of that mode. If the mode is being set up or the format hasn't defined one,\n * this returns undefined.\n */\nexport function useFormatCodeMirrorMode(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst {prefs} = usePrefsContext();\n\tconst [modeName, setModeName] = React.useState<string>();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (format.loadState === 'loaded') {\n\t\t\tconst editorExtensions = formatEditorExtensions(format, twineVersion);\n\n\t\t\tif (editorExtensions?.codeMirror?.mode) {\n\t\t\t\tCodeMirror.defineMode(\n\t\t\t\t\tnamespaceForFormat(format),\n\t\t\t\t\teditorExtensions.codeMirror.mode\n\t\t\t\t);\n\t\t\t\tsetModeName(namespaceForFormat(format));\n\t\t\t}\n\t\t}\n\t}, [dispatch, extensionsDisabled, format]);\n\n\treturn modeName;\n}\n","import {IconResize} from '@tabler/icons';\nimport {Editor} from 'codemirror';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {UndoRedoButtons} from '../../components/codemirror';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {MenuButton} from '../../components/control/menu-button';\nimport {RenamePassageButton} from '../../components/passage/rename-passage-button';\nimport {AddTagButton} from '../../components/tag';\nimport { TestPassageButton } from '../../routes/story-edit/toolbar/passage/test-passage-button';\nimport {\n\taddPassageTag,\n\tPassage,\n\tsetTagColor,\n\tStory,\n\tstoryPassageTags,\n\tupdatePassage,\n} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\nexport interface PassageToolbarProps {\n\tdisabled?: boolean;\n\teditor?: Editor;\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const PassageToolbar: React.FC<PassageToolbarProps> = props => {\n\tconst {disabled, editor, passage, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleAddTag(name: string, color?: Color) {\n\t\t// Kind of tricky. We make adding the tag to the passage undoable, but not\n\t\t// any color change associated with this. This is because we only set a\n\t\t// color here when creating an entirely new tag. If the user is adding an\n\t\t// existing tag, then we would only receive the name here, since it's\n\t\t// currently impossible to add an existing tag and change its color\n\t\t// simultaneously.\n\t\t//\n\t\t// If this changes, then this should change too.\n\n\t\tdispatch(addPassageTag(story, passage, name), t('undoChange.addTag'));\n\n\t\tif (color) {\n\t\t\tdispatch(setTagColor(story, name, color));\n\t\t}\n\t}\n\n\tfunction handleRename(name: string) {\n\t\t// Don't create newly linked passages here because the update action will\n\t\t// try to recreate the passage as it's been renamed--it sees new links in\n\t\t// existing passages, updates them, but does not see that the passage name\n\t\t// has been updated since that hasn't happened yet.\n\n\t\tdispatch(updatePassage(story, passage, {name}, {dontUpdateOthers: true}));\n\t}\n\n\tfunction handleSetSize({height, width}: {height: number; width: number}) {\n\t\tdispatch(updatePassage(story, passage, {height, width}));\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<UndoRedoButtons\n\t\t\t\tdisabled={disabled}\n\t\t\t\teditor={editor}\n\t\t\t\twatch={passage.text}\n\t\t\t/>\n\t\t\t<AddTagButton\n\t\t\t\tdisabled={disabled}\n\t\t\t\tassignedTags={passage.tags}\n\t\t\t\texistingTags={storyPassageTags(story)}\n\t\t\t\tonAdd={handleAddTag}\n\t\t\t/>\n\t\t\t<MenuButton\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon={<IconResize />}\n\t\t\t\titems={[\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 100 && passage.width === 100,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeSmall'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 100, width: 100})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 200 && passage.width === 200,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeLarge'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 200, width: 200})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 200 && passage.width === 100,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeTall'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 200, width: 100})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 100 && passage.width === 200,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeWide'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 100, width: 200})\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tlabel={t('dialogs.passageEdit.size')}\n\t\t\t/>\n\t\t\t<RenamePassageButton\n\t\t\t\tdisabled={disabled}\n\t\t\t\tonRename={handleRename}\n\t\t\t\tpassage={passage}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<TestPassageButton passage={passage} story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport CodeMirror from 'codemirror';\nimport {usePrefsContext} from '../../store/prefs';\nimport {StoryFormat, StoryFormatToolbarItem} from '../../store/story-formats';\nimport {useComputedTheme} from '../../store/prefs/use-computed-theme';\nimport {useFormatCodeMirrorToolbar} from '../../store/use-format-codemirror-toolbar';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {IconButton} from '../../components/control/icon-button';\nimport {MenuButton} from '../../components/control/menu-button';\nimport './story-format-toolbar.css';\n\nexport interface StoryFormatToolbarProps {\n\tdisabled?: boolean;\n\teditor?: CodeMirror.Editor;\n\tonExecCommand: (name: string) => void;\n\tstoryFormat: StoryFormat;\n}\n\nexport const StoryFormatToolbar: React.FC<StoryFormatToolbarProps> = props => {\n\tconst {disabled, editor, onExecCommand, storyFormat} = props;\n\tconst containerRef = React.useRef<HTMLDivElement>(null);\n\tconst appTheme = useComputedTheme();\n\tconst {prefs} = usePrefsContext();\n\tconst toolbarFactory = useFormatCodeMirrorToolbar(\n\t\tstoryFormat.name,\n\t\tstoryFormat.version\n\t);\n\tconst [toolbarItems, setToolbarItems] = React.useState<\n\t\tStoryFormatToolbarItem[]\n\t>([]);\n\n\tconst tryToSetToolbar = React.useCallback(() => {\n\t\tif (toolbarFactory && containerRef.current && editor) {\n\t\t\ttry {\n\t\t\t\tconst style = window.getComputedStyle(containerRef.current);\n\n\t\t\t\tsetToolbarItems(\n\t\t\t\t\ttoolbarFactory(editor, {\n\t\t\t\t\t\tappTheme,\n\t\t\t\t\t\tforegroundColor: style.color,\n\t\t\t\t\t\tlocale: prefs.locale\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Toolbar function for ${storyFormat.name} ${storyFormat.version} threw an error, skipping update`,\n\t\t\t\t\terror\n\t\t\t\t);\n\t\t\t}\n\t\t} else {\n\t\t\tsetToolbarItems([]);\n\t\t}\n\t}, [\n\t\tappTheme,\n\t\teditor,\n\t\tprefs.locale,\n\t\tstoryFormat.name,\n\t\tstoryFormat.version,\n\t\ttoolbarFactory\n\t]);\n\n\tReact.useEffect(() => {\n\t\tif (editor) {\n\t\t\t// Run the toolbar factory initially.\n\n\t\t\ttryToSetToolbar();\n\n\t\t\t// React to both content changes and the selection and cursor moving,\n\t\t\t// since the toolbar factory might want to do different things based on\n\t\t\t// the cursor position or selection.\n\n\t\t\teditor.on('cursorActivity', tryToSetToolbar);\n\t\t\treturn () => editor.off('cursorActivity', tryToSetToolbar);\n\t\t}\n\t}, [editor, tryToSetToolbar]);\n\n\tfunction execCommand(name: string) {\n\t\t// Run the command, then update the toolbar after the current execution\n\t\t// context finishes.\n\n\t\tonExecCommand(name);\n\t\tPromise.resolve().then(tryToSetToolbar);\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-toolbar\" ref={containerRef}>\n\t\t\t<ButtonBar>\n\t\t\t\t{toolbarItems.map((item, index) => {\n\t\t\t\t\tswitch (item.type) {\n\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\tdisabled={disabled || item.disabled}\n\t\t\t\t\t\t\t\t\ticon={<img src={item.icon} alt=\"\" />}\n\t\t\t\t\t\t\t\t\ticonOnly={item.iconOnly}\n\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\tonClick={() => execCommand(item.command)}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\tcase 'menu': {\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<MenuButton\n\t\t\t\t\t\t\t\t\tdisabled={disabled || item.disabled}\n\t\t\t\t\t\t\t\t\ticon={<img src={item.icon} alt=\"\" />}\n\t\t\t\t\t\t\t\t\ticonOnly={item.iconOnly}\n\t\t\t\t\t\t\t\t\titems={item.items\n\t\t\t\t\t\t\t\t\t\t.filter(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t['button', 'separator'].includes(subitem.type)\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t.map(subitem => {\n\t\t\t\t\t\t\t\t\t\t\tif (subitem.type === 'button') {\n\t\t\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: 'button',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabled: subitem.disabled,\n\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: subitem.label,\n\t\t\t\t\t\t\t\t\t\t\t\t\tonClick: () => execCommand(subitem.command)\n\t\t\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\treturn {separator: true};\n\t\t\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t})}\n\t\t\t</ButtonBar>\n\t\t</div>\n\t);\n};\n","import CodeMirror from 'codemirror';\nimport * as React from 'react';\nimport {version as twineVersion} from '../../package.json';\nimport {formatEditorExtensions, namespaceForFormat} from '../util/story-format';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tStoryFormatToolbarFactory,\n\tStoryFormatToolbarFactoryEnvironment,\n\tStoryFormatToolbarItem,\n\tuseStoryFormatsContext\n} from './story-formats';\n\n/**\n * Manages working with a CodeMirror toolbar for a story format, which consists\n * of:\n *\n * - (optionally, but usually) a set of CodeMirror commands\n * - A function that returns an array of objects describing the toolbar, which\n *   uses those commands for functionality\n *\n * This loads the story format if it hasn't already been loaded, and installs\n * CodeMirror commands it provides. It returns the toolbar factory function if\n * everything succeeds. Otherwise, it will return undefined.\n */\nexport function useFormatCodeMirrorToolbar(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst [loaded, setLoaded] = React.useState<Record<string, boolean>>({});\n\tconst [\n\t\ttoolbarFunc,\n\t\tsetToolbarFunc\n\t] = React.useState<StoryFormatToolbarFactory>();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst {prefs} = usePrefsContext();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (\n\t\t\tformat.loadState === 'loaded' &&\n\t\t\t!loaded[namespaceForFormat(format)]\n\t\t) {\n\t\t\tconst namespace = namespaceForFormat(format);\n\t\t\tconst editorExtensions = formatEditorExtensions(format, twineVersion);\n\n\t\t\tif (editorExtensions?.codeMirror?.commands) {\n\t\t\t\tfor (const commandName in editorExtensions.codeMirror.commands) {\n\t\t\t\t\tconst namespacedCommand = namespace + commandName;\n\n\t\t\t\t\tif (namespacedCommand in CodeMirror.commands) {\n\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t`CodeMirror already has a \"${namespacedCommand}\" command defined, skipping`\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Using any here because the type is defined with factory\n\t\t\t\t\t\t// commands only.\n\n\t\t\t\t\t\t(CodeMirror.commands as any)[\n\t\t\t\t\t\t\tnamespacedCommand\n\t\t\t\t\t\t] = editorExtensions.codeMirror!.commands![commandName];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (editorExtensions?.codeMirror?.toolbar) {\n\t\t\t\tsetToolbarFunc(\n\t\t\t\t\t() => (\n\t\t\t\t\t\teditor: CodeMirror.Editor,\n\t\t\t\t\t\tenvironment: StoryFormatToolbarFactoryEnvironment\n\t\t\t\t\t) => {\n\t\t\t\t\t\t// If somehow we lost our format's toolbar function, exit early.\n\n\t\t\t\t\t\tif (!editorExtensions?.codeMirror?.toolbar) {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst items = editorExtensions.codeMirror.toolbar(\n\t\t\t\t\t\t\teditor,\n\t\t\t\t\t\t\tenvironment\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// If we didn't get an array from the function, coerce it to an\n\t\t\t\t\t\t// empty one.\n\n\t\t\t\t\t\tif (!Array.isArray(items)) {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Namespace command properties and filter out any types that aren't\n\t\t\t\t\t\t// buttons or menus.\n\n\t\t\t\t\t\treturn items.reduce((result, item) => {\n\t\t\t\t\t\t\tswitch (item.type) {\n\t\t\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t\t\t\t{...item, command: namespace + item.command}\n\t\t\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\t\tcase 'menu':\n\t\t\t\t\t\t\t\t\tif (Array.isArray(item.items)) {\n\t\t\t\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t...item,\n\t\t\t\t\t\t\t\t\t\t\t\titems: item.items\n\t\t\t\t\t\t\t\t\t\t\t\t\t.filter(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t['button', 'separator'].includes(subitem.type)\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.map(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsubitem.type === 'separator'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? subitem\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t...subitem,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcommand: namespace + subitem.command\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}, [] as StoryFormatToolbarItem[]);\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tsetLoaded(loaded => ({...loaded, [namespaceForFormat(format)]: true}));\n\t\t}\n\t}, [dispatch, extensionsDisabled, format, loaded]);\n\n\treturn toolbarFunc;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {TagButton} from '../../components/tag';\nimport {\n\tPassage,\n\tremovePassageTag,\n\tStory,\n\tupdateStory\n} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\nexport interface TagToolbarProps {\n\tdisabled?: boolean;\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const TagToolbar: React.FC<TagToolbarProps> = props => {\n\tconst {disabled, passage, story} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleChangeTagColor(name: string, color: Color) {\n\t\tdispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttagColors: {...story.tagColors, [name]: color}\n\t\t\t})\n\t\t);\n\t}\n\n\tfunction handleRemoveTag(name: string) {\n\t\tdispatch(removePassageTag(story, passage, name), t('undoChange.removeTag'));\n\t}\n\n\tif (passage.tags.length === 0) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<div className=\"tags\">\n\t\t\t<ButtonBar>\n\t\t\t\t{passage.tags.map(tag => (\n\t\t\t\t\t<TagButton\n\t\t\t\t\t\tcolor={story.tagColors[tag]}\n\t\t\t\t\t\tdisabled={disabled}\n\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\tonChangeColor={color => handleChangeTagColor(tag, color)}\n\t\t\t\t\t\tonRemove={() => handleRemoveTag(tag)}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</ButtonBar>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport useErrorBoundary from 'use-error-boundary';\nimport {ErrorMessage} from '../../components/error';\nimport {passageWithId, storyWithId, updatePassage} from '../../store/stories';\nimport {\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {PassageText} from './passage-text';\nimport {PassageToolbar} from './passage-toolbar';\nimport {StoryFormatToolbar} from './story-format-toolbar';\nimport {TagToolbar} from './tag-toolbar';\nimport './passage-edit-contents.css';\n\nexport interface PassageEditContentsProps {\n\tdisabled?: boolean;\n\tpassageId: string;\n\tstoryId: string;\n}\n\nexport const PassageEditContents: React.FC<\n\tPassageEditContentsProps\n> = props => {\n\tconst {disabled, passageId, storyId} = props;\n\tconst [storyFormatExtensionsEnabled, setStoryFormatExtensionsEnabled] =\n\t\tReact.useState(true);\n\tconst [editorCrashed, setEditorCrashed] = React.useState(false);\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {ErrorBoundary, error, reset: resetError} = useErrorBoundary();\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {formats} = useStoryFormatsContext();\n\tconst passage = passageWithId(stories, storyId, passageId);\n\tconst story = storyWithId(stories, storyId);\n\tconst storyFormat = formatWithNameAndVersion(\n\t\tformats,\n\t\tstory.storyFormat,\n\t\tstory.storyFormatVersion\n\t);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (error) {\n\t\t\tif (storyFormatExtensionsEnabled) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t'Passage editor crashed, trying without format extensions',\n\t\t\t\t\terror\n\t\t\t\t);\n\t\t\t\tsetStoryFormatExtensionsEnabled(false);\n\t\t\t} else {\n\t\t\t\tsetEditorCrashed(true);\n\t\t\t}\n\n\t\t\tresetError();\n\t\t}\n\t}, [error, resetError, storyFormatExtensionsEnabled]);\n\n\tconst handlePassageTextChange = React.useCallback(\n\t\t(text: string) => {\n\t\t\tdispatch(updatePassage(story, passage, {text}));\n\t\t},\n\t\t[dispatch, passage, story]\n\t);\n\n\tfunction handleExecCommand(name: string) {\n\t\t// A format toolbar command probably will affect the editor content. It\n\t\t// appears that react-codemirror2 can't maintain the selection properly in\n\t\t// all cases when this happens (particularly when using\n\t\t// `replaceSelection('something', 'around')`), so we take a snapshot\n\t\t// immediately after the command runs, let react-codemirror2 work, then\n\t\t// reapply the selection ASAP.\n\n\t\tif (!cmEditor) {\n\t\t\tthrow new Error('No editor set');\n\t\t}\n\n\t\tcmEditor.execCommand(name);\n\n\t\tconst selections = cmEditor.listSelections();\n\n\t\tPromise.resolve().then(() => cmEditor.setSelections(selections));\n\t}\n\n\tif (editorCrashed) {\n\t\treturn (\n\t\t\t<ErrorMessage>{t('dialogs.passageEdit.editorCrashed')}</ErrorMessage>\n\t\t);\n\t}\n\n\treturn (\n\t\t<div className=\"passage-edit-contents\" aria-hidden={disabled}>\n\t\t\t<PassageToolbar\n\t\t\t\tdisabled={disabled}\n\t\t\t\teditor={cmEditor}\n\t\t\t\tpassage={passage}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t{storyFormatExtensionsEnabled && (\n\t\t\t\t<StoryFormatToolbar\n\t\t\t\t\tdisabled={disabled}\n\t\t\t\t\teditor={cmEditor}\n\t\t\t\t\tonExecCommand={handleExecCommand}\n\t\t\t\t\tstoryFormat={storyFormat}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t<TagToolbar disabled={disabled} passage={passage} story={story} />\n\t\t\t<ErrorBoundary>\n\t\t\t\t<PassageText\n\t\t\t\t\tdisabled={disabled}\n\t\t\t\t\tonChange={handlePassageTextChange}\n\t\t\t\t\tonEditorChange={setCmEditor}\n\t\t\t\t\tpassage={passage}\n\t\t\t\t\tstory={story}\n\t\t\t\t\tstoryFormat={storyFormat}\n\t\t\t\t\tstoryFormatExtensionsDisabled={!storyFormatExtensionsEnabled}\n\t\t\t\t/>\n\t\t\t</ErrorBoundary>\n\t\t</div>\n\t);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport {\n\tBackgroundDialogCard,\n\tDialogCard\n} from '../../components/container/dialog-card';\nimport {DialogStack} from '../../components/container/dialog-card/dialog-stack';\nimport {passageWithId, useStoriesContext} from '../../store/stories';\nimport {\n\taddPassageEditors,\n\tremovePassageEditors,\n\tuseDialogsContext\n} from '../context';\nimport {DialogComponentProps} from '../dialogs.types';\nimport {PassageEditContents} from './passage-edit-contents';\nimport './passage-edit-stack.css';\n\nexport interface PassageEditStackProps extends DialogComponentProps {\n\tpassageIds: string[];\n\tstoryId: string;\n}\n\nconst InnerPassageEditStack: React.FC<PassageEditStackProps> = props => {\n\tconst {onChangeProps, onClose, passageIds, storyId, ...managementProps} =\n\t\tprops;\n\tconst {dispatch} = useDialogsContext();\n\tconst {stories} = useStoriesContext();\n\n\tconst passageNames = passageIds.map(\n\t\tpassageId => passageWithId(stories, storyId, passageId).name\n\t);\n\n\tconst style: React.CSSProperties = {};\n\n\tif (managementProps.collapsed) {\n\t\tstyle.height = `calc(var(--control-height) * ${passageIds.length})`;\n\n\t\tif (managementProps.maximized) {\n\t\t\tstyle.bottom = 0;\n\t\t\tstyle.position = 'absolute';\n\t\t}\n\t}\n\n\tfunction handleClose(\n\t\tpassageId: string,\n\t\tevent?: React.KeyboardEvent | React.MouseEvent\n\t) {\n\t\tif (event?.shiftKey) {\n\t\t\tonClose(event);\n\t\t} else {\n\t\t\tdispatch(removePassageEditors([passageId]));\n\t\t}\n\t}\n\n\treturn (\n\t\t<div\n\t\t\tclassName={classNames('passage-edit-stack', {\n\t\t\t\tcollapsed: managementProps.collapsed\n\t\t\t})}\n\t\t\tstyle={style}\n\t\t>\n\t\t\t<DialogStack childKeys={passageIds}>\n\t\t\t\t{passageIds.map((passageId, index) => {\n\t\t\t\t\tif (index !== 0) {\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t<BackgroundDialogCard\n\t\t\t\t\t\t\t\t{...managementProps}\n\t\t\t\t\t\t\t\theaderLabel={passageNames[index]}\n\t\t\t\t\t\t\t\tkey={passageId}\n\t\t\t\t\t\t\t\tonClose={event => handleClose(passageId, event)}\n\t\t\t\t\t\t\t\tonRaise={() =>\n\t\t\t\t\t\t\t\t\tdispatch(addPassageEditors(storyId, [passageId]))\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<PassageEditContents\n\t\t\t\t\t\t\t\t\tdisabled\n\t\t\t\t\t\t\t\t\tpassageId={passageId}\n\t\t\t\t\t\t\t\t\tstoryId={storyId}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</BackgroundDialogCard>\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<DialogCard\n\t\t\t\t\t\t\t{...managementProps}\n\t\t\t\t\t\t\theaderLabel={passageNames[index]}\n\t\t\t\t\t\t\tkey={passageId}\n\t\t\t\t\t\t\tmaximizable\n\t\t\t\t\t\t\tonClose={event => handleClose(passageId, event)}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<PassageEditContents passageId={passageId} storyId={storyId} />\n\t\t\t\t\t\t</DialogCard>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</DialogStack>\n\t\t</div>\n\t);\n};\n\nexport const PassageEditStack: React.FC<PassageEditStackProps> = props => {\n\tconst {passageIds, storyId} = props;\n\tconst {stories} = useStoriesContext();\n\n\tconst existingPassageIds = passageIds.filter(passageId => {\n\t\ttry {\n\t\t\tpassageWithId(stories, storyId, passageId);\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t});\n\n\t// If there aren't any passages to display, render nothing and call onClose.\n\n\tif (existingPassageIds.length === 0) {\n\t\tprops.onClose();\n\t\treturn null;\n\t}\n\n\t// If passages differ from what we were asked to display, change our props.\n\n\tif (existingPassageIds.length !== passageIds.length) {\n\t\tprops.onChangeProps({...props, passageIds: existingPassageIds});\n\t\treturn null;\n\t}\n\n\t// We're good to display dialogs normally.\n\n\treturn <InnerPassageEditStack {...props} />;\n};\n","import escapeRegExp from 'lodash/escapeRegExp';\nimport {StorySearchFlags} from '../store/stories/stories.types';\n\n/**\n * Creates RegExps using UI-visible settings.\n */\nexport function createRegExp(\n\tsearch: string,\n\tflags: Omit<StorySearchFlags, 'includePassages'>\n) {\n\treturn new RegExp(\n\t\tflags.useRegexes ? search : escapeRegExp(search),\n\t\tflags.matchCase ? 'g' : 'gi'\n\t);\n}\n\n/**\n * Escapes replacement strings if the user didn't intend them to be regexps.\n * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace#Specifying_a_string_as_a_parameter\n */\nexport function escapeRegExpReplace(source: string) {\n\t// This implementation is a little tricky in that it needs to escape the $s\n\t// itself in the replacement.\n\n\treturn source.replace(/\\$/g, '$$$$');\n}\n","import * as React from 'react';\nimport {TagColors} from '../../store/stories';\nimport './tag-stripe.css';\n\nexport interface TagStripeProps {\n\ttagColors: TagColors;\n\ttags: string[];\n}\n\nexport const TagStripe: React.FC<TagStripeProps> = React.memo(props => {\n\treturn (\n\t\t<div className=\"tag-stripe\">\n\t\t\t{props.tags.map(tag => (\n\t\t\t\t<span\n\t\t\t\t\tclassName={`color-${props.tagColors[tag]}`}\n\t\t\t\t\tkey={tag}\n\t\t\t\t\ttitle={tag}\n\t\t\t\t/>\n\t\t\t))}\n\t\t</div>\n\t);\n});\n\nTagStripe.displayName = 'TagStripe';\n","import * as React from 'react';\nimport {useScrollbarSize} from 'react-scrollbar-size';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {useDialogsContext} from '.';\nimport {usePrefsContext} from '../../store/prefs';\nimport './dialogs.css';\n\n// TODO move this to separate module to avoid circular dep\nconst DialogTransition: React.FC = props => (\n\t<CSSTransition classNames=\"pop\" timeout={200} {...props}>\n\t\t{props.children}\n\t</CSSTransition>\n);\n\nexport const Dialogs: React.FC = () => {\n\tconst {height, width} = useScrollbarSize();\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch, dialogs} = useDialogsContext();\n\n\tconst hasUnmaximized = dialogs.some(dialog => !dialog.maximized);\n\tconst containerStyle: React.CSSProperties = {\n\t\tpaddingLeft: `calc(100% - (${prefs.dialogWidth}px + 2 * (var(--grid-size))))`,\n\t\tmarginBottom: height,\n\t\tmarginRight: width\n\t};\n\tconst maximizedStyle: React.CSSProperties = {\n\t\tmarginRight: hasUnmaximized\n\t\t\t? `calc(${prefs.dialogWidth}px + var(--grid-size))`\n\t\t\t: 0\n\t};\n\n\treturn (\n\t\t<div className=\"dialogs\" style={containerStyle}>\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{dialogs.map((dialog, index) => {\n\t\t\t\t\tconst managementProps = {\n\t\t\t\t\t\tcollapsed: dialog.collapsed,\n\t\t\t\t\t\thighlighted: dialog.highlighted,\n\t\t\t\t\t\tmaximized: dialog.maximized,\n\t\t\t\t\t\tonChangeCollapsed: (collapsed: boolean) =>\n\t\t\t\t\t\t\tdispatch({type: 'setDialogCollapsed', collapsed, index}),\n\t\t\t\t\t\tonChangeHighlighted: (highlighted: boolean) =>\n\t\t\t\t\t\t\tdispatch({type: 'setDialogHighlighted', highlighted, index}),\n\t\t\t\t\t\tonChangeMaximized: (maximized: boolean) =>\n\t\t\t\t\t\t\tdispatch({type: 'setDialogMaximized', maximized, index}),\n\t\t\t\t\t\tonChangeProps: (props: Record<string, any>) =>\n\t\t\t\t\t\t\tdispatch({type: 'setDialogProps', index, props}),\n\t\t\t\t\t\tonClose: () => dispatch({type: 'removeDialog', index})\n\t\t\t\t\t};\n\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<DialogTransition key={index}>\n\t\t\t\t\t\t\t{dialog.maximized ? (\n\t\t\t\t\t\t\t\t<div className=\"maximized\" style={maximizedStyle}>\n\t\t\t\t\t\t\t\t\t<dialog.component {...dialog.props} {...managementProps} />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t<dialog.component {...dialog.props} {...managementProps} />\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</DialogTransition>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</TransitionGroup>\n\t\t</div>\n\t);\n};\n","// Handles importing HTML source code into story objects ready to be saved to\n// the store. This works on both published story files and archives.\n//\n// It's important that this code be as efficient as possible, as it directly\n// affects startup time in the Twine desktop app. This module moves data from\n// the filesystem into local storage, and the app can't begin until it's done.\n\nimport defaults from 'lodash/defaults';\nimport uuid from 'tiny-uuid';\nimport {passageDefaults, storyDefaults, Passage, Story} from '../store/stories';\n\n/**\n * An imported story, which may contain incomplete or malformed data.\n */\nexport interface ImportedStory extends Omit<Partial<Story>, 'passages'> {\n\tpassages: Partial<Passage>[];\n}\n\n/**\n * HTML selectors used to find data in HTML format.\n */\nconst selectors = {\n\tpassage: 'tw-passage',\n\tstory: 'tw-story',\n\tscript: '[role=script]',\n\tstylesheet: '[role=stylesheet]',\n\tstoryData: 'tw-storydata',\n\ttagColors: 'tw-tag',\n\tpassageData: 'tw-passagedata'\n};\n\n/**\n * Convenience function to convert a string value to an float.\n */\nfunction float(stringValue: string) {\n\treturn parseFloat(stringValue);\n}\n\n/**\n * Convenience function to query an element by a selector.\n */\nfunction query(el: Element, selector: string) {\n\treturn Array.from(el.querySelectorAll(selector));\n}\n\n/**\n * Convenience function to parse a string like \"100,50\".\n */\nfunction parseDimensions(raw: any): [string, string] | undefined {\n\tif (typeof raw !== 'string') {\n\t\treturn undefined;\n\t}\n\n\tconst bits = raw.split(',');\n\n\tif (bits.length === 2) {\n\t\treturn [bits[0], bits[1]];\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Converts a DOM <tw-storydata> element to a story object matching the format\n * in the store. This *may* be missing data, or data it returns may be\n * malformed. This function does its best to reflect the contents of the\n * element.\n */\nfunction domToObject(storyEl: Element): ImportedStory {\n\tconst startPassagePid = storyEl.getAttribute('startnode');\n\tlet startPassageId: string | undefined = undefined;\n\tconst story: ImportedStory = {\n\t\tifid: storyEl.getAttribute('ifid') ?? uuid(),\n\t\tid: uuid(),\n\t\tlastUpdate: undefined,\n\t\tname: storyEl.getAttribute('name') ?? undefined,\n\t\tstoryFormat: storyEl.getAttribute('format') ?? undefined,\n\t\tstoryFormatVersion: storyEl.getAttribute('format-version') ?? undefined,\n\t\tscript: query(storyEl, selectors.script)\n\t\t\t.map(el => el.textContent)\n\t\t\t.join('\\n'),\n\t\tstylesheet: query(storyEl, selectors.stylesheet)\n\t\t\t.map(el => el.textContent)\n\t\t\t.join('\\n'),\n\t\ttags: storyEl.getAttribute('tags')\n\t\t\t? storyEl.getAttribute('tags')!.split(/\\s+/)\n\t\t\t: [],\n\t\tzoom: parseFloat(storyEl.getAttribute('zoom') ?? '1'),\n\t\ttagColors: query(storyEl, selectors.tagColors).reduce((result, el) => {\n\t\t\tconst tagName: string | null = el.getAttribute('name');\n\n\t\t\tif (typeof tagName !== 'string') {\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\treturn {...result, [tagName]: el.getAttribute('color')};\n\t\t}, {}),\n\t\tpassages: query(storyEl, selectors.passageData).map(passageEl => {\n\t\t\tconst id = uuid();\n\t\t\tconst position = parseDimensions(passageEl.getAttribute('position'));\n\t\t\tconst size = parseDimensions(passageEl.getAttribute('size'));\n\n\t\t\tif (passageEl.getAttribute('pid') === startPassagePid) {\n\t\t\t\tstartPassageId = id;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tid,\n\t\t\t\tleft: position ? float(position[0]) : undefined,\n\t\t\t\ttop: position ? float(position[1]) : undefined,\n\t\t\t\twidth: size ? float(size[0]) : undefined,\n\t\t\t\theight: size ? float(size[1]) : undefined,\n\t\t\t\ttags: passageEl.getAttribute('tags')\n\t\t\t\t\t? passageEl.getAttribute('tags')!.split(/\\s+/)\n\t\t\t\t\t: [],\n\t\t\t\tname: passageEl.getAttribute('name') ?? undefined,\n\t\t\t\ttext: passageEl.textContent ?? undefined\n\t\t\t};\n\t\t})\n\t};\n\n\tstory.startPassage = startPassageId;\n\treturn story;\n}\n\n/**\n * Imports stories from HTML. If there are any missing attributes in the HTML,\n * defaults will be applied.\n */\nexport function importStories(\n\thtml: string,\n\tlastUpdateOverride?: Date\n): Story[] {\n\tconst nodes = document.createElement('div');\n\n\tnodes.innerHTML = html;\n\n\treturn query(nodes, selectors.storyData).map(storyEl => {\n\t\tconst importedStory = domToObject(storyEl);\n\n\t\t// Merge in defaults. We can't use object spreads here because undefined\n\t\t// values would override defaults.\n\n\t\tconst story: Story = defaults(importedStory, {id: uuid()}, storyDefaults());\n\n\t\t// Override the last update as requested.\n\n\t\tif (lastUpdateOverride) {\n\t\t\tstory.lastUpdate = lastUpdateOverride;\n\t\t}\n\n\t\t// Merge in passage defaults. We don't need to set ID here--domToObject did\n\t\t// this for us.\n\n\t\tstory.passages = story.passages.map(passage =>\n\t\t\tdefaults(passage, passageDefaults(), {story: story.id})\n\t\t);\n\n\t\treturn story;\n\t});\n}\n","import {Passage} from '../store/stories';\n\n/**\n * Returns whether a passage is considered empty, e.g. whether the user has put\n * any content into it.\n */\nexport function passageIsEmpty(passage: Passage) {\n\treturn (\n\t\tpassage.text === '' &&\n\t\tpassage.tags.length === 0 &&\n\t\tpassage.width === 100 &&\n\t\tpassage.height === 100\n\t);\n}\n","import * as React from 'react';\nimport {Card, CardProps} from './card/card';\nimport './button-card.css';\n\nexport const ButtonCard: React.FC<CardProps> = props => (\n\t<div className=\"button-card\">\n\t\t<Card {...props} />\n\t</div>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconWriting} from '@tabler/icons';\nimport {PromptButton} from '../control/prompt-button';\nimport {Passage, Story} from '../../store/stories';\nimport {IconButton} from '../control/icon-button';\n\nconst DisabledRenamePassageButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton disabled icon={<IconWriting />} label={t('common.rename')} />\n\t);\n};\n\nexport interface EnabledRenamePassageButtonProps {\n\tonRename: (value: string) => void;\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const EnabledRenamePassageButton: React.FC<EnabledRenamePassageButtonProps> = props => {\n\tconst {onRename, passage, story} = props;\n\tconst [newName, setNewName] = React.useState(passage.name);\n\tconst {t} = useTranslation();\n\n\tfunction validate(name: string) {\n\t\tif (name.trim() === '') {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renamePassageButton.emptyName'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\tif (story.passages.some(p => p.id !== passage.id && p.name === name)) {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renamePassageButton.nameAlreadyUsed'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconWriting />}\n\t\t\tlabel={t('common.rename')}\n\t\t\tonChange={event => setNewName(event.target.value)}\n\t\t\tonSubmit={onRename}\n\t\t\tprompt={t('common.renamePrompt', {name: passage.name})}\n\t\t\tvalidate={validate}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n\nexport interface RenamePassageButtonProps\n\textends Omit<EnabledRenamePassageButtonProps, 'passage'> {\n\tdisabled?: boolean;\n\tpassage?: Passage;\n}\n\nexport const RenamePassageButton: React.FC<\n\tRenamePassageButtonProps\n> = props => {\n\tif (!props.disabled && props.passage) {\n\t\treturn (\n\t\t\t<EnabledRenamePassageButton\n\t\t\t\t{...(props as EnabledRenamePassageButtonProps)}\n\t\t\t/>\n\t\t);\n\t}\n\n\treturn <DisabledRenamePassageButton />;\n};","import {IconTool} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {Passage, Story} from '../../../../store/stories';\nimport {useStoryLaunch} from '../../../../store/use-story-launch';\n\nexport interface TestPassageButtonProps {\n\tpassage?: Passage;\n\tstory: Story;\n}\n\nexport const TestPassageButton: React.FC<TestPassageButtonProps> = props => {\n\tconst {passage, story} = props;\n\tconst {testStory} = useStoryLaunch();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!passage}\n\t\t\ticon={<IconTool />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.testFromHere')}\n\t\t\tonClick={() => testStory(story.id, passage?.id)}\n\t\t/>\n\t);\n};\n","import {usePublishing} from './use-publishing';\nimport {isElectronRenderer} from '../util/is-electron';\nimport {TwineElectronWindow} from '../electron/shared';\n\nexport interface UseStoryLaunchProps {\n\tplayStory: (storyId: string) => Promise<void>;\n\tproofStory: (storyId: string) => Promise<void>;\n\ttestStory: (storyId: string, startPassageId?: string) => Promise<void>;\n}\n\n/**\n * Provides functions to launch a story that include the correct handling for\n * both web and Electron contexts.\n */\nexport function useStoryLaunch(): UseStoryLaunchProps {\n\tconst {proofStory, publishStory} = usePublishing();\n\n\tif (isElectronRenderer()) {\n\t\tconst {twineElectron} = window as TwineElectronWindow;\n\n\t\tif (!twineElectron) {\n\t\t\tthrow new Error('Electron bridge is not present on window.');\n\t\t}\n\n\t\treturn {\n\t\t\tplayStory: async storyId => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait publishStory(storyId),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t},\n\t\t\tproofStory: async storyId => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait proofStory(storyId),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t},\n\t\t\ttestStory: async (storyId, startPassageId) => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait publishStory(storyId, {\n\t\t\t\t\t\tformatOptions: 'debug',\n\t\t\t\t\t\tstartId: startPassageId\n\t\t\t\t\t}),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t}\n\n\treturn {\n\t\tplayStory: async storyId => {\n\t\t\twindow.open(`#/stories/${storyId}/play`, '_blank');\n\t\t},\n\t\tproofStory: async storyId => {\n\t\t\twindow.open(`#/stories/${storyId}/proof`, '_blank');\n\t\t},\n\t\ttestStory: async (storyId, startPassageId) => {\n\t\t\twindow.open(\n\t\t\t\tstartPassageId\n\t\t\t\t\t? `#/stories/${storyId}/test/${startPassageId}`\n\t\t\t\t\t: `#/stories/${storyId}/test`,\n\t\t\t\t'_blank'\n\t\t\t);\n\t\t}\n\t};\n}\n","import * as React from 'react';\nimport {usePrefsContext} from '.';\n\nexport function useComputedTheme() {\n\t// See https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia\n\n\tconst {prefs} = usePrefsContext();\n\tconst [mediaQuery] = React.useState(\n\t\twindow.matchMedia('(prefers-color-scheme: dark)')\n\t);\n\tconst [systemTheme, setSystemTheme] = React.useState<'dark' | 'light'>(\n\t\tmediaQuery.matches ? 'dark' : 'light'\n\t);\n\n\tReact.useEffect(() => {\n\t\tconst listener = (event: MediaQueryListEvent) =>\n\t\t\tsetSystemTheme(event.matches ? 'dark' : 'light');\n\n\t\tmediaQuery.addEventListener('change', listener);\n\t\treturn () => mediaQuery.removeEventListener('change', listener);\n\t}, [mediaQuery]);\n\n\treturn prefs.appTheme === 'system' ? systemTheme : prefs.appTheme;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport classNames from 'classnames';\nimport {IconWriting} from '@tabler/icons';\nimport {colors, Color} from '../../util/color';\nimport {PromptButton, PromptValidationResponse} from '../control/prompt-button';\nimport {TextSelect} from '../control/text-select';\nimport './tag-editor.css';\n\nexport interface TagEditorProps {\n\tallTags: string[];\n\tcolor?: Color;\n\tname: string;\n\tonChangeColor: (color: Color) => void;\n\tonChangeName: (name: string) => void;\n}\n\nexport const TagEditor: React.FC<TagEditorProps> = props => {\n\tconst {allTags, color, name, onChangeColor, onChangeName} = props;\n\tconst [newName, setNewName] = React.useState(name);\n\tconst {t} = useTranslation();\n\n\tfunction validate(value: string): PromptValidationResponse {\n\t\tif (value !== name && allTags.includes(value)) {\n\t\t\treturn {message: t('components.tagEditor.alreadyExists'), valid: false};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<div className=\"tag-editor\">\n\t\t\t<span className={classNames('tag-name', `color-${props.color}`)}>\n\t\t\t\t{props.name}\n\t\t\t</span>\n\t\t\t<PromptButton\n\t\t\t\ticon={<IconWriting />}\n\t\t\t\tlabel={t('common.rename')}\n\t\t\t\tonChange={e => setNewName(e.target.value.replace(/\\s/g, '-'))}\n\t\t\t\tonSubmit={() => onChangeName(newName)}\n\t\t\t\tprompt={t('common.renamePrompt', {name})}\n\t\t\t\tvalue={newName}\n\t\t\t\tvalidate={validate}\n\t\t\t/>\n\t\t\t<TextSelect\n\t\t\t\tonChange={e => onChangeColor(e.target.value)}\n\t\t\t\toptions={colors.map(color => ({\n\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\tvalue: color\n\t\t\t\t}))}\n\t\t\t\tvalue={color ?? ''}\n\t\t\t>\n\t\t\t\t{t('common.color')}\n\t\t\t</TextSelect>\n\t\t</div>\n\t);\n};\n","import React from 'react';\nimport {defaults, usePrefsContext} from './prefs';\nimport {useStoriesContext} from './stories';\nimport {\n\tformatWithNameAndVersion,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from './story-formats';\n\n/**\n * A React hook to dispatch a repair action on the stories store. Like\n * publishing, this spans the stories, preferences, and formats stores.\n */\nexport function useStoriesRepair() {\n\tconst {dispatch} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {formats} = useStoryFormatsContext();\n\n\treturn React.useCallback(() => {\n\t\t// We try to repair stories to the user's preferred format, but perhaps\n\t\t// their prefs are out of date/corrupted. In that case, we use the default\n\t\t// one.\n\n\t\tlet safeFormat: StoryFormat | undefined;\n\n\t\ttry {\n\t\t\tsafeFormat = formatWithNameAndVersion(\n\t\t\t\tformats,\n\t\t\t\tprefs.storyFormat.name,\n\t\t\t\tprefs.storyFormat.version\n\t\t\t);\n\t\t} catch {\n\t\t\ttry {\n\t\t\t\tsafeFormat = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tdefaults().storyFormat.name,\n\t\t\t\t\tdefaults().storyFormat.version\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Could not locate a safe story format, skipping story repair: ${\n\t\t\t\t\t\t(error as Error).message\n\t\t\t\t\t}`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tif (safeFormat) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'repair',\n\t\t\t\tallFormats: formats,\n\t\t\t\tdefaultFormat: safeFormat\n\t\t\t});\n\t\t}\n\t}, [formats, prefs.storyFormat.name, prefs.storyFormat.version, dispatch]);\n}\n","import uuid from 'tiny-uuid';\nimport {sortBy} from 'lodash';\nimport {Passage, passageDefaults, Story, storyDefaults} from '../store/stories';\nimport {unusedName} from './unused-name';\n\nconst linebreakRegExp = /\\r?\\n/;\n\n/**\n * Escapes characters with special meanings in a Twee passage header (brackets,\n * curly quotes, and backslashes).\n */\nexport function escapeForTweeHeader(value: string) {\n\treturn value.replace(/\\\\/g, '\\\\\\\\').replace(/([[\\]{}])/g, '\\\\$1');\n}\n\n/**\n * Escapes characters that would disrupt parsing of passage text, i.e. `::` at\n * the start of a line.\n */\nexport function escapeForTweeText(value: string) {\n\treturn value.replace(/^::/gm, '\\\\::');\n}\n\n/**\n * Converts a single passage to Twee.\n */\nexport function passageToTwee(passage: Passage) {\n\tconst escapedName = escapeForTweeHeader(passage.name)\n\t\t.replace(/^\\s+/g, match => '\\\\ '.repeat(match.length))\n\t\t.replace(/\\s+$/g, match => '\\\\ '.repeat(match.length));\n\tconst tags =\n\t\tpassage.tags.length > 0\n\t\t\t? `[${passage.tags.map(escapeForTweeHeader).join(' ')}]`\n\t\t\t: undefined;\n\tconst metadata = JSON.stringify({\n\t\tposition: `${passage.left},${passage.top}`,\n\t\tsize: `${passage.width},${passage.height}`\n\t}).replace(/\\s+/g, '');\n\tconst escapedText = escapeForTweeText(passage.text);\n\n\treturn `:: ${escapedName}${\n\t\ttags ? ' ' + tags : ''\n\t} ${metadata}\\n${escapedText}\\n`;\n}\n\n/**\n * Converts Twee source to a passage. If it can't be parsed, then an error is\n * thrown. If it can partially parse the passage, it will do so.\n */\nexport function passageFromTwee(source: string): Omit<Passage, 'story'> {\n\tconst [headerLine, ...lines] = source.split(linebreakRegExp);\n\n\t// The first line should be the header, with name, tags, and metadata. Name\n\t// needs to capture a trailing `\\ `. Repeated trailing spaces should get\n\t// captured by the main group, since they include non-whitespace.\n\t//\n\t// Roughly translating this regexp: ::, whitespace, name, whitespace, [tags]?,\n\t// whitespace, {metadata}?, whitespace\n\tconst headerBits = /^::\\s*(.*?(?:\\\\\\s)?)\\s*(\\[.*?\\])?\\s*(\\{.*?\\})?\\s*$/.exec(\n\t\theaderLine\n\t);\n\n\tif (!headerBits) {\n\t\tthrow new Error(`Header line couldn't be parsed: ${headerLine}`);\n\t}\n\n\tconst [, rawName, rawTags, rawMetadata] = headerBits;\n\n\tif (rawName.trim() === '') {\n\t\tthrow new Error(\n\t\t\t`Passage name couldn't be found in header line: ${headerLine}`\n\t\t);\n\t}\n\n\tconst passage: Omit<Passage, 'story'> = {\n\t\t...passageDefaults(),\n\t\tid: uuid(),\n\t\tname: unescapeForTweeHeader(\n\t\t\trawName\n\t\t\t\t.replace(/^(\\\\\\s)+/g, match => ' '.repeat(match.length / 2))\n\t\t\t\t.replace(/(\\\\\\s)+$/g, match => ' '.repeat(match.length / 2))\n\t\t),\n\t\ttags: [],\n\t\ttext: lines.map(unescapeForTweeText).join('\\n').trim()\n\t};\n\n\tif (rawTags) {\n\t\t// Remove enclosing brackets and split on whitespace.\n\n\t\tpassage.tags = rawTags\n\t\t\t.replace(/^\\[(.*)\\]$/g, '$1')\n\t\t\t.split(/\\s/)\n\t\t\t.filter(tag => tag.trim() !== '')\n\t\t\t.map(tag => unescapeForTweeHeader(tag));\n\t}\n\n\tif (rawMetadata) {\n\t\t// Try to parse it as JSON.\n\n\t\ttry {\n\t\t\tconst metadata = JSON.parse(rawMetadata);\n\n\t\t\tif (typeof metadata.position === 'string') {\n\t\t\t\tconst [left, top] = metadata.position.split(',').map(parseFloat);\n\n\t\t\t\tif (typeof left === 'number' && typeof top === 'number') {\n\t\t\t\t\tpassage.left = left;\n\t\t\t\t\tpassage.top = top;\n\t\t\t\t} else {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Couldn't parse passage position metadata ${metadata.position}`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof metadata.size === 'string') {\n\t\t\t\tconst [width, height] = metadata.size.split(',').map(parseFloat);\n\n\t\t\t\tif (typeof width === 'number' && typeof height === 'number') {\n\t\t\t\t\tpassage.width = width;\n\t\t\t\t\tpassage.height = height;\n\t\t\t\t} else {\n\t\t\t\t\tconsole.warn(`Couldn't parse passage size metadata ${metadata.size}`);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.warn(`Couldn't parse passage metadata ${rawMetadata}`);\n\t\t}\n\t}\n\n\treturn passage;\n}\n\n/**\n * Converts a story from Twee source.\n */\nexport function storyFromTwee(source: string) {\n\tconst id = uuid();\n\n\tconst story: Story = {\n\t\t...storyDefaults(),\n\t\tid,\n\t\tifid: uuid(),\n\t\tlastUpdate: new Date(),\n\t\tpassages: source\n\t\t\t.split(/^::/m)\n\t\t\t.filter(s => s.trim() !== '')\n\t\t\t.map(s => ':: ' + s)\n\t\t\t.map(passageFromTwee)\n\t\t\t.map(passage => ({...passage, story: id})),\n\t\tscript: ''\n\t};\n\n\t// Remove all passages with a script or stylesheet tags and put them in the\n\t// story's properties instead.\n\n\tstory.passages = story.passages.filter(passage => {\n\t\tconst isScript = passage.tags.includes('script');\n\t\tconst isStylesheet = passage.tags.includes('stylesheet');\n\n\t\t// If the passage has neither *or* both tags, treat it as normal. Behavior\n\t\t// when a passage is tagged with both is not currently spec'd, but let's\n\t\t// assume the user is confused.\n\n\t\tif ((!isScript && !isStylesheet) || (isScript && isStylesheet)) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (isScript) {\n\t\t\tstory.script += passage.text + '\\n';\n\t\t} else if (isStylesheet) {\n\t\t\tstory.stylesheet += passage.text + '\\n';\n\t\t}\n\n\t\treturn false;\n\t});\n\n\t// Trim any extra whitespace in the script and stylesheet we created above.\n\n\tstory.script = story.script.trim();\n\tstory.stylesheet = story.stylesheet.trim();\n\n\t// If there is a StoryTitle passage, remove it and set the story name.\n\n\tconst titlePassageIndex = story.passages.findIndex(\n\t\tpassage => passage.name === 'StoryTitle'\n\t);\n\n\tif (titlePassageIndex !== -1) {\n\t\tstory.name = story.passages[titlePassageIndex].text.trim();\n\t\tstory.passages.splice(titlePassageIndex, 1);\n\t}\n\n\t// If there is a StoryData passage, remove it and apply properties contained\n\t// there.\n\n\tconst dataPassageIndex = story.passages.findIndex(\n\t\tpassage => passage.name === 'StoryData'\n\t);\n\n\tif (dataPassageIndex !== -1) {\n\t\tconst dataPassage = story.passages[dataPassageIndex];\n\n\t\tstory.passages.splice(dataPassageIndex, 1);\n\n\t\ttry {\n\t\t\tconst {\n\t\t\t\tifid,\n\t\t\t\tformat,\n\t\t\t\t'format-version': formatVersion,\n\t\t\t\tstart,\n\t\t\t\t'tag-colors': tagColors,\n\t\t\t\tzoom\n\t\t\t} = JSON.parse(dataPassage.text);\n\n\t\t\tif (typeof ifid === 'string') {\n\t\t\t\tstory.ifid = ifid;\n\t\t\t}\n\n\t\t\tif (typeof format === 'string') {\n\t\t\t\tstory.storyFormat = format;\n\t\t\t}\n\n\t\t\tif (typeof formatVersion === 'string') {\n\t\t\t\tstory.storyFormatVersion = formatVersion;\n\t\t\t}\n\n\t\t\tif (typeof start === 'string') {\n\t\t\t\tconst startPassage = story.passages.find(\n\t\t\t\t\tpassage => passage.name === start\n\t\t\t\t);\n\n\t\t\t\tif (startPassage) {\n\t\t\t\t\tstory.startPassage = startPassage.id;\n\t\t\t\t} else {\n\t\t\t\t\tconsole.warn(`Couldn't find start passage with name \"${start}\"`);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof tagColors === 'object') {\n\t\t\t\tfor (const tagName in tagColors) {\n\t\t\t\t\tif (typeof tagColors[tagName] === 'string') {\n\t\t\t\t\t\tstory.tagColors[tagName] = tagColors[tagName];\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn(`Tag \"${tagName}\" has non-string color`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (typeof zoom === 'number') {\n\t\t\t\tstory.zoom = zoom;\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tconsole.warn(`Couldn't parse story data: ${dataPassage.text}`);\n\t\t}\n\t} else {\n\t\tconsole.warn('No StoryData passage is present in Twee');\n\t}\n\n\t// Detect old Twee format, which would have no passage metadata, and put\n\t// passages in a grid.\n\n\tif (story.passages.every(({left, top}) => left === 0 && top === 0)) {\n\t\tstory.passages = story.passages.map((passage, index) => ({\n\t\t\t...passage,\n\t\t\tleft: 25 + 125 * (index % 10),\n\t\t\ttop: 25 + 125 * Math.floor(index / 10)\n\t\t}));\n\t}\n\n\treturn story;\n}\n\n/**\n * Converts a story to Twee.\n */\nexport function storyToTwee(story: Story) {\n\tconst storyTitle = `:: StoryTitle\\n${escapeForTweeText(story.name)}`;\n\tconst startPassage = story.passages.find(p => p.id === story.startPassage);\n\tconst storyData = `:: StoryData\\n${JSON.stringify(\n\t\t{\n\t\t\tifid: story.ifid,\n\t\t\tformat: story.storyFormat,\n\t\t\t'format-version': story.storyFormatVersion,\n\t\t\tstart: startPassage?.name,\n\t\t\t'tag-colors':\n\t\t\t\tObject.keys(story.tagColors).length > 0 ? story.tagColors : undefined,\n\t\t\tzoom: story.zoom\n\t\t},\n\t\tnull,\n\t\t2\n\t)}`;\n\n\tlet result = `${storyTitle}\\n\\n\\n${storyData}\\n\\n\\n${sortBy(story.passages, [\n\t\t'name'\n\t])\n\t\t.map(passageToTwee)\n\t\t.join('\\n\\n')}`;\n\n\t// If the story has script or stylesheet, they need to be converted to tagged\n\t// passages. These passage names are not part of the Twee spec.\n\n\tconst passageNames = story.passages.map(({name}) => name);\n\n\tif (story.script.trim() !== '') {\n\t\tconst scriptPassageName = unusedName('StoryScript', passageNames);\n\n\t\tresult += `\\n\\n:: ${scriptPassageName} [script]\\n${escapeForTweeText(\n\t\t\tstory.script\n\t\t)}`;\n\t}\n\n\tif (story.stylesheet.trim() !== '') {\n\t\tconst stylesheetPassageName = unusedName('StoryStylesheet', passageNames);\n\n\t\tresult += `\\n\\n:: ${stylesheetPassageName} [stylesheet]\\n${escapeForTweeText(\n\t\t\tstory.stylesheet\n\t\t)}`;\n\t}\n\n\treturn result;\n}\n\n/**\n * Unescapes characters with special meanings in a Twee passage header (brackets,\n * curly quotes, and backslashes).\n */\nexport function unescapeForTweeHeader(value: string) {\n\treturn value.replace(/\\\\([[\\]{}])/g, '$1').replace(/\\\\\\\\/g, '\\\\');\n}\n\n/**\n * Unescapes characters that would disrupt parsing of passage text, i.e. `::` at\n * the start of a line.\n */\nexport function unescapeForTweeText(value: string) {\n\treturn value.replace(/^\\\\:/gm, ':');\n}\n","import * as React from 'react';\nimport './meter.css';\n\nexport interface MeterProps {\n\tdomId: string;\n\tpercent: number;\n}\n\nexport const Meter: React.FC<MeterProps> = ({children, domId, percent}) => {\n\treturn (\n\t\t<div\n\t\t\tclassName=\"meter\"\n\t\t\tid={domId}\n\t\t\trole=\"meter\"\n\t\t\taria-labelledby={`${domId}-label`}\n\t\t\taria-valuemin={0}\n\t\t\taria-valuemax={100}\n\t\t\taria-valuenow={percent * 100}\n\t\t>\n\t\t\t<div className=\"meter-bar\">\n\t\t\t\t<span className=\"filled\" style={{width: percent * 100 + '%'}}></span>\n\t\t\t</div>\n\t\t\t<div className=\"meter-label\" id={`${domId}-label`}>\n\t\t\t\t{children}\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","// Initiates story format loading, optionally showing a progress meter while it works.\n\nimport * as React from 'react';\nimport {Meter} from '../components/meter';\nimport {\n\tloadAllFormatProperties,\n\tuseStoryFormatsContext,\n\tStoryFormat\n} from './story-formats';\n\nexport interface FormatLoaderProps {\n\tblock?: boolean;\n}\n\nexport const FormatLoader: React.FC<FormatLoaderProps> = ({\n\tblock,\n\tchildren\n}) => {\n\tconst [seenFormats, setSeenFormats] = React.useState<StoryFormat[]>([]);\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\n\t// We can't directly use formats in an effect because it will change as\n\t// loading takes place. Instead, we need to maintain a list of formats to load\n\t// that only ever changes if new formats appear in state.\n\n\tReact.useEffect(() => {\n\t\tconst newFormats = formats.filter(\n\t\t\tnewFormat =>\n\t\t\t\t!seenFormats.find(\n\t\t\t\t\toldFormat =>\n\t\t\t\t\t\toldFormat.name === newFormat.name &&\n\t\t\t\t\t\toldFormat.version === newFormat.version\n\t\t\t\t)\n\t\t);\n\n\t\tif (newFormats.length > 0) {\n\t\t\tdispatch(loadAllFormatProperties(newFormats));\n\t\t\tsetSeenFormats([...seenFormats, ...newFormats]);\n\t\t}\n\t}, [dispatch, formats, seenFormats]);\n\n\tconst loadingFormat = formats.find(f => f.loadState === 'loading');\n\tconst loadPercent =\n\t\tformats.filter(f => f.loadState === 'loaded').length / formats.length;\n\n\tif (block && loadPercent < 1) {\n\t\treturn (\n\t\t\t<Meter domId=\"story-format-loader\" percent={loadPercent}>\n\t\t\t\t{loadingFormat && (\n\t\t\t\t\t<>\n\t\t\t\t\t\tLoading {loadingFormat.name} {loadingFormat.version}\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t</Meter>\n\t\t);\n\t}\n\n\treturn <>{children}</>;\n};\n","import {PrefsAction, PrefsState} from './prefs.types';\nimport {Color} from '../../util/color';\n\nexport function setPref(\n\tname: keyof PrefsState,\n\tvalue:\n\t\t| boolean\n\t\t| number\n\t\t| string\n\t\t| {name: string; version: string}\n\t\t| {name: string; version: string}[]\n\t\t| Record<string, Color>\n): PrefsAction {\n\treturn {type: 'update', name, value};\n}\n","import {PrefsState} from './prefs.types';\n\n/**\n * Returns whether the user has disabled editor extensions for a story format.\n */\nexport function formatEditorExtensionsDisabled(\n\tprefs: PrefsState,\n\tname: string,\n\tversion: string\n) {\n\treturn prefs.disabledStoryFormatEditorExtensions.some(\n\t\tf => f.name === name && f.version === version\n\t);\n}\n","import {Story} from '../../store/stories/stories.types';\n\n/**\n * Returns a filename for a story object that's guaranteed to be safe across all\n * platforms. For this, we use POSIX's definition\n * (http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap03.html#tag_03_276)\n * with the addition of spaces, for legibility.\n */\nexport function storyFileName(story: Story, extension = '.html') {\n\treturn story.name.replace(/[^\\w. -]/g, '_') + extension;\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoryFormatsState} from '.';\nimport {fetchStoryFormatProperties} from '../../util/story-format/fetch-properties';\nimport {\n\tStoryFormat,\n\tStoryFormatProperties,\n\tStoryFormatsAction,\n\tStoryFormatsDispatch\n} from './story-formats.types';\n\n/**\n * Creates a new story format based on properties (probably loaded externally).\n */\nexport function createFromProperties(\n\turl: string,\n\tproperties: StoryFormatProperties\n): StoryFormatsAction {\n\tif (!properties.name || !properties.version) {\n\t\tthrow new Error('Missing required properties for a new story format');\n\t}\n\n\treturn {\n\t\ttype: 'create',\n\t\tprops: {\n\t\t\turl,\n\t\t\tname: properties.name,\n\t\t\tselected: false,\n\t\t\tuserAdded: true,\n\t\t\tversion: properties.version\n\t\t}\n\t};\n}\n\n/**\n * Deletes a story format.\n */\nexport function deleteFormat(format: StoryFormat): StoryFormatsAction {\n\treturn {type: 'delete', id: format.id};\n}\n\n/**\n * Deselects all formats.\n */\nexport function deselectAllFormats(): Thunk<StoryFormat[], StoryFormatsAction> {\n\treturn (dispatch, getFormats) => {\n\t\tfor (const format of getFormats()) {\n\t\t\tif (format.selected) {\n\t\t\t\tdispatch({type: 'update', id: format.id, props: {selected: false}});\n\t\t\t}\n\t\t}\n\t};\n}\n\n/**\n * Deselects a single format.\n */\nexport function deselectFormat(format: StoryFormat): StoryFormatsAction {\n\treturn {type: 'update', id: format.id, props: {selected: false}};\n}\n\nasync function loadFormatThunk(\n\tformat: StoryFormat,\n\tdispatch: StoryFormatsDispatch\n) {\n\tdispatch({\n\t\ttype: 'update',\n\t\tid: format.id,\n\t\tprops: {loadState: 'loading'}\n\t});\n\n\ttry {\n\t\tlet properties = await fetchStoryFormatProperties(format.url);\n\n\t\t// If the format contains a `hydrate` property, try running it and merge in\n\t\t// properties that function creates by modifiying what's bound to its\n\t\t// `this`. This allows creation of properties that can't be serialized to\n\t\t// JSON on the format. The hydrate function cannot override properties\n\t\t// already present in the format properties, e.g. to change its source.\n\n\t\tif (properties.hydrate) {\n\t\t\ttry {\n\t\t\t\tconst hydrateResult: Partial<StoryFormatProperties> = {};\n\n\t\t\t\t// eslint-disable-next-line no-new-func\n\t\t\t\tconst hydrateFunc = new Function(properties.hydrate);\n\n\t\t\t\thydrateFunc.call(hydrateResult);\n\t\t\t\tproperties = {...hydrateResult, ...properties};\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Format ${format.id} has a hydrate property but it threw an error when called`,\n\t\t\t\t\te\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tid: format.id,\n\t\t\tprops: {properties, loadState: 'loaded'}\n\t\t});\n\n\t\treturn properties;\n\t} catch (loadError) {\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tid: format.id,\n\t\t\tprops: {loadError: (loadError as unknown) as Error, loadState: 'error'}\n\t\t});\n\t}\n}\n\n/**\n * Loads all format properties. If loading previously failed, this will try\n * again.\n */\nexport function loadAllFormatProperties(\n\tformats: StoryFormat[]\n): Thunk<StoryFormat[], StoryFormatsAction> {\n\tconst toLoad = formats.filter(\n\t\tf => f.loadState !== 'loaded' && f.loadState !== 'loading'\n\t);\n\n\tif (!toLoad) {\n\t\treturn () => {};\n\t}\n\n\treturn async (dispatch: StoryFormatsDispatch) => {\n\t\tawait Promise.allSettled(\n\t\t\ttoLoad.map(format => loadFormatThunk(format, dispatch))\n\t\t);\n\t};\n}\n\n/**\n * Loads a format's properties. If loading previously failed, this function will\n * try again. This returns a thunk which in turns returns a promise resolving to\n * the format properties, which can be useful if you need them immediately.\n */\nexport function loadFormatProperties(format: StoryFormat) {\n\tif (format.loadState === 'loaded') {\n\t\treturn () => format.properties;\n\t}\n\n\treturn async (dispatch: StoryFormatsDispatch) =>\n\t\tawait loadFormatThunk(format, dispatch);\n}\n\n/**\n * Selects a single format.\n */\nexport function selectFormat(\n\tformat: StoryFormat,\n\texclusive?: boolean\n): Thunk<StoryFormatsState, StoryFormatsAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!format.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'update',\n\t\t\t\tid: format.id,\n\t\t\t\tprops: {selected: true}\n\t\t\t});\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tfor (const other of getState()) {\n\t\t\t\tif (other.id !== format.id && other.selected) {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'update',\n\t\t\t\t\t\tid: other.id,\n\t\t\t\t\t\tprops: {selected: false}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}","import isAbsoluteUrl from 'is-absolute-url';\nimport semverLt from 'semver/functions/lt';\nimport {StoryFormat} from './story-formats.types';\nimport {PrefsState} from '../prefs';\nimport {gt} from 'semver';\n\nexport function filteredFormats(\n\tformats: StoryFormat[],\n\tfilter: PrefsState['storyFormatListFilter']\n): StoryFormat[] {\n\tswitch (filter) {\n\t\tcase 'all':\n\t\t\treturn formats;\n\n\t\tcase 'current':\n\t\t\treturn Object.values(\n\t\t\t\tformats.reduce<Record<string, StoryFormat>>((result, format) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!result[format.name] ||\n\t\t\t\t\t\tsemverLt(result[format.name].version, format.version)\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn {...result, [format.name]: format};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn result;\n\t\t\t\t}, {})\n\t\t\t);\n\n\t\tcase 'user':\n\t\t\treturn formats.filter(format => format.userAdded);\n\t}\n}\n\nexport function formatImageUrl(format: StoryFormat) {\n\tif (format.loadState !== 'loaded' || !format.properties.image) {\n\t\tthrow new Error('Format has no image property');\n\t}\n\n\tif (isAbsoluteUrl(format.properties.image)) {\n\t\treturn format.properties.image;\n\t}\n\n\treturn format.url.replace(/\\/[^/]*?$/, '/') + format.properties.image;\n}\n\nexport function formatWithId(formats: StoryFormat[], id: string) {\n\tconst result = formats.find(f => f.id === id);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story format with ID \"${id}\".`);\n}\n\nexport function formatWithNameAndVersion(\n\tformats: StoryFormat[],\n\tname: string,\n\tversion: string\n) {\n\tconst result = formats.find(f => f.name === name && f.version === version);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no story format with name \"${name}\" and version \"${version}\".`\n\t);\n}\n\nexport function newestFormatNamed(formats: StoryFormat[], name: string) {\n\treturn formats.reduce<StoryFormat | undefined>((result, format) => {\n\t\tif (format.name !== name) {\n\t\t\treturn result;\n\t\t}\n\n\t\tif (!result || gt(format.version, result.version)) {\n\t\t\treturn format;\n\t\t}\n\n\t\treturn result;\n\t}, undefined);\n}\n\nexport function sortFormats(formats: StoryFormat[]) {\n\treturn formats.sort((a, b) => {\n\t\t// First sort by name ascending...\n\n\t\tif (a.name < b.name) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (a.name > b.name) {\n\t\t\treturn 1;\n\t\t}\n\n\t\t// ... then by version, in descending order.\n\n\t\tif (a.version === b.version) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (semverLt(b.version, a.version)) {\n\t\t\treturn -1;\n\t\t}\n\n\t\treturn 1;\n\t});\n}\n","import {IconHeart, IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {CardContent} from '../components/container/card';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {IconButton} from '../components/control/icon-button';\nimport {IconLink} from '../components/control/icon-link';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {DialogComponentProps} from './dialogs.types';\n\nexport const AppDonationDialog: React.FC<DialogComponentProps> = props => {\n\tconst {dispatch} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => dispatch(setPref('donateShown', true)), [dispatch]);\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"app-donation-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.appDonation.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<div className=\"text\">\n\t\t\t\t\t<p>{t('dialogs.appDonation.supportMessage')}</p>\n\t\t\t\t\t<p>{t('dialogs.appDonation.onlyOnce')}</p>\n\t\t\t\t</div>\n\t\t\t</CardContent>\n\t\t\t<ButtonBar>\n\t\t\t\t<IconLink\n\t\t\t\t\thref=\"https://twinery.org/donate\"\n\t\t\t\t\ticon={<IconHeart />}\n\t\t\t\t\tlabel={t('dialogs.appDonation.donate')}\n\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\tlabel={t('dialogs.appDonation.noThanks')}\n\t\t\t\t\tonClick={props.onClose}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CardContent} from '../components/container/card';\nimport {DialogComponentProps} from './dialogs.types';\nimport {\n\tsetTagColor,\n\tstoryWithId,\n\trenamePassageTag,\n\tstoryPassageTags\n} from '../store/stories';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {Color} from '../util/color';\nimport {TagEditor} from '../components/tag/tag-editor';\n\nexport interface PassageTagsDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const PassageTagsDialog: React.FC<PassageTagsDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tconst story = storyWithId(stories, storyId);\n\tconst tags = storyPassageTags(story);\n\n\tfunction handleChangeColor(tagName: string, color: Color) {\n\t\tdispatch(\n\t\t\tsetTagColor(story, tagName, color),\n\t\t\tt('undoChange.changeTagColor')\n\t\t);\n\t}\n\n\tfunction handleChangeTagName(tagName: string, newName: string) {\n\t\tdispatch(\n\t\t\trenamePassageTag(story, tagName, newName),\n\t\t\tt('undoChange.renameTag')\n\t\t);\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\tclassName=\"passage-tags-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.passageTags.title')}\n\t\t\t{...other}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t{tags.length > 0 ? (\n\t\t\t\t\ttags.map(tag => (\n\t\t\t\t\t\t<TagEditor\n\t\t\t\t\t\t\tallTags={tags}\n\t\t\t\t\t\t\tcolor={story.tagColors[tag]}\n\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\tonChangeColor={color => handleChangeColor(tag, color)}\n\t\t\t\t\t\t\tonChangeName={newName => handleChangeTagName(tag, newName)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t) : (\n\t\t\t\t\t<p>{t('dialogs.passageTags.noTags')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IndentButtons, UndoRedoButtons} from '../components/codemirror';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {DialogCard, DialogEditor} from '../components/container/dialog-card';\nimport {CodeArea} from '../components/control/code-area';\nimport {usePrefsContext} from '../store/prefs';\nimport {storyWithId, updateStory, useStoriesContext} from '../store/stories';\nimport {codeMirrorOptionsFromPrefs} from '../util/codemirror-options';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-javascript.css';\n\nexport interface StoryJavaScriptDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryJavaScriptDialog: React.FC<StoryJavaScriptDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tconst handleChange = (\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) => {\n\t\tsetCmEditor(editor);\n\t\tdispatch(updateStory(stories, story, {script: text}));\n\t};\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-javascript-dialog\"\n\t\t\theaderLabel={t('dialogs.storyJavaScript.title')}\n\t\t\tmaximizable\n\t\t>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={story.script} />\n\t\t\t\t<IndentButtons editor={cmEditor} />\n\t\t\t</ButtonBar>\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={setCmEditor}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.storyJavaScript.editorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tautofocus: true,\n\t\t\t\t\t\tlineWrapping: true,\n\t\t\t\t\t\tmode: 'javascript',\n\t\t\t\t\t\tplaceholder: t('dialogs.storyJavaScript.explanation')\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={story.script}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</DialogCard>\n\t);\n};\n","import {debounce} from 'lodash';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconReplace} from '@tabler/icons';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CheckboxButton} from '../components/control/checkbox-button';\nimport {CodeArea} from '../components/control/code-area';\nimport {IconButton} from '../components/control/icon-button';\nimport {\n\thighlightPassagesMatchingSearch,\n\tpassagesMatchingSearch,\n\treplaceInStory,\n\tstoryWithId,\n\tStorySearchFlags\n} from '../store/stories';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-search.css';\n\n// See https://github.com/codemirror/CodeMirror/issues/5444\n\nconst ignoreTab: any = {\n\tTab: false,\n\t'Shift-Tab': false\n};\n\nexport interface StorySearchDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StorySearchDialog: React.FC<StorySearchDialogProps> = props => {\n\tconst {storyId, onClose, ...other} = props;\n\tconst [flags, setFlags] = React.useState<StorySearchFlags>({\n\t\tincludePassageNames: true,\n\t\tmatchCase: false,\n\t\tuseRegexes: false\n\t});\n\tconst [replace, setReplace] = React.useState('');\n\tconst [find, setFind] = React.useState('');\n\tconst [debouncedFind, setDebouncedFind] = React.useState('');\n\tconst closingRef = React.useRef(false);\n\tconst updateDebouncedFind = React.useMemo(\n\t\t() =>\n\t\t\tdebounce(\n\t\t\t\t(value: string) => {\n\t\t\t\t\tsetDebouncedFind(value);\n\t\t\t\t},\n\t\t\t\t250,\n\t\t\t\t{leading: false, trailing: true}\n\t\t\t),\n\t\t[]\n\t);\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\tconst story = storyWithId(stories, storyId);\n\tconst matches = passagesMatchingSearch(story.passages, find, flags);\n\n\tReact.useEffect(() => {\n\t\t// If we are in the process of closing, don't dispatch any highlight\n\t\t// changes. We don't want to overwrite the dispatch that occurs in\n\t\t// handleClose.\n\n\t\tif (!closingRef.current) {\n\t\t\tdispatch(highlightPassagesMatchingSearch(story, debouncedFind, flags));\n\t\t}\n\n\t\t// This doesn't return a cleanup function--cleanup occurs in handleClose\n\t\t// instead. This is safe because we know this effect will only ever change\n\t\t// highlight status of passages.\n\t}, [debouncedFind, dispatch, flags, story]);\n\n\tfunction handleClose() {\n\t\tclosingRef.current = true;\n\t\tdispatch(highlightPassagesMatchingSearch(story, '', {}));\n\t\tonClose();\n\t}\n\n\tfunction handleReplaceWithChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tsetReplace(text);\n\t}\n\n\tfunction handleSearchForChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tsetFind(text);\n\t\tupdateDebouncedFind(text);\n\t}\n\n\tfunction handleReplace() {\n\t\tdispatch(\n\t\t\treplaceInStory(story, find, replace, flags),\n\t\t\t'undoChange.replaceAllText'\n\t\t);\n\t}\n\n\tfunction toggleFlag(name: keyof StorySearchFlags) {\n\t\tsetFlags(flags => ({...flags, [name]: !flags[name]}));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-search-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storySearch.title')}\n\t\t\tonClose={handleClose}\n\t\t>\n\t\t\t<div className=\"search-fields\">\n\t\t\t\t<CodeArea\n\t\t\t\t\tlabel={t('dialogs.storySearch.find')}\n\t\t\t\t\tonBeforeChange={handleSearchForChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\textraKeys: ignoreTab,\n\t\t\t\t\t\tmode: 'text'\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={find}\n\t\t\t\t/>\n\t\t\t\t<CodeArea\n\t\t\t\t\tlabel={t('dialogs.storySearch.replaceWith')}\n\t\t\t\t\tonBeforeChange={handleReplaceWithChange}\n\t\t\t\t\toptions={{extraKeys: ignoreTab, mode: 'text'}}\n\t\t\t\t\tvalue={replace}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"search-flags\">\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.includePassageNames')}\n\t\t\t\t\tonChange={() => toggleFlag('includePassageNames')}\n\t\t\t\t\tvalue={flags.includePassageNames ?? false}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.matchCase')}\n\t\t\t\t\tonChange={() => toggleFlag('matchCase')}\n\t\t\t\t\tvalue={flags.matchCase ?? false}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.useRegexes')}\n\t\t\t\t\tonChange={() => toggleFlag('useRegexes')}\n\t\t\t\t\tvalue={flags.useRegexes ?? false}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"search-results\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={matches.length === 0}\n\t\t\t\t\ticon={<IconReplace />}\n\t\t\t\t\tlabel={t('dialogs.storySearch.replaceAll')}\n\t\t\t\t\tonClick={handleReplace}\n\t\t\t\t\tvariant=\"danger\"\n\t\t\t\t/>\n\t\t\t\t<span>\n\t\t\t\t\t{find &&\n\t\t\t\t\t\t(matches.length > 0\n\t\t\t\t\t\t\t? t('dialogs.storySearch.matchCount', {count: matches.length})\n\t\t\t\t\t\t\t: t('dialogs.storySearch.noMatches'))}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IndentButtons, UndoRedoButtons} from '../components/codemirror';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {DialogCard, DialogEditor} from '../components/container/dialog-card';\nimport {CodeArea} from '../components/control/code-area';\nimport {usePrefsContext} from '../store/prefs';\nimport {storyWithId, updateStory, useStoriesContext} from '../store/stories';\nimport {codeMirrorOptionsFromPrefs} from '../util/codemirror-options';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-stylesheet.css';\n\nexport interface StoryStylesheetDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryStylesheetDialog: React.FC<StoryStylesheetDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tconst handleChange = (\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) => {\n\t\tsetCmEditor(editor);\n\t\tdispatch(updateStory(stories, story, {stylesheet: text}));\n\t};\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-stylesheet-dialog\"\n\t\t\theaderLabel={t('dialogs.storyStylesheet.title')}\n\t\t\tmaximizable\n\t\t>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={story.script} />\n\t\t\t\t<IndentButtons editor={cmEditor} />\n\t\t\t</ButtonBar>\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={setCmEditor}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.storyStylesheet.editorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tautofocus: true,\n\t\t\t\t\t\tlineWrapping: true,\n\t\t\t\t\t\tmode: 'css',\n\t\t\t\t\t\tplaceholder: t('dialogs.storyStylesheet.explanation')\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={story.stylesheet}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CardContent} from '../components/container/card';\nimport {DialogComponentProps} from './dialogs.types';\nimport {renameStoryTag, storyTags} from '../store/stories';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {Color} from '../util/color';\nimport {TagEditor} from '../components/tag/tag-editor';\n\nexport type StoryTagsDialogProps = DialogComponentProps;\n\nexport const StoryTagsDialog: React.FC<StoryTagsDialogProps> = props => {\n\tconst {dispatch: storiesDispatch, stories} = useUndoableStoriesContext();\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst tags = storyTags(stories);\n\n\tfunction handleChangeColor(tagName: string, color: Color) {\n\t\tprefsDispatch(\n\t\t\tsetPref('storyTagColors', {...prefs.storyTagColors, [tagName]: color})\n\t\t);\n\t}\n\n\tfunction handleChangeTagName(tagName: string, newName: string) {\n\t\tstoriesDispatch(renameStoryTag(stories, tagName, newName));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\tclassName=\"story-tags-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storyTags.title')}\n\t\t\t{...props}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t{tags.length > 0 ? (\n\t\t\t\t\ttags.map(tag => (\n\t\t\t\t\t\t<TagEditor\n\t\t\t\t\t\t\tallTags={tags}\n\t\t\t\t\t\t\tcolor={prefs.storyTagColors[tag]}\n\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\tonChangeColor={color => handleChangeColor(tag, color)}\n\t\t\t\t\t\t\tonChangeName={newName => handleChangeTagName(tag, newName)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t) : (\n\t\t\t\t\t<p>{t('dialogs.storyTags.noTags')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tCreatePassagesAction,\n\tPassage,\n\tStoriesState,\n\tStory\n} from '../stories.types';\nimport {passageDefaults} from '../defaults';\nimport {rectsIntersect} from '../../../util/geometry';\nimport {parseLinks} from '../../../util/parse-links';\n\n/**\n * Creates newly linked passages from a passage. You shouldn't need to call this\n * directly--it will be invoked automatically by updatePassage() if you change\n * the passage text.\n */\nexport function createNewlyLinkedPassages(\n\tstory: Story,\n\tpassage: Passage,\n\tnewText: string,\n\toldText: string\n): Thunk<StoriesState, CreatePassagesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn dispatch => {\n\t\tconst oldLinks = parseLinks(oldText);\n\t\tconst toCreate = parseLinks(newText).filter(\n\t\t\tl => !oldLinks.includes(l) && !story.passages.some(p => p.name === l)\n\t\t);\n\n\t\tif (toCreate.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst passageDefs = passageDefaults();\n\t\tconst passageGap = 25;\n\n\t\tlet top = passage.top + passage.height + passageGap;\n\t\tconst newPassagesWidth =\n\t\t\ttoCreate.length * passageDefs.width + (toCreate.length - 1) * passageGap;\n\n\t\t// Horizontally center the passages.\n\n\t\tlet left = passage.left + (passage.width - newPassagesWidth) / 2;\n\n\t\t// Move them to avoid overlaps.\n\n\t\tconst needsMoving = () =>\n\t\t\tstory.passages.some(passage =>\n\t\t\t\trectsIntersect(passage, {\n\t\t\t\t\tleft,\n\t\t\t\t\ttop,\n\t\t\t\t\theight: passageDefs.height,\n\t\t\t\t\twidth: newPassagesWidth\n\t\t\t\t})\n\t\t\t);\n\n\t\twhile (needsMoving()) {\n\t\t\t// Try rightward.\n\n\t\t\tleft += passageDefs.width + passageGap;\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Try leftward.\n\n\t\t\tleft -= 2 * (passageDefs.width + passageGap);\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Move downward and try again.\n\n\t\t\tleft += passageDefs.width + passageGap;\n\t\t\ttop += passageDefs.height + passageGap;\n\t\t}\n\n\t\t// Actually create them.\n\n\t\tdispatch({\n\t\t\ttype: 'createPassages',\n\t\t\tstoryId: story.id,\n\t\t\tprops: toCreate.map(name => {\n\t\t\t\tconst result = {left, name, top};\n\n\t\t\t\tleft += passageDefs.width + passageGap;\n\t\t\t\treturn result;\n\t\t\t})\n\t\t});\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport uuid from 'tiny-uuid';\nimport {PrefsState} from '../../prefs';\nimport {StoriesAction, StoriesState, Story} from '../stories.types';\n\n/**\n * Creates a new story with the default story format.\n */\nexport function createStory(\n\tstories: Story[],\n\tprefs: PrefsState,\n\tprops: Partial<Omit<Story, 'id'>> & Pick<Story, 'name'>\n): Thunk<StoriesState, StoriesAction> {\n\tconst id = uuid();\n\n\tif (props.name.trim() === '') {\n\t\tthrow new Error('Story name cannot be empty');\n\t}\n\n\tif (\n\t\tstories.some(story => story.name.toLowerCase() === props.name.toLowerCase())\n\t) {\n\t\tthrow new Error(`There is already a story named \"${props.name}\"`);\n\t}\n\n\treturn dispatch => {\n\t\tdispatch({\n\t\t\ttype: 'createStory',\n\t\t\tprops: {\n\t\t\t\tid,\n\t\t\t\tstoryFormat: prefs.storyFormat.name,\n\t\t\t\tstoryFormatVersion: prefs.storyFormat.version,\n\t\t\t\t...props\n\t\t\t}\n\t\t});\n\n\t\treturn id;\n\t};\n}\n","import {passageDefaults} from '../defaults';\nimport {CreatePassageAction, Story} from '../stories.types';\nimport {rectsIntersect} from '../../../util/geometry';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a new, untitled passage centered at a point in the story. This\n * automatically increments a number at the end of the passage name to ensure\n * it's unique.\n */\nexport function createUntitledPassage(\n\tstory: Story,\n\tcenterX: number,\n\tcenterY: number\n): CreatePassageAction {\n\tif (!Number.isFinite(centerX) || !Number.isFinite(centerY)) {\n\t\tthrow new Error('Center must be a finite coordinate pair');\n\t}\n\n\tconst defs = passageDefaults();\n\tconst passageName = unusedName(\n\t\tdefs.name,\n\t\tstory.passages.map(passage => passage.name)\n\t);\n\n\t// Center it at the position requested, but move it outward until no overlaps are found.\n\n\tconst passageGap = 25;\n\tconst bounds = {\n\t\theight: defs.height,\n\t\tleft: Math.max(centerX - defs.width / 2, 0),\n\t\ttop: Math.max(centerY - defs.height / 2, 0),\n\t\twidth: defs.width\n\t};\n\n\tif (story.snapToGrid) {\n\t\tbounds.left = Math.round(bounds.left / passageGap) * passageGap;\n\t\tbounds.top = Math.round(bounds.top / passageGap) * passageGap;\n\t}\n\n\tconst needsMoving = () =>\n\t\tstory.passages.some(passage => rectsIntersect(passage, bounds));\n\n\twhile (needsMoving()) {\n\t\t// Try rightward.\n\n\t\tbounds.left += bounds.width + passageGap;\n\n\t\tif (!needsMoving()) {\n\t\t\tbreak;\n\t\t}\n\n\t\t// Try downward.\n\n\t\tbounds.left -= bounds.width + passageGap;\n\t\tbounds.top += bounds.height + passageGap;\n\n\t\tif (!needsMoving()) {\n\t\t\tbreak;\n\t\t}\n\n\t\t// Try leftward.\n\n\t\tif (bounds.left >= bounds.width + passageGap) {\n\t\t\tbounds.left -= bounds.width + passageGap;\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tbounds.left += bounds.width + passageGap;\n\t\t}\n\n\t\t// Move downward permanently and repeat.\n\n\t\tbounds.top += bounds.height + passageGap;\n\t}\n\n\treturn {\n\t\ttype: 'createPassage',\n\t\tstoryId: story.id,\n\t\tprops: {\n\t\t\t...bounds,\n\t\t\tstory: story.id,\n\t\t\tname: passageName\n\t\t}\n\t};\n}\n","import {\n\tPassage,\n\tStory,\n\tDeletePassageAction,\n\tDeletePassagesAction\n} from '../stories.types';\n\n/**\n * Deletes a passage.\n */\nexport function deletePassage(\n\tstory: Story,\n\tpassage: Passage\n): DeletePassageAction {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn {type: 'deletePassage', storyId: story.id, passageId: passage.id};\n}\n\n/**\n * Deletes multiple passages.\n */\nexport function deletePassages(\n\tstory: Story,\n\tpassages: Passage[]\n): DeletePassagesAction {\n\treturn {\n\t\ttype: 'deletePassages',\n\t\tstoryId: story.id,\n\t\tpassageIds: passages.map(passage => passage.id)\n\t};\n}\n","import {StoriesAction, Story} from '../stories.types';\n\nexport function deleteStory(story: Story): StoriesAction {\n\treturn {type: 'deleteStory', storyId: story.id};\n}\n","import uuid from 'tiny-uuid';\nimport {CreateStoryAction, Story} from '../stories.types';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a duplicate of an existing story.\n */\nexport function duplicateStory(\n\tstory: Story,\n\tstories: Story[]\n): CreateStoryAction {\n\treturn {\n\t\ttype: 'createStory',\n\t\tprops: {\n\t\t\t...story,\n\t\t\tid: uuid(),\n\t\t\tifid: uuid(),\n\t\t\tname: unusedName(\n\t\t\t\tstory.name,\n\t\t\t\tstories.map(story => story.name)\n\t\t\t)\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {parseLinks} from '../../../util/parse-links';\nimport {passageIsEmpty} from '../../../util/passage-is-empty';\nimport {\n\tDeletePassagesAction,\n\tPassage,\n\tStoriesState,\n\tStory\n} from '../stories.types';\n\n/**\n * Deletes empty, orphaned passages from a story after passage text changes. An orphan\n * must meet all these criteria:\n *\n * - It is considered empty (see util/passage-is-empty.ts)\n * - It is not the story start\n * - It was linked previously from the passage, but is not anymore\n * - It is only linked to from the passage whose text is changing\n *\n * The intent is to delete passages that were automatically created in the past,\n * but the user has removed the link through editing without ever editing the\n * passage.\n */\nexport function deleteOrphanedPassages(\n\tstory: Story,\n\tpassage: Passage,\n\tnewText: string,\n\toldText: string\n): Thunk<StoriesState, DeletePassagesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn dispatch => {\n\t\tconst oldLinks = parseLinks(oldText);\n\t\tconst newLinks = parseLinks(newText);\n\t\tconst orphans = oldLinks.filter(link => !newLinks.includes(link));\n\n\t\tconst passageIds = orphans.reduce<string[]>((result, orphan) => {\n\t\t\tconst orphanPassage = story.passages.find(p => p.name === orphan);\n\n\t\t\t// These tests are fast because they look at the passage object only.\n\n\t\t\tif (\n\t\t\t\t!orphanPassage ||\n\t\t\t\t!passageIsEmpty(orphanPassage) ||\n\t\t\t\tstory.startPassage === orphanPassage.id\n\t\t\t) {\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\t// This is O(n) potentially.\n\n\t\t\tif (\n\t\t\t\tstory.passages.some(\n\t\t\t\t\tp => p.id !== passage.id && parseLinks(p.text).includes(orphan)\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\treturn [...result, orphanPassage.id];\n\t\t}, []);\n\n\t\tif (passageIds.length > 0) {\n\t\t\tdispatch({type: 'deletePassages', passageIds, storyId: story.id});\n\t\t}\n\t};\n}\n","import escapeRegExp from 'lodash/escapeRegExp';\nimport {Thunk} from 'react-hook-thunk-reducer';\nimport {storyWithId} from '../getters';\nimport {Passage, StoriesAction, StoriesState, Story} from '../stories.types';\nimport {createNewlyLinkedPassages} from './create-newly-linked-passages';\nimport {deleteOrphanedPassages} from './delete-orphaned-passages';\n\nexport interface UpdatePassageOptions {\n\tdontUpdateOthers?: boolean;\n}\n\n/**\n * General update of a passage.\n */\nexport function updatePassage(\n\tstory: Story,\n\tpassage: Passage,\n\tprops: Partial<Passage>,\n\toptions: UpdatePassageOptions = {}\n): Thunk<StoriesState, StoriesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (\n\t\t'name' in props &&\n\t\tstory.passages\n\t\t\t.filter(p => p.name === props.name)\n\t\t\t.some(p => p.id !== passage.id)\n\t) {\n\t\tthrow new Error(`There is already a passage named \"${props.name}\".`);\n\t}\n\n\treturn (dispatch, getState) => {\n\t\t// Do the passage update itself.\n\n\t\tconst oldName = passage.name;\n\t\tconst oldText = passage.text;\n\n\t\tdispatch({\n\t\t\tprops,\n\t\t\ttype: 'updatePassage',\n\t\t\tpassageId: passage.id,\n\t\t\tstoryId: story.id\n\t\t});\n\n\t\t// Side effects from changes.\n\n\t\tif (!options.dontUpdateOthers && props.text) {\n\t\t\tdispatch(deleteOrphanedPassages(story, passage, props.text, oldText));\n\n\t\t\t// We need to get an up-to-date version of the story so placement of new\n\t\t\t// passages is correct.\n\n\t\t\tconst updatedStory = storyWithId(getState(), story.id);\n\n\t\t\tdispatch(\n\t\t\t\tcreateNewlyLinkedPassages(updatedStory, passage, props.text, oldText)\n\t\t\t);\n\t\t}\n\n\t\tif (props.name) {\n\t\t\tconst oldNameEscaped = escapeRegExp(oldName);\n\n\t\t\t// We only need to escape $ stuff in the new name, because it will be the\n\t\t\t// second argument to replace(). This is a little mindbending, but the\n\t\t\t// purpose of this is to replace $ with $$.\n\n\t\t\tconst newNameEscaped = props.name.replace(/\\$/g, '$$$$');\n\n\t\t\tconst simpleLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[' + oldNameEscaped + '(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\t\t\tconst compoundLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[(.*?)(\\\\||->)' + oldNameEscaped + '(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\t\t\tconst reverseLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[' + oldNameEscaped + '(<-.*?)(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\n\t\t\tstory.passages.forEach(relinkedPassage => {\n\t\t\t\tif (\n\t\t\t\t\tsimpleLinkRegexp.test(relinkedPassage.text) ||\n\t\t\t\t\tcompoundLinkRegexp.test(relinkedPassage.text) ||\n\t\t\t\t\treverseLinkRegexp.test(relinkedPassage.text)\n\t\t\t\t) {\n\t\t\t\t\tlet newText = relinkedPassage.text;\n\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\tsimpleLinkRegexp,\n\t\t\t\t\t\t'[[' + newNameEscaped + '$1]]'\n\t\t\t\t\t);\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\tcompoundLinkRegexp,\n\t\t\t\t\t\t'[[$1$2' + newNameEscaped + '$3]]'\n\t\t\t\t\t);\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\treverseLinkRegexp,\n\t\t\t\t\t\t'[[' + newNameEscaped + '$1$2]]'\n\t\t\t\t\t);\n\n\t\t\t\t\tupdatePassage(\n\t\t\t\t\t\tstory,\n\t\t\t\t\t\trelinkedPassage,\n\t\t\t\t\t\t{text: newText},\n\t\t\t\t\t\toptions\n\t\t\t\t\t)(dispatch, getState);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {createRegExp, escapeRegExpReplace} from '../../../util/regexp';\nimport {updatePassage} from './update-passage';\nimport {\n\tPassage,\n\tStoriesAction,\n\tStoriesState,\n\tStory,\n\tStorySearchFlags\n} from '../stories.types';\n\n/**\n * Core logic for replacing text using flags.\n */\nfunction replaceText(source: string, searchFor: string, replaceWith: string, flags: StorySearchFlags) {\n\tconst {matchCase, useRegexes} = flags;\n\tconst matcher = createRegExp(searchFor, {matchCase, useRegexes});\n\tconst replacer = useRegexes\n\t? replaceWith\n\t: escapeRegExpReplace(replaceWith);\n\n\treturn source.replace(matcher, replacer);\n}\n\nexport function replaceInPassage(\n\tstory: Story,\n\tpassage: Passage,\n\tsearchFor: string,\n\treplaceWith: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, StoriesAction> {\n\treturn (dispatch, getState) => {\n\t\tif (searchFor === '') {\n\t\t\tthrow new Error(\"Can't replace an empty string\");\n\t\t}\n\n\t\tif (passage.story !== story.id) {\n\t\t\tthrow new Error('Passage does not belong to story');\n\t\t}\n\n\t\tconst {includePassageNames} = flags;\n\t\tconst props: Partial<Passage> = {};\n\n\t\tconst newText = replaceText(passage.text, searchFor, replaceWith, flags);\n\n\t\tif (newText !== passage.text) {\n\t\t\tprops.text = newText;\n\t\t}\n\n\t\tif (includePassageNames) {\n\t\t\tconst newName = replaceText(passage.name, searchFor, replaceWith, flags);\n\n\t\t\tif (newName !== passage.name) {\n\t\t\t\tprops.name = newName;\n\t\t\t}\n\t\t}\n\n\t\tif (Object.keys(props).length > 0) {\n\t\t\tupdatePassage(story, passage, props)(dispatch, getState);\n\t\t}\n\t};\n}\n\nexport function replaceInStory(\n\tstory: Story,\n\tsearchFor: string,\n\treplaceWith: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, StoriesAction> {\n\treturn (dispatch, getState) => {\n\t\tif (searchFor === '') {\n\t\t\tthrow new Error(\"Can't replace an empty string\");\n\t\t}\n\n\t\tif (flags.includePassageNames) {\n\t\t\t// Do replaces in passage names first, so that if a replace will change\n\t\t\t// both a link and a passage name, the updatePassage action will see that\n\t\t\t// the passage exists when the link is changed, and not create a new\n\t\t\t// passage that will conflict with the existing one.\n\t\t\t\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\tconst name = replaceText(passage.name, searchFor, replaceWith, flags);\n\n\t\t\t\tif (name !== passage.name) {\n\t\t\t\t\tupdatePassage(story, passage, {name})(dispatch, getState);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\tconst text = replaceText(passage.text, searchFor, replaceWith, flags);\n\n\t\t\t\tif (text !== passage.text) {\n\t\t\t\t\tupdatePassage(story, passage, {text})(dispatch, getState);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// We're only updating passage text, so we can do it the easy way.\n\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\treplaceInPassage(\n\t\t\t\t\tstory,\n\t\t\t\t\tpassage,\n\t\t\t\t\tsearchFor,\n\t\t\t\t\treplaceWith,\n\t\t\t\t\tflags\n\t\t\t\t)(dispatch, getState);\n\t\t\t}\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tStorySearchFlags,\n\tUpdatePassagesAction\n} from '../stories.types';\nimport {passagesMatchingSearch} from '../getters';\n\nexport function highlightPassagesMatchingSearch(\n\tstory: Story,\n\tsearch: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tlet passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tif (search === '') {\n\t\t\t// Remove all highlights.\n\t\t\tpassageUpdates = story.passages.reduce((result, passage) => {\n\t\t\t\tif (passage.highlighted) {\n\t\t\t\t\treturn {...result, [passage.id]: {highlighted: false}};\n\t\t\t\t}\n\n\t\t\t\treturn result;\n\t\t\t}, {});\n\t\t} else {\n\t\t\tconst matchIds = passagesMatchingSearch(\n\t\t\t\tstory.passages,\n\t\t\t\tsearch,\n\t\t\t\tflags\n\t\t\t).map(passage => passage.id);\n\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\tconst oldHighlighted = passage.highlighted;\n\t\t\t\tconst newHighlighted = matchIds.includes(passage.id);\n\n\t\t\t\tif (newHighlighted !== oldHighlighted) {\n\t\t\t\t\tpassageUpdates[passage.id] = {highlighted: newHighlighted};\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tCreateStoryAction,\n\tStoriesState,\n\tStory,\n\tUpdateStoryAction\n} from '../stories.types';\nimport {storyFileName} from '../../../electron/shared';\n\n/**\n * Imports stories, overwriting any stories with the same name.\n */\nexport function importStories(\n\ttoImport: Story[],\n\texistingStories: Story[]\n): Thunk<StoriesState, CreateStoryAction | UpdateStoryAction> {\n\ttoImport.forEach(importStory => {\n\t\tif (\n\t\t\ttoImport.some(\n\t\t\t\totherStory =>\n\t\t\t\t\totherStory !== importStory &&\n\t\t\t\t\tstoryFileName(otherStory) === storyFileName(importStory)\n\t\t\t)\n\t\t) {\n\t\t\tthrow new Error(\n\t\t\t\t`Stories to import cannot have the same name: \"${importStory.name}\"`\n\t\t\t);\n\t\t}\n\t});\n\n\treturn dispatch => {\n\t\ttoImport.forEach(importStory => {\n\t\t\t// Remove the temp ID that was assigned to the new story.\n\n\t\t\tconst props: Partial<Story> = {...importStory};\n\n\t\t\tdelete props.id;\n\n\t\t\tconst existingStory = existingStories.find(\n\t\t\t\ts => storyFileName(s) === storyFileName(importStory)\n\t\t\t);\n\n\t\t\t// Do an update so that if something goes awry, we won't have deleted the\n\t\t\t// story. We need to update passage props so that their parent story ID is\n\t\t\t// set properly.\n\n\t\t\tif (existingStory) {\n\t\t\t\tif (props.passages) {\n\t\t\t\t\tprops.passages = props.passages.map(passage => ({\n\t\t\t\t\t\t...passage,\n\t\t\t\t\t\tstory: existingStory.id\n\t\t\t\t\t}));\n\t\t\t\t}\n\n\t\t\t\tdispatch({props, type: 'updateStory', storyId: existingStory.id});\n\t\t\t} else {\n\t\t\t\tdispatch({props, type: 'createStory'});\n\t\t\t}\n\t\t});\n\t};\n}\n","import {Passage, Story, UpdatePassagesAction} from '../stories.types';\n\n/**\n * Moves passages by an offset, e.g. after dragging.\n */\nexport function movePassages(\n\tstory: Story,\n\tpassageIds: string[],\n\txChange: number,\n\tyChange: number\n): UpdatePassagesAction {\n\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\tif (!Number.isFinite(xChange) || !Number.isFinite(yChange)) {\n\t\tthrow new Error('Offset must be a finite number.');\n\t}\n\n\tpassageIds.forEach(passageId => {\n\t\tconst passage = story.passages.find(p => p.id === passageId);\n\n\t\tif (!passage) {\n\t\t\tthrow new Error(\n\t\t\t\t`There is no passage in this story with ID \"${passageId}\".`\n\t\t\t);\n\t\t}\n\n\t\tlet left = Math.max(passage.left + xChange, 0);\n\t\tlet top = Math.max(passage.top + yChange, 0);\n\n\t\tif (story.snapToGrid) {\n\t\t\tleft = Math.round(left / 25) * 25;\n\t\t\ttop = Math.round(top / 25) * 25;\n\t\t}\n\n\t\tpassageUpdates[passage.id] = {left, top};\n\t});\n\n\treturn {type: 'updatePassages', passageUpdates, storyId: story.id};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tUpdatePassagesAction,\n\tUpdateStoryAction\n} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\nexport function renamePassageTag(\n\tstory: Story,\n\toldName: string,\n\tnewName: string\n): Thunk<StoriesState, UpdatePassagesAction | UpdateStoryAction> {\n\tif (!isValidTagName(newName)) {\n\t\tthrow new Error(`\"${newName}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\t// Change tags in passages.\n\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (passage.tags.includes(oldName)) {\n\t\t\t\tpassageUpdates[passage.id] = {\n\t\t\t\t\ttags: passage.tags.map(tag => (tag === oldName ? newName : tag))\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\n\t\t\t// Move the tag color to the new one.\n\n\t\t\tconst tagColors = {...story.tagColors};\n\n\t\t\tdelete tagColors[oldName];\n\t\t\ttagColors[newName] = story.tagColors[oldName];\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops: {tagColors},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesAction, StoriesState, Story} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\nexport function renameStoryTag(\n\tstories: Story[],\n\toldName: string,\n\tnewName: string\n): Thunk<StoriesState, StoriesAction> {\n\tif (!isValidTagName(newName)) {\n\t\tthrow new Error(`\"${newName}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\tstories.forEach(story => {\n\t\t\tif (story.tags.includes(oldName)) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tstoryId: story.id,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\ttags: story.tags.map(tag => (tag === oldName ? newName : tag))\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {Rect, rectsIntersect} from '../../../util/geometry';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tUpdatePassageAction,\n\tUpdatePassagesAction\n} from '../stories.types';\n\n/**\n * Deselects all passages.\n */\nexport function deselectAllPassages(\n\tstory: Story\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (passage.selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected: false};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Deselects a single passage.\n */\nexport function deselectPassage(\n\tstory: Story,\n\tpassage: Passage\n): Thunk<StoriesState, UpdatePassageAction> {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story');\n\t}\n\n\treturn dispatch => {\n\t\tif (passage.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updatePassage',\n\t\t\t\tpassageId: passage.id,\n\t\t\t\tprops: {selected: false},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Selects all passages.\n */\nexport function selectAllPassages(\n\tstory: Story\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (!passage.selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected: true};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Selects a single passage.\n */\nexport function selectPassage(\n\tstory: Story,\n\tpassage: Passage,\n\texclusive: boolean\n): Thunk<StoriesState, UpdatePassagesAction> {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story');\n\t}\n\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tif (!passage.selected) {\n\t\t\tpassageUpdates[passage.id] = {selected: true};\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tstory.passages.forEach(p => {\n\t\t\t\tif (p.id !== passage.id && p.selected) {\n\t\t\t\t\tpassageUpdates[p.id] = {selected: false};\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\t\t}\n\t};\n}\n\nexport function selectPassagesInRect(\n\tstory: Story,\n\trect: Rect,\n\tignoreIds: string[] = []\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (ignoreIds.find(r => r === passage.id)) {\n\t\t\t\t// We are ignoring this passage, e.g. this is an additive selection and it\n\t\t\t\t// was already selected.\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst selected = rectsIntersect(rect, passage);\n\n\t\t\tif (passage.selected !== selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesState, Story, UpdateStoryAction} from '../stories.types';\n\n/**\n * Deselects a single story.\n */\nexport function deselectStory(\n\tstory: Story\n): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!story.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tstoryId: story.id,\n\t\t\t\tprops: {selected: false}\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Deselects all stories.\n */\nexport function deselectAllStories(): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tfor (const story of getState()) {\n\t\t\tif (story.selected) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tstoryId: story.id,\n\t\t\t\t\tprops: {selected: false}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t};\n}\n\n/**\n * Selects a single story.\n */\nexport function selectStory(\n\tstory: Story,\n\texclusive: boolean\n): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!story.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tstoryId: story.id,\n\t\t\t\tprops: {selected: true}\n\t\t\t});\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tfor (const other of getState()) {\n\t\t\t\tif (other.id !== story.id && other.selected) {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\t\tstoryId: other.id,\n\t\t\t\t\t\tprops: {selected: false}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {Color} from '../../../util/color';\nimport {isValidTagName} from '../../../util/tag';\nimport {StoriesState, Story, UpdateStoryAction} from '../stories.types';\n\nexport function setTagColor(\n\tstory: Story,\n\tname: string,\n\tcolor: Color\n): Thunk<StoriesState, UpdateStoryAction> {\n\tif (!isValidTagName(name)) {\n\t\tthrow new Error(`\"${name}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\t// Special handling: if the color is set to none, just delete it.\n\n\t\tif (color === 'none') {\n\t\t\tif (name in story.tagColors) {\n\t\t\t\tconst tagColors = {...story.tagColors};\n\n\t\t\t\tdelete tagColors[name];\n\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tprops: {tagColors},\n\t\t\t\t\tstoryId: story.id\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops: {tagColors: {...story.tagColors, [name]: color}},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Passage, Story, UpdatePassageAction} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\n/**\n * Adds a tag to a passage.\n */\nexport function addPassageTag(\n\tstory: Story,\n\tpassage: Passage,\n\ttagName: string\n): UpdatePassageAction {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (!isValidTagName(tagName)) {\n\t\tthrow new Error(`\"${tagName}\" is not a valid tag name.`);\n\t}\n\n\tif (passage.tags.includes(tagName)) {\n\t\tthrow new Error(`This passage already has the tag \"${tagName}\".`);\n\t}\n\n\treturn {\n\t\ttype: 'updatePassage',\n\t\tpassageId: passage.id,\n\t\tstoryId: story.id,\n\t\tprops: {tags: [...passage.tags, tagName]}\n\t};\n}\n\n/**\n * Removes a tag from a passage.\n */\nexport function removePassageTag(\n\tstory: Story,\n\tpassage: Passage,\n\ttagName: string\n): UpdatePassageAction {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (!isValidTagName(tagName)) {\n\t\tthrow new Error(`\"${tagName}\" is not a valid tag name.`);\n\t}\n\n\tif (!passage.tags.includes(tagName)) {\n\t\tthrow new Error(`This passage does not have the tag \"${tagName}\".`);\n\t}\n\n\treturn {\n\t\ttype: 'updatePassage',\n\t\tpassageId: passage.id,\n\t\tstoryId: story.id,\n\t\tprops: {tags: passage.tags.filter(t => t !== tagName)}\n\t};\n}\n","import {Story, UpdateStoryAction} from '../stories.types';\nimport {storyFileName} from '../../../electron/shared';\n\n/**\n * General update of a story.\n */\nexport function updateStory(\n\tstories: Story[],\n\tstory: Story,\n\tprops: Partial<Story>\n): UpdateStoryAction {\n\tif (\n\t\tprops.name &&\n\t\tstories\n\t\t\t.filter(s => storyFileName(s) === storyFileName({...s, ...props}))\n\t\t\t.some(s => s.id !== story.id)\n\t) {\n\t\tthrow new Error(`There is already a story named \"${props.name}\".`);\n\t}\n\n\treturn {\n\t\tprops,\n\t\tstoryId: story.id,\n\t\ttype: 'updateStory'\n\t};\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults} from '../defaults';\nimport {Passage, Story, StoriesState} from '../stories.types';\n\nexport function createPassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageProps: Partial<Passage>\n) {\n\tlet storyExists = false;\n\tlet created = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tstoryExists = true;\n\n\t\tif (story.passages.some(passage => passage.id === passageProps.id)) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with ID \"${passageProps.id}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tif (\n\t\t\t'name' in passageProps &&\n\t\t\tstory.passages.some(passage => passage.name === passageProps.name)\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with name \"${passageProps.name}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tconst newPassage: Passage = {\n\t\t\t...passageDefaults(),\n\t\t\tid: uuid(),\n\t\t\t...passageProps,\n\t\t\tstory: story.id\n\t\t};\n\t\tconst newStory: Story = {\n\t\t\t...story,\n\t\t\tlastUpdate: new Date(),\n\t\t\tpassages: [...story.passages, newPassage]\n\t\t};\n\n\t\tif (newStory.passages.length === 1) {\n\t\t\tnewStory.startPassage = newPassage.id;\n\t\t}\n\n\t\tcreated = true;\n\t\treturn newStory;\n\t});\n\n\tif (!storyExists) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!created) {\n\t\t// Should have warned above.\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {StoriesState} from '../stories.types';\n\nexport function deletePassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageId: string\n) {\n\tlet foundStory = false;\n\tlet deleted = false;\n\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tfoundStory = true;\n\n\t\tconst newStory = {\n\t\t\t...story,\n\t\t\tpassages: story.passages.filter(passage => {\n\t\t\t\tif (passage.id === passageId) {\n\t\t\t\t\tdeleted = true;\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t})\n\t\t};\n\n\t\tif (deleted) {\n\t\t\tnewStory.lastUpdate = new Date();\n\t\t\treturn newStory;\n\t\t}\n\n\t\treturn story;\n\t});\n\n\tif (!foundStory) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!deleted) {\n\t\tconsole.warn(\n\t\t\t`Asked to delete a passage with ID \"${passageId}\", but it does not exist in story ID ${storyId}, taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults} from '../../defaults';\nimport {Passage, Story} from '../../stories.types';\n\nfunction logRepair(\n\tpassage: Passage,\n\tpropName: keyof Passage,\n\trepairedValue: any,\n\tdetail?: string\n) {\n\tlet message =\n\t\t`Repairing passage (name: \"${passage.name}\", id: ${passage.id}): ` +\n\t\t`setting ${propName} to ${repairedValue}, was ${passage[propName]}`;\n\n\tif (detail) {\n\t\tmessage += ` (${detail})`;\n\t}\n\n\tconsole.info(message);\n}\n\nexport function repairPassage(passage: Passage, parentStory: Story): Passage {\n\tconst passageDefs = passageDefaults();\n\tconst repairs: Partial<Passage> = {};\n\n\t// Give the passage an ID if it has none.\n\n\tif (typeof passage.id !== 'string' || passage.id === '') {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(passage, 'id', newId, 'was undefined or empty string');\n\t\trepairs.id = uuid();\n\t}\n\n\t// Apply default properties to the passage.\n\n\tObject.entries(passageDefs).forEach(([key, value]) => {\n\t\tconst defKey = key as keyof typeof passageDefs;\n\n\t\tif (\n\t\t\t(typeof value === 'number' && !Number.isFinite(passage[defKey])) ||\n\t\t\ttypeof value !== typeof passage[defKey]\n\t\t) {\n\t\t\tlogRepair(passage, defKey, passageDefs[defKey]);\n\t\t\t(repairs[defKey] as Passage[typeof defKey]) = passageDefs[defKey];\n\t\t}\n\t});\n\n\t// Make passage coordinates 0 or greater.\n\n\t['left', 'top'].forEach(pos => {\n\t\tconst posKey = pos as keyof Passage;\n\n\t\tif (passage[posKey] < 0) {\n\t\t\tlogRepair(passage, posKey, 0, 'was negative');\n\t\t\t(repairs[posKey] as Passage[typeof posKey]) = 0;\n\t\t}\n\t});\n\n\t// Make passage dimensions 5 or greater.\n\n\t['height', 'width'].forEach(dim => {\n\t\tconst dimKey = dim as keyof Passage;\n\n\t\tif (passage[dimKey] < 5) {\n\t\t\tlogRepair(passage, dimKey, 0, 'was less than 5');\n\t\t\t(repairs[dimKey] as Passage[typeof dimKey]) = 5;\n\t\t}\n\t});\n\n\t// Repair story property if it doesn't point to the parent story.\n\n\tif (passage.story !== parentStory.id) {\n\t\tlogRepair(passage, 'story', parentStory.id, \"didn't match parent story\");\n\t\trepairs.story = parentStory.id;\n\t}\n\n\t// Repair ID conflicts with any other passage in the story.\n\n\tif (\n\t\tparentStory.passages.some(otherPassage => {\n\t\t\tif (otherPassage === passage) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn otherPassage.id === passage.id;\n\t\t})\n\t) {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(\n\t\t\tpassage,\n\t\t\t'id',\n\t\t\tnewId,\n\t\t\t'conflicted with another passage in the story'\n\t\t);\n\t\trepairs.id = newId;\n\t}\n\n\tif (Object.keys(repairs).length > 0) {\n\t\treturn {...passage, ...repairs};\n\t}\n\n\treturn passage;\n}\n","import {satisfies} from 'semver';\nimport uuid from 'tiny-uuid';\nimport {Story} from '../../stories.types';\nimport {storyDefaults} from '../../defaults';\nimport {StoryFormat} from '../../../story-formats';\nimport {repairPassage} from './repair-passage';\n\nfunction logRepair(\n\tstory: Story,\n\tpropName: keyof Story,\n\trepairedValue: any,\n\tdetail?: string\n) {\n\tlet message =\n\t\t`Repairing story (name: \"${story.name}\", id: ${story.id}) by ` +\n\t\t`setting ${propName} to ${repairedValue}, was ${story[propName]}`;\n\n\tif (detail) {\n\t\tmessage += ` (${detail})`;\n\t}\n\n\tconsole.info(message);\n}\n\nexport function repairStory(\n\tstory: Story,\n\tallStories: Story[],\n\tallFormats: StoryFormat[],\n\tdefaultFormat: StoryFormat\n): Story {\n\tconst storyDefs = storyDefaults();\n\tconst repairs: Partial<Story> = {};\n\n\t// Give the story an ID if it has none.\n\n\tif (typeof story.id !== 'string' || story.id === '') {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(story, 'id', newId, 'was bad type or empty string');\n\t\trepairs.id = newId;\n\t}\n\n\t// Give the story an IFID if it has none.\n\n\tif (typeof story.ifid !== 'string' || story.id === '') {\n\t\tconst newIfid = uuid();\n\n\t\tlogRepair(story, 'ifid', newIfid, 'was bad type or empty string');\n\t\trepairs.ifid = newIfid;\n\t}\n\n\t// Apply default properties to the story.\n\n\tObject.entries(storyDefs).forEach(([key, value]) => {\n\t\tconst defKey = key as keyof typeof storyDefs;\n\n\t\tif (\n\t\t\t(typeof value === 'number' && !Number.isFinite(story[defKey])) ||\n\t\t\ttypeof value !== typeof story[defKey]\n\t\t) {\n\t\t\tlogRepair(story, defKey, storyDefs[defKey]);\n\t\t\t(repairs[defKey] as Story[typeof defKey]) = storyDefs[defKey];\n\t\t}\n\t});\n\n\tif (\n\t\ttypeof story.storyFormat !== 'string' ||\n\t\tstory.storyFormat === '' ||\n\t\ttypeof story.storyFormatVersion !== 'string' ||\n\t\tstory.storyFormatVersion === ''\n\t) {\n\t\t// Assign the story the default story format if it has none.\n\n\t\tlogRepair(\n\t\t\tstory,\n\t\t\t'storyFormat',\n\t\t\tdefaultFormat.name,\n\t\t\t'was bad type or unset'\n\t\t);\n\t\tlogRepair(\n\t\t\tstory,\n\t\t\t'storyFormatVersion',\n\t\t\tdefaultFormat.version,\n\t\t\t'was bad type or unset'\n\t\t);\n\t\trepairs.storyFormat = defaultFormat.name;\n\t\trepairs.storyFormatVersion = defaultFormat.version;\n\t} else if (\n\t\t!allFormats.some(\n\t\t\tformat =>\n\t\t\t\tformat.name === story.storyFormat &&\n\t\t\t\tformat.version === story.storyFormatVersion\n\t\t)\n\t) {\n\t\t// If the story has a nonexistent story format, try to match it to one that\n\t\t// does, using semver as a guide.\n\n\t\tconst repairFormat = allFormats.find(\n\t\t\tformat =>\n\t\t\t\tformat.name === story.storyFormat &&\n\t\t\t\tsatisfies(format.version, '^' + story.storyFormatVersion)\n\t\t);\n\n\t\tif (repairFormat) {\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormat',\n\t\t\t\trepairFormat.name,\n\t\t\t\t'no match in existing formats but found one that satisfies semver'\n\t\t\t);\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormatVersion',\n\t\t\t\trepairFormat.version,\n\t\t\t\t'no match in existing formats but found one that satisfies semver'\n\t\t\t);\n\t\t\trepairs.storyFormat = repairFormat.name;\n\t\t\trepairs.storyFormatVersion = repairFormat.version;\n\t\t} else {\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormat',\n\t\t\t\tdefaultFormat.name,\n\t\t\t\t'no match in existing formats and could not find one that satisfies semver'\n\t\t\t);\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormatVersion',\n\t\t\t\tdefaultFormat.version,\n\t\t\t\t'no match in existing formats and could not find one that satisfies semver'\n\t\t\t);\n\t\t\trepairs.storyFormat = defaultFormat.name;\n\t\t\trepairs.storyFormatVersion = defaultFormat.version;\n\t\t}\n\t}\n\n\t// Repair ID conflicts with other stories.\n\n\tif (\n\t\tallStories.some(otherStory => {\n\t\t\tif (otherStory === story) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn otherStory.id === story.id;\n\t\t})\n\t) {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(story, 'id', newId, \"conflicted with another story's ID\");\n\t\trepairs.id = newId;\n\t}\n\n\t// Repair all passages. All story ID changes must be before this to prevent\n\t// mismatches. We merge in repairs temporarily here so that passages see the\n\t// most correct ID.\n\n\tlet anyPassageRepaired = false;\n\tconst repairedPassages = story.passages.map(passage => {\n\t\tconst repairedPassage = repairPassage(passage, {...story, ...repairs});\n\n\t\tif (repairedPassage !== passage) {\n\t\t\tanyPassageRepaired = true;\n\t\t\treturn repairedPassage;\n\t\t}\n\n\t\treturn passage;\n\t});\n\n\tif (anyPassageRepaired) {\n\t\trepairs.passages = repairedPassages;\n\t}\n\n\tif (Object.keys(repairs).length > 0) {\n\t\treturn {...story, ...repairs};\n\t}\n\n\treturn story;\n}\n","import {Passage, Story, StoriesState} from '../stories.types';\nimport {isPersistablePassageChange} from '../../persistence/persistable-changes';\n\nexport function updatePassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageId: string,\n\tpassageProps: Omit<Partial<Passage>, 'id' | 'story'>\n) {\n\tlet storyExists = false;\n\tlet updated = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tstoryExists = true;\n\n\t\tif (\n\t\t\t'name' in passageProps &&\n\t\t\tstory.passages.some(\n\t\t\t\tpassage =>\n\t\t\t\t\tpassage.name === passageProps.name && passage.id !== passageId\n\t\t\t)\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with name \"${passageProps.name}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tconst newStory: Story = {\n\t\t\t...story,\n\t\t\tpassages: story.passages.map(passage => {\n\t\t\t\tif (passage.id !== passageId) {\n\t\t\t\t\treturn passage;\n\t\t\t\t}\n\n\t\t\t\tupdated = true;\n\t\t\t\treturn {...passage, ...passageProps};\n\t\t\t})\n\t\t};\n\n\t\tif (updated) {\n\t\t\tif (isPersistablePassageChange(passageProps)) {\n\t\t\t\tnewStory.lastUpdate = new Date();\n\t\t\t}\n\n\t\t\treturn newStory;\n\t\t}\n\n\t\tconsole.warn(\n\t\t\t`Asked to update a passage with ID \"${passageId}\", but it does not exist in story ID ${storyId}, taking no action`\n\t\t);\n\t\treturn story;\n\t});\n\n\tif (!storyExists) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!updated) {\n\t\t// Should have warned above.\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {createPassage} from './create-passage';\nimport {createPassages} from './create-passages';\nimport {createStory} from './create-story';\nimport {deletePassage} from './delete-passage';\nimport {deletePassages} from './delete-passages';\nimport {deleteStory} from './delete-story';\nimport {initState} from './init';\nimport {repairState} from './repair';\nimport {updatePassage} from './update-passage';\nimport {updatePassages} from './update-passages';\nimport {updateStory} from './update-story';\nimport {StoriesAction, StoriesState} from '../stories.types';\n\nexport const reducer: React.Reducer<StoriesState, StoriesAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'createPassage':\n\t\t\treturn createPassage(state, action.storyId, action.props);\n\n\t\tcase 'createPassages':\n\t\t\treturn createPassages(state, action.storyId, action.props);\n\n\t\tcase 'createStory':\n\t\t\treturn createStory(state, action.props);\n\n\t\tcase 'deletePassage':\n\t\t\treturn deletePassage(state, action.storyId, action.passageId);\n\n\t\tcase 'deletePassages':\n\t\t\treturn deletePassages(state, action.storyId, action.passageIds);\n\n\t\tcase 'deleteStory':\n\t\t\treturn deleteStory(state, action.storyId);\n\n\t\tcase 'init':\n\t\t\treturn initState(state, action.state);\n\n\t\tcase 'repair':\n\t\t\treturn repairState(state, action.allFormats, action.defaultFormat);\n\n\t\tcase 'updatePassage':\n\t\t\treturn updatePassage(\n\t\t\t\tstate,\n\t\t\t\taction.storyId,\n\t\t\t\taction.passageId,\n\t\t\t\taction.props\n\t\t\t);\n\n\t\tcase 'updatePassages':\n\t\t\treturn updatePassages(state, action.storyId, action.passageUpdates);\n\n\t\tcase 'updateStory':\n\t\t\treturn updateStory(state, action.storyId, action.props);\n\n\t\tdefault:\n\t\t\tconsole.warn(`${(action as any).type} not implemented yet`);\n\t}\n\n\treturn state;\n};\n","import {Passage, StoriesState} from '../stories.types';\nimport {createPassage} from './create-passage';\n\nexport function createPassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageProps: Partial<Passage>[]\n) {\n\treturn passageProps.reduce(\n\t\t(state, props) => createPassage(state, storyId, props),\n\t\tstate\n\t);\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults, storyDefaults} from '../defaults';\nimport {Story, StoriesState} from '../stories.types';\n\nexport function createStory(state: StoriesState, storyProps: Partial<Story>) {\n\tif ('id' in storyProps && state.some(story => story.id === storyProps.id)) {\n\t\tconsole.warn(\n\t\t\t`There is already a story in state with ID \"${storyProps.id}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tif (\n\t\t'name' in storyProps &&\n\t\tstate.some(story => story.name === storyProps.name)\n\t) {\n\t\tconsole.warn(\n\t\t\t`There is already a story in state with name \"${storyProps.name}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tlet story: Story = {\n\t\tid: uuid(),\n\t\t...storyDefaults(),\n\t\tifid: uuid().toUpperCase(),\n\t\tlastUpdate: new Date(),\n\t\tpassages: [],\n\t\ttags: [],\n\t\ttagColors: {},\n\t\t...storyProps\n\t};\n\n\t// If we are prepopulating the story with passages, make sure they have the\n\t// correct ID linkage, and at least make sure basic properties are set.\n\n\tstory.passages = story.passages.map(passage => ({\n\t\t...passageDefaults,\n\t\t...passage,\n\t\tstory: story.id\n\t}));\n\n\treturn [...state, story];\n}\n","import {StoriesState} from '../stories.types';\nimport {deletePassage} from './delete-passage';\n\nexport function deletePassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageIds: string[]\n) {\n\treturn passageIds.reduce(\n\t\t(state, passageId) => deletePassage(state, storyId, passageId),\n\t\tstate\n\t);\n}\n","import {StoriesState} from '../stories.types';\n\nexport function deleteStory(state: StoriesState, storyId: string) {\n\tlet deleted = false;\n\tconst newState = state.filter(story => {\n\t\tif (story.id === storyId) {\n\t\t\tdeleted = true;\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t});\n\n\tif (!deleted) {\n\t\tconsole.warn(\n\t\t\t`Asked to delete a story with ID \"${storyId}\", but it does not exist in state`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {Story, StoriesState} from '../stories.types';\n\nexport function initState(state: StoriesState, init: Story[]) {\n\treturn [...init];\n}\n","import {repairStory} from './repair-story';\nimport {StoryFormat} from '../../../story-formats';\nimport {StoriesState} from '../../stories.types';\n\nexport function repairState(\n\tstate: StoriesState,\n\tallFormats: StoryFormat[],\n\tdefaultFormat: StoryFormat\n): StoriesState {\n\treturn state.map(story =>\n\t\trepairStory(story, state, allFormats, defaultFormat)\n\t);\n}\n","import {Passage, StoriesState} from '../stories.types';\nimport {updatePassage} from './update-passage';\n\nexport function updatePassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageUpdates: Record<string, Partial<Passage>>\n) {\n\treturn Object.keys(passageUpdates).reduce(\n\t\t(state, passageId) =>\n\t\t\tupdatePassage(state, storyId, passageId, passageUpdates[passageId]),\n\t\tstate\n\t);\n}\n","import {Story, StoriesState} from '../stories.types';\nimport {isPersistableStoryChange} from '../../persistence/persistable-changes';\n\nexport function updateStory(\n\tstate: StoriesState,\n\tstoryId: string,\n\tstoryProps: Partial<Omit<Story, 'id'>>\n) {\n\tif (\n\t\t'name' in storyProps &&\n\t\tstate.some(story => story.name === storyProps.name && story.id !== storyId)\n\t) {\n\t\tconsole.warn(\n\t\t\t`There is another story in state with name \"${storyProps.name}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tlet updated = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tupdated = true;\n\n\t\tconst updatedStory = {...story, ...storyProps};\n\n\t\tif (isPersistableStoryChange(storyProps)) {\n\t\t\tupdatedStory.lastUpdate = new Date();\n\t\t}\n\n\t\treturn updatedStory;\n\t});\n\n\tif (!updated) {\n\t\tconsole.warn(\n\t\t\t`Asked to update a story with ID \"${storyId}\", but it does not exist in state`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import * as React from 'react';\nimport useThunkReducer from 'react-hook-thunk-reducer';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {reducer} from './reducer';\nimport {\n\tStoriesContextProps,\n\tStoriesAction,\n\tStoriesState\n} from './stories.types';\nimport {useStoryFormatsContext} from '../story-formats';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\n\nexport const StoriesContext = React.createContext<StoriesContextProps>({\n\tdispatch: () => {},\n\tstories: []\n});\n\nStoriesContext.displayName = 'Stories';\n\nexport const useStoriesContext = () => React.useContext(StoriesContext);\n\nexport const StoriesContextProvider: React.FC = props => {\n\tconst {stories: storiesPersistence} = usePersistence();\n\tconst {formats} = useStoryFormatsContext();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tStoriesState,\n\t\tStoriesAction\n\t> = React.useMemo(\n\t\t() => (state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tstoriesPersistence.saveMiddleware(newState, action, formats);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistStories');\n\t\t\t}\n\n\t\t\treturn newState;\n\t\t},\n\t\t[formats, reportError, storiesPersistence]\n\t);\n\tconst [stories, dispatch] = useThunkReducer(persistedReducer, []);\n\n\treturn (\n\t\t<StoriesContext.Provider value={{dispatch, stories}}>\n\t\t\t{props.children}\n\t\t</StoriesContext.Provider>\n\t);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport './file-input.css';\n\n// See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file\n\nexport interface FileInputProps {\n\taccept?: string;\n\tchildren: React.ReactNode;\n\tonChange: (file: File, data: string) => void;\n\tonError?: (error: Error) => void;\n\torientation?: 'horizontal' | 'vertical';\n}\n\nexport const FileInput: React.FC<FileInputProps> = props => {\n\tconst {children, onChange, onError, orientation, ...otherProps} = props;\n\tconst className = classNames(\n\t\t'file-input',\n\t\t`orientation-${orientation ?? 'horizontal'}`\n\t);\n\n\tfunction handleChange(changeEvent: React.ChangeEvent<HTMLInputElement>) {\n\t\tif (!changeEvent.target.files) {\n\t\t\tthrow new Error('Change event occurred but no files present');\n\t\t}\n\n\t\tconst file = changeEvent.target.files[0];\n\t\tconst reader = new FileReader();\n\n\t\treader.addEventListener('loadend', loadEvent => {\n\t\t\tif (reader.error) {\n\t\t\t\tconsole.warn(reader.error);\n\n\t\t\t\tif (onError) {\n\t\t\t\t\tonError(reader.error);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tonChange(file, reader.result as string);\n\t\t\t}\n\t\t});\n\n\t\treader.readAsText(file);\n\t}\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"file-input-label\">{children}</span>\n\t\t\t\t<span className=\"file-input-control\">\n\t\t\t\t\t<input {...otherProps} onChange={handleChange} type=\"file\" />\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {FileInput} from '../../components/control/file-input';\nimport {Story} from '../../store/stories';\nimport {importStories} from '../../util/import';\nimport {storyFromTwee} from '../../util/twee';\n\nexport interface FileChooserProps {\n\tonChange: (file: File, stories: Story[]) => void;\n}\n\nexport const FileChooser: React.FC<FileChooserProps> = props => {\n\tconst {onChange} = props;\n\tconst {t} = useTranslation();\n\n\tfunction handleChange(file: File, data: string) {\n\t\tif (/\\.html$/.test(file.name)) {\n\t\t\tonChange(file, importStories(data));\n\t\t} else {\n\t\t\tonChange(file, [storyFromTwee(data)]);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"file-chooser\">\n\t\t\t<p>\n\t\t\t\t<FileInput\n\t\t\t\t\taccept=\".html,.twee,.tw\"\n\t\t\t\t\tonChange={handleChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.storyImport.filePrompt')}\n\t\t\t\t</FileInput>\n\t\t\t</p>\n\t\t</div>\n\t);\n};\n","import {IconFileImport} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {IconButton} from '../../components/control/icon-button';\nimport {storyFileName} from '../../electron/shared';\nimport {Story} from '../../store/stories';\nimport './story-chooser.css';\n\nexport interface StoryChooserProps {\n\texistingStories: Story[];\n\tonImport: (stories: Story[]) => void;\n\tstories: Story[];\n}\n\nexport const StoryChooser: React.FC<StoryChooserProps> = props => {\n\tconst {existingStories, onImport, stories} = props;\n\tconst [selectedStories, setSelectedStories] = React.useState<Story[]>([]);\n\tconst {t} = useTranslation();\n\n\t// Whenever either existing stories or stories to import changes, select all\n\t// stories that do not conflict.\n\n\tconst willReplaceExisting = React.useCallback(\n\t\t(story: Story) => {\n\t\t\treturn existingStories.some(\n\t\t\t\tother => storyFileName(other) === storyFileName(story)\n\t\t\t);\n\t\t},\n\t\t[existingStories]\n\t);\n\n\tReact.useEffect(() => {\n\t\tsetSelectedStories(stories.filter(story => !willReplaceExisting(story)));\n\t}, [stories, willReplaceExisting]);\n\n\tfunction handleChange(story: Story, selected: boolean) {\n\t\tif (selected) {\n\t\t\tsetSelectedStories(current => [...current, story]);\n\t\t} else {\n\t\t\tsetSelectedStories(current =>\n\t\t\t\tcurrent.filter(other => other.id !== story.id)\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"story-chooser\">\n\t\t\t<p>{t('dialogs.storyImport.storiesPrompt')}</p>\n\t\t\t<ul>\n\t\t\t\t{stories.map(story => (\n\t\t\t\t\t<li key={story.id}>\n\t\t\t\t\t\t<CheckboxButton\n\t\t\t\t\t\t\tlabel={story.name}\n\t\t\t\t\t\t\tonChange={selected => handleChange(story, selected)}\n\t\t\t\t\t\t\tvalue={selectedStories.includes(story)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{selectedStories.includes(story) && willReplaceExisting(story) && (\n\t\t\t\t\t\t\t<span className=\"replace-warning\">\n\t\t\t\t\t\t\t\t{t('dialogs.storyImport.willReplaceExisting')}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</li>\n\t\t\t\t))}\n\t\t\t</ul>\n\t\t\t<div className=\"actions\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={selectedStories.length === 0}\n\t\t\t\t\ticon={<IconFileImport />}\n\t\t\t\t\tlabel={t('dialogs.storyImport.importSelected')}\n\t\t\t\t\tonClick={() => onImport(selectedStories)}\n\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../../components/container/card';\nimport {\n\tDialogCard,\n\tDialogCardProps\n} from '../../components/container/dialog-card';\nimport {storyFileName} from '../../electron/shared';\nimport {importStories, Story, useStoriesContext} from '../../store/stories';\nimport {useStoriesRepair} from '../../store/use-stories-repair';\nimport {FileChooser} from './file-chooser';\nimport {StoryChooser} from './story-chooser';\nimport './story-import.css';\n\nexport type StoryImportDialogProps = Omit<DialogCardProps, 'headerLabel'>;\n\nexport const StoryImportDialog: React.FC<StoryImportDialogProps> = props => {\n\tconst {onClose} = props;\n\tconst {t} = useTranslation();\n\tconst repairStories = useStoriesRepair();\n\tconst {dispatch, stories: existingStories} = useStoriesContext();\n\tconst [file, setFile] = React.useState<File>();\n\tconst [stories, setStories] = React.useState<Story[]>([]);\n\n\tfunction handleImport(stories: Story[]) {\n\t\tdispatch(importStories(stories, existingStories));\n\t\trepairStories();\n\t\tonClose();\n\t}\n\n\tfunction handleFileChange(file: File, stories: Story[]) {\n\t\t// If there are no conflicts in the stories, import them now. Otherwise, set\n\t\t// them in state and let the user choose via <StoryChooser>.\n\n\t\tif (\n\t\t\tstories.length === 0 ||\n\t\t\tstories.some(story =>\n\t\t\t\texistingStories.some(\n\t\t\t\t\texisting => storyFileName(existing) === storyFileName(story)\n\t\t\t\t)\n\t\t\t)\n\t\t) {\n\t\t\tsetFile(file);\n\t\t\tsetStories(stories);\n\t\t} else {\n\t\t\thandleImport(stories);\n\t\t}\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"story-import-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storyImport.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<FileChooser onChange={handleFileChange} />\n\t\t\t\t{file && stories.length > 0 && (\n\t\t\t\t\t<StoryChooser\n\t\t\t\t\t\texistingStories={existingStories}\n\t\t\t\t\t\tonImport={handleImport}\n\t\t\t\t\t\tstories={stories}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t\t{file && stories.length === 0 && (\n\t\t\t\t\t<p>{t('dialogs.storyImport.noStoriesInFile')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tpassageWithId,\n\tpassageWithName,\n\tstoryWithId,\n\tPassage,\n\tStoriesAction,\n\tStoriesState,\n\tStory\n} from '../stories';\nimport {StoriesActionOrThunk} from './undoable-stories.types';\n\n/**\n * Returns an action or thunk to reverse a single action.\n */\nexport function reverseAction(\n\taction: StoriesAction,\n\tstate: StoriesState\n): StoriesActionOrThunk {\n\tswitch (action.type) {\n\t\tcase 'createPassage':\n\t\t\tif (action.props.id) {\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\tpassageId: action.props.id,\n\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t};\n\t\t\t} else if (action.props.name) {\n\t\t\t\t// This is dependant on the fact that we will only undo this action\n\t\t\t\t// immediately--otherwise this could create havoc if the passage has\n\t\t\t\t// been renamed in the meantime.\n\t\t\t\t//\n\t\t\t\t// This also assumes that the create action will succeed--e.g. there are\n\t\t\t\t// no conflicts.\n\t\t\t\tconst reverseThunk: Thunk<StoriesState, StoriesAction> = (\n\t\t\t\t\tdispatch,\n\t\t\t\t\tgetState\n\t\t\t\t) => {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\tpassageId: passageWithName(\n\t\t\t\t\t\t\tgetState(),\n\t\t\t\t\t\t\taction.storyId,\n\t\t\t\t\t\t\taction.props.name!\n\t\t\t\t\t\t).id,\n\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t});\n\t\t\t\t};\n\n\t\t\t\treturn reverseThunk;\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Can't reverse a createPassage action without either name or ID\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t// TODO: crashes on a replace all that affects a passage name, unclear why\n\n\t\tcase 'createPassages':\n\t\t\tif (action.props.some(prop => !prop.id && !prop.name)) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Can't reverse a createPassages action where a prop set doesn't have either name or ID\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn (dispatch, getState) => {\n\t\t\t\taction.props.forEach(props => {\n\t\t\t\t\tif (props.id) {\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\t\tpassageId: props.id,\n\t\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (props.name) {\n\t\t\t\t\t\t// This is dependent on the fact that we will only undo this action\n\t\t\t\t\t\t// immediately--see comment about the createPassage action.\n\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\t\tpassageId: passageWithName(getState(), action.storyId, props.name)\n\t\t\t\t\t\t\t\t.id,\n\t\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t};\n\n\t\tcase 'deletePassage':\n\t\t\treturn {\n\t\t\t\ttype: 'createPassage',\n\t\t\t\tprops: passageWithId(state, action.storyId, action.passageId),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'deletePassages':\n\t\t\treturn {\n\t\t\t\ttype: 'createPassages',\n\t\t\t\tprops: action.passageIds.map(passageId =>\n\t\t\t\t\tpassageWithId(state, action.storyId, passageId)\n\t\t\t\t),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'updatePassage': {\n\t\t\tconst passage = passageWithId(state, action.storyId, action.passageId);\n\t\t\tconst props = Object.keys(action.props).reduce(\n\t\t\t\t(result, propName) => ({\n\t\t\t\t\t...result,\n\t\t\t\t\t[propName]: passage[propName as keyof Passage]\n\t\t\t\t}),\n\t\t\t\t{} as Passage\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\ttype: 'updatePassage',\n\t\t\t\tprops,\n\t\t\t\tpassageId: action.passageId,\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\t\t}\n\n\t\tcase 'updatePassages':\n\t\t\treturn {\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tpassageUpdates: Object.keys(action.passageUpdates).reduce(\n\t\t\t\t\t(result, passageId) => {\n\t\t\t\t\t\tconst passage = passageWithId(state, action.storyId, passageId);\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t[passageId]: Object.keys(action.passageUpdates[passageId]).reduce(\n\t\t\t\t\t\t\t\t(passageResult, propName) => ({\n\t\t\t\t\t\t\t\t\t...passageResult,\n\t\t\t\t\t\t\t\t\t[propName]: passage[propName as keyof Passage]\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t{} as Passage\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t};\n\t\t\t\t\t},\n\t\t\t\t\t{} as Record<string, Partial<Passage>>\n\t\t\t\t),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'updateStory': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\tconst props = Object.keys(action.props).reduce(\n\t\t\t\t(result, propName) => ({\n\t\t\t\t\t...result,\n\t\t\t\t\t[propName]: story[propName as keyof Story]\n\t\t\t\t}),\n\t\t\t\t{} as Story\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops,\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\t\t}\n\t}\n\n\tthrow new Error(`Don't know how to reverse action type \"${action.type}\"`);\n}\n","import * as React from 'react';\nimport {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesAction, StoriesState} from '../stories';\nimport {reverseAction} from './reverse-action';\nimport {StoriesActionOrThunk} from './undoable-stories.types';\n\n/**\n * Returns a thunk to reverse a thunk's actions. **This only works with thunks\n * that dispatch all actions synchronously.**\n */\nexport function reverseThunk(\n\tthunk: Thunk<StoriesState, StoriesAction>,\n\tstate: StoriesState\n): Thunk<StoriesState, StoriesAction> {\n\tconst actions: StoriesActionOrThunk[] = [];\n\tconst dispatch: React.Dispatch<StoriesActionOrThunk> = (\n\t\tactionOrThunk: StoriesActionOrThunk\n\t) => {\n\t\tif (typeof actionOrThunk === 'function') {\n\t\t\tactions.push(reverseThunk(actionOrThunk, state));\n\t\t} else {\n\t\t\tactions.push(reverseAction(actionOrThunk, state));\n\t\t}\n\t};\n\n\tthunk(dispatch, () => state);\n\treturn dispatch => actions.forEach(dispatch);\n}\n","// This reducer manages tracking undo states only. It does not actually perform\n// the undo/redos itself--that is instead done by\n// <UndoableStoriesContextProvider>, which orchestrates things between this\n// reducer and the main stories reducer.\n\nimport * as React from 'react';\nimport {reverseAction} from './reverse-action';\nimport {reverseThunk} from './reverse-thunk';\nimport {\n\tStoryChange,\n\tUndoableStoriesAction,\n\tUndoableStoriesState\n} from './undoable-stories.types';\n\nexport const reducer: React.Reducer<\n\tUndoableStoriesState,\n\tUndoableStoriesAction\n> = (state, action) => {\n\tswitch (action.type) {\n\t\tcase 'addChange':\n\t\t\tconst newChange: StoryChange = {\n\t\t\t\tdescription: action.description,\n\t\t\t\tredo: action.action,\n\t\t\t\tundo:\n\t\t\t\t\ttypeof action.action === 'function'\n\t\t\t\t\t\t? reverseThunk(action.action, action.storiesState)\n\t\t\t\t\t\t: reverseAction(action.action, action.storiesState)\n\t\t\t};\n\n\t\t\t// Slice off any changes after the current one.\n\n\t\t\tconst newChanges = [\n\t\t\t\t...state.changes.slice(0, state.currentChange + 1),\n\t\t\t\tnewChange\n\t\t\t];\n\n\t\t\treturn {\n\t\t\t\tchanges: newChanges,\n\t\t\t\tcurrentChange: newChanges.length - 1\n\t\t\t};\n\n\t\tcase 'updateCurrent':\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tcurrentChange: Math.min(\n\t\t\t\t\tMath.max(state.currentChange + action.change, -1),\n\t\t\t\t\tstate.changes.length - 1\n\t\t\t\t)\n\t\t\t};\n\t}\n};\n","// This context wraps access to a StoriesContext so that changes made can be\n// undone. To properly use this, a change should be dispatched via either a\n// single action object or a thunk. This context assumes that each dispatch call\n// should be treated as a discrete change. If this context is being used, all\n// changes should go through this context--the StoriesContext shouldn't be\n// accessed directly.\n\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {\n\tStoriesActionOrThunk,\n\tUndoableStoriesContextProps\n} from './undoable-stories.types';\nimport {reducer} from './reducer';\nimport {useStoriesContext} from '../stories';\n\nexport const UndoableStoriesContext = React.createContext<UndoableStoriesContextProps>(\n\t{\n\t\tdispatch: () => {},\n\t\tstories: []\n\t}\n);\n\nUndoableStoriesContext.displayName = 'UndoableStories';\n\nexport const useUndoableStoriesContext = () =>\n\tReact.useContext(UndoableStoriesContext);\n\nexport const UndoableStoriesContextProvider: React.FC = props => {\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\tconst [state, dispatch] = React.useReducer(reducer, {\n\t\tchanges: [],\n\t\tcurrentChange: -1\n\t});\n\tconst dispatchAndRecordStoryAction = React.useCallback(\n\t\t(action: StoriesActionOrThunk, description?: string) => {\n\t\t\tif (description) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addChange',\n\t\t\t\t\taction,\n\t\t\t\t\tdescription: description,\n\t\t\t\t\tstoriesState: stories\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn storiesDispatch(action);\n\t\t},\n\t\t[stories, storiesDispatch]\n\t);\n\tconst {t} = useTranslation();\n\n\tlet redo: (() => void) | undefined = undefined;\n\tlet redoLabel: string | undefined = undefined;\n\tlet undo: (() => void) | undefined = undefined;\n\tlet undoLabel: string | undefined = undefined;\n\n\tif (state.changes.length > 0) {\n\t\tif (state.currentChange >= 0) {\n\t\t\tundo = () => {\n\t\t\t\tstoriesDispatch(state.changes[state.currentChange].undo);\n\t\t\t\tdispatch({type: 'updateCurrent', change: -1});\n\t\t\t};\n\t\t\tundoLabel = t('common.undoChange', {\n\t\t\t\tchange: t(state.changes[state.currentChange].description)\n\t\t\t});\n\t\t}\n\n\t\tif (state.currentChange < state.changes.length - 1) {\n\t\t\tredo = () => {\n\t\t\t\tstoriesDispatch(state.changes[state.currentChange + 1].redo);\n\t\t\t\tdispatch({type: 'updateCurrent', change: 1});\n\t\t\t};\n\t\t\tredoLabel = t('common.redoChange', {\n\t\t\t\tchange: t(state.changes[state.currentChange + 1].description)\n\t\t\t});\n\t\t}\n\t}\n\n\treturn (\n\t\t<UndoableStoriesContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch: dispatchAndRecordStoryAction,\n\t\t\t\tredo,\n\t\t\t\tredoLabel,\n\t\t\t\tstories,\n\t\t\t\tundo,\n\t\t\t\tundoLabel\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</UndoableStoriesContext.Provider>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {StoryFormat, sortFormats} from '../../store/story-formats';\nimport {TextSelect, TextSelectProps} from '../control/text-select';\n\nexport interface StoryFormatSelectProps\n\textends Omit<TextSelectProps, 'options' | 'value'> {\n\tformats: StoryFormat[];\n\tselectedFormat: StoryFormat;\n}\n\nexport const StoryFormatSelect: React.FC<StoryFormatSelectProps> = props => {\n\tconst {formats, selectedFormat, ...other} = props;\n\tconst {t} = useTranslation();\n\tconst loadingFormats = formats.filter(\n\t\tformat => format.loadState === 'loading'\n\t);\n\tconst visibleFormats = sortFormats(\n\t\tformats.filter(\n\t\t\tformat => format.loadState === 'loaded' || format.id === selectedFormat.id\n\t\t)\n\t);\n\tconst options = visibleFormats.map(format => ({\n\t\tdisabled: false,\n\t\tlabel: `${format.name} ${format.version}`,\n\t\tvalue: format.id\n\t}));\n\n\tif (loadingFormats.length !== 0) {\n\t\toptions.push({\n\t\t\tdisabled: true,\n\t\t\tlabel: t('components.storyFormatSelect.loadingCount', {\n\t\t\t\tloadingCount: loadingFormats.length\n\t\t\t}),\n\t\t\tvalue: ''\n\t\t});\n\t}\n\n\treturn <TextSelect {...other} options={options} value={selectedFormat.id} />;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {storyStats, Story} from '../../store/stories';\nimport './story-stats.css';\n\nconst dateFormatter = new Intl.DateTimeFormat([], {\n\tdateStyle: 'full',\n\ttimeStyle: 'long'\n});\n\nexport interface StoryDetailsDialogStatsProps {\n\tstory: Story;\n}\n\nexport const StoryDetailsDialogStats: React.FC<StoryDetailsDialogStatsProps> = props => {\n\tconst {story} = props;\n\tconst stats = storyStats(story);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"story-stats\">\n\t\t\t<table className=\"counts\">\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.characters}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.characters')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.words}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.words')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.passages}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.passages')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.links.length}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.links')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.brokenLinks.length}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.brokenLinks')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t<div className=\"update-and-ifid\">\n\t\t\t\t<p>\n\t\t\t\t\t{t('dialogs.storyDetails.stats.lastUpdate', {\n\t\t\t\t\t\tdate: dateFormatter.format(story.lastUpdate)\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t\t<p>\n\t\t\t\t\t{t('dialogs.storyDetails.stats.ifid', {ifid: story.ifid})}&nbsp;\n\t\t\t\t\t<a href=\"https://ifdb.org/help-ifid\" target=\"_blank\" rel=\"noreferrer\">\n\t\t\t\t\t\t{t('dialogs.storyDetails.stats.ifidExplanation')}\n\t\t\t\t\t</a>\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {CardContent} from '../../components/container/card';\nimport {DialogCard} from '../../components/container/dialog-card';\nimport {StoryFormatSelect} from '../../components/story-format/story-format-select';\nimport {storyWithId, updateStory, useStoriesContext} from '../../store/stories';\nimport {\n\tformatWithId,\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {FormatLoader} from '../../store/format-loader';\nimport {DialogComponentProps} from '../dialogs.types';\nimport {StoryDetailsDialogStats} from './story-stats';\n\nexport interface StoryDetailsDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryDetailsDialog: React.FC<StoryDetailsDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {formats} = useStoryFormatsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tfunction handleFormatChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst newFormat = formatWithId(formats, event.target.value);\n\n\t\tdispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\tstoryFormat: newFormat.name,\n\t\t\t\tstoryFormatVersion: newFormat.version\n\t\t\t})\n\t\t);\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-details-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={story.name}\n\t\t>\n\t\t\t<div className=\"story-format\">\n\t\t\t\t<FormatLoader block={false} />\n\t\t\t\t<StoryFormatSelect\n\t\t\t\t\tformats={formats}\n\t\t\t\t\tonChange={handleFormatChange}\n\t\t\t\t\tselectedFormat={formatWithNameAndVersion(\n\t\t\t\t\t\tformats,\n\t\t\t\t\t\tstory.storyFormat,\n\t\t\t\t\t\tstory.storyFormatVersion\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t{t('common.storyFormat')}\n\t\t\t\t</StoryFormatSelect>\n\t\t\t\t<a\n\t\t\t\t\thref=\"https://twinery.org/2storyformats\"\n\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\trel=\"noreferrer\"\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.storyDetails.storyFormatExplanation')}\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t\t<ButtonBar>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storyDetails.snapToGrid')}\n\t\t\t\t\tonChange={value =>\n\t\t\t\t\t\tdispatch(updateStory(stories, story, {snapToGrid: value}))\n\t\t\t\t\t}\n\t\t\t\t\tvalue={story.snapToGrid}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t\t<CardContent>\n\t\t\t\t{!other.collapsed && <StoryDetailsDialogStats story={story} />}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {TextInput} from './text-input';\nimport {TextSelect} from './text-select';\nimport './font-select.css';\n\nconst families = ['var(--font-monospaced)', 'var(--font-system)'];\nconst scales = [0.8, 0.9, 1, 1.25, 1.5, 2];\n\nexport interface FontSelectProps {\n\tfamilyLabel: string;\n\tfontFamily: string;\n\tfontScale: number;\n\tonChangeFamily: (value: string) => void;\n\tonChangeScale: (value: number) => void;\n\tscaleLabel: string;\n}\n\nexport const FontSelect: React.FC<FontSelectProps> = props => {\n\tconst {\n\t\tfamilyLabel,\n\t\tfontFamily,\n\t\tfontScale,\n\t\tonChangeFamily,\n\t\tonChangeScale,\n\t\tscaleLabel\n\t} = props;\n\tconst [customScaleVisible, setCustomScaleVisible] = React.useState(\n\t\t!scales.includes(fontScale)\n\t);\n\tconst [customFamilyVisible, setCustomFamilyVisible] = React.useState(\n\t\t!families.includes(fontFamily)\n\t);\n\tconst [customFamily, setCustomFamily] = React.useState(fontFamily);\n\tconst [customScale, setCustomScale] = React.useState(\n\t\t(fontScale * 100).toString()\n\t);\n\tconst {t} = useTranslation();\n\n\tfunction handleFamilyChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tif (event.target.value === 'custom') {\n\t\t\tsetCustomFamilyVisible(true);\n\t\t\tif (families.includes(customFamily)) {\n\t\t\t\tsetCustomFamily('');\n\t\t\t}\n\t\t} else {\n\t\t\tsetCustomFamilyVisible(false);\n\t\t\tonChangeFamily(event.target.value);\n\t\t}\n\t}\n\n\tfunction handleScaleChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tif (event.target.value === 'custom') {\n\t\t\tsetCustomScaleVisible(true);\n\t\t} else {\n\t\t\tsetCustomScaleVisible(false);\n\t\t\tonChangeScale(parseFloat(event.target.value));\n\t\t}\n\t}\n\n\tfunction handleCustomFamilyChange(\n\t\tevent: React.ChangeEvent<HTMLInputElement>\n\t) {\n\t\tsetCustomFamily(event.target.value);\n\n\t\tif (event.target.value.trim() !== '') {\n\t\t\tonChangeFamily(event.target.value);\n\t\t}\n\t}\n\n\tfunction handleCustomScaleChange(event: React.ChangeEvent<HTMLInputElement>) {\n\t\tsetCustomScale(event.target.value);\n\n\t\tconst value = parseInt(event.target.value);\n\n\t\tif (Number.isFinite(value)) {\n\t\t\tonChangeScale(value / 100);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"font-select\">\n\t\t\t<TextSelect\n\t\t\t\tonChange={handleFamilyChange}\n\t\t\t\toptions={[\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('components.fontSelect.fonts.system'),\n\t\t\t\t\t\tvalue: 'var(--font-system)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('components.fontSelect.fonts.monospaced'),\n\t\t\t\t\t\tvalue: 'var(--font-monospaced)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('common.custom'),\n\t\t\t\t\t\tvalue: 'custom'\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tvalue={customFamilyVisible ? 'custom' : fontFamily}\n\t\t\t>\n\t\t\t\t{familyLabel}\n\t\t\t</TextSelect>\n\t\t\t{customFamilyVisible && (\n\t\t\t\t<TextInput\n\t\t\t\t\tonChange={handleCustomFamilyChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t\tvalue={customFamily}\n\t\t\t\t>\n\t\t\t\t\t{t('components.fontSelect.customFamilyDetail')}\n\t\t\t\t</TextInput>\n\t\t\t)}\n\t\t\t<TextSelect\n\t\t\t\tonChange={handleScaleChange}\n\t\t\t\toptions={[\n\t\t\t\t\t...scales.map(scale => ({\n\t\t\t\t\t\tlabel: t('components.fontSelect.percentage', {\n\t\t\t\t\t\t\tpercent: scale * 100\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tvalue: scale.toString()\n\t\t\t\t\t})),\n\t\t\t\t\t{label: t('common.custom'), value: 'custom'}\n\t\t\t\t]}\n\t\t\t\tvalue={customScaleVisible ? 'custom' : fontScale.toString()}\n\t\t\t>\n\t\t\t\t{scaleLabel}\n\t\t\t</TextSelect>\n\t\t\t{customScaleVisible && (\n\t\t\t\t<TextInput\n\t\t\t\t\tonChange={handleCustomScaleChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t\tvalue={customScale}\n\t\t\t\t>\n\t\t\t\t\t{t('components.fontSelect.customScaleDetail')}\n\t\t\t\t</TextInput>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","/**\n * Locales supported in the app.\n * @see https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes\n */\nexport const locales = [\n\t{code: 'ca', name: 'Catal'},\n\t{code: 'cs', name: 'etina'},\n\t{code: 'da', name: 'Dansk'},\n\t{code: 'de', name: 'Deutsch'},\n\t{code: 'en', name: 'English'},\n\t{code: 'es', name: 'Castellano'},\n\t{code: 'fi', name: 'Suomi'},\n\t{code: 'fr', name: 'Franais'},\n\t{code: 'it', name: 'Italiano'},\n\t{code: 'ms', name: 'Bahasa Melayu'},\n\t{code: 'nb', name: 'Norsk bokml'},\n\t{code: 'nl', name: 'Nederlands'},\n\t{code: 'pt-br', name: 'Portugus Brasileiro'},\n\t{code: 'pt-pt', name: 'Portugus'},\n\t{code: 'ru', name: ''},\n\t{code: 'sv', name: 'Svenska'},\n\t{code: 'tr', name: 'Trke'},\n\t{code: 'uk', name: ''},\n\t{code: 'zh-cn', name: '()'}\n];\n\n/**\n * Finds the closest match for a locale in app-supported locales, for example\n * mapping `en-US` to `en`. If none are plausible, this returns `en` as a\n * default.\n */\nexport function closestAppLocale(code: string) {\n\t// Exact match? \n\n\tif (locales.some(locale => locale.code === code)) {\n\t\treturn code;\n\t}\n\n\tif (code.includes('-')) {\n\t\tconst roughCode = code.replace(/-.+/, '');\n\t\tconst roughMatch = locales.find(locale => locale.code === roughCode || locale.code.replace(/-.+/, '') === roughCode);\n\n\t\tif (roughMatch) {\n\t\t\treturn roughMatch.code;\n\t\t}\n\t}\n\n\treturn 'en';\n}","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../components/container/card';\nimport {DialogCard, DialogCardProps} from '../components/container/dialog-card';\nimport {CheckboxButton} from '../components/control/checkbox-button';\nimport {FontSelect} from '../components/control/font-select';\nimport {TextSelect} from '../components/control/text-select';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {closestAppLocale, locales} from '../util/locales';\nimport './app-prefs.css';\n\nexport const AppPrefsDialog: React.FC<\n\tOmit<DialogCardProps, 'headerLabel'>\n> = props => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"app-prefs-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.appPrefs.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e => dispatch(setPref('locale', e.target.value))}\n\t\t\t\t\toptions={locales.map(locale => ({\n\t\t\t\t\t\tlabel: locale.name,\n\t\t\t\t\t\tvalue: locale.code\n\t\t\t\t\t}))}\n\t\t\t\t\tvalue={closestAppLocale(prefs.locale)}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.language')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e => dispatch(setPref('appTheme', e.target.value))}\n\t\t\t\t\toptions={[\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeSystem'), value: 'system'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeLight'), value: 'light'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeDark'), value: 'dark'}\n\t\t\t\t\t]}\n\t\t\t\t\tvalue={prefs.appTheme}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.theme')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e =>\n\t\t\t\t\t\tdispatch(setPref('dialogWidth', parseInt(e.target.value)))\n\t\t\t\t\t}\n\t\t\t\t\toptions={[\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.dialogWidths.default'), value: '600'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.dialogWidths.wider'), value: '700'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.dialogWidths.widest'), value: '800'}\n\t\t\t\t\t]}\n\t\t\t\t\tvalue={prefs.dialogWidth.toString()}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.dialogWidth')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.appPrefs.editorCursorBlinks')}\n\t\t\t\t\tonChange={value => dispatch(setPref('editorCursorBlinks', value))}\n\t\t\t\t\tvalue={prefs.editorCursorBlinks}\n\t\t\t\t/>\n\t\t\t\t<p className=\"font-explanation\">\n\t\t\t\t\t{t('dialogs.appPrefs.fontExplanation')}\n\t\t\t\t</p>\n\t\t\t\t<FontSelect\n\t\t\t\t\tfamilyLabel={t('dialogs.appPrefs.passageEditorFont')}\n\t\t\t\t\tfontFamily={prefs.passageEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.passageEditorFontScale}\n\t\t\t\t\tonChangeFamily={value =>\n\t\t\t\t\t\tdispatch(setPref('passageEditorFontFamily', value))\n\t\t\t\t\t}\n\t\t\t\t\tonChangeScale={value =>\n\t\t\t\t\t\tdispatch(setPref('passageEditorFontScale', value))\n\t\t\t\t\t}\n\t\t\t\t\tscaleLabel={t('dialogs.appPrefs.passageEditorFontScale')}\n\t\t\t\t/>\n\t\t\t\t<FontSelect\n\t\t\t\t\tfamilyLabel={t('dialogs.appPrefs.codeEditorFont')}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tonChangeFamily={value =>\n\t\t\t\t\t\tdispatch(setPref('codeEditorFontFamily', value))\n\t\t\t\t\t}\n\t\t\t\t\tonChangeScale={value =>\n\t\t\t\t\t\tdispatch(setPref('codeEditorFontScale', value))\n\t\t\t\t\t}\n\t\t\t\t\tscaleLabel={t('dialogs.appPrefs.codeEditorFontScale')}\n\t\t\t\t/>\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\nimport {defaults} from './defaults';\nimport {PrefsAction, PrefsContextProps, PrefsState} from './prefs.types';\nimport {reducer} from './reducer';\n\nexport const PrefsContext = React.createContext<PrefsContextProps>({\n\tdispatch: () => {},\n\tprefs: defaults()\n});\n\nPrefsContext.displayName = 'Prefs';\n\nexport const usePrefsContext = () => React.useContext(PrefsContext);\n\nexport const PrefsContextProvider: React.FC = props => {\n\tconst {prefs} = usePersistence();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tPrefsState,\n\t\tPrefsAction\n\t> = React.useCallback(\n\t\t(state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tprefs.saveMiddleware(newState, action);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistPrefs');\n\t\t\t}\n\n\t\t\treturn newState;\n\t\t},\n\t\t[prefs, reportError]\n\t);\n\n\tconst [state, dispatch] = React.useReducer(persistedReducer, defaults());\n\n\treturn (\n\t\t<PrefsContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch,\n\t\t\t\tprefs: state\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</PrefsContext.Provider>\n\t);\n};\n","import {PrefsAction, PrefsState} from './prefs.types';\nimport {defaults} from './defaults';\nimport {formatWithNameAndVersion, newestFormatNamed} from '../story-formats';\n\nexport const reducer: React.Reducer<PrefsState, PrefsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\t\treturn {...state, ...action.state};\n\n\t\tcase 'repair':\n\t\t\tconst defs = defaults();\n\n\t\t\t// Type check values.\n\n\t\t\tlet changes: Partial<PrefsState> = Object.entries(defs).reduce(\n\t\t\t\t(result, [key, value]) => {\n\t\t\t\t\tconst prefKey = key as keyof PrefsState;\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t(typeof value === 'number' && !Number.isFinite(state[prefKey])) ||\n\t\t\t\t\t\ttypeof value !== typeof state[prefKey]\n\t\t\t\t\t) {\n\t\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t\t`Repairing preference \"${key}\" by setting it to ${value}, ` +\n\t\t\t\t\t\t\t\t`was ${state[prefKey]} (bad type)`\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn {...result, [prefKey]: value};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn result;\n\t\t\t\t},\n\t\t\t\t{}\n\t\t\t);\n\n\t\t\t// If the proofing or story format don't match an existing format, repair\n\t\t\t// them to the most recent version with the same name. If none exist with\n\t\t\t// that name, repair to the default.\n\n\t\t\tconst {proofingFormat, storyFormat} = state;\n\t\t\tconst {allFormats} = action;\n\n\t\t\ttry {\n\t\t\t\tformatWithNameAndVersion(\n\t\t\t\t\tallFormats,\n\t\t\t\t\tproofingFormat.name,\n\t\t\t\t\tproofingFormat.version\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\tconst format = newestFormatNamed(allFormats, proofingFormat.name);\n\n\t\t\t\tif (format) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing proofing format preference (version doesn't exist) by setting to ${format.name} ${format.version}, was ${proofingFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.proofingFormat = {name: format.name, version: format.version};\n\t\t\t\t} else {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing proofing format preference (format doesn't exist at all) by setting to default ${defs.proofingFormat.name} ${defs.proofingFormat.version}, was ${proofingFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.proofingFormat = {\n\t\t\t\t\t\tname: defs.proofingFormat.name,\n\t\t\t\t\t\tversion: defs.proofingFormat.version\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tformatWithNameAndVersion(\n\t\t\t\t\tallFormats,\n\t\t\t\t\tstoryFormat.name,\n\t\t\t\t\tstoryFormat.version\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\tconst format = newestFormatNamed(allFormats, storyFormat.name);\n\n\t\t\t\tif (format) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story format preference (version doesn't exist) by setting to ${format.name} ${format.version}, was ${storyFormat.name} ${storyFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.storyFormat = {name: format.name, version: format.version};\n\t\t\t\t} else {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story format preference (format doesn't exist at all) by setting to default ${defs.storyFormat.name} ${defs.storyFormat.version}, was ${storyFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.storyFormat = {\n\t\t\t\t\t\tname: defs.storyFormat.name,\n\t\t\t\t\t\tversion: defs.storyFormat.version\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {...state, ...changes};\n\n\t\tcase 'update': {\n\t\t\treturn {...state, [action.name]: action.value};\n\t\t}\n\t}\n};\n","import uuid from 'tiny-uuid';\nimport * as React from 'react';\nimport useThunkReducer from 'react-hook-thunk-reducer';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {builtins} from './defaults';\nimport {\n\tStoryFormat,\n\tStoryFormatsAction,\n\tStoryFormatsContextProps,\n\tStoryFormatsState\n} from './story-formats.types';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\nimport {reducer} from './reducer';\n\nconst defaultBuiltins: StoryFormat[] = builtins().map(f => ({\n\t...f,\n\tid: uuid(),\n\tloadState: 'unloaded',\n\tselected: false,\n\tuserAdded: false\n}));\n\nexport const StoryFormatsContext = React.createContext<StoryFormatsContextProps>(\n\t{\n\t\tdispatch: () => {},\n\t\tformats: []\n\t}\n);\n\nStoryFormatsContext.displayName = 'StoryFormats';\n\nexport const useStoryFormatsContext = () =>\n\tReact.useContext(StoryFormatsContext);\n\nexport const StoryFormatsContextProvider: React.FC = props => {\n\tconst {storyFormats} = usePersistence();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tStoryFormatsState,\n\t\tStoryFormatsAction\n\t> = React.useCallback(\n\t\t(state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tstoryFormats.saveMiddleware(newState, action);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistStoryFormats');\n\t\t\t}\n\t\t\treturn newState;\n\t\t},\n\t\t[reportError, storyFormats]\n\t);\n\n\tconst [state, dispatch] = useThunkReducer(persistedReducer, defaultBuiltins);\n\n\treturn (\n\t\t<StoryFormatsContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch,\n\t\t\t\tformats: state\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</StoryFormatsContext.Provider>\n\t);\n};\n","import uuid from 'tiny-uuid';\nimport {builtins} from './defaults';\nimport {\n\tStoryFormat,\n\tStoryFormatsAction,\n\tStoryFormatsState\n} from './story-formats.types';\n\nexport const reducer: React.Reducer<StoryFormatsState, StoryFormatsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\t\treturn [...action.state];\n\n\t\tcase 'repair':\n\t\t\tconst builtinFormats = builtins();\n\n\t\t\t// Filter out any outdated builtins.\n\n\t\t\tconst result = state.filter(format => {\n\t\t\t\tconst keep =\n\t\t\t\t\tformat.userAdded ||\n\t\t\t\t\tbuiltinFormats.some(\n\t\t\t\t\t\tf => f.name === format.name && f.version === format.version\n\t\t\t\t\t);\n\n\t\t\t\tif (!keep) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story formats by removing ${format.name} ${format.version} ` +\n\t\t\t\t\t\t\t`(outdated version of built-in format)`\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\treturn keep;\n\t\t\t});\n\n\t\t\t// Add any builtins not present.\n\n\t\t\tbuiltinFormats.forEach(builtinFormat => {\n\t\t\t\tif (\n\t\t\t\t\t!result.some(\n\t\t\t\t\t\tf =>\n\t\t\t\t\t\t\tf.name === builtinFormat.name &&\n\t\t\t\t\t\t\tf.version === builtinFormat.version\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story formats by adding built-in ${builtinFormat.name} ${builtinFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tresult.push({\n\t\t\t\t\t\t...builtinFormat,\n\t\t\t\t\t\tid: uuid(),\n\t\t\t\t\t\tloadState: 'unloaded',\n\t\t\t\t\t\tselected: false,\n\t\t\t\t\t\tuserAdded: false\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn result;\n\n\t\tcase 'create':\n\t\t\tif (\n\t\t\t\tstate.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.name === action.props.name &&\n\t\t\t\t\t\tformat.version === action.props.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\treturn [...state, {...action.props, id: uuid(), loadState: 'unloaded'}];\n\n\t\tcase 'delete':\n\t\t\treturn state.filter(f => f.id !== action.id);\n\n\t\tcase 'update':\n\t\t\tif (\n\t\t\t\tstate.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.id !== action.id &&\n\t\t\t\t\t\tformat.name === action.props.name &&\n\t\t\t\t\t\tformat.version === action.props.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\treturn state.map(format => {\n\t\t\t\tif (format.id !== action.id) {\n\t\t\t\t\treturn format;\n\t\t\t\t}\n\n\t\t\t\treturn {...format, ...action.props} as StoryFormat;\n\t\t\t});\n\t}\n\n\treturn state;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconCode, IconHeart} from '@tabler/icons';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {DialogCard} from '../../components/container/dialog-card';\nimport {IconLink} from '../../components/control/icon-link';\nimport {getAppInfo} from '../../util/app-info';\nimport {DialogComponentProps} from '../dialogs.types';\nimport credits from './credits.json';\nimport './about-twine.css';\n\nexport const AboutTwineDialog: React.FC<DialogComponentProps> = props => {\n\tconst {t} = useTranslation();\n\tconst info = getAppInfo();\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"about-twine-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.aboutTwine.title', {\n\t\t\t\tversion: info.version\n\t\t\t})}\n\t\t>\n\t\t\t<div className=\"content\">\n\t\t\t\t<p>{t('dialogs.aboutTwine.twineDescription')}</p>\n\t\t\t\t<p\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: t('dialogs.aboutTwine.license')\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t\t<div className=\"credits\">\n\t\t\t\t\t<div className=\"code\">\n\t\t\t\t\t\t<h3>{t('dialogs.aboutTwine.codeHeader')}</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t{credits.code.map(c => (\n\t\t\t\t\t\t\t\t<li key={c}>{c}</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"localizations\">\n\t\t\t\t\t\t<h3>{t('dialogs.aboutTwine.localizationHeader')}</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t{credits.localizations.map(c => (\n\t\t\t\t\t\t\t\t<li key={c}>{c}</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://twinery.org/donate\"\n\t\t\t\t\t\ticon={<IconHeart />}\n\t\t\t\t\t\tlabel={t('dialogs.aboutTwine.donateToTwine')}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://github.com/klembot/twinejs\"\n\t\t\t\t\t\ticon={<IconCode />}\n\t\t\t\t\t\tlabel={t('dialogs.aboutTwine.codeRepo')}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</div>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {IconLoading} from '../image/icon';\nimport './loading-curtain.css';\n\nexport const LoadingCurtain: React.FC = () => (\n\t<div className=\"loading-curtain\">\n\t\t<IconLoading />\n\t</div>\n);\n","// Listens to changes in the locale preference and changes i18n's language\n// accordingly.\n\nimport * as React from 'react';\nimport {usePrefsContext} from './prefs';\nimport {i18n} from '../util/i18n';\n\nexport const LocaleSwitcher: React.FC = () => {\n\tconst {prefs} = usePrefsContext();\n\n\tReact.useEffect(() => {\n\t\ti18n.changeLanguage(prefs.locale);\n\t}, [prefs.locale]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport 'element-closest';\n\nexport interface ClickAwayListenerProps {\n\tignoreSelector?: string;\n\tonClickAway: () => void;\n}\n\nexport const ClickAwayListener: React.FC<ClickAwayListenerProps> = props => {\n\tconst {children, ignoreSelector, onClickAway} = props;\n\tconst handleClick: React.MouseEventHandler = event => {\n\t\tif (ignoreSelector) {\n\t\t\tif (!(event.target as HTMLElement)?.closest(ignoreSelector)) {\n\t\t\t\tonClickAway();\n\t\t\t}\n\t\t} else {\n\t\t\tonClickAway();\n\t\t}\n\t};\n\n\treturn <div onClick={handleClick}>{children}</div>;\n};\n","import * as React from 'react';\nimport './card-group.css';\n\nexport type CardGroupProps =\n\t| {columns: number; maxWidth?: string}\n\t| {columnWidth: number | string; maxWidth?: string};\n\nexport const CardGroup: React.FC<CardGroupProps> = props => {\n\tconst style: React.CSSProperties = {\n\t\tgridTemplateColumns:\n\t\t\t'columnWidth' in props\n\t\t\t\t? `repeat(auto-fit, ${\n\t\t\t\t\t\ttypeof props.columnWidth === 'number'\n\t\t\t\t\t\t\t? props.columnWidth + 'px'\n\t\t\t\t\t\t\t: props.columnWidth\n\t\t\t\t  })`\n\t\t\t\t: `repeat(${props.columns}, 1fr)`,\n\t\tmaxWidth: props.maxWidth ?? 'auto'\n\t};\n\n\treturn (\n\t\t<div className=\"card-group\" style={style}>\n\t\t\t{props.children}\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {Helmet} from 'react-helmet';\nimport {isElectronRenderer} from '../../util/is-electron';\n\nexport interface DocumentTitleProps {\n\ttitle: string;\n}\n\n/**\n * Sets the document title. This works around a bug with Electron and may not be\n * needed in later versions.\n */\nexport const DocumentTitle: React.FC<DocumentTitleProps> = ({title}) => {\n\t// Using `history.goBack()` doesn't seem to cause Electron to update the\n\t// window title bar--possibly tied to using a <HashRouter>. If it does in a\n\t// future version, we can just use react-helmet directly.\n\n\tReact.useEffect(() => {\n\t\tif (isElectronRenderer()) {\n\t\t\tconst timeout = window.setTimeout(() => {\n\t\t\t\tdocument.querySelector('title')!.innerHTML = title;\n\t\t\t}, 0);\n\n\t\t\treturn () => window.clearTimeout(timeout);\n\t\t}\n\t}, [title]);\n\n\treturn (\n\t\t<Helmet>\n\t\t\t<title>{title}</title>\n\t\t</Helmet>\n\t);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport {Point} from '../../util/geometry';\nimport {DocumentTitle} from '../document-title/document-title';\nimport './main-content.css';\n\nexport interface MainContentProps\n\textends React.ComponentPropsWithoutRef<'div'> {\n\tgrabbable?: boolean;\n\tpadded?: boolean;\n\ttitle?: string;\n}\n\nexport const MainContent = React.forwardRef<HTMLDivElement, MainContentProps>(\n\t(props, ref) => {\n\t\tconst {children, grabbable, title} = props;\n\t\tconst containerRef = React.useRef<HTMLDivElement>(null);\n\t\tconst className = classNames('main-content', {\n\t\t\tpadded: props.padded ?? true\n\t\t});\n\n\t\tReact.useImperativeHandle(\n\t\t\tref,\n\t\t\t() => containerRef.current as HTMLDivElement\n\t\t);\n\n\t\tReact.useEffect(() => {\n\t\t\tif (containerRef.current) {\n\t\t\t\tcontainerRef.current.focus();\n\t\t\t}\n\t\t}, []);\n\n\t\tReact.useEffect(() => {\n\t\t\tconst container = containerRef.current;\n\t\t\tlet dragScrollStart: Point;\n\t\t\tlet dragMouseStart: Point;\n\n\t\t\tfunction moveListener(event: PointerEvent) {\n\t\t\t\tif (container) {\n\t\t\t\t\tcontainer.scrollLeft =\n\t\t\t\t\t\tdragScrollStart.left + (dragMouseStart.left - event.clientX);\n\t\t\t\t\tcontainer.scrollTop =\n\t\t\t\t\t\tdragScrollStart.top + (dragMouseStart.top - event.clientY);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction stopGrab(event: PointerEvent) {\n\t\t\t\tif (!container) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcontainer.releasePointerCapture(event.pointerId);\n\t\t\t\tcontainer.removeEventListener('pointerleave', stopGrab);\n\t\t\t\tcontainer.removeEventListener('pointermove', moveListener);\n\t\t\t\tcontainer.style.cursor = '';\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tfunction upListener(event: PointerEvent) {\n\t\t\t\tif (event.button === 2) {\n\t\t\t\t\tstopGrab(event);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction downListener(event: PointerEvent) {\n\t\t\t\tif (event.button !== 2 || !container) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcontainer.setPointerCapture(event.pointerId);\n\t\t\t\tcontainer.addEventListener('pointerleave', stopGrab);\n\t\t\t\tcontainer.addEventListener('pointermove', moveListener);\n\t\t\t\tcontainer.addEventListener('pointerup', upListener);\n\t\t\t\tcontainer.style.cursor = 'grabbing';\n\t\t\t\tdragScrollStart = {\n\t\t\t\t\tleft: container.scrollLeft,\n\t\t\t\t\ttop: container.scrollTop\n\t\t\t\t};\n\t\t\t\tdragMouseStart = {left: event.clientX, top: event.clientY};\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tfunction ignoreContext(event: Event) {\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tif (grabbable && container) {\n\t\t\t\tcontainer.addEventListener('pointerdown', downListener);\n\t\t\t\tcontainer.addEventListener('contextmenu', ignoreContext);\n\t\t\t\treturn () => {\n\t\t\t\t\tcontainer.removeEventListener('pointerdown', downListener);\n\t\t\t\t\tcontainer.removeEventListener('contextmenu', ignoreContext);\n\t\t\t\t};\n\t\t\t}\n\t\t}, [grabbable]);\n\n\t\treturn (\n\t\t\t<div className={className} ref={containerRef}>\n\t\t\t\t{title && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<DocumentTitle title={title} />\n\t\t\t\t\t\t<h1>{title}</h1>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t\t{children}\n\t\t\t</div>\n\t\t);\n\t}\n);\n","import * as React from 'react';\nimport './badge.css';\n\nexport interface BadgeProps {\n\tlabel: string;\n}\n\nexport const Badge: React.FC<BadgeProps> = ({label}) => (\n\t<span className=\"badge\">{label}</span>\n);\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport {Card, CardProps} from './card';\nimport './selectable-card.css';\n\nexport interface SelectableCardProps extends CardProps {\n\tlabel: string;\n\tonDoubleClick?: React.MouseEventHandler;\n\tonSelect: (value: boolean, exclusive: boolean) => void;\n\tselected?: boolean;\n}\n\nexport const SelectableCard: React.FC<SelectableCardProps> = props => {\n\tconst {label, onDoubleClick, onSelect, selected, ...other} = props;\n\tconst onClick = React.useCallback(\n\t\t(event: React.MouseEvent) => {\n\t\t\tif (event.ctrlKey || event.shiftKey) {\n\t\t\t\tonSelect(!selected, false);\n\t\t\t} else {\n\t\t\t\tonSelect(true, true);\n\t\t\t}\n\t\t},\n\t\t[onSelect, selected]\n\t);\n\tconst onKeyDown = React.useCallback(\n\t\t(event: React.KeyboardEvent) => {\n\t\t\tif (event.key === ' ' || event.key === 'Enter') {\n\t\t\t\tevent.preventDefault();\n\n\t\t\t\tif (event.ctrlKey || event.shiftKey) {\n\t\t\t\t\tonSelect(!selected, false);\n\t\t\t\t} else {\n\t\t\t\t\tonSelect(true, true);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t[onSelect, selected]\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tclassName={classNames('selectable-card', {selected})}\n\t\t\trole=\"button\"\n\t\t\taria-label={label}\n\t\t\taria-pressed={selected}\n\t\t\tonClick={onClick}\n\t\t\tonDoubleClick={onDoubleClick}\n\t\t\tonKeyDown={onKeyDown}\n\t\t\ttabIndex={0}\n\t\t>\n\t\t\t<Card {...other} />\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {StoryFormat} from '../../../store/story-formats';\n\nexport interface StoryFormatCardDetailsProps {\n\tformat: StoryFormat;\n}\n\nexport const StoryFormatCardDetails: React.FC<StoryFormatCardDetailsProps> = ({\n\tformat\n}) => {\n\tconst {t} = useTranslation();\n\n\tif (format.loadState === 'unloaded' || format.loadState === 'loading') {\n\t\treturn (\n\t\t\t<div className=\"story-format-card-details\">\n\t\t\t\t<p>{t('components.storyFormatCard.loadingFormat')}</p>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tif (format.loadState === 'error') {\n\t\treturn (\n\t\t\t<div className=\"story-format-card-details\">\n\t\t\t\t<p>\n\t\t\t\t\t{t('components.storyFormatCard.loadError', {\n\t\t\t\t\t\terrorMessage: format.loadError.message\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t);\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-card-details\">\n\t\t\t{format.properties.author && (\n\t\t\t\t<p\n\t\t\t\t\tclassName=\"story-format-card-author\"\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: t('components.storyFormatCard.author', {\n\t\t\t\t\t\t\tauthor: format.properties.author\n\t\t\t\t\t\t})\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t{format.properties.description && (\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"story-format-card-description\"\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: format.properties.description\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t{format.properties.license && (\n\t\t\t\t<p className=\"story-format-card-license\">\n\t\t\t\t\t{t('components.storyFormatCard.license', {\n\t\t\t\t\t\tlicense: format.properties.license\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","import {IconAlertTriangle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {formatImageUrl, StoryFormat} from '../../../store/story-formats';\nimport {Badge} from '../../badge/badge';\nimport {CardContent} from '../../container/card';\nimport {SelectableCard} from '../../container/card/selectable-card';\nimport {IconLoading} from '../../image/icon';\nimport {StoryFormatCardDetails} from './story-format-card-details';\nimport './story-format-card.css';\n\nexport interface StoryFormatCardProps {\n\tdefaultFormat: boolean;\n\teditorExtensionsDisabled: boolean;\n\tformat: StoryFormat;\n\tonSelect: () => void;\n\tproofingFormat: boolean;\n}\n\nexport const StoryFormatCard: React.FC<StoryFormatCardProps> = props => {\n\tconst {\n\t\tdefaultFormat,\n\t\teditorExtensionsDisabled,\n\t\tformat,\n\t\tonSelect,\n\t\tproofingFormat\n\t} = props;\n\tconst {t} = useTranslation();\n\n\tlet image = <></>;\n\n\tif (format.loadState === 'error') {\n\t\timage = <IconAlertTriangle />;\n\t} else if (\n\t\tformat.loadState === 'unloaded' ||\n\t\tformat.loadState === 'loading'\n\t) {\n\t\timage = <IconLoading />;\n\t} else if (format.loadState === 'loaded' && format.properties.image) {\n\t\timage = <img src={formatImageUrl(format)} alt=\"\" />;\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-card\">\n\t\t\t<SelectableCard\n\t\t\t\tlabel={t('components.storyFormatCard.name', {\n\t\t\t\t\tname: format.name,\n\t\t\t\t\tversion: format.version\n\t\t\t\t})}\n\t\t\t\tonSelect={onSelect}\n\t\t\t\tselected={format.selected}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<div className=\"story-format-image\">{image}</div>\n\t\t\t\t\t<div className=\"story-format-description\">\n\t\t\t\t\t\t<h2>\n\t\t\t\t\t\t\t{t('components.storyFormatCard.name', {\n\t\t\t\t\t\t\t\tname: format.name,\n\t\t\t\t\t\t\t\tversion: format.version\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<StoryFormatCardDetails format={format} />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"story-format-badges\">\n\t\t\t\t\t\t{!format.userAdded && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.builtIn')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{defaultFormat && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.defaultFormat')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{editorExtensionsDisabled && (\n\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\tlabel={t('components.storyFormatCard.editorExtensionsDisabled')}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{format.loadState === 'loaded' && format.properties.proofing && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.proofing')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{proofingFormat && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.proofingFormat')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</CardContent>\n\t\t\t</SelectableCard>\n\t\t</div>\n\t);\n};\n","import {IconArrowLeft} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconButton} from '../control/icon-button';\n\nexport const BackButton: React.FC = () => {\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\tif (['/', '/stories'].includes(history.location.pathname)) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconArrowLeft />}\n\t\t\tvariant=\"primary\"\n\t\t\tlabel={\n\t\t\t\thistory.length > 1\n\t\t\t\t\t? t('common.back')\n\t\t\t\t\t: t('routes.storyList.titleGeneric')\n\t\t\t}\n\t\t\tonClick={() =>\n\t\t\t\thistory.length > 1 ? history.goBack() : history.push('/')\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconHelp} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {Tab, TabList, TabPanel, Tabs} from 'react-tabs';\nimport {IconButton} from '../control/icon-button';\nimport {BackButton} from './back-button';\nimport './route-toolbar.css';\n\nexport interface RouteToolbarProps {\n\thelpUrl?: string;\n\tpinnedControls?: React.ReactNode;\n\ttabs: Record<string, React.ReactNode>;\n}\n\nexport const RouteToolbar: React.FC<RouteToolbarProps> = props => {\n\tconst {helpUrl = 'https://twinery.org/2guide', pinnedControls, tabs} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"route-toolbar\">\n\t\t\t<Tabs selectedTabClassName=\"selected\">\n\t\t\t\t<div className=\"route-toolbar-top\">\n\t\t\t\t\t<BackButton />\n\t\t\t\t\t<TabList className=\"route-toolbar-tablist\">\n\t\t\t\t\t\t{Object.keys(tabs).map(tabName => (\n\t\t\t\t\t\t\t<Tab className=\"route-toolbar-tab\" key={tabName}>\n\t\t\t\t\t\t\t\t{tabName}\n\t\t\t\t\t\t\t</Tab>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</TabList>\n\t\t\t\t\t<div className=\"route-toolbar-pinned-controls\">\n\t\t\t\t\t\t{pinnedControls}\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconHelp />}\n\t\t\t\t\t\t\tlabel={t('common.help')}\n\t\t\t\t\t\t\tonClick={() => window.open(helpUrl, '_blank')}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div>\n\t\t\t\t\t{Object.entries(tabs).map(([tabName, tabContent]) => (\n\t\t\t\t\t\t<TabPanel key={tabName}>{tabContent}</TabPanel>\n\t\t\t\t\t))}\n\t\t\t\t</div>\n\t\t\t</Tabs>\n\t\t</div>\n\t);\n};\n","import {saveAs} from 'file-saver';\n\n/**\n * Saves text to an HTML file. This works in either a browser or Electron\n * context.\n */\nexport function saveHtml(source: string, filename: string) {\n\tconst data = new Blob([source], {type: 'text/html;charset=utf-8'});\n\n\tsaveAs(data, filename);\n}\n\n/**\n * Saves text to a Twee file. This works in either a browser or Electron\n * context.\n */\nexport function saveTwee(source: string, filename: string) {\n\tconst data = new Blob([source], {type: 'text/plain;charset=utf-8'});\n\n\tsaveAs(data, filename);\n}\n","import {\n\tIconEyeglass,\n\tIconFileText,\n\tIconPlayerPlay,\n\tIconTool,\n\tIconX\n} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next/';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {CardContent} from '../components/container/card';\nimport {CardButton} from '../components/control/card-button';\nimport {IconButton} from '../components/control/icon-button';\nimport {IconFileTwee} from '../components/image/icon';\nimport {storyFileName} from '../electron/shared';\nimport {Story} from '../store/stories';\nimport {usePublishing} from '../store/use-publishing';\nimport {useStoryLaunch} from '../store/use-story-launch';\nimport {saveHtml, saveTwee} from '../util/save-file';\nimport {storyToTwee} from '../util/twee';\n\nexport interface BuildActionsProps {\n\tstory?: Story;\n}\n\nexport const BuildActions: React.FC<BuildActionsProps> = ({story}) => {\n\tconst {publishStory} = usePublishing();\n\tconst [playError, setPlayError] = React.useState<Error>();\n\tconst [proofError, setProofError] = React.useState<Error>();\n\tconst [publishError, setPublishError] = React.useState<Error>();\n\tconst [testError, setTestError] = React.useState<Error>();\n\tconst {playStory, proofStory, testStory} = useStoryLaunch();\n\tconst {t} = useTranslation();\n\n\tfunction resetErrors() {\n\t\tsetPlayError(undefined);\n\t\tsetProofError(undefined);\n\t\tsetPublishError(undefined);\n\t\tsetTestError(undefined);\n\t}\n\n\tasync function handlePlay() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tresetErrors();\n\n\t\ttry {\n\t\t\tawait playStory(story.id);\n\t\t} catch (error) {\n\t\t\tsetPlayError(error as Error);\n\t\t}\n\t}\n\n\tasync function handleProof() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tresetErrors();\n\n\t\ttry {\n\t\t\tawait proofStory(story.id);\n\t\t} catch (error) {\n\t\t\tsetProofError(error as Error);\n\t\t}\n\t}\n\n\tasync function handlePublishFile() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tresetErrors();\n\n\t\ttry {\n\t\t\tsaveHtml(await publishStory(story.id), storyFileName(story));\n\t\t} catch (error) {\n\t\t\tsetPublishError(error as Error);\n\t\t}\n\t}\n\n\tasync function handleTest() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tresetErrors();\n\n\t\ttry {\n\t\t\tawait testStory(story.id);\n\t\t} catch (error) {\n\t\t\tsetTestError(error as Error);\n\t\t}\n\t}\n\n\tfunction handleExportAsTwee() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to export');\n\t\t}\n\n\t\tsaveTwee(storyToTwee(story), storyFileName(story, '.twee'));\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CardButton\n\t\t\t\tariaLabel={testError?.message ?? ''}\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconTool />}\n\t\t\t\tlabel={t('routeActions.build.test')}\n\t\t\t\tonChangeOpen={() => setTestError(undefined)}\n\t\t\t\tonClick={handleTest}\n\t\t\t\topen={!!testError}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<p>{testError?.message}</p>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\tonClick={() => setTestError(undefined)}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n\t\t\t<CardButton\n\t\t\t\tariaLabel={playError?.message ?? ''}\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconPlayerPlay />}\n\t\t\t\tlabel={t('routeActions.build.play')}\n\t\t\t\tonChangeOpen={() => setPlayError(undefined)}\n\t\t\t\tonClick={handlePlay}\n\t\t\t\topen={!!playError}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<p>{playError?.message}</p>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\tonClick={() => setPlayError(undefined)}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n\t\t\t<CardButton\n\t\t\t\tariaLabel={proofError?.message ?? ''}\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconEyeglass />}\n\t\t\t\tlabel={t('routeActions.build.proof')}\n\t\t\t\tonChangeOpen={() => setProofError(undefined)}\n\t\t\t\tonClick={handleProof}\n\t\t\t\topen={!!proofError}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<p>{proofError?.message}</p>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\tonClick={() => setProofError(undefined)}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n\t\t\t<CardButton\n\t\t\t\tariaLabel={publishError?.message ?? ''}\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconFileText />}\n\t\t\t\tlabel={t('routeActions.build.publishToFile')}\n\t\t\t\tonChangeOpen={() => setPublishError(undefined)}\n\t\t\t\tonClick={handlePublishFile}\n\t\t\t\topen={!!publishError}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<p>{publishError?.message}</p>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\tonClick={() => setPublishError(undefined)}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t</CardContent>\n\t\t\t</CardButton>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconFileTwee />}\n\t\t\t\tlabel={t('routeActions.build.exportAsTwee')}\n\t\t\t\tonClick={handleExportAsTwee}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import {IconAward, IconBug, IconFileCode, IconSettings} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {IconButton} from '../components/control/icon-button';\nimport {AboutTwineDialog, AppPrefsDialog, useDialogsContext} from '../dialogs';\n\nexport const AppActions: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconSettings />}\n\t\t\t\tlabel={t('routeActions.app.preferences')}\n\t\t\t\tonClick={() => dispatch({type: 'addDialog', component: AppPrefsDialog})}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={history.location.pathname === '/story-formats'}\n\t\t\t\ticon={<IconFileCode />}\n\t\t\t\tlabel={t('routeActions.app.storyFormats')}\n\t\t\t\tonClick={() => history.push('/story-formats')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconAward />}\n\t\t\t\tlabel={t('routeActions.app.aboutApp')}\n\t\t\t\tonClick={() =>\n\t\t\t\t\tdispatch({type: 'addDialog', component: AboutTwineDialog})\n\t\t\t\t}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconBug />}\n\t\t\t\tlabel={t('routeActions.app.reportBug')}\n\t\t\t\tonClick={() => window.open('https://twinery.org/2bugs', '_blank')}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {\n\tcreateFromProperties,\n\tuseStoryFormatsContext\n} from '../../../../store/story-formats';\nimport {\n\tPromptButton,\n\tPromptButtonValidator\n} from '../../../../components/control/prompt-button';\nimport {fetchStoryFormatProperties} from '../../../../util/story-format';\nimport './add-story-format-button.css';\n\nfunction isValidUrl(value: string) {\n\ttry {\n\t\tnew URL(value);\n\t\treturn true;\n\t} catch (e) {}\n\n\treturn false;\n}\n\nexport const AddStoryFormatButton: React.FC = () => {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst [newFormatUrl, setNewFormatUrl] = React.useState('');\n\tconst {t} = useTranslation();\n\n\tasync function handleSubmit() {\n\t\tdispatch(\n\t\t\tcreateFromProperties(\n\t\t\t\tnewFormatUrl,\n\t\t\t\tawait fetchStoryFormatProperties(newFormatUrl)\n\t\t\t)\n\t\t);\n\t}\n\n\tconst validate: PromptButtonValidator = async (value: string) => {\n\t\tif (newFormatUrl.trim() === '') {\n\t\t\treturn {valid: false};\n\t\t}\n\n\t\tif (!isValidUrl(newFormatUrl)) {\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.invalidUrl'\n\t\t\t\t),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\ttry {\n\t\t\tconst properties = await fetchStoryFormatProperties(newFormatUrl);\n\n\t\t\tif (\n\t\t\t\tformats.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.name === properties.name &&\n\t\t\t\t\t\tformat.version === properties.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn {\n\t\t\t\t\tmessage: t(\n\t\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.alreadyAdded',\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstoryFormatName: properties.name,\n\t\t\t\t\t\t\tstoryFormatVersion: properties.version\n\t\t\t\t\t\t}\n\t\t\t\t\t),\n\t\t\t\t\tvalid: false\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.addPreview',\n\t\t\t\t\t{\n\t\t\t\t\t\tstoryFormatName: properties.name,\n\t\t\t\t\t\tstoryFormatVersion: properties.version\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tvalid: true\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.fetchError',\n\t\t\t\t\t{\n\t\t\t\t\t\terrorMessage: error.message\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\t};\n\n\treturn (\n\t\t<span className=\"add-format-button\">\n\t\t\t<PromptButton\n\t\t\t\ticon={<IconPlus />}\n\t\t\t\tlabel={t('common.add')}\n\t\t\t\tonChange={event => setNewFormatUrl(event.target.value)}\n\t\t\t\tonSubmit={handleSubmit}\n\t\t\t\tprompt={t('routes.storyFormatList.toolbar.addStoryFormatButton.prompt')}\n\t\t\t\tsubmitIcon={<IconPlus />}\n\t\t\t\tsubmitLabel={t('common.add')}\n\t\t\t\tsubmitVariant=\"create\"\n\t\t\t\tvalidate={validate}\n\t\t\t\tvalue={newFormatUrl}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import {IconStar} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface DefaultStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const DefaultStoryFormatButton: React.FC<DefaultStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst disabled =\n\t\tformat?.loadState !== 'loaded' ||\n\t\tformat.properties.proofing ||\n\t\t(prefs.storyFormat.name === format.name &&\n\t\t\tprefs.storyFormat.version === format.version);\n\tconst handleClick: React.MouseEventHandler = () => {\n\t\tif (!format) {\n\t\t\tthrow new Error(\"Can't set undefined format as default\");\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tname: 'storyFormat',\n\t\t\tvalue: {name: format.name, version: format.version}\n\t\t});\n\t};\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconStar />}\n\t\t\tlabel={t('routes.storyFormatList.toolbar.useAsDefaultFormat')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEye} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface ProofingStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const ProofingStoryFormatButton: React.FC<ProofingStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst disabled =\n\t\tformat?.loadState !== 'loaded' ||\n\t\t!format.properties.proofing ||\n\t\t(prefs.proofingFormat.name === format.name &&\n\t\t\tprefs.proofingFormat.version === format.version);\n\tconst handleClick: React.MouseEventHandler = () => {\n\t\tif (!format) {\n\t\t\tthrow new Error(\"Can't set undefined format as proofing\");\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tname: 'proofingFormat',\n\t\t\tvalue: {name: format.name, version: format.version}\n\t\t});\n\t};\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconEye />}\n\t\t\tlabel={t('routes.storyFormatList.toolbar.useAsProofingFormat')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {\n\tdeleteFormat,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from '../../../../store/story-formats';\n\nexport interface RemoveStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const RemoveStoryFormatButton: React.FC<RemoveStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch} = useStoryFormatsContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst isDefault =\n\t\tformat?.name === prefs.storyFormat.name &&\n\t\tformat?.version === prefs.storyFormat.version;\n\tconst isProofing =\n\t\tformat?.name === prefs.proofingFormat.name &&\n\t\tformat?.version === prefs.proofingFormat.version;\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!format || !format.userAdded || isDefault || isProofing}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={t('common.remove')}\n\t\t\tonClick={() => format && dispatch(deleteFormat(format))}\n\t\t/>\n\t);\n};\n","import {IconPuzzle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface StoryFormatExtensionsButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const StoryFormatExtensionsButton: React.FC<StoryFormatExtensionsButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst extensionsDisabled = prefs.disabledStoryFormatEditorExtensions.some(\n\t\tother => other.name === format?.name && other.version === format?.version\n\t);\n\n\tfunction handleClick() {\n\t\tif (!format) {\n\t\t\tthrow new Error('Format is not set');\n\t\t}\n\n\t\t// This logic is a little backwards--the user is setting whether to use the\n\t\t// extensions but our preferences track disabled ones.\n\n\t\tif (extensionsDisabled) {\n\t\t\tdispatch(\n\t\t\t\tsetPref(\n\t\t\t\t\t'disabledStoryFormatEditorExtensions',\n\t\t\t\t\tprefs.disabledStoryFormatEditorExtensions.filter(\n\t\t\t\t\t\tf => f.name !== format.name || f.version !== format.version\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\t\t} else {\n\t\t\tdispatch(\n\t\t\t\tsetPref('disabledStoryFormatEditorExtensions', [\n\t\t\t\t\t...prefs.disabledStoryFormatEditorExtensions,\n\t\t\t\t\t{name: format.name, version: format.version}\n\t\t\t\t])\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!format}\n\t\t\ticon={<IconPuzzle />}\n\t\t\tlabel={t(\n\t\t\t\t`routes.storyFormatList.toolbar.${\n\t\t\t\t\textensionsDisabled ? 'enable' : 'disable'\n\t\t\t\t}FormatExtensions`\n\t\t\t)}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {StoryFormat} from '../../../../store/story-formats';\nimport {AddStoryFormatButton} from './add-story-format-button';\nimport {DefaultStoryFormatButton} from './default-story-format-button';\nimport {ProofingStoryFormatButton} from './proofing-story-format-button';\nimport {RemoveStoryFormatButton} from './remove-story-format-button';\nimport {StoryFormatExtensionsButton} from './story-format-extensions-button';\n\nexport interface FormatActionsProps {\n\tselectedFormats: StoryFormat[];\n}\n\nexport const FormatActions: React.FC<FormatActionsProps> = props => {\n\tconst {selectedFormats} = props;\n\tconst format = selectedFormats.length === 1 ? selectedFormats[0] : undefined;\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<AddStoryFormatButton />\n\t\t\t<RemoveStoryFormatButton format={format} />\n\t\t\t<StoryFormatExtensionsButton format={format} />\n\t\t\t<DefaultStoryFormatButton format={format} />\n\t\t\t<ProofingStoryFormatButton format={format} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../../components/control/checkbox-button';\nimport {setPref, usePrefsContext} from '../../../store/prefs';\n\nexport const ViewActions: React.FC = () => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tfunction setFilter(name: string) {\n\t\tdispatch(setPref('storyFormatListFilter', name));\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'current'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.current')}\n\t\t\t\tonChange={() => setFilter('current')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'current'}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'user'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.user')}\n\t\t\t\tonChange={() => setFilter('user')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'user'}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'all'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.all')}\n\t\t\t\tonChange={() => setFilter('all')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'all'}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {AppActions} from '../../../route-actions';\nimport {StoryFormat} from '../../../store/story-formats';\nimport {FormatActions} from './formats/format-actions';\nimport {ViewActions} from './view-actions';\n\nexport interface StoryFormatListToolbarProps {\n\tselectedFormats: StoryFormat[];\n}\n\nexport const StoryFormatListToolbar: React.FC<StoryFormatListToolbarProps> = props => {\n\tconst {selectedFormats} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\ttabs={{\n\t\t\t\t[t('common.storyFormat')]: (\n\t\t\t\t\t<FormatActions selectedFormats={selectedFormats} />\n\t\t\t\t),\n\t\t\t\t[t('common.view')]: <ViewActions />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {ClickAwayListener} from '../../components/click-away-listener';\nimport {CardGroup} from '../../components/container/card-group';\nimport {MainContent} from '../../components/container/main-content';\nimport {StoryFormatCard} from '../../components/story-format/story-format-card/story-format-card';\nimport {DialogsContextProvider} from '../../dialogs';\nimport {FormatLoader} from '../../store/format-loader';\nimport {usePrefsContext} from '../../store/prefs';\nimport {\n\tdeselectAllFormats,\n\tdeselectFormat,\n\tfilteredFormats,\n\tselectFormat,\n\tsortFormats,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {StoryFormatListToolbar} from './toolbar';\n\nexport const StoryFormatListRoute: React.FC = () => {\n\tconst {dispatch: formatsDispatch, formats} = useStoryFormatsContext();\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst selectedFormats = formats.filter(format => format.selected);\n\n\tconst visibleFormats = sortFormats(\n\t\tfilteredFormats(formats, prefs.storyFormatListFilter)\n\t);\n\n\t// Any formats no longer visible should be deselected.\n\n\tReact.useEffect(() => {\n\t\tfor (const format of selectedFormats) {\n\t\t\tif (format.selected && !visibleFormats.includes(format)) {\n\t\t\t\tformatsDispatch(deselectFormat(format));\n\t\t\t}\n\t\t}\n\t}, [prefsDispatch, selectedFormats, visibleFormats, formatsDispatch]);\n\n\tfunction handleSelect(format: StoryFormat) {\n\t\tformatsDispatch(selectFormat(format, true));\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-list-route\">\n\t\t\t<DialogsContextProvider>\n\t\t\t\t<StoryFormatListToolbar selectedFormats={selectedFormats} />\n\t\t\t\t<ClickAwayListener\n\t\t\t\t\tignoreSelector=\".story-format-card\"\n\t\t\t\t\tonClickAway={() => formatsDispatch(deselectAllFormats())}\n\t\t\t\t>\n\t\t\t\t\t<MainContent\n\t\t\t\t\t\ttitle={t(\n\t\t\t\t\t\t\t`routes.storyFormatList.title.${prefs.storyFormatListFilter}`\n\t\t\t\t\t\t)}\n\t\t\t\t\t>\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t{t(\n\t\t\t\t\t\t\t\tvisibleFormats.length > 0\n\t\t\t\t\t\t\t\t\t? 'routes.storyFormatList.storyFormatExplanation'\n\t\t\t\t\t\t\t\t\t: 'routes.storyFormatList.noneVisible'\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<FormatLoader>\n\t\t\t\t\t\t\t<CardGroup columnWidth=\"450px\">\n\t\t\t\t\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t\t\t\t\t{visibleFormats.map(format => (\n\t\t\t\t\t\t\t\t\t\t<CSSTransition\n\t\t\t\t\t\t\t\t\t\t\tclassNames=\"pop\"\n\t\t\t\t\t\t\t\t\t\t\tkey={format.id}\n\t\t\t\t\t\t\t\t\t\t\ttimeout={200}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<StoryFormatCard\n\t\t\t\t\t\t\t\t\t\t\t\tdefaultFormat={\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === prefs.storyFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === prefs.storyFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\teditorExtensionsDisabled={prefs.disabledStoryFormatEditorExtensions.some(\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabledFormat =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === disabledFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === disabledFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\tformat={format}\n\t\t\t\t\t\t\t\t\t\t\t\tonSelect={() => handleSelect(format)}\n\t\t\t\t\t\t\t\t\t\t\t\tproofingFormat={\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === prefs.proofingFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === prefs.proofingFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t</TransitionGroup>\n\t\t\t\t\t\t\t</CardGroup>\n\t\t\t\t\t\t</FormatLoader>\n\t\t\t\t\t</MainContent>\n\t\t\t\t</ClickAwayListener>\n\t\t\t</DialogsContextProvider>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport 'element-closest';\nimport {rectFromPoints, Point, Rect} from '../../util/geometry';\nimport './marquee-selection.css';\n\nexport interface MarqueeSelectionProps {\n\t/**\n\t * Container DOM element to attach events to.\n\t */\n\tcontainer: React.RefObject<HTMLElement>;\n\t/**\n\t * Ignores click events on any element matching this selector. This is so that\n\t * drags beginning on a passage card can be ignored.\n\t */\n\tignoreEventsOnSelector?: string;\n\t/**\n\t * Callback for when selection is finalized by the user letting go of the\n\t * mouse button.\n\t */\n\tonSelectRect: (rect: Rect, additive: boolean) => void;\n\t/**\n\t * Callback for when the user is altering the selection by dragging the mouse.\n\t */\n\tonTemporarySelectRect: (rect: Rect, additive: boolean) => void;\n}\n\nexport const MarqueeSelection: React.FC<MarqueeSelectionProps> = props => {\n\tconst {\n\t\tcontainer,\n\t\tignoreEventsOnSelector,\n\t\tonSelectRect,\n\t\tonTemporarySelectRect\n\t} = props;\n\tconst [additive, setAdditive] = React.useState(false);\n\tconst [dragging, setDragging] = React.useState(false);\n\tconst [start, setStart] = React.useState<Point>();\n\tconst [current, setCurrent] = React.useState<Point>();\n\n\t// There are two effects here to prevent unnecesary cleanup of event\n\t// listeners. One listens to DOM events on the container, the other handles\n\t// calling onSelectRect.\n\n\tReact.useEffect(() => {\n\t\tconst currentContainer = container.current;\n\t\tlet currentContainerRect: DOMRect;\n\n\t\tfunction relativePointerPos(event: PointerEvent) {\n\t\t\treturn {\n\t\t\t\tleft:\n\t\t\t\t\tevent.clientX -\n\t\t\t\t\tcurrentContainerRect.left +\n\t\t\t\t\tcurrentContainer!.scrollLeft,\n\t\t\t\ttop:\n\t\t\t\t\tevent.clientY - currentContainerRect.top + currentContainer!.scrollTop\n\t\t\t};\n\t\t}\n\n\t\tfunction upListener(event: PointerEvent) {\n\t\t\tif (currentContainer) {\n\t\t\t\tcurrentContainer.releasePointerCapture(event.pointerId);\n\t\t\t\tcurrentContainer.removeEventListener('pointermove', moveListener);\n\t\t\t\tcurrentContainer.removeEventListener('pointerup', upListener);\n\t\t\t\tsetDragging(false);\n\t\t\t\t// See the second effect for how callbacks are invoked.\n\t\t\t}\n\t\t}\n\n\t\tfunction moveListener(event: PointerEvent) {\n\t\t\tsetCurrent(relativePointerPos(event));\n\t\t}\n\n\t\tfunction downListener(event: PointerEvent) {\n\t\t\tif (\n\t\t\t\tevent.pointerType === 'touch' ||\n\t\t\t\tevent.button !== 0 ||\n\t\t\t\t!currentContainer\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tignoreEventsOnSelector &&\n\t\t\t\t(event.target as HTMLElement).closest(ignoreEventsOnSelector)\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcurrentContainerRect = currentContainer.getBoundingClientRect();\n\t\t\tcurrentContainer.setPointerCapture(event.pointerId);\n\t\t\tcurrentContainer.addEventListener('pointermove', moveListener);\n\t\t\tcurrentContainer.addEventListener('pointerup', upListener);\n\t\t\tsetAdditive(!!(event.shiftKey || event.ctrlKey));\n\t\t\tsetDragging(true);\n\t\t\tsetStart(relativePointerPos(event));\n\t\t\tsetCurrent(relativePointerPos(event));\n\t\t}\n\n\t\tif (currentContainer) {\n\t\t\tcurrentContainer.addEventListener('pointerdown', downListener);\n\t\t\treturn () =>\n\t\t\t\tcurrentContainer.removeEventListener('pointerdown', downListener);\n\t\t}\n\t}, [container, ignoreEventsOnSelector]);\n\n\tReact.useEffect(() => {\n\t\t// This effect will trigger constantly if the on* callbacks aren't memoized\n\t\t// outside the component.\n\n\t\tif (start && current) {\n\t\t\tif (dragging) {\n\t\t\t\tonTemporarySelectRect(rectFromPoints(start, current), additive);\n\t\t\t} else {\n\t\t\t\tonSelectRect(rectFromPoints(start, current), additive);\n\t\t\t\tsetStart(undefined);\n\t\t\t\tsetCurrent(undefined);\n\t\t\t}\n\t\t}\n\t}, [additive, current, dragging, onSelectRect, onTemporarySelectRect, start]);\n\n\tconst style = React.useMemo(() => {\n\t\tif (!start || !current) {\n\t\t\treturn {};\n\t\t}\n\n\t\tconst rect = rectFromPoints(start, current);\n\n\t\t// This relies on the static dimensions of the div being set at 100x100 in\n\t\t// CSS. The point of this is to allow the browser to resize the marquee\n\t\t// using GPU only (hopefully), which is more performant than setting bounds\n\t\t// directly.\n\n\t\treturn {\n\t\t\ttransform: `translate(${rect.left}px, ${rect.top}px) scale(${\n\t\t\t\trect.width / 100\n\t\t\t}, ${rect.height / 100})`\n\t\t};\n\t}, [current, start]);\n\n\tif (!start || !current) {\n\t\treturn null;\n\t}\n\n\treturn <div className=\"marquee-selection\" style={style} />;\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport './broken-connection.css';\n\nexport interface BrokenConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n}\n\n// Making this equal in length to <StartConnector>.\nconst lineOffset = 25 * Math.sqrt(2);\n\nexport const BrokenConnection: React.FC<BrokenConnectionProps> = props => {\n\tconst {offset, passage} = props;\n\tconst start: Point = {left: passage.left, top: passage.top};\n\n\tif (passage.selected) {\n\t\tstart.left += offset.left;\n\t\tstart.top += offset.top;\n\t}\n\n\treturn (\n\t\t<line\n\t\t\tclassName=\"broken-connection\"\n\t\t\tx1={start.left + passage.width}\n\t\t\ty1={start.top + passage.height}\n\t\t\tx2={start.left + passage.width + lineOffset}\n\t\t\ty2={start.top + passage.height + lineOffset}\n\t\t\tstyle={{markerEnd: 'url(#link-broken)'}}\n\t\t/>\n\t);\n};\n","import {Point} from './geometry';\n\nexport interface ArcProps {\n\tend: Point;\n\tlargeArc?: boolean;\n\tradius: Point;\n\trotation?: number;\n\tstart: Point;\n\tsweep?: boolean;\n}\n\n/**\n * Returns an SVG path string between two points.\n * @see https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths#arcs\n */\nexport function arc({start, end, radius, largeArc, sweep, rotation}: ArcProps) {\n\treturn (\n\t\t'M' +\n\t\tstart.left +\n\t\t',' +\n\t\tstart.top +\n\t\t' A' +\n\t\tradius.left +\n\t\t',' +\n\t\tradius.top +\n\t\t' ' +\n\t\t(rotation ?? '0') +\n\t\t(largeArc ? ' 1' : ' 0') +\n\t\t(sweep ? ' 1 ' : ' 0 ') +\n\t\tend.left +\n\t\t',' +\n\t\tend.top\n\t);\n}\n","import * as React from 'react';\nimport {arc} from '../../../util/svg';\nimport {\n\tlineAngle,\n\tlineDistance,\n\trectCenter,\n\trectIntersectionWithLine,\n\tPoint\n} from '../../../util/geometry';\nimport {Passage} from '../../../store/stories';\nimport './passage-connection.css';\n\nexport interface PassageConnectionProps {\n\tend: Passage;\n\toffset: Point;\n\tstart: Passage;\n\tvariant: 'link' | 'reference';\n}\n\nexport const PassageConnection: React.FC<PassageConnectionProps> = props => {\n\tconst {end, offset, start, variant} = props;\n\tconst path = React.useMemo(() => {\n\t\t// If either passage is selected, offset it. We need to take care not to\n\t\t// overwrite the passage information.\n\n\t\tlet offsetStart = start;\n\t\tlet offsetEnd = end;\n\n\t\tif (start.selected) {\n\t\t\toffsetStart = {\n\t\t\t\t...start,\n\t\t\t\tleft: start.left + offset.left,\n\t\t\t\ttop: start.top + offset.top\n\t\t\t};\n\t\t}\n\n\t\tif (end.selected) {\n\t\t\toffsetEnd = {\n\t\t\t\t...end,\n\t\t\t\tleft: end.left + offset.left,\n\t\t\t\ttop: end.top + offset.top\n\t\t\t};\n\t\t}\n\n\t\t// Start at the center of both passages.\n\n\t\tlet startPoint: Point | null = rectCenter(offsetStart);\n\t\tlet endPoint: Point | null = rectCenter(offsetEnd);\n\n\t\t// Move both points to where they intersect with the edges of their passages.\n\n\t\tstartPoint = rectIntersectionWithLine(offsetStart, startPoint, endPoint);\n\n\t\tif (!startPoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\tendPoint = rectIntersectionWithLine(offsetEnd, startPoint, endPoint);\n\n\t\tif (!endPoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\t// Draw a flattened arc, to make it easier to distinguish between links\n\t\t// between passages with the same horizontal or vertical position (which\n\t\t// would otherwise be overlapping flat lines).\n\t\t//\n\t\t// The horizontal radius of our arc is proportional to the distance\n\t\t// the line will travel.\n\n\t\tconst distance = lineDistance(startPoint, endPoint);\n\n\t\t// Rotate the arc so that its underside will always face downward. We cheat\n\t\t// vertical lines so that their undersides face right--an aesthetic choice,\n\t\t// and so that bidirectional links line up.\n\n\t\tlet sweep = startPoint.left < endPoint.left;\n\n\t\tif (startPoint.left === endPoint.left && startPoint.top < endPoint.top) {\n\t\t\tsweep = true;\n\t\t}\n\n\t\tconst angle = lineAngle(startPoint, endPoint);\n\n\t\t// The Y radius is another aesthetic choice. The lower the ratio, the less\n\t\t// curved the lines become.\n\n\t\treturn arc({\n\t\t\tstart: startPoint,\n\t\t\tend: endPoint,\n\t\t\tradius: {left: distance, top: distance * 0.75},\n\t\t\trotation: angle,\n\t\t\tsweep\n\t\t});\n\t}, [end, offset.left, offset.top, start]);\n\n\treturn (\n\t\t<path\n\t\t\td={path}\n\t\t\tclassName={`passage-connection variant-${variant}`}\n\t\t\tstyle={{markerEnd: 'url(#link-arrowhead)'}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {arc} from '../../../util/svg';\nimport './self-connection.css';\n\nexport interface SelfConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n\tvariant: 'link' | 'reference';\n}\n\nexport const SelfConnection: React.FC<SelfConnectionProps> = props => {\n\tconst {offset, passage, variant} = props;\n\tconst start: Point = {left: passage.left, top: passage.top};\n\n\tif (passage.selected) {\n\t\tstart.left += offset.left;\n\t\tstart.top += offset.top;\n\t}\n\n\tconst radius = React.useMemo(\n\t\t() => 0.4 * Math.min(passage.width, passage.height),\n\t\t[passage.height, passage.width]\n\t);\n\n\tconst path = React.useMemo(\n\t\t() =>\n\t\t\tarc({\n\t\t\t\tstart: {\n\t\t\t\t\tleft: start.left,\n\t\t\t\t\ttop: start.top + passage.height / 2\n\t\t\t\t},\n\t\t\t\tend: {\n\t\t\t\t\tleft: start.left,\n\t\t\t\t\ttop: start.top\n\t\t\t\t},\n\t\t\t\tradius: {\n\t\t\t\t\tleft: radius,\n\t\t\t\t\ttop: radius\n\t\t\t\t},\n\t\t\t\tsweep: true,\n\t\t\t\tlargeArc: true\n\t\t\t}),\n\t\t[passage.height, radius, start.left, start.top]\n\t);\n\n\treturn (\n\t\t<path\n\t\t\tclassName={`self-connection variant-${variant}`}\n\t\t\td={path}\n\t\t\tstyle={{markerEnd: 'url(#link-arrowhead)'}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {BrokenConnection} from './broken-connection';\nimport {PassageConnection} from './passage-connection';\nimport {SelfConnection} from './self-connection';\nimport {Point} from '../../../util/geometry';\n\nexport interface PassageConnectionGroupProps {\n\tbroken: Set<Passage>;\n\tconnections: Map<Passage, Set<Passage>>;\n\toffset: Point;\n\tself: Set<Passage>;\n\tvariant?: 'link' | 'reference';\n}\n\nexport const PassageConnectionGroup: React.FC<PassageConnectionGroupProps> = React.memo(\n\tprops => {\n\t\tconst {broken, connections, offset, self, variant = 'link'} = props;\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t{Array.from(connections).map(connection =>\n\t\t\t\t\tArray.from(connection[1]).map(end => (\n\t\t\t\t\t\t<PassageConnection\n\t\t\t\t\t\t\tend={end}\n\t\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\t\tkey={connection[0].name + end.name}\n\t\t\t\t\t\t\tstart={connection[0]}\n\t\t\t\t\t\t\tvariant={variant}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t)}\n\t\t\t\t{Array.from(self).map(passage => (\n\t\t\t\t\t<SelfConnection\n\t\t\t\t\t\tkey={passage.name}\n\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t\tvariant={variant}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t\t{Array.from(broken).map(passage => (\n\t\t\t\t\t<BrokenConnection\n\t\t\t\t\t\tkey={passage.name}\n\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</>\n\t\t);\n\t}\n);\n\nPassageConnectionGroup.displayName = 'PassageConnectionGroup';","import * as React from 'react';\nimport './link-markers.css';\n\n/**\n * Arrowheads used on connectors. Arrowheads must be applied by an inline style.\n * There seems to be disagreement on the proper way to implement this, but it\n * does not work in an external stylesheet in Firefox.\n * @see https://developer.mozilla.org/en-US/docs/Web/SVG/Element/marker\n */\nexport const LinkMarkers: React.FC = () => (\n\t<defs>\n\t\t<marker\n\t\t\tid=\"link-arrowhead\"\n\t\t\trefX=\"6\"\n\t\t\trefY=\"4\"\n\t\t\tmarkerWidth=\"8\"\n\t\t\tmarkerHeight=\"8\"\n\t\t\torient=\"auto\"\n\t\t>\n\t\t\t<path d=\"M 1,1 7,4 1,7 Z\" />\n\t\t</marker>\n\t\t<marker\n\t\t\tid=\"link-broken\"\n\t\t\trefX=\"7.5\"\n\t\t\trefY=\"7.5\"\n\t\t\tmarkerWidth=\"15\"\n\t\t\tmarkerHeight=\"15\"\n\t\t>\n\t\t\t<circle cx=\"7.5\" cy=\"7.5\" r=\"7.5\" />\n\t\t\t<path d=\"M4.5 7.5h 6z\" />\n\t\t</marker>\n\t\t<marker\n\t\t\tid=\"link-start\"\n\t\t\tmarkerWidth=\"15\"\n\t\t\tmarkerHeight=\"15\"\n\t\t\trefX=\"16\"\n\t\t\trefY=\"16\"\n\t\t\tviewBox=\"0 0 32 32\"\n\t\t>\n\t\t\t<circle cx=\"16\" cy=\"16\" r=\"16\" />\n\t\t\t<path d=\"M8 17a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3\" />\n\t\t\t<path d=\"M11 18a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3\" />\n\t\t\t<circle className=\"fill-white\" cx=\"19\" cy=\"13\" r=\"1\" />\n\t\t</marker>\n\t</defs>\n);\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport './start-connection.css';\n\nexport interface StartConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n}\n\nexport const StartConnection: React.FC<StartConnectionProps> = React.memo(\n\tprops => {\n\t\tconst {offset, passage} = props;\n\t\tconst start: Point = {left: passage.left, top: passage.top};\n\n\t\tif (passage.selected) {\n\t\t\tstart.left += offset.left;\n\t\t\tstart.top += offset.top;\n\t\t}\n\n\t\treturn (\n\t\t\t<line\n\t\t\t\tclassName=\"start-connection\"\n\t\t\t\tx1={start.left - 50}\n\t\t\t\ty1={start.top + passage.height / 2}\n\t\t\t\tx2={start.left}\n\t\t\t\ty2={start.top + passage.height / 2}\n\t\t\t\tstyle={{markerStart: 'url(#link-start)'}}\n\t\t\t/>\n\t\t);\n\t}\n);\n\nStartConnection.displayName = 'StartConnection';","import * as React from 'react';\nimport {version as twineVersion} from '../../package.json';\nimport {formatEditorExtensions} from '../util/story-format';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\n\nconst emptyFunc = () => [];\n\nexport function useFormatReferenceParser(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst [editorExtensions, setEditorExtensions] = React.useState<\n\t\tReturnType<typeof formatEditorExtensions>\n\t>();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (format.loadState === 'loaded') {\n\t\t\tsetEditorExtensions(formatEditorExtensions(format, twineVersion));\n\t\t}\n\t}, [dispatch, extensionsDisabled, format]);\n\n\tif (extensionsDisabled) {\n\t\treturn emptyFunc;\n\t}\n\n\treturn editorExtensions?.references?.parsePassageText ?? emptyFunc;\n}\n","import * as React from 'react';\nimport {Passage, passageConnections} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {PassageConnectionGroup} from './passage-connection-group';\nimport {LinkMarkers} from './link-markers';\nimport {StartConnection} from './start-connection';\nimport {useFormatReferenceParser} from '../../../store/use-format-reference-parser';\n\nexport interface PassageConnectionsProps {\n\tformatName: string;\n\tformatVersion: string;\n\toffset: Point;\n\tpassages: Passage[];\n\tstartPassageId: string;\n}\n\nconst emptySet = new Set<Passage>();\nconst noOffset: Point = {left: 0, top: 0};\n\nexport const PassageConnections: React.FC<PassageConnectionsProps> = props => {\n\tconst {formatName, formatVersion, offset, passages, startPassageId} = props;\n\tconst referenceParser = useFormatReferenceParser(formatName, formatVersion);\n\tconst {draggable: draggableLinks, fixed: fixedLinks} = React.useMemo(\n\t\t() => passageConnections(passages),\n\t\t[passages]\n\t);\n\tconst {\n\t\tdraggable: draggableReferences,\n\t\tfixed: fixedReferences\n\t} = React.useMemo(() => passageConnections(passages, referenceParser), [\n\t\tpassages,\n\t\treferenceParser\n\t]);\n\n\tconst startPassage = React.useMemo(\n\t\t() => passages.find(passage => passage.id === startPassageId),\n\t\t[passages, startPassageId]\n\t);\n\n\t// References only show existing connections.\n\n\treturn (\n\t\t<svg className=\"link-connectors\">\n\t\t\t<LinkMarkers />\n\t\t\t{startPassage && (\n\t\t\t\t<StartConnection offset={offset} passage={startPassage} />\n\t\t\t)}\n\t\t\t<PassageConnectionGroup {...draggableLinks} offset={offset} />\n\t\t\t<PassageConnectionGroup {...fixedLinks} offset={noOffset} />\n\t\t\t<PassageConnectionGroup\n\t\t\t\tbroken={emptySet}\n\t\t\t\tconnections={draggableReferences.connections}\n\t\t\t\toffset={offset}\n\t\t\t\tself={emptySet}\n\t\t\t\tvariant=\"reference\"\n\t\t\t/>\n\t\t\t<PassageConnectionGroup\n\t\t\t\tbroken={emptySet}\n\t\t\t\tconnections={fixedReferences.connections}\n\t\t\t\toffset={noOffset}\n\t\t\t\tself={emptySet}\n\t\t\t\tvariant=\"reference\"\n\t\t\t/>\n\t\t</svg>\n\t);\n};\n","import classNames from 'classnames';\nimport {deviceType} from 'detect-it';\nimport * as React from 'react';\nimport {DraggableCore, DraggableCoreProps} from 'react-draggable';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../container/card';\nimport {SelectableCard} from '../container/card/selectable-card';\nimport {Passage, TagColors} from '../../store/stories';\nimport {TagStripe} from '../tag/tag-stripe';\nimport {passageIsEmpty} from '../../util/passage-is-empty';\nimport './passage-card.css';\n\nexport interface PassageCardProps {\n\tonEdit: (passage: Passage) => void;\n\tonDeselect: (passage: Passage) => void;\n\tonDragStart?: DraggableCoreProps['onStart'];\n\tonDrag?: DraggableCoreProps['onDrag'];\n\tonDragStop?: DraggableCoreProps['onStop'];\n\tonSelect: (passage: Passage, exclusive: boolean) => void;\n\tpassage: Passage;\n\ttagColors: TagColors;\n}\n\n// Needs to fill a large-sized passage card.\nconst excerptLength = 400;\n\nexport const PassageCard: React.FC<PassageCardProps> = React.memo(props => {\n\tconst {\n\t\tonDeselect,\n\t\tonDrag,\n\t\tonDragStart,\n\t\tonDragStop,\n\t\tonEdit,\n\t\tonSelect,\n\t\tpassage,\n\t\ttagColors\n\t} = props;\n\tconst {t} = useTranslation();\n\tconst className = React.useMemo(\n\t\t() =>\n\t\t\tclassNames('passage-card', {\n\t\t\t\tempty: passageIsEmpty(passage),\n\t\t\t\tselected: passage.selected\n\t\t\t}),\n\t\t[passage]\n\t);\n\tconst container = React.useRef<HTMLDivElement>(null);\n\tconst excerpt = React.useMemo(() => {\n\t\tif (passage.text.length > 0) {\n\t\t\treturn passage.text.substring(0, excerptLength);\n\t\t}\n\n\t\treturn (\n\t\t\t<span className=\"placeholder\">\n\t\t\t\t{t(\n\t\t\t\t\tdeviceType === 'touchOnly'\n\t\t\t\t\t\t? 'components.passageCard.placeholderTouch'\n\t\t\t\t\t\t: 'components.passageCard.placeholderClick'\n\t\t\t\t)}\n\t\t\t</span>\n\t\t);\n\t}, [passage.text, t]);\n\tconst style = React.useMemo(\n\t\t() => ({\n\t\t\theight: passage.height,\n\t\t\tleft: passage.left,\n\t\t\ttop: passage.top,\n\t\t\twidth: passage.width\n\t\t}),\n\t\t[passage.height, passage.left, passage.top, passage.width]\n\t);\n\tconst handleMouseDown = React.useCallback(\n\t\t(event: MouseEvent) => {\n\t\t\t// Shift- or control-clicking toggles our selected status, but doesn't\n\t\t\t// affect any other passage's selected status. If the shift or control key\n\t\t\t// was not held down and we were not already selected, we know the user\n\t\t\t// wants to select only this passage.\n\n\t\t\tif (event.shiftKey || event.ctrlKey) {\n\t\t\t\tif (passage.selected) {\n\t\t\t\t\tonDeselect(passage);\n\t\t\t\t} else {\n\t\t\t\t\tonSelect(passage, false);\n\t\t\t\t}\n\t\t\t} else if (!passage.selected) {\n\t\t\t\tonSelect(passage, true);\n\t\t\t}\n\t\t},\n\t\t[onDeselect, onSelect, passage]\n\t);\n\tconst handleEdit = React.useCallback(\n\t\t() => onEdit(passage),\n\t\t[onEdit, passage]\n\t);\n\tconst handleSelect = React.useCallback(\n\t\t(value: boolean, exclusive: boolean) => {\n\t\t\tonSelect(passage, exclusive);\n\t\t},\n\t\t[onSelect, passage]\n\t);\n\n\treturn (\n\t\t<DraggableCore\n\t\t\tnodeRef={container}\n\t\t\tonMouseDown={handleMouseDown}\n\t\t\tonStart={onDragStart}\n\t\t\tonDrag={onDrag}\n\t\t\tonStop={onDragStop}\n\t\t>\n\t\t\t<div className={className} ref={container} style={style}>\n\t\t\t\t<SelectableCard\n\t\t\t\t\thighlighted={passage.highlighted}\n\t\t\t\t\tlabel={passage.name}\n\t\t\t\t\tonDoubleClick={handleEdit}\n\t\t\t\t\tonSelect={handleSelect}\n\t\t\t\t\tselected={passage.selected}\n\t\t\t\t>\n\t\t\t\t\t<TagStripe tagColors={tagColors} tags={passage.tags} />\n\t\t\t\t\t<h2>{passage.name}</h2>\n\t\t\t\t\t<CardContent>{excerpt}</CardContent>\n\t\t\t\t</SelectableCard>\n\t\t\t</div>\n\t\t</DraggableCore>\n\t);\n});\n\nPassageCard.displayName = 'PassageCard';","import * as React from 'react';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {Passage} from '../../store/stories';\nimport {PassageCard, PassageCardProps} from './passage-card';\nimport '../../styles/animations.css';\n\nexport interface PassageCardGroupProps\n\textends Omit<PassageCardProps, 'passage'> {\n\tpassages: Passage[];\n}\n\nexport const PassageCardGroup: React.FC<PassageCardGroupProps> = React.memo(\n\tprops => {\n\t\tconst {passages} = props;\n\n\t\t// Passages must be sorted so that tabbing around follows a logical pattern.\n\n\t\tconst sortedPassages = React.useMemo(\n\t\t\t() =>\n\t\t\t\t[...passages].sort((a, b) => {\n\t\t\t\t\tif (a.top !== b.top) {\n\t\t\t\t\t\treturn a.top - b.top;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn a.left - b.left;\n\t\t\t\t}),\n\t\t\t[passages]\n\t\t);\n\n\t\treturn (\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{sortedPassages.map(passage => (\n\t\t\t\t\t<CSSTransition classNames=\"pop\" key={passage.id} timeout={200}>\n\t\t\t\t\t\t<PassageCard passage={passage} {...props} />\n\t\t\t\t\t</CSSTransition>\n\t\t\t\t))}\n\t\t\t</TransitionGroup>\n\t\t);\n\t}\n);\n\nPassageCardGroup.displayName = 'PassageCardGroup';","import * as React from 'react';\nimport {DraggableData} from 'react-draggable';\nimport {Passage, Story} from '../../../store/stories';\nimport {boundingRect, Point} from '../../../util/geometry';\nimport {PassageConnections} from '../passage-connections';\nimport {PassageCardGroup} from '../passage-card-group';\nimport './passage-map.css';\nimport classnames from 'classnames';\n\nexport interface PassageMapProps {\n\tformatName: string;\n\tformatVersion: string;\n\tonDeselect: (passage: Passage) => void;\n\tonDrag: (change: Point) => void;\n\tonEdit: (passage: Passage) => void;\n\tonSelect: (passage: Passage, exclusive: boolean) => void;\n\tpassages: Passage[];\n\tstartPassageId: string;\n\ttagColors: Story['tagColors'];\n\tvisibleZoom: number;\n\tzoom: number;\n}\n\ninterface DragState {\n\tdragging: boolean;\n\tdragX: number;\n\tdragY: number;\n\tstartX: number;\n\tstartY: number;\n}\n\ntype DragAction =\n\t| {type: 'start'; x: number; y: number}\n\t| {type: 'move'; x: number; y: number}\n\t| {type: 'stop'; callback: (change: Point) => void};\n\nfunction dragReducer(state: DragState, action: DragAction) {\n\tswitch (action.type) {\n\t\tcase 'start':\n\t\t\treturn {\n\t\t\t\tdragging: true,\n\t\t\t\tdragX: action.x,\n\t\t\t\tdragY: action.y,\n\t\t\t\tstartX: action.x,\n\t\t\t\tstartY: action.y\n\t\t\t};\n\n\t\tcase 'move':\n\t\t\treturn {...state, dragX: action.x, dragY: action.y};\n\n\t\tcase 'stop':\n\t\t\t// This is bad reducer practice, probablythis dispatch causes a side\n\t\t\t// effect. However, it allows us to avoid re-renders as state\n\t\t\t// changes--otherwise state becomes a dependency of the handleDragStop\n\t\t\t// callback below--which have a large performance impact.\n\t\t\t//\n\t\t\t// This also must be deferred to avoid changing state mid-render through\n\t\t\t// the callback.\n\n\t\t\tPromise.resolve().then(() =>\n\t\t\t\taction.callback({\n\t\t\t\t\tleft: state.dragX - state.startX,\n\t\t\t\t\ttop: state.dragY - state.startY\n\t\t\t\t})\n\t\t\t);\n\t\t\treturn {dragging: false, dragX: 0, dragY: 0, startX: 0, startY: 0};\n\t}\n}\n\nconst compactCardZoom = 0.6;\n\nexport const PassageMap: React.FC<PassageMapProps> = props => {\n\tconst {\n\t\tformatName,\n\t\tformatVersion,\n\t\tonDeselect,\n\t\tonDrag,\n\t\tonEdit,\n\t\tonSelect,\n\t\tpassages,\n\t\tstartPassageId,\n\t\ttagColors,\n\t\tvisibleZoom,\n\t\tzoom\n\t} = props;\n\tconst [compactCards, setCompactCards] = React.useState(\n\t\tvisibleZoom <= compactCardZoom\n\t);\n\tconst container = React.useRef<HTMLDivElement>(null);\n\tconst passageBounds = React.useMemo(() => {\n\t\t// Need to inject a fake rect at the very top-left corner to anchor the\n\t\t// bounds there.\n\n\t\treturn boundingRect([...passages, {top: 0, left: 0, width: 0, height: 0}]);\n\t}, [passages]);\n\n\t// This is a separate memo so that there's less work when visibleZoom changes\n\t// during a zoom transition. The max() expression ensures that dialogs will\n\t// never overlap it--800px is the largest user-selectable dialog width (see\n\t// dialogs/app-prefs.tsx), so we leave 200px padding around that. We hardcode\n\t// it here instead of taking a prop mainly for simplicity's sake.\n\n\tconst style = React.useMemo(() => {\n\t\treturn {\n\t\t\theight: `calc(${passageBounds.height}px + max(50vh, ${\n\t\t\t\t1000 / visibleZoom\n\t\t\t}px))`,\n\t\t\twidth: `calc(${passageBounds.width}px + max(50vw, ${\n\t\t\t\t1000 / visibleZoom\n\t\t\t}px))`,\n\t\t\ttransform: `scale(${visibleZoom})`\n\t\t};\n\t}, [passageBounds.height, passageBounds.width, visibleZoom]);\n\n\tconst [state, dispatch] = React.useReducer(dragReducer, {\n\t\tdragging: false,\n\t\tdragX: 0,\n\t\tdragY: 0,\n\t\tstartX: 0,\n\t\tstartY: 0\n\t});\n\n\t// Only update the compact card state when visibleZoom and zoom are the same.\n\t// This avoids re-rendering the cards in the middle of a zoom transition\n\t// (which causes jank).\n\n\tReact.useEffect(() => {\n\t\tif (zoom === visibleZoom) {\n\t\t\tsetCompactCards(zoom <= compactCardZoom);\n\t\t}\n\t}, [visibleZoom, zoom]);\n\n\t// Set CSS variables on the container for drag offsets.\n\n\tReact.useEffect(() => {\n\t\tif (!container.current) {\n\t\t\treturn;\n\t\t}\n\n\t\tcontainer.current.style.setProperty(\n\t\t\t'--drag-offset-left',\n\t\t\t`${(state.dragX - state.startX) / visibleZoom}px`\n\t\t);\n\t\tcontainer.current.style.setProperty(\n\t\t\t'--drag-offset-top',\n\t\t\t`${(state.dragY - state.startY) / visibleZoom}px`\n\t\t);\n\t}, [state.dragX, state.dragY, state.startX, state.startY, visibleZoom]);\n\n\tconst handleDragStart = React.useCallback((event, data: DraggableData) => {\n\t\tdocument.body.classList.add('dragging-passages');\n\t\tdispatch({type: 'start', x: data.x, y: data.y});\n\t}, []);\n\tconst handleDrag = React.useCallback(\n\t\t(event, data: DraggableData) =>\n\t\t\tdispatch({type: 'move', x: data.x, y: data.y}),\n\t\t[]\n\t);\n\tconst handleDragStop = React.useCallback(() => {\n\t\t// We use a timeout to delay this execution until after the click handler on\n\t\t// <SelectableCard> runs and triggers handleSelect below, so that function\n\t\t// can see that a drag has just finished (and should be ignored as part of\n\t\t// the drag interaction).\n\t\t//\n\t\t// Promise.resolve() doesn't appear to give us the timing we need.\n\n\t\twindow.setTimeout(() => {\n\t\t\tdocument.body.classList.remove('dragging-passages');\n\t\t\tdispatch({type: 'stop', callback: onDrag});\n\t\t}, 0);\n\t}, [onDrag]);\n\tconst handleSelect = React.useCallback(\n\t\t(passage: Passage, exclusive: boolean) => {\n\t\t\t// See comments in handleDragStop above.\n\n\t\t\tif (!state.dragging) {\n\t\t\t\tonSelect(passage, exclusive);\n\t\t\t}\n\t\t},\n\t\t[onSelect, state.dragging]\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tclassName={classnames('passage-map', {\n\t\t\t\t'compact-passage-cards': compactCards\n\t\t\t})}\n\t\t\tref={container}\n\t\t\tstyle={style}\n\t\t>\n\t\t\t<PassageConnections\n\t\t\t\tformatName={formatName}\n\t\t\t\tformatVersion={formatVersion}\n\t\t\t\toffset={{\n\t\t\t\t\tleft: (state.dragX - state.startX) / zoom,\n\t\t\t\t\ttop: (state.dragY - state.startY) / zoom\n\t\t\t\t}}\n\t\t\t\tpassages={passages}\n\t\t\t\tstartPassageId={startPassageId}\n\t\t\t/>\n\t\t\t<PassageCardGroup\n\t\t\t\tonDeselect={onDeselect}\n\t\t\t\tonDragStart={handleDragStart}\n\t\t\t\tonDrag={handleDrag}\n\t\t\t\tonDragStop={handleDragStop}\n\t\t\t\tonEdit={onEdit}\n\t\t\t\tonSelect={handleSelect}\n\t\t\t\tpassages={passages}\n\t\t\t\ttagColors={tagColors}\n\t\t\t/>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {\n\tMarqueeSelection,\n\tMarqueeSelectionProps\n} from '../../components/marquee-selection';\nimport {\n\tPassageMap,\n\tPassageMapProps\n} from '../../components/passage/passage-map';\nimport {Rect, rectsIntersect} from '../../util/geometry';\n\nexport interface MarqueeablePassageMapProps\n\textends PassageMapProps,\n\t\tOmit<\n\t\t\tMarqueeSelectionProps,\n\t\t\t'ignoreEventsOnSelector' | 'onTemporarySelectRect'\n\t\t> {}\n\n/**\n * Marries a MarqueeSelection with a PassageMap. This handles displaying a\n * temporary selection while the user drags around the marquee selection\n * *without* persisting the change, for performance.\n */\nexport const MarqueeablePassageMap: React.FC<\n\tMarqueeablePassageMapProps\n> = props => {\n\tconst {container, onSelectRect, ...other} = props;\n\tconst [temporaryRect, setTemporaryRect] = React.useState<Rect>();\n\tconst [temporaryAdditive, setTemporaryAdditive] = React.useState<boolean>();\n\tconst innerPassages = React.useMemo(() => {\n\t\tif (!temporaryRect) {\n\t\t\treturn props.passages;\n\t\t}\n\n\t\treturn props.passages.map(passage => {\n\t\t\tif (temporaryAdditive && passage.selected) {\n\t\t\t\treturn passage;\n\t\t\t}\n\n\t\t\tconst selected = rectsIntersect(temporaryRect, passage);\n\n\t\t\tif (selected === passage.selected) {\n\t\t\t\treturn passage;\n\t\t\t}\n\n\t\t\treturn {...passage, selected};\n\t\t});\n\t}, [props.passages, temporaryAdditive, temporaryRect]);\n\n\tconst handleTemporarySelectRect = React.useCallback(\n\t\t(rect: Rect, additive: boolean) => {\n\t\t\tsetTemporaryRect({\n\t\t\t\theight: rect.height / props.zoom,\n\t\t\t\tleft: rect.left / props.zoom,\n\t\t\t\ttop: rect.top / props.zoom,\n\t\t\t\twidth: rect.width / props.zoom\n\t\t\t});\n\t\t\tsetTemporaryAdditive(additive);\n\t\t},\n\t\t[props.zoom]\n\t);\n\n\tconst handleSelectRect = React.useCallback(\n\t\t(rect: Rect, additive: boolean) => {\n\t\t\tsetTemporaryRect(undefined);\n\t\t\tsetTemporaryAdditive(undefined);\n\t\t\tonSelectRect(rect, additive);\n\t\t},\n\t\t[onSelectRect]\n\t);\n\n\treturn (\n\t\t<>\n\t\t\t<MarqueeSelection\n\t\t\t\tcontainer={container}\n\t\t\t\tignoreEventsOnSelector=\".passage-card, .fuzzy-finder, .zoom-buttons\"\n\t\t\t\tonSelectRect={handleSelectRect}\n\t\t\t\tonTemporarySelectRect={handleTemporarySelectRect}\n\t\t\t/>\n\t\t\t<PassageMap {...other} passages={innerPassages} />\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {createUntitledPassage, Story} from '../../../../store/stories';\nimport {useUndoableStoriesContext} from '../../../../store/undoable-stories';\nimport {Point} from '../../../../util/geometry';\n\nexport interface CreatePassageButtonProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const CreatePassageButton: React.FC<CreatePassageButtonProps> = props => {\n\tconst {getCenter, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst handleClick = React.useCallback(() => {\n\t\tconst {left, top} = getCenter();\n\n\t\tdispatch(createUntitledPassage(story, left, top), 'undoChange.newPassage');\n\t}, [dispatch, getCenter, story]);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPlus />}\n\t\t\tlabel={t('common.new')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport 'element-closest';\nimport * as React from 'react';\nimport {useHotkeys} from 'react-hotkeys-hook';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {deletePassages, Passage, Story} from '../../../../store/stories';\nimport {useUndoableStoriesContext} from '../../../../store/undoable-stories';\n\nexport interface DeletePassagesButtonProps {\n\tpassages: Passage[];\n\tstory: Story;\n}\n\nexport const DeletePassagesButton: React.FC<\n\tDeletePassagesButtonProps\n> = props => {\n\tconst {passages, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\tconst disabled = React.useMemo(() => {\n\t\tif (passages.length === 0) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn passages.some(passage => story.startPassage === passage.id);\n\t}, [passages, story.startPassage]);\n\tconst handleClick = React.useCallback(() => {\n\t\tif (passages.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tdispatch(\n\t\t\tdeletePassages(story, passages),\n\t\t\tpassages.length > 1\n\t\t\t\t? 'undoChange.deletePassages'\n\t\t\t\t: 'undoChange.deletePassage'\n\t\t);\n\t}, [dispatch, passages, story]);\n\n\tuseHotkeys('Backspace,Delete', handleClick, [handleClick]);\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={\n\t\t\t\t!disabled && passages.length > 1\n\t\t\t\t\t? t('common.deleteCount', {count: passages.length})\n\t\t\t\t\t: t('common.delete')\n\t\t\t}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEdit} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {addPassageEditors, useDialogsContext} from '../../../../dialogs';\nimport {Passage, Story} from '../../../../store/stories';\n\nexport interface EditPassagesButtonProps {\n\tpassages: Passage[];\n\tstory: Story;\n}\n\nexport const EditPassagesButton: React.FC<EditPassagesButtonProps> = props => {\n\tconst {passages, story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tdispatch(\n\t\t\taddPassageEditors(\n\t\t\t\tstory.id,\n\t\t\t\tpassages.map(({id}) => id)\n\t\t\t)\n\t\t);\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={passages.length === 0}\n\t\t\ticon={<IconEdit />}\n\t\t\tlabel={\n\t\t\t\tpassages.length > 1\n\t\t\t\t\t? t('common.editCount', {count: passages.length})\n\t\t\t\t\t: t('common.edit')\n\t\t\t}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconFocus2} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\n\nexport interface GoToPassageButtonProps {\n\tonOpenFuzzyFinder: () => void;\n}\n\nexport const GoToPassageButton: React.FC<GoToPassageButtonProps> = props => {\n\tconst {onOpenFuzzyFinder} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconFocus2 />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.goTo')}\n\t\t\tonClick={onOpenFuzzyFinder}\n\t\t/>\n\t);\n};\n","import {IconMarquee} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tselectAllPassages,\n\tStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface SelectAllPassagesButtonProps {\n\tstory: Story;\n}\n\nexport const SelectAllPassagesButton: React.FC<SelectAllPassagesButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconMarquee />}\n\t\t\tlabel={t('common.selectAll')}\n\t\t\tonClick={() => dispatch(selectAllPassages(story))}\n\t\t/>\n\t);\n};\n","import {IconRocket} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tPassage,\n\tStory,\n\tupdateStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface StartAtPassageButtonProps {\n\tpassage?: Passage;\n\tstory: Story;\n}\n\nexport const StartAtPassageButton: React.FC<StartAtPassageButtonProps> = props => {\n\tconst {passage, story} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tif (!passage) {\n\t\t\tthrow new Error('No passage set');\n\t\t}\n\n\t\tdispatch(updateStory(stories, story, {startPassage: passage.id}));\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!passage || passage.id === story.startPassage}\n\t\t\ticon={<IconRocket />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.startStoryHere')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenamePassageButton} from '../../../../components/passage/rename-passage-button';\nimport {\n\tPassage,\n\tStory,\n\tupdatePassage,\n\tuseStoriesContext\n} from '../../../../store/stories';\nimport {Point} from '../../../../util/geometry';\nimport {CreatePassageButton} from './create-passage-button';\nimport {DeletePassagesButton} from './delete-passages-button';\nimport {EditPassagesButton} from './edit-passages-buttons';\nimport {GoToPassageButton} from './go-to-passage-button';\nimport {SelectAllPassagesButton} from './select-all-passages-button';\nimport {StartAtPassageButton} from './start-at-passage-button';\nimport {TestPassageButton} from './test-passage-button';\n\nexport interface PassageActionsProps {\n\tgetCenter: () => Point;\n\tonOpenFuzzyFinder: () => void;\n\tstory: Story;\n}\n\nexport const PassageActions: React.FC<PassageActionsProps> = props => {\n\tconst {getCenter, onOpenFuzzyFinder, story} = props;\n\tconst {dispatch} = useStoriesContext();\n\tconst selectedPassages = React.useMemo(\n\t\t() => story.passages.filter(passage => passage.selected),\n\t\t[story.passages]\n\t);\n\tconst soloSelectedPassage = React.useMemo(\n\t\t() => (selectedPassages.length === 1 ? selectedPassages[0] : undefined),\n\t\t[selectedPassages]\n\t);\n\n\tfunction handleRename(name: string, passage?: Passage) {\n\t\tif (!passage) {\n\t\t\tthrow new Error('Passage is unset');\n\t\t}\n\n\t\t// Don't create newly linked passages here because the update action will\n\t\t// try to recreate the passage as it's been renamed--it sees new links in\n\t\t// existing passages, updates them, but does not see that the passage name\n\t\t// has been updated since that hasn't happened yet.\n\n\t\tdispatch(updatePassage(story, passage, {name}, {dontUpdateOthers: true}));\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CreatePassageButton getCenter={getCenter} story={story} />\n\t\t\t<EditPassagesButton passages={selectedPassages} story={story} />\n\t\t\t<RenamePassageButton\n\t\t\t\tonRename={name => handleRename(name, soloSelectedPassage)}\n\t\t\t\tpassage={soloSelectedPassage}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<DeletePassagesButton passages={selectedPassages} story={story} />\n\t\t\t<TestPassageButton passage={soloSelectedPassage} story={story} />\n\t\t\t<StartAtPassageButton passage={soloSelectedPassage} story={story} />\n\t\t\t<GoToPassageButton onOpenFuzzyFinder={onOpenFuzzyFinder} />\n\t\t\t<SelectAllPassagesButton story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconWriting} from '@tabler/icons';\nimport {PromptButton} from '../control/prompt-button';\nimport {storyFileName} from '../../electron/shared';\nimport {Story} from '../../store/stories';\nimport {IconButton} from '../control/icon-button';\n\n// This is here because it's used in two places--the story list and the story\n// info dialog.\n\nconst DisabledRenameStoryButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton disabled icon={<IconWriting />} label={t('common.rename')} />\n\t);\n};\n\ninterface EnabledRenameStoryButtonProps {\n\texistingStories: Story[];\n\tonRename: (value: string) => void;\n\tstory: Story;\n}\n\nconst EnabledRenameStoryButton: React.FC<EnabledRenameStoryButtonProps> = props => {\n\tconst {existingStories, onRename, story} = props;\n\tconst [newName, setNewName] = React.useState(story.name);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => setNewName(story.name), [story]);\n\n\tfunction validate(name: string) {\n\t\tif (name.trim() === '') {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renameStoryButton.emptyName'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\texistingStories.some(\n\t\t\t\ts =>\n\t\t\t\t\ts.id !== story.id &&\n\t\t\t\t\tstoryFileName(s) === storyFileName({...story, name})\n\t\t\t)\n\t\t) {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renameStoryButton.nameAlreadyUsed'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconWriting />}\n\t\t\tlabel={t('common.rename')}\n\t\t\tonChange={event => setNewName(event.target.value)}\n\t\t\tonSubmit={onRename}\n\t\t\tprompt={t('common.renamePrompt', {name: story.name})}\n\t\t\tvalidate={validate}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n\nexport interface RenameStoryButtonProps\n\textends Omit<EnabledRenameStoryButtonProps, 'story'> {\n\tstory?: Story;\n}\n\nexport const RenameStoryButton: React.FC<RenameStoryButtonProps> = props => {\n\tif (props.story) {\n\t\treturn (\n\t\t\t<EnabledRenameStoryButton {...(props as EnabledRenameStoryButtonProps)} />\n\t\t);\n\t}\n\n\treturn <DisabledRenameStoryButton />;\n};","import {IconInfoCircle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryDetailsDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface DetailsButtonProps {\n\tstory: Story;\n}\n\nexport const DetailsButton: React.FC<DetailsButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconInfoCircle />}\n\t\t\tlabel={t('common.details')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryDetailsDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconSearch} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StorySearchDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface FindReplaceButtonProps {\n\tstory: Story;\n}\n\nexport const FindReplaceButton: React.FC<FindReplaceButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconSearch />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.findAndReplace')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StorySearchDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconBraces} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryJavaScriptDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface JavaScriptButtonProps {\n\tstory: Story;\n}\n\nexport const JavaScriptButton: React.FC<JavaScriptButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconBraces />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.javaScript')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryJavaScriptDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconTags} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {PassageTagsDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface PassageTagsButtonProps {\n\tstory: Story;\n}\n\nexport const PassageTagsButton: React.FC<PassageTagsButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconTags />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.passageTags')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: PassageTagsDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconHash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryStylesheetDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface StylesheetButtonProps {\n\tstory: Story;\n}\n\nexport const StylesheetButton: React.FC<StylesheetButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconHash />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.stylesheet')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryStylesheetDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenameStoryButton} from '../../../../components/story/rename-story-button';\nimport {Story, updateStory, useStoriesContext} from '../../../../store/stories';\nimport {DetailsButton} from './details-button';\nimport {FindReplaceButton} from './find-replace-button';\nimport {JavaScriptButton} from './javascript-button';\nimport {PassageTagsButton} from './passage-tags-button';\nimport {StylesheetButton} from './stylesheet-button';\n\nexport interface StoryActionsProps {\n\tstory: Story;\n}\n\nexport const StoryActions: React.FC<StoryActionsProps> = props => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {story} = props;\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<FindReplaceButton story={story} />\n\t\t\t<RenameStoryButton\n\t\t\t\texistingStories={stories}\n\t\t\t\tonRename={name => dispatch(updateStory(stories, story, {name}))}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<DetailsButton story={story} />\n\t\t\t<PassageTagsButton story={story} />\n\t\t\t<JavaScriptButton story={story} />\n\t\t\t<StylesheetButton story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowBack, IconArrowForward} from '@tabler/icons';\nimport {useUndoableStoriesContext} from '../../../store/undoable-stories';\nimport {IconButton} from '../../../components/control/icon-button';\n\nexport const UndoRedoButtons: React.FC = () => {\n\tconst {redo, redoLabel, undo, undoLabel} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!undo}\n\t\t\t\ticon={<IconArrowBack />}\n\t\t\t\tlabel={undoLabel ?? t('common.undo')}\n\t\t\t\tonClick={undo}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!redo}\n\t\t\t\ticon={<IconArrowForward />}\n\t\t\t\tlabel={redoLabel ?? t('common.redo')}\n\t\t\t\tonClick={redo}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {AppActions, BuildActions} from '../../../route-actions';\nimport {Story} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {PassageActions} from './passage/passage-actions';\nimport {StoryActions} from './story/story-actions';\nimport {UndoRedoButtons} from './undo-redo-buttons';\n\nexport interface StoryEditToolbarProps {\n\tgetCenter: () => Point;\n\tonOpenFuzzyFinder: () => void;\n\tstory: Story;\n}\n\nexport const StoryEditToolbar: React.FC<StoryEditToolbarProps> = props => {\n\tconst {getCenter, onOpenFuzzyFinder, story} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\tpinnedControls={<UndoRedoButtons />}\n\t\t\ttabs={{\n\t\t\t\t[t('common.passage')]: (\n\t\t\t\t\t<PassageActions\n\t\t\t\t\t\tgetCenter={getCenter}\n\t\t\t\t\t\tonOpenFuzzyFinder={onOpenFuzzyFinder}\n\t\t\t\t\t\tstory={story}\n\t\t\t\t\t/>\n\t\t\t\t),\n\t\t\t\t[t('common.story')]: <StoryActions story={story} />,\n\t\t\t\t[t('common.build')]: <BuildActions story={story} />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {quadOut} from 'eases';\nimport {Point} from '../../util/geometry';\n\n/**\n * Information about a single zoom transition.\n */\ninterface ZoomTransition {\n\t/**\n\t * How much time has elapsed, in seconds.\n\t */\n\telapsed: number;\n\t/**\n\t * The last timestamp an update was done, in seconds.\n\t */\n\tlastTimestamp?: number;\n\t/**\n\t * The point the scrollTarget was centered on when the transition began,\n\t * normalized for zoom level. e.g. if it was centered on (100, 100) but the\n\t * story zoom was 0.5, this is (200, 200).\n\t */\n\tscrollNormalizedCenter: Point;\n\t/**\n\t * The current point the scrollTarget is centered on.\n\t */\n\tscrollCenter: {\n\t\theight: number;\n\t\twidth: number;\n\t};\n\t/**\n\t * The element whose scroll position is being maintained.\n\t */\n\tscrollTarget: HTMLElement;\n\t/**\n\t * How the zoom is changing during this transition.\n\t */\n\tzoom: {\n\t\tstart: number;\n\t\tchange: number;\n\t};\n}\n\n/**\n * Runs a single step of the zoom transition. This is outside the effect to\n * avoid dependencies.\n * @param setter Setter function for the zoom value\n * @param start Value of the zoom when the transition began\n * @param change Change in zoom value for the entire transition\n * @param time Elapsed time in seconds--assumes total time is 1 second\n * \n * @return transitioned value of zoom\n */\nfunction transitionStep(\n\tsetter: React.Dispatch<React.SetStateAction<number>>,\n\tstart: number,\n\tchange: number,\n\ttime: number\n) {\n\tlet value: number;\n\n\tif (time < 1) {\n\t\t// Step toward the change.\n\n\t\tvalue = start + change * quadOut(time);\n\t\tsetter(value);\n\t\treturn value;\n\t}\n\n\t// We're done.\n\n\tsetter(start + change);\n}\n\n/**\n * Manages transitioning zoom level of a story while maintaining the scroll\n * position's focus. This is meant to be called repeatedly with different\n * values, and returns the _visible_ zoom--what the user should see as zoom\n * value, which gradually changes over time.\n *\n * @param target Zoom value to transition towrds\n * @param scrollTarget DOM element whose scroll position should be manipulated\n * to match the returned value\n */\nexport function useZoomTransition(\n\ttarget: number,\n\tscrollTarget: HTMLElement | null\n) {\n\tconst [current, setCurrent] = React.useState(target);\n\tconst transition = React.useRef<ZoomTransition>();\n\n\t// This queues a single transition step using requestAnimationFrame. It's\n\t// crucial that this callback have no dependencies; otherwise things could get\n\t// confused in the middle of a transition.\n\n\tconst step = React.useCallback(() => {\n\t\tif (!transition.current) {\n\t\t\treturn;\n\t\t}\n\n\t\twindow.requestAnimationFrame(timestamp => {\n\t\t\tconst t = transition.current as ZoomTransition;\n\n\t\t\tif (t.lastTimestamp) {\n\t\t\t\t// Complete the transition in 0.5 seconds, not 1.\n\t\t\t\tt.elapsed += (timestamp - t.lastTimestamp) / 500;\n\t\t\t\tt.lastTimestamp = timestamp;\n\n\t\t\t\tconst value = transitionStep(\n\t\t\t\t\tsetCurrent,\n\t\t\t\t\tt.zoom.start,\n\t\t\t\t\tt.zoom.change,\n\t\t\t\t\tt.elapsed\n\t\t\t\t);\n\n\t\t\t\tif (value) {\n\t\t\t\t\t// Sync scroll position and request a new animation step.\n\n\t\t\t\t\tconst newLeft =\n\t\t\t\t\t\tt.scrollNormalizedCenter.left * value - t.scrollCenter.width;\n\t\t\t\t\tconst newTop =\n\t\t\t\t\t\tt.scrollNormalizedCenter.top * value - t.scrollCenter.height;\n\n\t\t\t\t\tif (newLeft >= 0 && newTop >= 0) {\n\t\t\t\t\t\tt.scrollTarget.scrollLeft = newLeft;\n\t\t\t\t\t\tt.scrollTarget.scrollTop = newTop;\n\t\t\t\t\t}\n\n\t\t\t\t\tstep();\n\t\t\t\t} else {\n\t\t\t\t\t// We've reached the end.\n\t\t\t\t\ttransition.current = undefined;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// This is the first time we've been called in a transition. Record the\n\t\t\t\t// timestamp and try again.\n\n\t\t\t\tt.lastTimestamp = timestamp;\n\t\t\t\tstep();\n\t\t\t}\n\t\t});\n\t}, []);\n\n\t// Start a new transition.\n\n\tReact.useEffect(() => {\n\t\tif (!transition.current && current !== target && scrollTarget) {\n\t\t\ttransition.current = {\n\t\t\t\tscrollTarget,\n\t\t\t\telapsed: 0,\n\t\t\t\tscrollNormalizedCenter: {\n\t\t\t\t\tleft:\n\t\t\t\t\t\t(scrollTarget.scrollLeft + scrollTarget.clientWidth / 2) / current,\n\t\t\t\t\ttop:\n\t\t\t\t\t\t(scrollTarget.scrollTop + scrollTarget.clientHeight / 2) / current\n\t\t\t\t},\n\t\t\t\tscrollCenter: {\n\t\t\t\t\theight: scrollTarget.clientHeight / 2,\n\t\t\t\t\twidth: scrollTarget.clientWidth / 2\n\t\t\t\t},\n\t\t\t\tzoom: {\n\t\t\t\t\tstart: current,\n\t\t\t\t\tchange: target - current\n\t\t\t\t}\n\t\t\t};\n\t\t\twindow.requestAnimationFrame(step);\n\t\t}\n\t}, [current, scrollTarget, step, target]);\n\n\treturn current;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconGridDots, IconLayoutGrid, IconSquare} from '@tabler/icons';\nimport {IconButton} from '../../components/control/icon-button';\nimport {updateStory, useStoriesContext, Story} from '../../store/stories';\nimport {ButtonCard} from '../../components/container/button-card';\nimport './zoom-buttons.css';\nimport {useScrollbarSize} from 'react-scrollbar-size';\n\nexport interface ZoomButtonsProps {\n\tstory: Story;\n}\n\nexport const ZoomButtons: React.FC<ZoomButtonsProps> = React.memo(({story}) => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\tconst {height} = useScrollbarSize();\n\n\tconst handleZoomChange = React.useCallback(\n\t\t(zoom: number) => {\n\t\t\tdispatch(updateStory(stories, story, {zoom}));\n\t\t},\n\t\t[dispatch, stories, story]\n\t);\n\n\tconst style: React.CSSProperties = {\n\t\tmarginBottom: height\n\t};\n\n\treturn (\n\t\t<div className=\"zoom-buttons\" style={style}>\n\t\t\t<ButtonCard>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconSquare />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.passageNamesAndExcerpts')}\n\t\t\t\t\tonClick={() => handleZoomChange(1)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 1}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconLayoutGrid />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.passageNames')}\n\t\t\t\t\tonClick={() => handleZoomChange(0.6)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 0.6}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconGridDots />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.storyStructure')}\n\t\t\t\t\tonClick={() => handleZoomChange(0.3)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 0.3}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t</ButtonCard>\n\t\t</div>\n\t);\n});\n\nZoomButtons.displayName = 'ZoomButtons';","import {IconChevronsRight} from '@tabler/icons';\nimport classNames from 'classnames';\nimport * as React from 'react';\nimport './fuzzy-finder-result.css';\n\nexport interface FuzzyFinderResultProps {\n\tdetail: string;\n\theading: string;\n\tonClick: () => void;\n\tselected?: boolean;\n}\n\nexport const FuzzyFinderResult: React.FC<FuzzyFinderResultProps> = props => {\n\tconst {detail, heading, onClick, selected} = props;\n\n\treturn (\n\t\t<button\n\t\t\tclassName={classNames('fuzzy-finder-result', {selected})}\n\t\t\tonClick={onClick}\n\t\t>\n\t\t\t<IconChevronsRight />\n\t\t\t<span className=\"heading\">{heading}</span>\n\t\t\t<span className=\"detail\">{detail}</span>\n\t\t</button>\n\t);\n};\n","import {IconX} from '@tabler/icons';\nimport classnames from 'classnames';\nimport * as React from 'react';\nimport {useHotkeys} from 'react-hotkeys-hook';\nimport {Card} from '../container/card';\nimport {IconButton} from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport {FuzzyFinderResult, FuzzyFinderResultProps} from './fuzzy-finder-result';\nimport './fuzzy-finder.css';\n\nfunction elementIsFocused(element: HTMLElement | null): boolean {\n\treturn !!(element && document.activeElement === element);\n}\n\nexport interface FuzzyFinderProps {\n\tnoResultsText: string;\n\tonChangeSearch: (value: string) => void;\n\tonClose: () => void;\n\tonSelectResult: (index: number) => void;\n\tprompt: string;\n\tresults: Omit<FuzzyFinderResultProps, 'onClick'>[];\n\tsearch: string;\n}\n\nexport const FuzzyFinder: React.FC<FuzzyFinderProps> = props => {\n\tconst {\n\t\tnoResultsText,\n\t\tonChangeSearch,\n\t\tonClose,\n\t\tonSelectResult,\n\t\tprompt,\n\t\tsearch,\n\t\tresults\n\t} = props;\n\tconst [selectedResult, setSelectedResult] = React.useState(0);\n\tconst containerRef = React.useRef<HTMLDivElement>(null);\n\tconst inputRef = React.useRef<HTMLInputElement>(null);\n\tuseHotkeys(\n\t\t'escape',\n\t\tonClose,\n\t\t{\n\t\t\tenableOnTags: ['INPUT'],\n\t\t\tfilter: () => elementIsFocused(inputRef.current)\n\t\t},\n\t\t[onClose]\n\t);\n\tuseHotkeys(\n\t\t'return',\n\t\t() => onSelectResult(selectedResult),\n\t\t{\n\t\t\tenableOnTags: ['INPUT'],\n\t\t\tfilter: () => elementIsFocused(inputRef.current)\n\t\t},\n\t\t[onSelectResult, selectedResult]\n\t);\n\tuseHotkeys(\n\t\t'up',\n\t\t() =>\n\t\t\tsetSelectedResult(value =>\n\t\t\t\tvalue === 0 ? results.length - 1 : value - 1\n\t\t\t),\n\t\t{\n\t\t\tenableOnTags: ['INPUT'],\n\t\t\tfilter: () => elementIsFocused(inputRef.current)\n\t\t},\n\t\t[onSelectResult, selectedResult]\n\t);\n\tuseHotkeys(\n\t\t'down',\n\t\t() =>\n\t\t\tsetSelectedResult(value =>\n\t\t\t\tvalue === results.length - 1 ? 0 : value + 1\n\t\t\t),\n\t\t{\n\t\t\tenableOnTags: ['INPUT'],\n\t\t\tfilter: () => elementIsFocused(inputRef.current)\n\t\t},\n\t\t[onSelectResult, selectedResult]\n\t);\n\n\tReact.useEffect(() => {\n\t\t// Automatically focus the search input on mount.\n\t\t//\n\t\t// This timeout is needed to avoid stealing focus too early. If this\n\t\t// component is mounted in reaction to a hotkey, the input will receive the\n\t\t// hotkey input.\n\n\t\tconst timeout = window.setTimeout(() => {\n\t\t\tif (containerRef.current) {\n\t\t\t\tcontainerRef.current.querySelector('input')?.focus();\n\t\t\t}\n\t\t}, 0);\n\n\t\treturn () => window.clearTimeout(timeout);\n\t}, []);\n\n\treturn (\n\t\t<div className=\"fuzzy-finder\" ref={containerRef}>\n\t\t\t<Card>\n\t\t\t\t<div className=\"search\">\n\t\t\t\t\t<TextInput\n\t\t\t\t\t\tonChange={event => onChangeSearch(event.target.value)}\n\t\t\t\t\t\tref={inputRef}\n\t\t\t\t\t\tvalue={search}\n\t\t\t\t\t>\n\t\t\t\t\t\t{prompt}\n\t\t\t\t\t</TextInput>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\ticonOnly\n\t\t\t\t\t\tlabel=\"Close\"\n\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\ttooltipPosition=\"bottom\"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclassName={classnames('results', {'has-results': results.length > 0})}\n\t\t\t\t>\n\t\t\t\t\t{search.length > 0 && results.length === 0 && (\n\t\t\t\t\t\t<div className=\"no-results\">{noResultsText}</div>\n\t\t\t\t\t)}\n\t\t\t\t\t{search.length > 0 && results.length > 0 && (\n\t\t\t\t\t\t<ol>\n\t\t\t\t\t\t\t{results.map((props, index) => (\n\t\t\t\t\t\t\t\t<li key={props.heading}>\n\t\t\t\t\t\t\t\t\t<FuzzyFinderResult\n\t\t\t\t\t\t\t\t\t\t{...props}\n\t\t\t\t\t\t\t\t\t\tonClick={() => onSelectResult(index)}\n\t\t\t\t\t\t\t\t\t\tselected={index === selectedResult}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ol>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import {debounce} from 'lodash';\nimport * as React from 'react';\nimport {useHotkeys} from 'react-hotkeys-hook';\nimport {useTranslation} from 'react-i18next';\nimport {CSSTransition} from 'react-transition-group';\nimport {FuzzyFinder} from '../../components/fuzzy-finder';\nimport {\n\tpassagesMatchingFuzzySearch,\n\tselectPassage,\n\tStory,\n\tuseStoriesContext\n} from '../../store/stories';\nimport {Point} from '../../util/geometry';\n\nexport interface PassageFuzzyFinderProps {\n\tonClose: () => void;\n\tonOpen: () => void;\n\topen?: boolean;\n\tsetCenter: (value: Point) => void;\n\tstory: Story;\n}\n\nexport const PassageFuzzyFinder: React.FC<PassageFuzzyFinderProps> = props => {\n\tconst {onClose, onOpen, open, setCenter, story} = props;\n\tconst {dispatch} = useStoriesContext();\n\tconst [search, setSearch] = React.useState('');\n\tconst [debouncedSearch, setDebouncedSearch] = React.useState('');\n\tconst updateDebouncedSearch = React.useMemo(\n\t\t() =>\n\t\t\tdebounce(\n\t\t\t\t(value: string) => {\n\t\t\t\t\tsetDebouncedSearch(value);\n\t\t\t\t},\n\t\t\t\t100,\n\t\t\t\t{leading: true, trailing: true}\n\t\t\t),\n\t\t[]\n\t);\n\tconst matches = React.useMemo(\n\t\t() => passagesMatchingFuzzySearch(story.passages, debouncedSearch),\n\t\t[debouncedSearch, story.passages]\n\t);\n\tconst results = React.useMemo(\n\t\t() =>\n\t\t\tmatches.map(({name, text}) => ({\n\t\t\t\theading: name,\n\t\t\t\tdetail: text\n\t\t\t})),\n\t\t[matches]\n\t);\n\tuseHotkeys('p', onOpen);\n\tconst {t} = useTranslation();\n\n\tfunction handleChangeSearch(value: string) {\n\t\tsetSearch(value);\n\t\tupdateDebouncedSearch(value);\n\t}\n\n\tfunction handleSelectResult(index: number) {\n\t\tsetCenter(matches[index]);\n\t\tdispatch(selectPassage(story, matches[index], true));\n\t\tsetSearch('');\n\t\tonClose();\n\t}\n\n\treturn (\n\t\t<CSSTransition\n\t\t\tclassNames=\"pop\"\n\t\t\tmountOnEnter\n\t\t\ttimeout={200}\n\t\t\tunmountOnExit\n\t\t\tin={open}\n\t\t>\n\t\t\t<FuzzyFinder\n\t\t\t\tnoResultsText={t('components.passageFuzzyFinder.noResults')}\n\t\t\t\tonClose={onClose}\n\t\t\t\tonChangeSearch={handleChangeSearch}\n\t\t\t\tonSelectResult={handleSelectResult}\n\t\t\t\tprompt={t('components.passageFuzzyFinder.prompt')}\n\t\t\t\tsearch={search}\n\t\t\t\tresults={results}\n\t\t\t/>\n\t\t</CSSTransition>\n\t);\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {MainContent} from '../../components/container/main-content';\nimport {DocumentTitle} from '../../components/document-title/document-title';\nimport {DialogsContextProvider} from '../../dialogs';\nimport {storyWithId} from '../../store/stories';\nimport {\n\tUndoableStoriesContextProvider,\n\tuseUndoableStoriesContext\n} from '../../store/undoable-stories';\nimport {MarqueeablePassageMap} from './marqueeable-passage-map';\nimport {StoryEditToolbar} from './toolbar';\nimport {useInitialPassageCreation} from './use-initial-passage-creation';\nimport {usePassageChangeHandlers} from './use-passage-change-handlers';\nimport {useViewCenter} from './use-view-center';\nimport {useZoomShortcuts} from './use-zoom-shortcuts';\nimport {useZoomTransition} from './use-zoom-transition';\nimport {ZoomButtons} from './zoom-buttons';\nimport './story-edit-route.css';\nimport {PassageFuzzyFinder} from './passage-fuzzy-finder';\n\nexport const InnerStoryEditRoute: React.FC = () => {\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {stories} = useUndoableStoriesContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst [fuzzyFinderOpen, setFuzzyFinderOpen] = React.useState(false);\n\tconst mainContent = React.useRef<HTMLDivElement>(null);\n\tconst {getCenter, setCenter} = useViewCenter(story, mainContent);\n\tconst {\n\t\thandleDeselectPassage,\n\t\thandleDragPassages,\n\t\thandleEditPassage,\n\t\thandleSelectPassage,\n\t\thandleSelectRect\n\t} = usePassageChangeHandlers(story);\n\tconst visibleZoom = useZoomTransition(story.zoom, mainContent.current);\n\n\tuseZoomShortcuts(story);\n\tuseInitialPassageCreation(story, getCenter);\n\n\treturn (\n\t\t<div className=\"story-edit-route\">\n\t\t\t<DocumentTitle title={story.name} />\n\t\t\t<StoryEditToolbar\n\t\t\t\tgetCenter={getCenter}\n\t\t\t\tonOpenFuzzyFinder={() => setFuzzyFinderOpen(true)}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<MainContent grabbable padded={false} ref={mainContent}>\n\t\t\t\t<MarqueeablePassageMap\n\t\t\t\t\tcontainer={mainContent}\n\t\t\t\t\tformatName={story.storyFormat}\n\t\t\t\t\tformatVersion={story.storyFormatVersion}\n\t\t\t\t\tonDeselect={handleDeselectPassage}\n\t\t\t\t\tonDrag={handleDragPassages}\n\t\t\t\t\tonEdit={handleEditPassage}\n\t\t\t\t\tonSelect={handleSelectPassage}\n\t\t\t\t\tonSelectRect={handleSelectRect}\n\t\t\t\t\tpassages={story.passages}\n\t\t\t\t\tstartPassageId={story.startPassage}\n\t\t\t\t\ttagColors={story.tagColors}\n\t\t\t\t\tvisibleZoom={visibleZoom}\n\t\t\t\t\tzoom={story.zoom}\n\t\t\t\t/>\n\t\t\t\t<PassageFuzzyFinder\n\t\t\t\t\tonClose={() => setFuzzyFinderOpen(false)}\n\t\t\t\t\tonOpen={() => setFuzzyFinderOpen(true)}\n\t\t\t\t\topen={fuzzyFinderOpen}\n\t\t\t\t\tsetCenter={setCenter}\n\t\t\t\t\tstory={story}\n\t\t\t\t/>\n\t\t\t\t<ZoomButtons story={story} />\n\t\t\t</MainContent>\n\t\t</div>\n\t);\n};;;;\n\n// This is a separate component so that the inner one can use\n// `useDialogsContext()` and `useUndoableStoriesContext()` inside it.\n\nexport const StoryEditRoute: React.FC = () => (\n\t<UndoableStoriesContextProvider>\n\t\t<DialogsContextProvider>\n\t\t\t<InnerStoryEditRoute />\n\t\t</DialogsContextProvider>\n\t</UndoableStoriesContextProvider>\n);\n","import * as React from 'react';\nimport {useDialogsContext} from '../../dialogs';\nimport {usePrefsContext} from '../../store/prefs';\nimport {Story} from '../../store/stories';\nimport {Point} from '../../util/geometry';\n\nexport function useViewCenter(\n\tstory: Story,\n\telementRef: React.RefObject<HTMLElement>\n) {\n\tconst {dialogs} = useDialogsContext();\n\tconst {prefs} = usePrefsContext();\n\n\tconst getCenter = React.useCallback(() => {\n\t\tif (!elementRef.current) {\n\t\t\tthrow new Error(\n\t\t\t\t'Asked for the center of an element, but it does not exist in the DOM yet'\n\t\t\t);\n\t\t}\n\n\t\treturn {\n\t\t\tleft:\n\t\t\t\t(elementRef.current.scrollLeft + elementRef.current.clientWidth / 2) /\n\t\t\t\tstory.zoom,\n\t\t\ttop:\n\t\t\t\t(elementRef.current.scrollTop + elementRef.current.clientHeight / 2) /\n\t\t\t\tstory.zoom\n\t\t};\n\t}, [elementRef, story.zoom]);\n\n\tconst setCenter = React.useCallback(\n\t\t({left, top}: Point) => {\n\t\t\tif (!elementRef.current) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'Asked to set the center of an element, but it does not exist in the DOM yet'\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst {height, width} = elementRef.current.getBoundingClientRect();\n\t\t\tconst scroll = {\n\t\t\t\tleft: (left - width / story.zoom / 2) * story.zoom,\n\t\t\t\ttop: (top - height / story.zoom / 2) * story.zoom\n\t\t\t};\n\n\t\t\tif (dialogs.length > 0) {\n\t\t\t\tscroll.left += prefs.dialogWidth / 2;\n\t\t\t}\n\n\t\t\telementRef.current.scrollTo(scroll);\n\t\t},\n\t\t[dialogs.length, elementRef, prefs.dialogWidth, story.zoom]\n\t);\n\n\treturn {getCenter, setCenter};\n}\n","import * as React from 'react';\nimport {addPassageEditors, useDialogsContext} from '../../dialogs';\nimport {\n\tdeselectPassage,\n\tmovePassages,\n\tPassage,\n\tselectPassage,\n\tselectPassagesInRect,\n\tStory\n} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Point, Rect} from '../../util/geometry';\n\nexport function usePassageChangeHandlers(story: Story) {\n\tconst selectedPassages = React.useMemo(\n\t\t() => story.passages.filter(passage => passage.selected),\n\t\t[story.passages]\n\t);\n\tconst {dispatch: undoableStoriesDispatch} = useUndoableStoriesContext();\n\tconst {dispatch: dialogsDispatch} = useDialogsContext();\n\n\tconst handleDeselectPassage = React.useCallback(\n\t\t(passage: Passage) =>\n\t\t\tundoableStoriesDispatch(deselectPassage(story, passage)),\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleDragPassages = React.useCallback(\n\t\t(change: Point) => {\n\t\t\t// Ignore tiny drags--they're probably caused by the user moving their\n\t\t\t// mouse slightly during double-clicking.\n\n\t\t\tif (Math.abs(change.left) < 1 && Math.abs(change.top) < 1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tmovePassages(\n\t\t\t\t\tstory,\n\t\t\t\t\tstory.passages.reduce<string[]>(\n\t\t\t\t\t\t(result, current) =>\n\t\t\t\t\t\t\tcurrent.selected ? [...result, current.id] : result,\n\t\t\t\t\t\t[]\n\t\t\t\t\t),\n\t\t\t\t\tchange.left / story.zoom,\n\t\t\t\t\tchange.top / story.zoom\n\t\t\t\t),\n\t\t\t\tselectedPassages.length > 1\n\t\t\t\t\t? 'undoChange.movePassages'\n\t\t\t\t\t: 'undoChange.movePassages'\n\t\t\t);\n\t\t},\n\t\t[selectedPassages.length, story, undoableStoriesDispatch]\n\t);\n\n\tconst handleEditPassage = React.useCallback(\n\t\t(passage: Passage) =>\n\t\t\tdialogsDispatch(addPassageEditors(story.id, [passage.id])),\n\t\t[dialogsDispatch, story.id]\n\t);\n\n\tconst handleSelectPassage = React.useCallback(\n\t\t(passage: Passage, exclusive: boolean) =>\n\t\t\tundoableStoriesDispatch(selectPassage(story, passage, exclusive)),\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleSelectRect = React.useCallback(\n\t\t(rect: Rect, additive: boolean) => {\n\t\t\t// The rect we receive is in screen coordinates--we need to convert to\n\t\t\t// logical ones.\n\t\t\tconst logicalRect: Rect = {\n\t\t\t\theight: rect.height / story.zoom,\n\t\t\t\tleft: rect.left / story.zoom,\n\t\t\t\ttop: rect.top / story.zoom,\n\t\t\t\twidth: rect.width / story.zoom\n\t\t\t};\n\n\t\t\t// This should not be undoable.\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tselectPassagesInRect(\n\t\t\t\t\tstory,\n\t\t\t\t\tlogicalRect,\n\t\t\t\t\tadditive ? selectedPassages.map(passage => passage.id) : []\n\t\t\t\t)\n\t\t\t);\n\t\t},\n\t\t[selectedPassages, story, undoableStoriesDispatch]\n\t);\n\n\treturn {\n\t\thandleDeselectPassage,\n\t\thandleDragPassages,\n\t\thandleEditPassage,\n\t\thandleSelectPassage,\n\t\thandleSelectRect\n\t};\n}\n","import {useHotkeys} from 'react-hotkeys-hook';\nimport {Story, updateStory, useStoriesContext} from '../../store/stories';\n\nexport function useZoomShortcuts(story: Story) {\n\tconst {dispatch, stories} = useStoriesContext();\n\n\tuseHotkeys(\n\t\t'-',\n\t\t() => {\n\t\t\tswitch (story.zoom) {\n\t\t\t\tcase 1:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.6}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase 0.6:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.3}));\n\t\t\t\t\tbreak;\n\t\t\t\t// Do nothing if zoom is 0.3\n\t\t\t}\n\t\t},\n\t\t{keydown: false, keyup: true},\n\t\t[dispatch, stories, story]\n\t);\n\tuseHotkeys(\n\t\t'=',\n\t\t() => {\n\t\t\tswitch (story.zoom) {\n\t\t\t\tcase 0.3:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.6}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase 0.6:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 1}));\n\t\t\t\t\tbreak;\n\t\t\t\t// Do nothing if zoom is 1\n\t\t\t}\n\t\t},\n\t\t{keydown: false, keyup: true},\n\t\t[dispatch, stories, story]\n\t);\n}\n","import * as React from 'react';\nimport {createUntitledPassage, Story} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Point} from '../../util/geometry';\n\nexport function useInitialPassageCreation(\n\tstory: Story,\n\tgetCenter: () => Point\n) {\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst [inited, setInited] = React.useState(false);\n\n\t// If we have just mounted and the story has no passages, create one for the\n\t// user (and skip undo history, since it was an automatic action).\n\n\tReact.useEffect(() => {\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\n\t\t\tif (story.passages.length === 0) {\n\t\t\t\tconst center = getCenter();\n\n\t\t\t\tdispatch(createUntitledPassage(story, center.left, center.top));\n\t\t\t}\n\t\t}\n\t}, [dispatch, getCenter, inited, story]);\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {isElectronRenderer} from '../../util/is-electron';\nimport './storage-quota.css';\n\nexport interface StorageQuotaProps {\n\twatch: any;\n}\n\nexport const StorageQuota: React.FC<StorageQuotaProps> = props => {\n\tconst {watch} = props;\n\tconst [lastWatch, setLastWatch] = React.useState<any>();\n\tconst [working, setWorking] = React.useState(false);\n\tconst [percentFree, setPercentFree] = React.useState<string>();\n\n\t// This is set to -1 so that we can hide the percentage while doing the\n\t// initial calculation. Later ones will show the same percentage but with a\n\t// loading icon beside it until finishes.\n\n\tconst {t} = useTranslation();\n\n\tconst hide = isElectronRenderer() || !navigator.storage?.estimate;\n\n\t// When the watch prop changes, start calculating space.\n\n\tReact.useEffect(() => {\n\t\tasync function run() {\n\t\t\tsetWorking(true);\n\n\t\t\tconst {quota, usage} = await navigator.storage.estimate();\n\n\t\t\tif (quota !== undefined && usage !== undefined) {\n\t\t\t\tsetPercentFree(((1 - usage / quota) * 100).toFixed(0));\n\t\t\t}\n\n\t\t\tsetLastWatch(watch);\n\t\t\tsetWorking(false);\n\t\t}\n\n\t\tif (!hide && !working && lastWatch !== watch) {\n\t\t\trun();\n\t\t}\n\t}, [hide, lastWatch, watch, working]);\n\n\tif (hide) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<span className=\"storage-quota\">\n\t\t\t{percentFree &&\n\t\t\t\tt('components.storageQuota.freeSpace', {\n\t\t\t\t\tpercent: percentFree\n\t\t\t\t})}\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPackage} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {useStoriesContext} from '../../../../store/stories';\nimport {archiveFilename, publishArchive} from '../../../../util/publish';\nimport {saveHtml} from '../../../../util/save-file';\nimport {getAppInfo} from '../../../../util/app-info';\n\nexport const ArchiveButton: React.FC = () => {\n\tconst {stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPackage />}\n\t\t\tlabel={t('routes.storyList.toolbar.archive')}\n\t\t\tonClick={() =>\n\t\t\t\tsaveHtml(publishArchive(stories, getAppInfo()), archiveFilename())\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconFileImport} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryImportDialog, useDialogsContext} from '../../../../dialogs';\n\nexport const ImportStoryButton: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconFileImport />}\n\t\t\tlabel={t('common.import')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({type: 'addDialog', component: StoryImportDialog})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconTags} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryTagsDialog, useDialogsContext} from '../../../../dialogs';\n\nexport const StoryTagsButton: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconTags />}\n\t\t\tlabel={t('routes.storyList.toolbar.storyTags')}\n\t\t\tonClick={() => {\n\t\t\t\tdispatch({type: 'addDialog', component: StoryTagsDialog});\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {ArchiveButton} from './archive-button';\nimport {ImportStoryButton} from './import-story-button';\nimport {StoryTagsButton} from './story-tags-button';\n\nexport const LibraryActions: React.FC = () => (\n\t<ButtonBar>\n\t\t<StoryTagsButton />\n\t\t<ImportStoryButton />\n\t\t<ArchiveButton />\n\t</ButtonBar>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconPlus} from '@tabler/icons';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {\n\tcreateStory,\n\tstoryDefaults,\n\tuseStoriesContext\n} from '../../../../store/stories';\nimport {PromptButton} from '../../../../components/control/prompt-button';\nimport {unusedName} from '../../../../util/unused-name';\n\nexport const CreateStoryButton: React.FC = () => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst [newName, setNewName] = React.useState(\n\t\tunusedName(\n\t\t\tstoryDefaults().name,\n\t\t\tstories.map(story => story.name)\n\t\t)\n\t);\n\tconst history = useHistory();\n\tconst {prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tfunction validateName(value: string) {\n\t\tif (value.trim() === '') {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\tmessage: t('routes.storyList.toolbar.createStoryButton.emptyName')\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\tstories.some(story => story.name.toLowerCase() === value.toLowerCase())\n\t\t) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\tmessage: t('routes.storyList.toolbar.createStoryButton.nameConflict')\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\tfunction handleSubmit() {\n\t\tconst id = createStory(stories, prefs, {name: newName})(\n\t\t\tdispatch,\n\t\t\t() => stories\n\t\t);\n\n\t\thistory.push(`/stories/${id}`);\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconPlus />}\n\t\t\tlabel={t('common.new')}\n\t\t\tsubmitLabel={t('common.create')}\n\t\t\tsubmitVariant=\"create\"\n\t\t\tonChange={e => setNewName(e.target.value)}\n\t\t\tonSubmit={handleSubmit}\n\t\t\tprompt={t('routes.storyList.toolbar.createStoryButton.prompt')}\n\t\t\tvalidate={validateName}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n","import {IconCheck, IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton, CardButtonProps} from './card-button';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './confirm-button.css';\n\nexport interface ConfirmButtonProps\n\textends Omit<CardButtonProps, 'ariaLabel' | 'open' | 'onChangeOpen'> {\n\tcancelIcon?: React.ReactNode;\n\tcancelLabel?: string;\n\tconfirmIcon?: React.ReactNode;\n\tconfirmLabel?: string;\n\tconfirmVariant?: IconButtonProps['variant'];\n\tonConfirm: () => void;\n\tprompt: string;\n}\n\nexport const ConfirmButton: React.FC<ConfirmButtonProps> = props => {\n\tconst {\n\t\tcancelIcon,\n\t\tcancelLabel,\n\t\tconfirmIcon,\n\t\tconfirmLabel,\n\t\tconfirmVariant,\n\t\tonConfirm,\n\t\tprompt,\n\t\t...other\n\t} = props;\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\tfunction handleConfirm() {\n\t\tsetOpen(false);\n\t\tonConfirm();\n\t}\n\n\treturn (\n\t\t<span className=\"confirm-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={prompt}\n\t\t\t\tfocusSelector=\"button:nth-child(2)\"\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t\t{...other}\n\t\t\t>\n\t\t\t\t<div>\n\t\t\t\t\t<CardContent>{prompt}</CardContent>\n\t\t\t\t\t<ButtonBar>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={confirmIcon ?? <IconCheck />}\n\t\t\t\t\t\t\tlabel={confirmLabel ?? t('common.ok')}\n\t\t\t\t\t\t\tonClick={handleConfirm}\n\t\t\t\t\t\t\tvariant={confirmVariant ?? 'primary'}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={cancelIcon ?? <IconX />}\n\t\t\t\t\t\t\tlabel={cancelLabel ?? t('common.cancel')}\n\t\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</ButtonBar>\n\t\t\t\t</div>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ConfirmButton} from '../../../../components/control/confirm-button';\nimport {deleteStory, Story, useStoriesContext} from '../../../../store/stories';\nimport {isElectronRenderer} from '../../../../util/is-electron';\n\nexport interface DeleteStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const DeleteStoryButton: React.FC<DeleteStoryButtonProps> = ({\n\tstory\n}) => {\n\t// We need to store a local copy of the story name so that after it's deleted,\n\t// the prompt doesn't change as it transitions out.\n\tconst [storyName, setStoryName] = React.useState(story?.name);\n\tconst {dispatch} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (story?.name) {\n\t\t\tsetStoryName(story.name);\n\t\t}\n\t}, [story?.name]);\n\n\treturn (\n\t\t<ConfirmButton\n\t\t\tconfirmIcon={<IconTrash />}\n\t\t\tconfirmLabel={t('common.delete')}\n\t\t\tconfirmVariant=\"danger\"\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={t('common.delete')}\n\t\t\tonConfirm={story ? () => dispatch(deleteStory(story)) : () => {}}\n\t\t\tprompt={t(\n\t\t\t\t`routes.storyList.toolbar.deleteStoryButton.warning.${\n\t\t\t\t\tisElectronRenderer() ? 'electron' : 'web'\n\t\t\t\t}`,\n\t\t\t\t{storyName}\n\t\t\t)}\n\t\t/>\n\t);\n};\n","import {IconCopy} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tduplicateStory,\n\tStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface DuplicateStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const DuplicateStoryButton: React.FC<DuplicateStoryButtonProps> = ({\n\tstory\n}) => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story set');\n\t\t}\n\n\t\tdispatch(duplicateStory(story, stories));\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconCopy />}\n\t\t\tlabel={t('common.duplicate')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEdit} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {Story} from '../../../../store/stories';\n\nexport interface EditStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const EditStoryButton: React.FC<EditStoryButtonProps> = ({story}) => {\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconEdit />}\n\t\t\tlabel={t('common.edit')}\n\t\t\tonClick={() => history.push(`/stories/${story?.id}`)}\n\t\t/>\n\t);\n};\n","import {IconTag} from '@tabler/icons';\nimport * as React from 'react';\nimport {AddTagButton} from '../../../../components/tag';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\nimport {\n\tStory,\n\tstoryTags,\n\tupdateStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface TagStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const TagStoryButton: React.FC<TagStoryButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\n\tfunction handleAddTag(tagName: string, tagColor?: string) {\n\t\tif (!story) {\n\t\t\tthrow new Error('Story is unset');\n\t\t}\n\n\t\tstoriesDispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttags: story.tags ? [...story.tags, tagName] : [tagName]\n\t\t\t})\n\t\t);\n\n\t\tif (tagColor) {\n\t\t\tprefsDispatch(\n\t\t\t\tsetPref('storyTagColors', {\n\t\t\t\t\t...prefs.storyTagColors,\n\t\t\t\t\t[tagName]: tagColor\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<AddTagButton\n\t\t\tassignedTags={story?.tags ?? []}\n\t\t\tdisabled={!story}\n\t\t\texistingTags={storyTags(stories)}\n\t\t\ticon={<IconTag />}\n\t\t\tonAdd={handleAddTag}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenameStoryButton} from '../../../../components/story/rename-story-button';\nimport {Story, updateStory, useStoriesContext} from '../../../../store/stories';\nimport {CreateStoryButton} from './create-story-button';\nimport {DeleteStoryButton} from './delete-story-button';\nimport {DuplicateStoryButton} from './duplicate-story-button';\nimport {EditStoryButton} from './edit-story-button';\nimport {TagStoryButton} from './tag-story-button';\n\nexport interface StoryActionsProps {\n\tselectedStory?: Story;\n}\n\nexport const StoryActions: React.FC<StoryActionsProps> = props => {\n\tconst {selectedStory} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CreateStoryButton />\n\t\t\t<EditStoryButton story={selectedStory} />\n\t\t\t<TagStoryButton story={selectedStory} />\n\t\t\t<RenameStoryButton\n\t\t\t\texistingStories={stories}\n\t\t\t\tonRename={name =>\n\t\t\t\t\tdispatch(updateStory(stories, selectedStory!, {name}))\n\t\t\t\t}\n\t\t\t\tstory={selectedStory}\n\t\t\t/>\n\t\t\t<DuplicateStoryButton story={selectedStory} />\n\t\t\t<DeleteStoryButton story={selectedStory} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowsSort} from '@tabler/icons';\nimport {MenuButton} from '../../../../components/control/menu-button';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\n\nexport const SortByButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\tconst {dispatch, prefs} = usePrefsContext();\n\n\treturn (\n\t\t<MenuButton\n\t\t\ticon={<IconArrowsSort />}\n\t\t\titems={[\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListSort === 'date',\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.sortByDate'),\n\t\t\t\t\tonClick: () => dispatch(setPref('storyListSort', 'date'))\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListSort === 'name',\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.sortByName'),\n\t\t\t\t\tonClick: () => dispatch(setPref('storyListSort', 'name'))\n\t\t\t\t}\n\t\t\t]}\n\t\t\tlabel={t('routes.storyList.toolbar.sort')}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconTag} from '@tabler/icons';\nimport {MenuButton} from '../../../../components/control/menu-button';\nimport {usePrefsContext} from '../../../../store/prefs';\n\nexport interface TagFilterButtonProps {\n\ttags: string[];\n}\n\nexport const TagFilterButton: React.FC<TagFilterButtonProps> = props => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<MenuButton\n\t\t\tdisabled={props.tags.length === 0}\n\t\t\ticon={<IconTag />}\n\t\t\titems={[\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListTagFilter.length === 0,\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.showAllStories'),\n\t\t\t\t\tonClick: () =>\n\t\t\t\t\t\tdispatch({type: 'update', name: 'storyListTagFilter', value: []})\n\t\t\t\t},\n\t\t\t\t{separator: true},\n\t\t\t\t...props.tags.map(tag => ({\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListTagFilter.includes(tag),\n\t\t\t\t\tlabel: tag,\n\t\t\t\t\tonClick: () =>\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'update',\n\t\t\t\t\t\t\tname: 'storyListTagFilter',\n\t\t\t\t\t\t\tvalue: prefs.storyListTagFilter.includes(tag)\n\t\t\t\t\t\t\t\t? prefs.storyListTagFilter.filter(t => t !== tag)\n\t\t\t\t\t\t\t\t: [...prefs.storyListTagFilter, tag]\n\t\t\t\t\t\t})\n\t\t\t\t}))\n\t\t\t]}\n\t\t\tlabel={t('routes.storyList.toolbar.showTags')}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {storyTags, useStoriesContext} from '../../../../store/stories';\nimport {SortByButton} from './sort-by-button';\nimport {TagFilterButton} from './tag-filter-button';\n\nexport const ViewActions: React.FC = () => {\n\tconst {stories} = useStoriesContext();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<SortByButton />\n\t\t\t<TagFilterButton tags={storyTags(stories)} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {StorageQuota} from '../../../components/storage-quota/storage-quota';\nimport {BuildActions, AppActions} from '../../../route-actions';\nimport {Story, useStoriesContext} from '../../../store/stories';\nimport {LibraryActions} from './library/library-actions';\nimport {StoryActions} from './story/story-actions';\nimport {ViewActions} from './view/view-actions';\n\nexport interface StoryListToolbarProps {\n\tselectedStories: Story[];\n}\n\nexport const StoryListToolbar: React.FC<StoryListToolbarProps> = props => {\n\tconst {selectedStories} = props;\n\tconst {stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\tconst selectedStory =\n\t\tselectedStories.length === 1 ? selectedStories[0] : undefined;\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\tpinnedControls={<StorageQuota watch={stories} />}\n\t\t\ttabs={{\n\t\t\t\t[t('common.story')]: <StoryActions selectedStory={selectedStory} />,\n\t\t\t\t[t('routes.storyList.library')]: <LibraryActions />,\n\t\t\t\t[t('common.build')]: <BuildActions story={selectedStory} />,\n\t\t\t\t[t('common.view')]: <ViewActions />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","/**\n * Generates a hue (as in the HSL colorspace) for a string.\n */\nexport function hueString(value: string): number {\n\tlet result = 0;\n\n\tfor (let i = 0; i < value.length; i++) {\n\t\tresult += value.charCodeAt(i);\n\t}\n\n\treturn result % 360;\n}\n","import * as React from 'react';\nimport {Story} from '../../store/stories';\nimport {hueString} from '../../util/hue-string';\nimport './story-preview.css';\n\nexport interface StoryPreviewProps {\n\tstory: Story;\n}\n\nexport const StoryPreview: React.FC<StoryPreviewProps> = React.memo(props => {\n\tconst {story} = props;\n\tconst hues = [hueString(story.name)];\n\n\thues.push((hues[0] + 15) % 360);\n\thues.push((hues[0] - 15) % 360);\n\thues.push((hues[0] + 30) % 360);\n\thues.push((hues[0] - 30) % 360);\n\thues.push((hues[0] + 60) % 360);\n\n\tlet minX = Number.POSITIVE_INFINITY;\n\tlet minY = Number.POSITIVE_INFINITY;\n\tlet maxX = Number.NEGATIVE_INFINITY;\n\tlet maxY = Number.NEGATIVE_INFINITY;\n\n\tconst circles = story.passages.map(passage => ({\n\t\tkey: passage.name,\n\t\tx: passage.left + passage.width / 2,\n\t\ty: passage.top + passage.height / 2,\n\t\tradius: Math.max(passage.width, passage.height)\n\t}));\n\n\tconst svg = circles\n\t\t.reduce<[React.ReactNode[], React.ReactNode[]]>(\n\t\t\t(result, circle, index) => {\n\t\t\t\t// We reduce the circles to an array with two elements so that the\n\t\t\t\t// larger, faded circles appear below the smaller, more solid ones.\n\n\t\t\t\tconst bgRadius = circle.radius + 200;\n\n\t\t\t\t// Kind of gross to do side effects in a reduce(), but it saves an O(n).\n\n\t\t\t\tminX = Math.min(minX, circle.x - bgRadius);\n\t\t\t\tminY = Math.min(minY, circle.y - bgRadius);\n\t\t\t\tmaxX = Math.max(maxX, circle.x + bgRadius);\n\t\t\t\tmaxY = Math.max(maxY, circle.y + bgRadius);\n\n\t\t\t\tresult[0].push(\n\t\t\t\t\t<circle\n\t\t\t\t\t\tcx={circle.x}\n\t\t\t\t\t\tcy={circle.y}\n\t\t\t\t\t\tkey={`${circle.key}-bg`}\n\t\t\t\t\t\tr={bgRadius}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfill: `hsl(${hues[index % hues.length]}, 80%, 80%)`\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t);\n\n\t\t\t\tresult[1].push(\n\t\t\t\t\t<circle\n\t\t\t\t\t\tcx={circle.x}\n\t\t\t\t\t\tcy={circle.y}\n\t\t\t\t\t\tkey={`${circle.key}-fg`}\n\t\t\t\t\t\tr={circle.radius}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfill: `hsl(${hues[index % hues.length]}, 80%, 60%)`\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t);\n\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\t[[], []]\n\t\t)\n\t\t.map((nodes, index) => (\n\t\t\t<g className={`story-preview-${index === 0 ? 'bg' : 'fg'}`} key={index}>\n\t\t\t\t{nodes}\n\t\t\t</g>\n\t\t));\n\n\tconst viewBox = `${minX} ${minY} ${maxX - minX} ${maxY - minY}`;\n\n\treturn (\n\t\t<svg\n\t\t\tclassName=\"story-preview\"\n\t\t\tviewBox={viewBox}\n\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t>\n\t\t\t{svg}\n\t\t</svg>\n\t);\n});\n\nStoryPreview.displayName = 'StoryPreview';","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {Story} from '../../store/stories';\nimport {Color} from '../../util/color';\nimport {CardContent, CardProps} from '../container/card';\nimport {SelectableCard} from '../container/card/selectable-card';\nimport {TagButton} from '../tag';\nimport './story-card.css';\nimport {StoryPreview} from './story-preview';\n\nconst dateFormatter = new Intl.DateTimeFormat([]);\n\nexport interface StoryCardProps extends CardProps {\n\tonChangeTagColor: (name: string, color: Color) => void;\n\tonRemoveTag: (name: string) => void;\n\tonEdit: () => void;\n\tonSelect: () => void;\n\tstory: Story;\n\tstoryTagColors: Record<string, Color>;\n}\n\nexport const StoryCard: React.FC<StoryCardProps> = props => {\n\tconst {\n\t\tonChangeTagColor,\n\t\tonEdit,\n\t\tonRemoveTag,\n\t\tonSelect,\n\t\tstory,\n\t\tstoryTagColors,\n\t\t...otherProps\n\t} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"story-card\">\n\t\t\t<SelectableCard\n\t\t\t\t{...otherProps}\n\t\t\t\tlabel={story.name}\n\t\t\t\tonDoubleClick={onEdit}\n\t\t\t\tonSelect={onSelect}\n\t\t\t\tselected={story.selected}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<div className=\"story-card-summary\">\n\t\t\t\t\t\t<div className=\"story-card-summary-preview\">\n\t\t\t\t\t\t\t<StoryPreview story={story} />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div className=\"story-card-summary-text\">\n\t\t\t\t\t\t\t<h2>{story.name}</h2>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t{t('components.storyCard.lastUpdated', {\n\t\t\t\t\t\t\t\t\tdate: dateFormatter.format(story.lastUpdate)\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\t{t('components.storyCard.passageCount', {\n\t\t\t\t\t\t\t\t\tcount: story.passages.length\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{story.tags && (\n\t\t\t\t\t\t<div className=\"tags\">\n\t\t\t\t\t\t\t{story.tags.map(tag => (\n\t\t\t\t\t\t\t\t<TagButton\n\t\t\t\t\t\t\t\t\tcolor={storyTagColors[tag]}\n\t\t\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\t\t\tonChangeColor={color => onChangeTagColor(tag, color)}\n\t\t\t\t\t\t\t\t\tonRemove={() => onRemoveTag(tag)}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</CardContent>\n\t\t\t</SelectableCard>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useHistory} from 'react-router-dom';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {CardGroup} from '../../components/container/card-group';\nimport {StoryCard} from '../../components/story/story-card';\nimport {setPref, usePrefsContext} from '../../store/prefs';\nimport {Story, updateStory} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\n/**\n * How wide a story card should render onscreen as.\n */\nconst cardWidth = '360px';\n\nexport interface StoryCardsProps {\n\tonSelectStory: (story: Story) => void;\n\tstories: Story[];\n}\n\nexport const StoryCards: React.FC<StoryCardsProps> = props => {\n\tconst {onSelectStory, stories} = props;\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {dispatch: storiesDispatch} = useUndoableStoriesContext();\n\tconst history = useHistory();\n\n\tfunction handleChangeTagColor(tagName: string, color: Color) {\n\t\tprefsDispatch(\n\t\t\tsetPref('storyTagColors', {\n\t\t\t\t...prefs.storyTagColors,\n\t\t\t\t[tagName]: color\n\t\t\t})\n\t\t);\n\t}\n\n\tfunction handleRemoveTag(story: Story, tagName: string) {\n\t\tstoriesDispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttags: story.tags.filter(tag => tag !== tagName)\n\t\t\t})\n\t\t);\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<CardGroup columnWidth={cardWidth}>\n\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t{stories.map(story => (\n\t\t\t\t\t\t<CSSTransition classNames=\"pop\" key={story.id} timeout={200}>\n\t\t\t\t\t\t\t<StoryCard\n\t\t\t\t\t\t\t\tonChangeTagColor={handleChangeTagColor}\n\t\t\t\t\t\t\t\tonEdit={() => history.push(`/stories/${story.id}`)}\n\t\t\t\t\t\t\t\tonRemoveTag={name => handleRemoveTag(story, name)}\n\t\t\t\t\t\t\t\tonSelect={() => onSelectStory(story)}\n\t\t\t\t\t\t\t\tstory={story}\n\t\t\t\t\t\t\t\tstoryTagColors={prefs.storyTagColors}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t))}\n\t\t\t\t</TransitionGroup>\n\t\t\t</CardGroup>\n\t\t</>\n\t);\n};\n","import sortBy from 'lodash/sortBy';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {MainContent} from '../../components/container/main-content';\nimport {SafariWarningCard} from '../../components/error';\nimport {\n\tAppDonationDialog,\n\tDialogsContextProvider,\n\tuseDialogsContext\n} from '../../dialogs';\nimport {usePrefsContext} from '../../store/prefs';\nimport {useDonationCheck} from '../../store/prefs/use-donation-check';\nimport {\n\tdeselectAllStories,\n\tdeselectStory,\n\tselectStory,\n\tuseStoriesContext\n} from '../../store/stories';\nimport {UndoableStoriesContextProvider} from '../../store/undoable-stories';\nimport {StoryListToolbar} from './toolbar/story-list-toolbar';\nimport {StoryCards} from './story-cards';\nimport {ClickAwayListener} from '../../components/click-away-listener';\n\nexport const InnerStoryListRoute: React.FC = () => {\n\tconst {dispatch: dialogsDispatch} = useDialogsContext();\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {shouldShowDonationPrompt} = useDonationCheck();\n\tconst {t} = useTranslation();\n\n\tconst selectedStories = React.useMemo(\n\t\t() => stories.filter(story => story.selected),\n\t\t[stories]\n\t);\n\n\tconst visibleStories = React.useMemo(() => {\n\t\tconst filteredStories =\n\t\t\tprefs.storyListTagFilter.length > 0\n\t\t\t\t? stories.filter(story =>\n\t\t\t\t\t\tstory.tags.some(tag => prefs.storyListTagFilter.includes(tag))\n\t\t\t\t  )\n\t\t\t\t: stories;\n\n\t\tswitch (prefs.storyListSort) {\n\t\t\tcase 'date':\n\t\t\t\treturn sortBy(filteredStories, 'lastUpdated');\n\t\t\tcase 'name':\n\t\t\t\treturn sortBy(filteredStories, 'name');\n\t\t}\n\t}, [prefs.storyListSort, prefs.storyListTagFilter, stories]);\n\n\t// Any stories no longer visible should be deselected.\n\n\tReact.useEffect(() => {\n\t\tfor (const story of selectedStories) {\n\t\t\tif (story.selected && !visibleStories.includes(story)) {\n\t\t\t\tstoriesDispatch(deselectStory(story));\n\t\t\t}\n\t\t}\n\t}, [selectedStories, stories, storiesDispatch, visibleStories]);\n\n\tReact.useEffect(() => {\n\t\tif (shouldShowDonationPrompt()) {\n\t\t\tdialogsDispatch({type: 'addDialog', component: AppDonationDialog});\n\t\t}\n\t}, [dialogsDispatch, shouldShowDonationPrompt]);\n\n\treturn (\n\t\t<div className=\"story-list-route\">\n\t\t\t<StoryListToolbar selectedStories={selectedStories} />\n\t\t\t<ClickAwayListener\n\t\t\t\tignoreSelector=\".story-card\"\n\t\t\t\tonClickAway={() => storiesDispatch(deselectAllStories())}\n\t\t\t>\n\t\t\t\t<MainContent\n\t\t\t\t\ttitle={t(\n\t\t\t\t\t\tprefs.storyListTagFilter.length > 0\n\t\t\t\t\t\t\t? 'routes.storyList.taggedTitleCount'\n\t\t\t\t\t\t\t: 'routes.storyList.titleCount',\n\t\t\t\t\t\t{count: visibleStories.length}\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t<SafariWarningCard />\n\t\t\t\t\t<div className=\"stories\">\n\t\t\t\t\t\t{stories.length === 0 ? (\n\t\t\t\t\t\t\t<p>{t('routes.storyList.noStories')}</p>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<StoryCards\n\t\t\t\t\t\t\t\tonSelectStory={story =>\n\t\t\t\t\t\t\t\t\tstoriesDispatch(selectStory(story, true))\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tstories={visibleStories}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</MainContent>\n\t\t\t</ClickAwayListener>\n\t\t</div>\n\t);\n};\n\nexport const StoryListRoute: React.FC = () => (\n\t<UndoableStoriesContextProvider>\n\t\t<DialogsContextProvider>\n\t\t\t<InnerStoryListRoute />\n\t\t</DialogsContextProvider>\n\t</UndoableStoriesContextProvider>\n);\n","import * as React from 'react';\nimport {usePrefsContext} from '.';\n\n/**\n * How long since the user began using Twine to show a donation prompt. It's set\n * to 14 days.\n */\nexport const donationDelay = 1000 * 60 * 60 * 24 * 14;\n\nexport function useDonationCheck() {\n\tconst {prefs} = usePrefsContext();\n\n\tconst shouldShowDonationPrompt = React.useCallback(() => {\n\t\tif (prefs.donateShown) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn Date.now() > prefs.firstRunTime + donationDelay;\n\t}, [prefs.donateShown, prefs.firstRunTime]);\n\n\treturn {shouldShowDonationPrompt};\n}\n","export function replaceDom(html: string) {\n\t// Blast JS globals.\n\n\tdelete (window as any).CodeMirror;\n\tdelete (window as any).SVG;\n\tdelete (window as any).Store;\n\tdelete (window as any).StoryFormat;\n\tdelete (window as any).amdDefine;\n\tdelete (window as any).app;\n\tdelete (window as any).jQuery;\n\n\t// Rewrite the document.\n\n\tdocument.open();\n\tdocument.write(html);\n\tdocument.close();\n}\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\nimport {ErrorMessage} from '../../components/error';\n\nexport const StoryPlayRoute: React.FC = () => {\n\tconst [publishError, setPublishError] = React.useState<Error>();\n\tconst [inited, setInited] = React.useState(false);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {publishStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\ttry {\n\t\t\t\treplaceDom(await publishStory(storyId));\n\t\t\t} catch (error) {\n\t\t\t\tsetPublishError(error as Error);\n\t\t\t}\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, publishStory, storyId]);\n\n\tif (publishError) {\n\t\treturn <ErrorMessage>{publishError.message}</ErrorMessage>;\n\t}\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\nimport {ErrorMessage} from '../../components/error';\n\nexport const StoryProofRoute: React.FC = () => {\n\tconst [publishError, setPublishError] = React.useState<Error>();\n\tconst [inited, setInited] = React.useState(false);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {proofStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\ttry {\n\t\t\t\treplaceDom(await proofStory(storyId));\n\t\t\t} catch (error) {\n\t\t\t\tsetPublishError(error as Error);\n\t\t\t}\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, proofStory, storyId]);\n\n\tif (publishError) {\n\t\treturn <ErrorMessage>{publishError.message}</ErrorMessage>;\n\t}\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\nimport {ErrorMessage} from '../../components/error';\n\nexport const StoryTestRoute: React.FC = () => {\n\tconst [publishError, setPublishError] = React.useState<Error>();\n\tconst [inited, setInited] = React.useState(false);\n\tconst {passageId, storyId} = useParams<{\n\t\tpassageId: string;\n\t\tstoryId: string;\n\t}>();\n\tconst {publishStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\ttry {\n\t\t\t\treplaceDom(\n\t\t\t\t\tawait publishStory(storyId, {\n\t\t\t\t\t\tformatOptions: 'debug',\n\t\t\t\t\t\tstartId: passageId\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tsetPublishError(error as Error);\n\t\t\t}\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, passageId, publishStory, storyId]);\n\n\tif (publishError) {\n\t\treturn <ErrorMessage>{publishError.message}</ErrorMessage>;\n\t}\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowRight, IconArrowBarToRight} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {Card, CardContent, CardProps} from '../container/card';\nimport {IconButton} from '../control/icon-button';\nimport './welcome-card.css';\n\nexport interface WelcomeCardProps extends CardProps {\n\timage?: React.ReactNode;\n\tnextLabel: string;\n\tonNext: () => void;\n\tonSkip: () => void;\n\tshowSkip: boolean;\n\ttitle: string;\n}\n\nexport const WelcomeCard: React.FC<WelcomeCardProps> = props => {\n\tconst {\n\t\tchildren,\n\t\timage,\n\t\tnextLabel,\n\t\tonNext,\n\t\tonSkip,\n\t\tshowSkip,\n\t\ttitle,\n\t\t...otherProps\n\t} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"welcome-card\">\n\t\t\t<Card {...otherProps}>\n\t\t\t\t<div className=\"welcome-card-image\">{image}</div>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<h2>{title}</h2>\n\t\t\t\t\t{children}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconArrowRight />}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\tonClick={onNext}\n\t\t\t\t\t\tlabel={nextLabel}\n\t\t\t\t\t/>\n\t\t\t\t\t{showSkip && (\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconArrowBarToRight />}\n\t\t\t\t\t\t\tlabel={t('common.skip')}\n\t\t\t\t\t\t\tonClick={onSkip}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</ButtonBar>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import {IconDeviceFloppy, IconHelp, IconMoodSmile} from '@tabler/icons';\nimport {IconTwine} from '../../components/image/icon';\nimport {isElectronRenderer} from '../../util/is-electron';\n\nexport const content = () => [\n\t{\n\t\thtml: 'routes.welcome.greeting',\n\t\timage: <IconTwine />,\n\t\tnextLabel: 'routes.welcome.tellMeMore',\n\t\ttitle: 'routes.welcome.greetingTitle'\n\t},\n\t{\n\t\thtml: 'routes.welcome.help',\n\t\timage: <IconHelp />,\n\t\ttitle: 'routes.welcome.helpTitle'\n\t},\n\tisElectronRenderer()\n\t\t? {\n\t\t\t\thtml: 'routes.welcome.autosave',\n\t\t\t\timage: <IconDeviceFloppy />,\n\t\t\t\ttitle: 'routes.welcome.autosaveTitle'\n\t\t  }\n\t\t: {\n\t\t\t\thtml: 'routes.welcome.browserStorage',\n\t\t\t\timage: <IconDeviceFloppy />,\n\t\t\t\ttitle: 'routes.welcome.browserStorageTitle'\n\t\t  },\n\t{\n\t\thtml: 'routes.welcome.done',\n\t\timage: <IconMoodSmile />,\n\t\tnextLabel: 'routes.welcome.gotoStoryList',\n\t\ttitle: 'routes.welcome.doneTitle'\n\t}\n];\n","import * as React from 'react';\nimport {Helmet} from 'react-helmet';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport scroll from 'scroll';\nimport {WelcomeCard} from '../../components/welcome/welcome-card';\nimport {setPref, usePrefsContext} from '../../store/prefs';\nimport {content} from './content';\nimport './welcome-route.css';\n\nexport const WelcomeRoute: React.FC = () => {\n\tconst containerEl = React.useRef<HTMLDivElement>(null);\n\tconst {dispatch} = usePrefsContext();\n\tconst history = useHistory();\n\tconst [shown, setShown] = React.useState(1);\n\tconst allCards = React.useMemo(content, []);\n\tconst visibleCards = React.useMemo(() => allCards.slice(0, shown), [\n\t\tallCards,\n\t\tshown\n\t]);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (containerEl.current) {\n\t\t\tconst lastCard = containerEl.current.querySelector(\n\t\t\t\t'.welcome-card:last-of-type'\n\t\t\t);\n\n\t\t\tif (lastCard) {\n\t\t\t\tscroll.top(\n\t\t\t\t\tdocument.documentElement ?? document.body,\n\t\t\t\t\t(lastCard as HTMLElement).offsetTop,\n\t\t\t\t\t{duration: 400}\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}, [shown]);\n\n\tconst finish = () => {\n\t\tdispatch(setPref('welcomeSeen', true));\n\t\thistory.push('/');\n\t};\n\n\tconst showNext = () => setShown(shown => shown + 1);\n\n\treturn (\n\t\t<div className=\"welcome-route\" ref={containerEl}>\n\t\t\t<Helmet>\n\t\t\t\t<title>{t('routes.welcome.greetingTitle')}</title>\n\t\t\t</Helmet>\n\t\t\t<div className=\"cards\">\n\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t{visibleCards.map((card, index) => (\n\t\t\t\t\t\t<CSSTransition classNames=\"pop\" key={card.title} timeout={200}>\n\t\t\t\t\t\t\t<WelcomeCard\n\t\t\t\t\t\t\t\timage={card.image}\n\t\t\t\t\t\t\t\tnextLabel={\n\t\t\t\t\t\t\t\t\tcard.nextLabel ? t(card.nextLabel) : t('common.next')\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tonNext={index === allCards.length - 1 ? finish : showNext}\n\t\t\t\t\t\t\t\tonSkip={finish}\n\t\t\t\t\t\t\t\tshowSkip={index === 0}\n\t\t\t\t\t\t\t\ttitle={t(card.title)}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div dangerouslySetInnerHTML={{__html: t(card.html)}} />\n\t\t\t\t\t\t\t</WelcomeCard>\n\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t))}\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {HashRouter, Route, Switch} from 'react-router-dom';\nimport {usePrefsContext} from '../store/prefs';\nimport {StoryFormatListRoute} from './story-format-list';\nimport {StoryEditRoute} from './story-edit';\nimport {StoryListRoute} from './story-list';\nimport {StoryPlayRoute} from './story-play';\nimport {StoryProofRoute} from './story-proof';\nimport {StoryTestRoute} from './story-test';\nimport {WelcomeRoute} from './welcome';\n\nexport const Routes: React.FC = () => {\n\tconst {prefs} = usePrefsContext();\n\n\t// A <HashRouter> is used to make our lives easier--to load local story\n\t// formats, we need the document HREF to reflect where the HTML file is.\n\t// Otherwise we'd have to store the actual location somewhere, which will\n\t// differ between web and Electron contexts.\n\n\treturn (\n\t\t<HashRouter>\n\t\t\t{prefs.welcomeSeen ? (\n\t\t\t\t<Switch>\n\t\t\t\t\t<Route exact path=\"/\">\n\t\t\t\t\t\t<StoryListRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/story-formats\">\n\t\t\t\t\t\t<StoryFormatListRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/welcome\">\n\t\t\t\t\t\t<WelcomeRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/play\">\n\t\t\t\t\t\t<StoryPlayRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/proof\">\n\t\t\t\t\t\t<StoryProofRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/test/:passageId\">\n\t\t\t\t\t\t<StoryTestRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/test\">\n\t\t\t\t\t\t<StoryTestRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId\">\n\t\t\t\t\t\t<StoryEditRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route\n\t\t\t\t\t\tpath=\"*\"\n\t\t\t\t\t\trender={path => {\n\t\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t\t`No route for path \"${path.location.pathname}\", rendering story list`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\treturn <StoryListRoute />;\n\t\t\t\t\t\t}}\n\t\t\t\t\t></Route>\n\t\t\t\t</Switch>\n\t\t\t) : (\n\t\t\t\t<WelcomeRoute />\n\t\t\t)}\n\t\t</HashRouter>\n\t);\n};\n","import * as React from 'react';\nimport {LoadingCurtain} from '../components/loading-curtain';\nimport {usePersistence} from './persistence/use-persistence';\nimport {usePrefsContext} from './prefs';\nimport {useStoriesContext} from './stories';\nimport {useStoryFormatsContext} from './story-formats';\nimport {useStoriesRepair} from './use-stories-repair';\n\nexport const StateLoader: React.FC = ({children}) => {\n\tconst [initing, setIniting] = React.useState(false);\n\tconst [inited, setInited] = React.useState(false);\n\tconst [prefsRepaired, setPrefsRepaired] = React.useState(false);\n\tconst [formatsRepaired, setFormatsRepaired] = React.useState(false);\n\tconst [storiesRepaired, setStoriesRepaired] = React.useState(false);\n\tconst {dispatch: prefsDispatch, prefs: prefsState} = usePrefsContext();\n\tconst {dispatch: storiesDispatch} = useStoriesContext();\n\tconst {dispatch: formatsDispatch, formats: formatsState} =\n\t\tuseStoryFormatsContext();\n\tconst repairStories = useStoriesRepair();\n\tconst {prefs, stories, storyFormats} = usePersistence();\n\n\t// Done in steps so that the repair action can see the inited state, and then\n\t// each repair action can see the results of the preceding ones.\n\t//\n\t// Repairs must go:\n\t// formats -> prefs (so it can repair bad format preferences) -> stories\n\n\tReact.useEffect(() => {\n\t\tasync function run() {\n\t\t\tif (!initing) {\n\t\t\t\tconst formatsState = await storyFormats.load();\n\t\t\t\tconst prefsState = await prefs.load();\n\t\t\t\tconst storiesState = await stories.load();\n\n\t\t\t\tformatsDispatch({type: 'init', state: formatsState});\n\t\t\t\tprefsDispatch({type: 'init', state: prefsState});\n\t\t\t\tstoriesDispatch({type: 'init', state: storiesState});\n\t\t\t\tsetInited(true);\n\t\t\t}\n\t\t}\n\n\t\trun();\n\t\tsetIniting(true);\n\t}, [\n\t\tformatsDispatch,\n\t\tinited,\n\t\tiniting,\n\t\tprefs,\n\t\tprefsDispatch,\n\t\tstories,\n\t\tstoriesDispatch,\n\t\tstoryFormats\n\t]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && !formatsRepaired) {\n\t\t\tformatsDispatch({type: 'repair'});\n\t\t\tsetFormatsRepaired(true);\n\t\t}\n\t}, [formatsDispatch, formatsRepaired, inited]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && formatsRepaired && !prefsRepaired) {\n\t\t\tprefsDispatch({type: 'repair', allFormats: formatsState});\n\t\t\tsetPrefsRepaired(true);\n\t\t}\n\t}, [formatsRepaired, formatsState, inited, prefsDispatch, prefsRepaired]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && formatsRepaired && prefsRepaired && !storiesRepaired) {\n\t\t\trepairStories();\n\t\t\tsetStoriesRepaired(true);\n\t\t}\n\t}, [\n\t\tformatsDispatch,\n\t\tformatsRepaired,\n\t\tformatsState,\n\t\tinited,\n\t\tprefsDispatch,\n\t\tprefsRepaired,\n\t\tprefsState.storyFormat.name,\n\t\tprefsState.storyFormat.version,\n\t\trepairStories,\n\t\tstories,\n\t\tstoriesDispatch,\n\t\tstoriesRepaired\n\t]);\n\n\treturn inited && formatsRepaired && prefsRepaired && storiesRepaired ? (\n\t\t<>{children}</>\n\t) : (\n\t\t<LoadingCurtain />\n\t);\n};\n","import * as React from 'react';\nimport {useComputedTheme} from './prefs/use-computed-theme';\n\nexport function ThemeSetter() {\n\tconst computedTheme = useComputedTheme();\n\n\tReact.useEffect(() => {\n\t\tdocument.body.dataset.appTheme = computedTheme;\n\t}, [computedTheme]);\n\n\treturn null;\n}\n","import * as React from 'react';\nimport {GlobalErrorBoundary} from './components/error';\nimport {LoadingCurtain} from './components/loading-curtain/loading-curtain';\nimport {LocaleSwitcher} from './store/locale-switcher';\nimport {PrefsContextProvider} from './store/prefs';\nimport {Routes} from './routes';\nimport {StoriesContextProvider} from './store/stories';\nimport {StoryFormatsContextProvider} from './store/story-formats';\nimport {StateLoader} from './store/state-loader';\nimport {ThemeSetter} from './store/theme-setter';\nimport 'focus-visible';\nimport './styles/typography.css';\nimport './styles/focus-visible-shim.css';\n\nexport const App: React.FC = () => {\n\treturn (\n\t\t<GlobalErrorBoundary>\n\t\t\t<PrefsContextProvider>\n\t\t\t\t<LocaleSwitcher />\n\t\t\t\t<ThemeSetter />\n\t\t\t\t<StoryFormatsContextProvider>\n\t\t\t\t\t<StoriesContextProvider>\n\t\t\t\t\t\t<StateLoader>\n\t\t\t\t\t\t\t<React.Suspense fallback={<LoadingCurtain />}>\n\t\t\t\t\t\t\t\t<Routes />\n\t\t\t\t\t\t\t</React.Suspense>\n\t\t\t\t\t\t</StateLoader>\n\t\t\t\t\t</StoriesContextProvider>\n\t\t\t\t</StoryFormatsContextProvider>\n\t\t\t</PrefsContextProvider>\n\t\t</GlobalErrorBoundary>\n\t);\n};\n","import * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport {App} from './app';\nimport './util/i18n';\n\nReactDOM.render(\n\t<React.StrictMode>\n\t\t<App />\n\t</React.StrictMode>,\n\tdocument.getElementById('root')\n);\n"],"sourceRoot":""}